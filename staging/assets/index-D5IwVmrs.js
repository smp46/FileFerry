(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const Q5=Symbol.for("@libp2p/connection"),Ml=Symbol.for("@libp2p/content-routing"),na=Symbol.for("@libp2p/peer-discovery"),Uu=Symbol.for("@libp2p/peer-id");function di(r){return!!r?.[Uu]}const Ol=Symbol.for("@libp2p/peer-routing"),rc="keep-alive",$u=Symbol.for("@libp2p/transport");var xi;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(xi||(xi={}));let Rr=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class Y5 extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}let X5=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},L=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class sa extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class J2 extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}class Z5 extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}class e0 extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class t0 extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class Ks extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class J5 extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class Fl extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}let nr=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class r0 extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let qu=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class e8 extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class t8 extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class Vu extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class ve extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}class r8 extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}let nc=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class ia extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class hi extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class Ul extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class n0 extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class n8 extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class s0 extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class Hi extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class He extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}function zu(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Ai(...r){const e=[];for(const t of r)zu(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function sc(...r){const e=[];for(const t of r)zu(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const rt=Symbol.for("@libp2p/service-capabilities"),ns=Symbol.for("@libp2p/service-dependencies");function s8(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function ic(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function i8(r){return new TextEncoder().encode(r)}function o8(r){return new TextDecoder().decode(r)}function a8(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,g=0,y=0,E=p.length;y!==E&&p[y]===0;)y++,m++;for(var b=(E-y)*l+1>>>0,_=new Uint8Array(b);y!==E;){for(var w=p[y],k=0,x=b-1;(w!==0||k<g)&&x!==-1;x--,k++)w+=256*_[x]>>>0,_[x]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");g=k,y++}for(var T=b-g;T!==b&&_[T]===0;)T++;for(var v=c.repeat(m);T<b;++T)v+=r.charAt(_[T]);return v}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var g=0,y=0;p[m]===c;)g++,m++;for(var E=(p.length-m)*u+1>>>0,b=new Uint8Array(E);p[m];){var _=t[p.charCodeAt(m)];if(_===255)return;for(var w=0,k=E-1;(_!==0||w<y)&&k!==-1;k--,w++)_+=a*b[k]>>>0,b[k]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");y=w,m++}if(p[m]!==" "){for(var x=E-y;x!==E&&b[x]===0;)x++;for(var T=new Uint8Array(g+(E-x)),v=g;x!==E;)T[v++]=b[x++];return T}}}function f(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:h,decode:f}}var c8=a8,l8=c8;class u8{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}let d8=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return i0(this,e)}};class h8{decoders;constructor(e){this.decoders=e}or(e){return i0(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function i0(r,e){return new h8({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class f8{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new u8(e,t,n),this.decoder=new d8(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function oc({name:r,prefix:e,encode:t,decode:n}){return new f8(r,e,t,n)}function Ki({name:r,prefix:e,alphabet:t}){const{encode:n,decode:s}=l8(t,r);return oc({prefix:e,name:r,encode:n,decode:i=>ic(s(i))})}function p8(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let o=0,a=0,c=0;for(let u=0;u<s;++u){const l=e[r[u]];if(l===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|l,o+=t,o>=8&&(o-=8,i[c++]=255&a>>o)}if(o>=t||(255&a<<8-o)!==0)throw new SyntaxError("Unexpected end of data");return i}function g8(r,e,t){const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o!==0&&(i+=e[s&a<<t-o]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function m8(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function Ne({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const s=m8(n);return oc({prefix:e,name:r,encode(i){return g8(i,n,t)},decode(i){return p8(i,s,t,r)}})}const Ae=Ki({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),y8=Ki({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),w8=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Ae,base58flickr:y8},Symbol.toStringTag,{value:"Module"})),Tr=Ne({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),b8=Ne({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),v8=Ne({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),E8=Ne({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),S8=Ne({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),_8=Ne({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),x8=Ne({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),A8=Ne({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),C8=Ne({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),k8=Object.freeze(Object.defineProperty({__proto__:null,base32:Tr,base32hex:S8,base32hexpad:x8,base32hexpadupper:A8,base32hexupper:_8,base32pad:v8,base32padupper:E8,base32upper:b8,base32z:C8},Symbol.toStringTag,{value:"Module"})),Go=Ki({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),T8=Ki({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),I8=Object.freeze(Object.defineProperty({__proto__:null,base36:Go,base36upper:T8},Symbol.toStringTag,{value:"Module"}));var P8=o0,ud=128,R8=-128,D8=Math.pow(2,31);function o0(r,e,t){e=e||[],t=t||0;for(var n=t;r>=D8;)e[t++]=r&255|ud,r/=128;for(;r&R8;)e[t++]=r&255|ud,r>>>=7;return e[t]=r|0,o0.bytes=t-n+1,e}var L8=$l,N8=128,dd=127;function $l(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw $l.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&dd)<<s:(o&dd)*Math.pow(2,s),s+=7}while(o>=N8);return $l.bytes=i-n,t}var B8=Math.pow(2,7),M8=Math.pow(2,14),O8=Math.pow(2,21),F8=Math.pow(2,28),U8=Math.pow(2,35),$8=Math.pow(2,42),q8=Math.pow(2,49),V8=Math.pow(2,56),z8=Math.pow(2,63),H8=function(r){return r<B8?1:r<M8?2:r<O8?3:r<F8?4:r<U8?5:r<$8?6:r<q8?7:r<V8?8:r<z8?9:10},K8={encode:P8,decode:L8,encodingLength:H8},oa=K8;function ql(r,e=0){return[oa.decode(r,e),oa.decode.bytes]}function aa(r,e,t=0){return oa.encode(r,e,t),e}function ca(r){return oa.encodingLength(r)}function ss(r,e){const t=e.byteLength,n=ca(r),s=n+ca(t),i=new Uint8Array(s+t);return aa(r,i,0),aa(t,i,n),i.set(e,s),new Hu(r,t,e,i)}function Tt(r){const e=ic(r),[t,n]=ql(e),[s,i]=ql(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Hu(t,s,o,e)}function W8(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&s8(r.bytes,t.bytes)}}class Hu{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}function hd(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return j8(t,Vl(r),e??Ae.encoder);default:return Q8(t,Vl(r),e??Tr.encoder)}}const fd=new WeakMap;function Vl(r){const e=fd.get(r);if(e==null){const t=new Map;return fd.set(r,t),t}return e}class se{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ws)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Y8)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return se.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=ss(e,t);return se.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return se.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&W8(e.multihash,n.multihash)}toString(e){return hd(this,e)}toJSON(){return{"/":hd(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof se)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new se(n,s,i,o??pd(n,s,i.bytes))}else if(t[X8]===!0){const{version:n,multihash:s,code:i}=t,o=Tt(s);return se.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ws)throw new Error(`Version 0 CID must use dag-pb (code: ${Ws}) block encoding`);return new se(e,t,n,n.bytes)}case 1:{const s=pd(e,t,n.bytes);return new se(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return se.create(0,Ws,e)}static createV1(e,t){return se.create(1,e,t)}static decode(e){const[t,n]=se.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=se.inspectBytes(e),n=t.size-t.multihashSize,s=ic(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Hu(t.multihashCode,t.digestSize,i,s);return[t.version===0?se.createV0(o):se.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,h]=ql(e.subarray(t));return t+=h,d};let s=n(),i=Ws;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=G8(e,t),i=se.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Vl(i).set(n,e),i}}function G8(r,e){switch(r[0]){case"Q":{const t=e??Ae;return[Ae.prefix,t.decode(`${Ae.prefix}${r}`)]}case Ae.prefix:{const t=e??Ae;return[Ae.prefix,t.decode(r)]}case Tr.prefix:{const t=e??Tr;return[Tr.prefix,t.decode(r)]}case Go.prefix:{const t=e??Go;return[Go.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function j8(r,e,t){const{prefix:n}=t;if(n!==Ae.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s}function Q8(r,e,t){const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s}const Ws=112,Y8=18;function pd(r,e,t){const n=ca(r),s=n+ca(e),i=new Uint8Array(s+t.byteLength);return aa(r,i,0),aa(e,i,n),i.set(t,s),i}const X8=Symbol.for("@ipld/js-cid/CID"),a0=0,Z8="identity",c0=ic;function J8(r){return ss(a0,c0(r))}const Wi={code:a0,name:Z8,encode:c0,digest:J8};function pe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function ee(r=0){return new Uint8Array(r)}function At(r=0){return new Uint8Array(r)}function sr(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));const t=At(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return t}const l0=Symbol.for("@achingbrain/uint8arraylist");function gd(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function lo(r){return!!r?.[l0]}class Y{bufs;length;[l0]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(lo(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(lo(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=gd(this.bufs,e);return t.buf[t.index]}set(e,t){const n=gd(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(lo(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return sr(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:sr(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new Y;return i.length=s,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;const u=e>=a&&e<c,l=t>a&&t<=c;if(u&&l){if(e===a&&t===c){n.push(o);break}const d=e-a;n.push(o.subarray(d,d+(t-e)));break}if(u){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(l){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!lo(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let d=0;d<i;d++)o[d]=-1;for(let d=0;d<s;d++)o[n[d]]=d;const a=o,c=this.byteLength-n.byteLength,u=n.byteLength-1;let l;for(let d=t;d<=c;d+=l){l=0;for(let h=u;h>=0;h--){const f=this.get(d+h);if(n[h]!==f){l=Math.max(1,h-a[f]);break}}if(l===0)return d}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=At(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=ee(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=ee(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=ee(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=At(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=ee(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=ee(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=ee(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=ee(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=ee(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof Y)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!pe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Y;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}const ep=Ki({prefix:"9",name:"base10",alphabet:"0123456789"}),tp=Object.freeze(Object.defineProperty({__proto__:null,base10:ep},Symbol.toStringTag,{value:"Module"})),rp=Ne({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),np=Ne({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),sp=Object.freeze(Object.defineProperty({__proto__:null,base16:rp,base16upper:np},Symbol.toStringTag,{value:"Module"})),ip=Ne({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),op=Object.freeze(Object.defineProperty({__proto__:null,base2:ip},Symbol.toStringTag,{value:"Module"})),u0=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),ap=u0.reduce((r,e,t)=>(r[t]=e,r),[]),cp=u0.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function lp(r){return r.reduce((e,t)=>(e+=ap[t],e),"")}function up(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const s=cp[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const dp=oc({prefix:"🚀",name:"base256emoji",encode:lp,decode:up}),hp=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:dp},Symbol.toStringTag,{value:"Module"})),Gi=Ne({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),fp=Ne({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Ku=Ne({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),pp=Ne({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),gp=Object.freeze(Object.defineProperty({__proto__:null,base64:Gi,base64pad:fp,base64url:Ku,base64urlpad:pp},Symbol.toStringTag,{value:"Module"})),mp=Ne({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),yp=Object.freeze(Object.defineProperty({__proto__:null,base8:mp},Symbol.toStringTag,{value:"Module"})),wp=oc({prefix:"\0",name:"identity",encode:r=>o8(r),decode:r=>i8(r)}),bp=Object.freeze(Object.defineProperty({__proto__:null,identity:wp},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const vp=85;function Ep({name:r,code:e,encode:t}){return new Sp(r,e,t)}class Sp{name;code;encode;constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ss(this.code,t):t.then(n=>ss(this.code,n))}else throw Error("Unknown type, must be binary type")}}function _p(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const Ls=Ep({name:"sha2-256",code:18,encode:_p("SHA-256")}),zl={...bp,...op,...yp,...tp,...sp,...k8,...I8,...w8,...gp,...hp};function d0(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const md=d0("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Dc=d0("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=At(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),h0={utf8:md,"utf-8":md,hex:zl.base16,latin1:Dc,ascii:Dc,binary:Dc,...zl};function q(r,e="utf8"){const t=h0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function F(r,e="utf8"){const t=h0[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const xp=parseInt("11111",2),Hl=parseInt("10000000",2),Ap=parseInt("01111111",2),yd={0:Gs,1:Gs,2:Cp,3:Ip,4:Pp,5:Tp,6:kp,16:Gs,22:Gs,48:Gs};function bn(r,e={offset:0}){const t=r[e.offset]&xp;if(e.offset++,yd[t]!=null)return yd[t](r,e);throw new Error("No decoder for tag "+t)}function ji(r,e){let t=0;if((r[e.offset]&Hl)===Hl){const n=r[e.offset]&Ap;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Gs(r,e){ji(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=bn(r,e);if(n===null)break;t.push(n)}return t}function Cp(r,e){const t=ji(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function kp(r,e){const t=ji(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const u=r[e.offset];if(e.offset++,c.push(u&127),u<128){c.reverse();let l=0;for(let d=0;d<c.length;d++)l+=c[d]<<d*7;a+=`.${l}`,c=[]}}return a}function Tp(r,e){return e.offset++,null}function Ip(r,e){const t=ji(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function Pp(r,e){const t=ji(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function Rp(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Y;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function ac(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=Rp(r.byteLength);return new Y(Uint8Array.from([e.byteLength|Hl]),e)}function ot(r){const e=new Y,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Y(Uint8Array.from([2]),ac(e),e)}function Wu(r){const e=Uint8Array.from([0]),t=new Y(e,r);return new Y(Uint8Array.from([3]),ac(t),t)}function Dp(r){return new Y(Uint8Array.from([4]),ac(r),r)}function Jt(r,e=48){const t=new Y;for(const n of r)t.append(n);return new Y(Uint8Array.from([e]),ac(t),t)}const Lp="1.2.840.10045.3.1.7",Np="1.3.132.0.34",Bp="1.3.132.0.35";async function Mp(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();const s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function Op(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const Fp=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Up=Uint8Array.from([6,5,43,129,4,0,34]),$p=Uint8Array.from([6,5,43,129,4,0,35]),f0={ext:!0,kty:"EC",crv:"P-256"},p0={ext:!0,kty:"EC",crv:"P-384"},g0={ext:!0,kty:"EC",crv:"P-521"},Kn=32,Wn=48,Gn=66;function qp(r){const e=bn(r);return m0(e)}function m0(r){const e=r[1],t=F(e,"base64url"),n=r[2][1][0],s=1;let i,o;if(e.byteLength===Kn)return i=F(n.subarray(s,s+Kn),"base64url"),o=F(n.subarray(s+Kn),"base64url"),new Lc({...f0,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Wn)return i=F(n.subarray(s,s+Wn),"base64url"),o=F(n.subarray(s+Wn),"base64url"),new Lc({...p0,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Gn)return i=F(n.subarray(s,s+Gn),"base64url"),o=F(n.subarray(s+Gn),"base64url"),new Lc({...g0,key_ops:["sign"],d:t,x:i,y:o});throw new L(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function y0(r){const e=bn(r);return Vp(e)}function Vp(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===Kn*2+1)return n=F(e.subarray(t,t+Kn),"base64url"),s=F(e.subarray(t+Kn),"base64url"),new jo({...f0,key_ops:["verify"],x:n,y:s});if(e.byteLength===Wn*2+1)return n=F(e.subarray(t,t+Wn),"base64url"),s=F(e.subarray(t+Wn),"base64url"),new jo({...p0,key_ops:["verify"],x:n,y:s});if(e.byteLength===Gn*2+1)return n=F(e.subarray(t,t+Gn),"base64url"),s=F(e.subarray(t+Gn),"base64url"),new jo({...g0,key_ops:["verify"],x:n,y:s});throw new L(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function zp(r){return Jt([ot(Uint8Array.from([1])),Dp(q(r.d??"","base64url")),Jt([w0(r.crv)],160),Jt([Wu(new Y(Uint8Array.from([4]),q(r.x??"","base64url"),q(r.y??"","base64url")))],161)]).subarray()}function Hp(r){return Jt([ot(Uint8Array.from([1])),Jt([w0(r.crv)],160),Jt([Wu(new Y(Uint8Array.from([4]),q(r.x??"","base64url"),q(r.y??"","base64url")))],161)]).subarray()}function w0(r){if(r==="P-256")return Fp;if(r==="P-384")return Up;if(r==="P-521")return $p;throw new L(`Invalid curve ${r}`)}class jo{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=Hp(this.jwk)),this._raw}toMultihash(){return Wi.digest(Ft(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return Ae.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async verify(e,t,n){return Op(this.jwk,t,e,n)}}class Lc{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new jo({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=zp(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async sign(e,t){return Mp(this.jwk,e,t)}}const kn=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Gu(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function tn(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Ct(r,...e){if(!Gu(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function cc(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");tn(r.outputLen),tn(r.blockLen)}function la(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Kp(r,e){Ct(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Vt(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function fi(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Pt(r,e){return r<<32-e|r>>>e}function Nc(r,e){return r<<e|r>>>32-e>>>0}const b0=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Wp=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function is(r){if(Ct(r),b0)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=Wp[r[t]];return e}const Wt={_0:48,_9:57,A:65,F:70,a:97,f:102};function wd(r){if(r>=Wt._0&&r<=Wt._9)return r-Wt._0;if(r>=Wt.A&&r<=Wt.F)return r-(Wt.A-10);if(r>=Wt.a&&r<=Wt.f)return r-(Wt.a-10)}function ju(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(b0)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=wd(r.charCodeAt(i)),a=wd(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}const Gp=async()=>{};async function jp(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);const i=Date.now()-n;i>=0&&i<e||(await Gp(),n+=i)}}function v0(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Ci(r){return typeof r=="string"&&(r=v0(r)),Ct(r),r}function bd(r){return typeof r=="string"&&(r=v0(r)),Ct(r),r}function Xt(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];Ct(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function Qp(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}class E0{}function Qu(r){const e=n=>r().update(Ci(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function lc(r=32){if(kn&&typeof kn.getRandomValues=="function")return kn.getRandomValues(new Uint8Array(r));if(kn&&typeof kn.randomBytes=="function")return Uint8Array.from(kn.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function Yp(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=n?4:0,u=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+u,a,n)}function S0(r,e,t){return r&e^~r&t}function _0(r,e,t){return r&e^r&t^e&t}class Yu extends E0{constructor(e,t,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=fi(this.buffer)}update(e){la(this),e=Ci(e),Ct(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=fi(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){la(this),Kp(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,Vt(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let d=o;d<s;d++)t[d]=0;Yp(n,s-8,BigInt(this.length*8),i),this.process(n,0);const a=fi(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<u;d++)a.setUint32(4*d,l[d],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const dr=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Me=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),uo=BigInt(2**32-1),vd=BigInt(32);function Xp(r,e=!1){return e?{h:Number(r&uo),l:Number(r>>vd&uo)}:{h:Number(r>>vd&uo)|0,l:Number(r&uo)|0}}function Zp(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=Xp(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const Ed=(r,e,t)=>r>>>t,Sd=(r,e,t)=>r<<32-t|e>>>t,Tn=(r,e,t)=>r>>>t|e<<32-t,In=(r,e,t)=>r<<32-t|e>>>t,ho=(r,e,t)=>r<<64-t|e>>>t-32,fo=(r,e,t)=>r>>>t-32|e<<64-t;function Gt(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const Jp=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),e7=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,t7=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),r7=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,n7=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),s7=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,i7=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),hr=new Uint32Array(64);class o7 extends Yu{constructor(e=32){super(64,e,8,!1),this.A=dr[0]|0,this.B=dr[1]|0,this.C=dr[2]|0,this.D=dr[3]|0,this.E=dr[4]|0,this.F=dr[5]|0,this.G=dr[6]|0,this.H=dr[7]|0}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let d=0;d<16;d++,t+=4)hr[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){const h=hr[d-15],f=hr[d-2],p=Pt(h,7)^Pt(h,18)^h>>>3,m=Pt(f,17)^Pt(f,19)^f>>>10;hr[d]=m+hr[d-7]+p+hr[d-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:u,H:l}=this;for(let d=0;d<64;d++){const h=Pt(a,6)^Pt(a,11)^Pt(a,25),f=l+h+S0(a,c,u)+i7[d]+hr[d]|0,m=(Pt(n,2)^Pt(n,13)^Pt(n,22))+_0(n,s,i)|0;l=u,u=c,c=a,a=o+f|0,o=i,i=s,s=n,n=f+m|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,s,i,o,a,c,u,l)}roundClean(){Vt(hr)}destroy(){this.set(0,0,0,0,0,0,0,0),Vt(this.buffer)}}const x0=Zp(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),a7=x0[0],c7=x0[1],fr=new Uint32Array(80),pr=new Uint32Array(80);class l7 extends Yu{constructor(e=64){super(128,e,16,!1),this.Ah=Me[0]|0,this.Al=Me[1]|0,this.Bh=Me[2]|0,this.Bl=Me[3]|0,this.Ch=Me[4]|0,this.Cl=Me[5]|0,this.Dh=Me[6]|0,this.Dl=Me[7]|0,this.Eh=Me[8]|0,this.El=Me[9]|0,this.Fh=Me[10]|0,this.Fl=Me[11]|0,this.Gh=Me[12]|0,this.Gl=Me[13]|0,this.Hh=Me[14]|0,this.Hl=Me[15]|0}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:u,El:l,Fh:d,Fl:h,Gh:f,Gl:p,Hh:m,Hl:g}=this;return[e,t,n,s,i,o,a,c,u,l,d,h,f,p,m,g]}set(e,t,n,s,i,o,a,c,u,l,d,h,f,p,m,g){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=u|0,this.El=l|0,this.Fh=d|0,this.Fl=h|0,this.Gh=f|0,this.Gl=p|0,this.Hh=m|0,this.Hl=g|0}process(e,t){for(let b=0;b<16;b++,t+=4)fr[b]=e.getUint32(t),pr[b]=e.getUint32(t+=4);for(let b=16;b<80;b++){const _=fr[b-15]|0,w=pr[b-15]|0,k=Tn(_,w,1)^Tn(_,w,8)^Ed(_,w,7),x=In(_,w,1)^In(_,w,8)^Sd(_,w,7),T=fr[b-2]|0,v=pr[b-2]|0,A=Tn(T,v,19)^ho(T,v,61)^Ed(T,v,6),S=In(T,v,19)^fo(T,v,61)^Sd(T,v,6),C=t7(x,S,pr[b-7],pr[b-16]),I=r7(C,k,A,fr[b-7],fr[b-16]);fr[b]=I|0,pr[b]=C|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:u,Dl:l,Eh:d,El:h,Fh:f,Fl:p,Gh:m,Gl:g,Hh:y,Hl:E}=this;for(let b=0;b<80;b++){const _=Tn(d,h,14)^Tn(d,h,18)^ho(d,h,41),w=In(d,h,14)^In(d,h,18)^fo(d,h,41),k=d&f^~d&m,x=h&p^~h&g,T=n7(E,w,x,c7[b],pr[b]),v=s7(T,y,_,k,a7[b],fr[b]),A=T|0,S=Tn(n,s,28)^ho(n,s,34)^ho(n,s,39),C=In(n,s,28)^fo(n,s,34)^fo(n,s,39),I=n&i^n&a^i&a,P=s&o^s&c^o&c;y=m|0,E=g|0,m=f|0,g=p|0,f=d|0,p=h|0,{h:d,l:h}=Gt(u|0,l|0,v|0,A|0),u=a|0,l=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const R=Jp(A,C,P);n=e7(R,v,S,I),s=R|0}({h:n,l:s}=Gt(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=Gt(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=Gt(this.Ch|0,this.Cl|0,a|0,c|0),{h:u,l}=Gt(this.Dh|0,this.Dl|0,u|0,l|0),{h:d,l:h}=Gt(this.Eh|0,this.El|0,d|0,h|0),{h:f,l:p}=Gt(this.Fh|0,this.Fl|0,f|0,p|0),{h:m,l:g}=Gt(this.Gh|0,this.Gl|0,m|0,g|0),{h:y,l:E}=Gt(this.Hh|0,this.Hl|0,y|0,E|0),this.set(n,s,i,o,a,c,u,l,d,h,f,p,m,g,y,E)}roundClean(){Vt(fr,pr)}destroy(){Vt(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const A0=Qu(()=>new o7),C0=Qu(()=>new l7);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Xu=BigInt(0),Kl=BigInt(1);function an(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function po(r){const e=r.toString(16);return e.length&1?"0"+e:e}function k0(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Xu:BigInt("0x"+r)}function uc(r){return k0(is(r))}function cn(r){return Ct(r),k0(is(Uint8Array.from(r).reverse()))}function Zu(r,e){return ju(r.toString(16).padStart(e*2,"0"))}function Qi(r,e){return Zu(r,e).reverse()}function we(r,e,t){let n;if(typeof e=="string")try{n=ju(e)}catch(i){throw new Error(r+" must be hex string or Uint8Array, cause: "+i)}else if(Gu(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");const s=n.length;if(typeof t=="number"&&s!==t)throw new Error(r+" of length "+t+" expected, got "+s);return n}const Bc=r=>typeof r=="bigint"&&Xu<=r;function u7(r,e,t){return Bc(r)&&Bc(e)&&Bc(t)&&e<=r&&r<t}function Er(r,e,t,n){if(!u7(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function d7(r){let e;for(e=0;r>Xu;r>>=Kl,e+=1);return e}const dc=r=>(Kl<<BigInt(r))-Kl;function h7(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const n=f=>new Uint8Array(f),s=f=>Uint8Array.of(f);let i=n(r),o=n(r),a=0;const c=()=>{i.fill(1),o.fill(0),a=0},u=(...f)=>t(o,i,...f),l=(f=n(0))=>{o=u(s(0),f),i=u(),f.length!==0&&(o=u(s(1),f),i=u())},d=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let f=0;const p=[];for(;f<e;){i=u();const m=i.slice();p.push(m),f+=i.length}return Xt(...p)};return(f,p)=>{c(),l(f);let m;for(;!(m=p(d()));)l();return c(),m}}function Ns(r,e,t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(s,i,o){const a=r[s];if(o&&a===void 0)return;const c=typeof a;if(c!==i||a===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${c}`)}Object.entries(e).forEach(([s,i])=>n(s,i,!1)),Object.entries(t).forEach(([s,i])=>n(s,i,!0))}function ua(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const et=BigInt(0),Le=BigInt(1),Qr=BigInt(2),f7=BigInt(3),T0=BigInt(4),I0=BigInt(5),P0=BigInt(8);function be(r,e){const t=r%e;return t>=et?t:e+t}function ye(r,e,t){let n=r;for(;e-- >et;)n*=n,n%=t;return n}function _d(r,e){if(r===et)throw new Error("invert: expected non-zero number");if(e<=et)throw new Error("invert: expected positive modulus, got "+e);let t=be(r,e),n=e,s=et,i=Le;for(;t!==et;){const a=n/t,c=n%t,u=s-i*a;n=t,t=c,s=i,i=u}if(n!==Le)throw new Error("invert: does not exist");return be(s,e)}function R0(r,e){const t=(r.ORDER+Le)/T0,n=r.pow(e,t);if(!r.eql(r.sqr(n),e))throw new Error("Cannot find square root");return n}function p7(r,e){const t=(r.ORDER-I0)/P0,n=r.mul(e,Qr),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,Qr),s),a=r.mul(i,r.sub(o,r.ONE));if(!r.eql(r.sqr(a),e))throw new Error("Cannot find square root");return a}function g7(r){if(r<BigInt(3))throw new Error("sqrt is not defined for small field");let e=r-Le,t=0;for(;e%Qr===et;)e/=Qr,t++;let n=Qr;const s=Bs(r);for(;xd(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return R0;let i=s.pow(n,e);const o=(e+Le)/Qr;return function(c,u){if(c.is0(u))return u;if(xd(c,u)!==1)throw new Error("Cannot find square root");let l=t,d=c.mul(c.ONE,i),h=c.pow(u,e),f=c.pow(u,o);for(;!c.eql(h,c.ONE);){if(c.is0(h))return c.ZERO;let p=1,m=c.sqr(h);for(;!c.eql(m,c.ONE);)if(p++,m=c.sqr(m),p===l)throw new Error("Cannot find square root");const g=Le<<BigInt(l-p-1),y=c.pow(d,g);l=p,d=c.sqr(y),h=c.mul(h,d),f=c.mul(f,y)}return f}}function m7(r){return r%T0===f7?R0:r%P0===I0?p7:g7(r)}const y7=(r,e)=>(be(r,e)&Le)===Le,w7=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function b7(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=w7.reduce((n,s)=>(n[s]="function",n),e);return Ns(r,t),r}function v7(r,e,t){if(t<et)throw new Error("invalid exponent, negatives unsupported");if(t===et)return r.ONE;if(t===Le)return e;let n=r.ONE,s=e;for(;t>et;)t&Le&&(n=r.mul(n,s)),s=r.sqr(s),t>>=Le;return n}function D0(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function xd(r,e){const t=(r.ORDER-Le)/Qr,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function E7(r,e){e!==void 0&&tn(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function Bs(r,e,t=!1,n={}){if(r<=et)throw new Error("invalid field: expected ORDER > 0, got "+r);let s,i;if(typeof e=="object"&&e!=null){if(n.sqrt||t)throw new Error("cannot specify opts in two arguments");const l=e;l.BITS&&(s=l.BITS),l.sqrt&&(i=l.sqrt),typeof l.isLE=="boolean"&&(t=l.isLE)}else typeof e=="number"&&(s=e),n.sqrt&&(i=n.sqrt);const{nBitLength:o,nByteLength:a}=E7(r,s);if(a>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let c;const u=Object.freeze({ORDER:r,isLE:t,BITS:o,BYTES:a,MASK:dc(o),ZERO:et,ONE:Le,create:l=>be(l,r),isValid:l=>{if(typeof l!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof l);return et<=l&&l<r},is0:l=>l===et,isValidNot0:l=>!u.is0(l)&&u.isValid(l),isOdd:l=>(l&Le)===Le,neg:l=>be(-l,r),eql:(l,d)=>l===d,sqr:l=>be(l*l,r),add:(l,d)=>be(l+d,r),sub:(l,d)=>be(l-d,r),mul:(l,d)=>be(l*d,r),pow:(l,d)=>v7(u,l,d),div:(l,d)=>be(l*_d(d,r),r),sqrN:l=>l*l,addN:(l,d)=>l+d,subN:(l,d)=>l-d,mulN:(l,d)=>l*d,inv:l=>_d(l,r),sqrt:i||(l=>(c||(c=m7(r)),c(u,l))),toBytes:l=>t?Qi(l,a):Zu(l,a),fromBytes:l=>{if(l.length!==a)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+l.length);return t?cn(l):uc(l)},invertBatch:l=>D0(u,l),cmov:(l,d,h)=>h?d:l});return Object.freeze(u)}function L0(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function N0(r){const e=L0(r);return e+Math.ceil(e/2)}function S7(r,e,t=!1){const n=r.length,s=L0(e),i=N0(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?cn(r):uc(r),a=be(o,e-Le)+Le;return t?Qi(a,s):Zu(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const os=BigInt(0),Yr=BigInt(1);function pi(r,e){const t=e.negate();return r?t:e}function B0(r,e,t){const n=e==="pz"?o=>o.pz:o=>o.ez,s=D0(r.Fp,t.map(n));return t.map((o,a)=>o.toAffine(s[a])).map(r.fromAffine)}function M0(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function Mc(r,e){M0(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=dc(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function Ad(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=Yr);const u=e*n,l=u+Math.abs(a)-1,d=a===0,h=a<0,f=e%2!==0;return{nextN:c,offset:l,isZero:d,isNeg:h,isNegF:f,offsetF:u}}function _7(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function x7(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}const Oc=new WeakMap,O0=new WeakMap;function Fc(r){return O0.get(r)||1}function Cd(r){if(r!==os)throw new Error("invalid wNAF")}function F0(r,e){return{constTimeNegate:pi,hasPrecomputes(t){return Fc(t)!==1},unsafeLadder(t,n,s=r.ZERO){let i=t;for(;n>os;)n&Yr&&(s=s.add(i)),i=i.double(),n>>=Yr;return s},precomputeWindow(t,n){const{windows:s,windowSize:i}=Mc(n,e),o=[];let a=t,c=a;for(let u=0;u<s;u++){c=a,o.push(c);for(let l=1;l<i;l++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,n,s){let i=r.ZERO,o=r.BASE;const a=Mc(t,e);for(let c=0;c<a.windows;c++){const{nextN:u,offset:l,isZero:d,isNeg:h,isNegF:f,offsetF:p}=Ad(s,c,a);s=u,d?o=o.add(pi(f,n[p])):i=i.add(pi(h,n[l]))}return Cd(s),{p:i,f:o}},wNAFUnsafe(t,n,s,i=r.ZERO){const o=Mc(t,e);for(let a=0;a<o.windows&&s!==os;a++){const{nextN:c,offset:u,isZero:l,isNeg:d}=Ad(s,a,o);if(s=c,!l){const h=n[u];i=i.add(d?h.negate():h)}}return Cd(s),i},getPrecomputes(t,n,s){let i=Oc.get(n);return i||(i=this.precomputeWindow(n,t),t!==1&&(typeof s=="function"&&(i=s(i)),Oc.set(n,i))),i},wNAFCached(t,n,s){const i=Fc(t);return this.wNAF(i,this.getPrecomputes(i,t,s),n)},wNAFCachedUnsafe(t,n,s,i){const o=Fc(t);return o===1?this.unsafeLadder(t,n,i):this.wNAFUnsafe(o,this.getPrecomputes(o,t,s),n,i)},setWindowSize(t,n){M0(n,e),O0.set(t,n),Oc.delete(t)}}}function A7(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>os||n>os;)t&Yr&&(i=i.add(s)),n&Yr&&(o=o.add(s)),s=s.double(),t>>=Yr,n>>=Yr;return{p1:i,p2:o}}function U0(r,e,t,n){_7(t,r),x7(n,e);const s=t.length,i=n.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const o=r.ZERO,a=d7(BigInt(s));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const u=dc(c),l=new Array(Number(u)+1).fill(o),d=Math.floor((e.BITS-1)/c)*c;let h=o;for(let f=d;f>=0;f-=c){l.fill(o);for(let m=0;m<i;m++){const g=n[m],y=Number(g>>BigInt(f)&u);l[y]=l[y].add(t[m])}let p=o;for(let m=l.length-1,g=o;m>0;m--)g=g.add(l[m]),p=p.add(g);if(h=h.add(p),f!==0)for(let m=0;m<c;m++)h=h.double()}return h}function kd(r,e){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return b7(e),e}else return Bs(r)}function $0(r,e,t={}){if(!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const a of["p","n","h"]){const c=e[a];if(!(typeof c=="bigint"&&c>os))throw new Error(`CURVE.${a} must be positive bigint`)}const n=kd(e.p,t.Fp),s=kd(e.n,t.Fn),o=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const a of o)if(!n.isValid(e[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return{Fp:n,Fn:s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Dt=BigInt(0),Ke=BigInt(1),Uc=BigInt(2),C7=BigInt(8),k7={zip215:!0};function T7(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function I7(r,e={}){const{Fp:t,Fn:n}=$0("edwards",r,e),{h:s,n:i}=r;Ns(e,{},{uvRatio:"function"});const o=Uc<<BigInt(n.BYTES*8)-Ke,a=m=>t.create(m),c=e.uvRatio||((m,g)=>{try{return{isValid:!0,value:t.sqrt(t.div(m,g))}}catch{return{isValid:!1,value:Dt}}});if(!T7(t,r,r.Gx,r.Gy))throw new Error("bad curve params: generator point");function u(m,g,y=!1){const E=y?Ke:Dt;return Er("coordinate "+m,g,E,o),g}function l(m){if(!(m instanceof f))throw new Error("ExtendedPoint expected")}const d=ua((m,g)=>{const{ex:y,ey:E,ez:b}=m,_=m.is0();g==null&&(g=_?C7:t.inv(b));const w=a(y*g),k=a(E*g),x=a(b*g);if(_)return{x:Dt,y:Ke};if(x!==Ke)throw new Error("invZ was invalid");return{x:w,y:k}}),h=ua(m=>{const{a:g,d:y}=r;if(m.is0())throw new Error("bad point: ZERO");const{ex:E,ey:b,ez:_,et:w}=m,k=a(E*E),x=a(b*b),T=a(_*_),v=a(T*T),A=a(k*g),S=a(T*a(A+x)),C=a(v+a(y*a(k*x)));if(S!==C)throw new Error("bad point: equation left != right (1)");const I=a(E*b),P=a(_*w);if(I!==P)throw new Error("bad point: equation left != right (2)");return!0});class f{constructor(g,y,E,b){this.ex=u("x",g),this.ey=u("y",y),this.ez=u("z",E,!0),this.et=u("t",b),Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(g){if(g instanceof f)throw new Error("extended point not allowed");const{x:y,y:E}=g||{};return u("x",y),u("y",E),new f(y,E,Ke,a(y*E))}static normalizeZ(g){return B0(f,"ez",g)}static msm(g,y){return U0(f,n,g,y)}_setWindowSize(g){this.precompute(g)}precompute(g=8,y=!0){return p.setWindowSize(this,g),y||this.multiply(Uc),this}assertValidity(){h(this)}equals(g){l(g);const{ex:y,ey:E,ez:b}=this,{ex:_,ey:w,ez:k}=g,x=a(y*k),T=a(_*b),v=a(E*k),A=a(w*b);return x===T&&v===A}is0(){return this.equals(f.ZERO)}negate(){return new f(a(-this.ex),this.ey,this.ez,a(-this.et))}double(){const{a:g}=r,{ex:y,ey:E,ez:b}=this,_=a(y*y),w=a(E*E),k=a(Uc*a(b*b)),x=a(g*_),T=y+E,v=a(a(T*T)-_-w),A=x+w,S=A-k,C=x-w,I=a(v*S),P=a(A*C),R=a(v*C),D=a(S*A);return new f(I,P,D,R)}add(g){l(g);const{a:y,d:E}=r,{ex:b,ey:_,ez:w,et:k}=this,{ex:x,ey:T,ez:v,et:A}=g,S=a(b*x),C=a(_*T),I=a(k*E*A),P=a(w*v),R=a((b+_)*(x+T)-S-C),D=P-I,N=P+I,M=a(C-y*S),B=a(R*D),z=a(N*M),U=a(R*M),K=a(D*N);return new f(B,z,K,U)}subtract(g){return this.add(g.negate())}multiply(g){const y=g;Er("scalar",y,Ke,i);const{p:E,f:b}=p.wNAFCached(this,y,f.normalizeZ);return f.normalizeZ([E,b])[0]}multiplyUnsafe(g,y=f.ZERO){const E=g;return Er("scalar",E,Dt,i),E===Dt?f.ZERO:this.is0()||E===Ke?this:p.wNAFCachedUnsafe(this,E,f.normalizeZ,y)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}isTorsionFree(){return p.wNAFCachedUnsafe(this,i).is0()}toAffine(g){return d(this,g)}clearCofactor(){return s===Ke?this:this.multiplyUnsafe(s)}static fromBytes(g,y=!1){return Ct(g),this.fromHex(g,y)}static fromHex(g,y=!1){const{d:E,a:b}=r,_=t.BYTES;g=we("pointHex",g,_),an("zip215",y);const w=g.slice(),k=g[_-1];w[_-1]=k&-129;const x=cn(w),T=y?o:t.ORDER;Er("pointHex.y",x,Dt,T);const v=a(x*x),A=a(v-Ke),S=a(E*v-b);let{isValid:C,value:I}=c(A,S);if(!C)throw new Error("Point.fromHex: invalid y coordinate");const P=(I&Ke)===Ke,R=(k&128)!==0;if(!y&&I===Dt&&R)throw new Error("Point.fromHex: x=0 and x_0=1");return R!==P&&(I=a(-I)),f.fromAffine({x:I,y:x})}static fromPrivateScalar(g){return f.BASE.multiply(g)}toBytes(){const{x:g,y}=this.toAffine(),E=Qi(y,t.BYTES);return E[E.length-1]|=g&Ke?128:0,E}toRawBytes(){return this.toBytes()}toHex(){return is(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}f.BASE=new f(r.Gx,r.Gy,Ke,a(r.Gx*r.Gy)),f.ZERO=new f(Dt,Ke,Ke,Dt),f.Fp=t,f.Fn=n;const p=F0(f,n.BYTES*8);return f}function P7(r,e){Ns(e,{hash:"function"},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:t,hash:n}=e,{BASE:s,Fp:i,Fn:o}=r,a=o.ORDER,c=e.randomBytes||lc,u=e.adjustScalarBytes||(w=>w),l=e.domain||((w,k,x)=>{if(an("phflag",x),k.length||x)throw new Error("Contexts/pre-hash are not supported");return w});function d(w){return o.create(w)}function h(w){return d(cn(w))}function f(w){const k=i.BYTES;w=we("private key",w,k);const x=we("hashed private key",n(w),2*k),T=u(x.slice(0,k)),v=x.slice(k,2*k),A=h(T);return{head:T,prefix:v,scalar:A}}function p(w){const{head:k,prefix:x,scalar:T}=f(w),v=s.multiply(T),A=v.toBytes();return{head:k,prefix:x,scalar:T,point:v,pointBytes:A}}function m(w){return p(w).pointBytes}function g(w=Uint8Array.of(),...k){const x=Xt(...k);return h(n(l(x,we("context",w),!!t)))}function y(w,k,x={}){w=we("message",w),t&&(w=t(w));const{prefix:T,scalar:v,pointBytes:A}=p(k),S=g(x.context,T,w),C=s.multiply(S).toBytes(),I=g(x.context,C,A,w),P=d(S+I*v);Er("signature.s",P,Dt,a);const R=i.BYTES,D=Xt(C,Qi(P,R));return we("result",D,R*2)}const E=k7;function b(w,k,x,T=E){const{context:v,zip215:A}=T,S=i.BYTES;w=we("signature",w,2*S),k=we("message",k),x=we("publicKey",x,S),A!==void 0&&an("zip215",A),t&&(k=t(k));const C=cn(w.slice(S,2*S));let I,P,R;try{I=r.fromHex(x,A),P=r.fromHex(w.slice(0,S),A),R=s.multiplyUnsafe(C)}catch{return!1}if(!A&&I.isSmallOrder())return!1;const D=g(v,P.toBytes(),I.toBytes(),k);return P.add(I.multiplyUnsafe(D)).subtract(R).clearCofactor().is0()}return s.precompute(8),{getPublicKey:m,sign:y,verify:b,utils:{getExtendedPublicKey:p,randomPrivateKey:()=>c(i.BYTES),precompute(w=8,k=r.BASE){return k.precompute(w,!1)}},Point:r}}function R7(r){const e={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=Bs(e.n,r.nBitLength,!0),s={Fp:t,Fn:n,uvRatio:r.uvRatio},i={hash:r.hash,randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:e,curveOpts:s,eddsaOpts:i}}function D7(r,e){return Object.assign({},e,{ExtendedPoint:e.Point,CURVE:r})}function L7(r){const{CURVE:e,curveOpts:t,eddsaOpts:n}=R7(r),s=I7(e,t),i=P7(s,n);return D7(r,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const js=BigInt(0),Pn=BigInt(1),go=BigInt(2);function N7(r){return Ns(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function B7(r){const e=N7(r),{P:t,type:n,adjustScalarBytes:s,powPminus2:i,randomBytes:o}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");const c=o||lc,u=a?255:448,l=a?32:56,d=BigInt(a?9:5),h=BigInt(a?121665:39081),f=a?go**BigInt(254):go**BigInt(447),p=a?BigInt(8)*go**BigInt(251)-Pn:BigInt(4)*go**BigInt(445)-Pn,m=f+p+Pn,g=v=>be(v,t),y=E(d);function E(v){return Qi(g(v),l)}function b(v){const A=we("u coordinate",v,l);return a&&(A[31]&=127),g(cn(A))}function _(v){return cn(s(we("scalar",v,l)))}function w(v,A){const S=T(b(A),_(v));if(S===js)throw new Error("invalid private or public key received");return E(S)}function k(v){return w(v,y)}function x(v,A,S){const C=g(v*(A-S));return A=g(A-C),S=g(S+C),{x_2:A,x_3:S}}function T(v,A){Er("u",v,js,t),Er("scalar",A,f,m);const S=A,C=v;let I=Pn,P=js,R=v,D=Pn,N=js;for(let B=BigInt(u-1);B>=js;B--){const z=S>>B&Pn;N^=z,{x_2:I,x_3:R}=x(N,I,R),{x_2:P,x_3:D}=x(N,P,D),N=z;const U=I+P,K=g(U*U),Z=I-P,de=g(Z*Z),j=K-de,ge=R+D,Ye=R-D,Be=g(Ye*U),Ie=g(ge*Z),Cn=Be+Ie,Kt=Be-Ie;R=g(Cn*Cn),D=g(C*g(Kt*Kt)),I=g(K*de),P=g(j*(K+g(h*j)))}({x_2:I,x_3:R}=x(N,I,R)),{x_2:P,x_3:D}=x(N,P,D);const M=i(P);return g(I*M)}return{scalarMult:w,scalarMultBase:k,getSharedSecret:(v,A)=>w(v,A),getPublicKey:v=>k(v),utils:{randomPrivateKey:()=>c(l)},GuBytes:y.slice()}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */BigInt(0);const M7=BigInt(1),Td=BigInt(2),O7=BigInt(3),F7=BigInt(5),U7=BigInt(8),Yi={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:U7,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function q0(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=Yi.p,a=r*r%i*r%i,c=ye(a,Td,i)*a%i,u=ye(c,M7,i)*r%i,l=ye(u,F7,i)*u%i,d=ye(l,e,i)*l%i,h=ye(d,t,i)*d%i,f=ye(h,n,i)*h%i,p=ye(f,s,i)*f%i,m=ye(p,s,i)*f%i,g=ye(m,e,i)*l%i;return{pow_p_5_8:ye(g,Td,i)*r%i,b2:a}}function V0(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const Id=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function $7(r,e){const t=Yi.p,n=be(e*e*e,t),s=be(n*n*e,t),i=q0(r*s).pow_p_5_8;let o=be(r*n*i,t);const a=be(e*o*o,t),c=o,u=be(o*Id,t),l=a===r,d=a===be(-r,t),h=a===be(-r*Id,t);return l&&(o=c),(d||h)&&(o=u),y7(o,t)&&(o=be(-o,t)),{isValid:l||d,value:o}}const q7=Bs(Yi.p,void 0,!0),V7={...Yi,Fp:q7,hash:C0,adjustScalarBytes:V0,uvRatio:$7},da=L7(V7),mo=(()=>{const r=Yi.p;return B7({P:r,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:n}=q0(e);return be(ye(t,O7,r)*n,r)},adjustScalarBytes:V0})})();class Pd extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class Rd extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class z7 extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const mt={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new z7("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}},ha=32,Bt=64,Wl=32;let jn;const z0=(async()=>{try{return await mt.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function H7(){const r=da.utils.randomPrivateKey(),e=da.getPublicKey(r);return{privateKey:X7(r,e),publicKey:e}}async function K7(r,e){let t;r.length===Bt?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:F(r.subarray(32),"base64url"),d:F(t,"base64url"),ext:!0,key_ops:["sign"]},s=await mt.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await mt.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function W7(r,e){const t=r.subarray(0,Wl);return da.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function G7(r,e){return jn==null&&(jn=await z0),jn?K7(r,e):W7(r,e)}async function j7(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await mt.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await mt.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function Q7(r,e,t){return da.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function Y7(r,e,t){return jn==null&&(jn=await z0),jn?j7(r,e,t):Q7(r,e,t)}function X7(r,e){const t=new Uint8Array(Bt);for(let n=0;n<Wl;n++)t[n]=r[n],t[Wl+n]=e[n];return t}function hc(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class H0{type="Ed25519";raw;constructor(e){this.raw=ki(e,ha)}toMultihash(){return Wi.digest(Ft(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return Ae.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=Y7(this.raw,t,e);return hc(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}}class Gl{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=ki(e,Bt),this.publicKey=new H0(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=G7(this.raw,e);return hc(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}}function K0(r){if(r.length>Bt){r=ki(r,Bt+ha);const n=r.subarray(0,Bt),s=r.subarray(Bt,r.length);return new Gl(n,s)}r=ki(r,Bt);const e=r.subarray(0,Bt),t=r.subarray(ha);return new Gl(e,t)}function W0(r){return r=ki(r,ha),new H0(r)}async function Z7(){const{privateKey:r,publicKey:e}=H7();return new Gl(r,e)}function ki(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new L(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const J7=Math.pow(2,7),eg=Math.pow(2,14),tg=Math.pow(2,21),Ju=Math.pow(2,28),e1=Math.pow(2,35),t1=Math.pow(2,42),r1=Math.pow(2,49),re=128,Fe=127;function Ve(r){if(r<J7)return 1;if(r<eg)return 2;if(r<tg)return 3;if(r<Ju)return 4;if(r<e1)return 5;if(r<t1)return 6;if(r<r1)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function fa(r,e,t=0){switch(Ve(r)){case 8:e[t++]=r&255|re,r/=128;case 7:e[t++]=r&255|re,r/=128;case 6:e[t++]=r&255|re,r/=128;case 5:e[t++]=r&255|re,r/=128;case 4:e[t++]=r&255|re,r>>>=7;case 3:e[t++]=r&255|re,r>>>=7;case 2:e[t++]=r&255|re,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function rg(r,e,t=0){switch(Ve(r)){case 8:e.set(t++,r&255|re),r/=128;case 7:e.set(t++,r&255|re),r/=128;case 6:e.set(t++,r&255|re),r/=128;case 5:e.set(t++,r&255|re),r/=128;case 4:e.set(t++,r&255|re),r>>>=7;case 3:e.set(t++,r&255|re),r>>>=7;case 2:e.set(t++,r&255|re),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function G0(r,e){let t=r[e],n=0;if(n+=t&Fe,t<re||(t=r[e+1],n+=(t&Fe)<<7,t<re)||(t=r[e+2],n+=(t&Fe)<<14,t<re)||(t=r[e+3],n+=(t&Fe)<<21,t<re)||(t=r[e+4],n+=(t&Fe)*Ju,t<re)||(t=r[e+5],n+=(t&Fe)*e1,t<re)||(t=r[e+6],n+=(t&Fe)*t1,t<re)||(t=r[e+7],n+=(t&Fe)*r1,t<re))return n;throw new RangeError("Could not decode varint")}function ng(r,e){let t=r.get(e),n=0;if(n+=t&Fe,t<re||(t=r.get(e+1),n+=(t&Fe)<<7,t<re)||(t=r.get(e+2),n+=(t&Fe)<<14,t<re)||(t=r.get(e+3),n+=(t&Fe)<<21,t<re)||(t=r.get(e+4),n+=(t&Fe)*Ju,t<re)||(t=r.get(e+5),n+=(t&Fe)*e1,t<re)||(t=r.get(e+6),n+=(t&Fe)*t1,t<re)||(t=r.get(e+7),n+=(t&Fe)*r1,t<re))return n;throw new RangeError("Could not decode varint")}function rn(r,e,t=0){return e==null&&(e=At(Ve(r))),e instanceof Uint8Array?fa(r,e,t):rg(r,e,t)}function Xi(r,e=0){return r instanceof Uint8Array?G0(r,e):ng(r,e)}const n1=new Float32Array([-0]),Sr=new Uint8Array(n1.buffer);function sg(r,e,t){n1[0]=r,e[t]=Sr[0],e[t+1]=Sr[1],e[t+2]=Sr[2],e[t+3]=Sr[3]}function ig(r,e){return Sr[0]=r[e],Sr[1]=r[e+1],Sr[2]=r[e+2],Sr[3]=r[e+3],n1[0]}const s1=new Float64Array([-0]),Ue=new Uint8Array(s1.buffer);function og(r,e,t){s1[0]=r,e[t]=Ue[0],e[t+1]=Ue[1],e[t+2]=Ue[2],e[t+3]=Ue[3],e[t+4]=Ue[4],e[t+5]=Ue[5],e[t+6]=Ue[6],e[t+7]=Ue[7]}function ag(r,e){return Ue[0]=r[e],Ue[1]=r[e+1],Ue[2]=r[e+2],Ue[3]=r[e+3],Ue[4]=r[e+4],Ue[5]=r[e+5],Ue[6]=r[e+6],Ue[7]=r[e+7],s1[0]}const cg=BigInt(Number.MAX_SAFE_INTEGER),lg=BigInt(Number.MIN_SAFE_INTEGER);class $e{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return nn;if(e<cg&&e>lg)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>Dd&&(s=0n,++n>Dd&&(n=0n))),new $e(Number(s),Number(n))}static fromNumber(e){if(e===0)return nn;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new $e(n,s)}static from(e){return typeof e=="number"?$e.fromNumber(e):typeof e=="bigint"?$e.fromBigInt(e):typeof e=="string"?$e.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new $e(e.low>>>0,e.high>>>0):nn}}const nn=new $e(0,0);nn.toBigInt=function(){return 0n};nn.zzEncode=nn.zzDecode=function(){return this};nn.length=function(){return 1};const Dd=4294967296n;function ug(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function dg(r,e,t){if(t-e<1)return"";let s;const i=[];let o=0,a;for(;e<t;)a=r[e++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function j0(r,e,t){const n=t;let s,i;for(let o=0;o<r.length;++o)s=r.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=r.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function bt(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function yo(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class hg{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,bt(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw bt(this,4);return yo(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw bt(this,4);return yo(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw bt(this,4);const e=ig(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw bt(this,4);const e=ag(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw bt(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return dg(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw bt(this,e);this.pos+=e}else do if(this.pos>=this.len)throw bt(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new $e(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw bt(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw bt(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw bt(this,8);const e=yo(this.buf,this.pos+=4),t=yo(this.buf,this.pos+=4);return new $e(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=G0(this.buf,this.pos);return this.pos+=Ve(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function fg(r){return new hg(r instanceof Uint8Array?r:r.subarray())}function ce(r,e,t){const n=fg(r);return e.decode(n,void 0,t)}function pg(r){let n,s=8192;return function(o){if(o<1||o>4096)return At(o);s+o>8192&&(n=At(8192),s=0);const a=n.subarray(s,s+=o);return(s&7)!==0&&(s=(s|7)+1),a}}class ri{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function $c(){}class gg{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const mg=pg();function yg(r){return globalThis.Buffer!=null?At(r):mg(r)}class jl{len;head;tail;states;constructor(){this.len=0,this.head=new ri($c,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new ri(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new bg((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(wo,10,$e.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=$e.fromBigInt(e);return this._push(wo,t.length(),t)}uint64Number(e){return this._push(fa,Ve(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=$e.fromBigInt(e).zzEncode();return this._push(wo,t.length(),t)}sint64Number(e){const t=$e.fromNumber(e).zzEncode();return this._push(wo,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(qc,1,e?1:0)}fixed32(e){return this._push(Qs,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=$e.fromBigInt(e);return this._push(Qs,4,t.lo)._push(Qs,4,t.hi)}fixed64Number(e){const t=$e.fromNumber(e);return this._push(Qs,4,t.lo)._push(Qs,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(sg,4,e)}double(e){return this._push(og,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(qc,1,0):this.uint32(t)._push(vg,t,e)}string(e){const t=ug(e);return t!==0?this.uint32(t)._push(j0,t,e):this._push(qc,1,0)}fork(){return this.states=new gg(this),this.head=this.tail=new ri($c,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new ri($c,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=yg(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function qc(r,e,t){e[t]=r&255}function wg(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class bg extends ri{next;constructor(e,t){super(wg,e,t),this.next=void 0}}function wo(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Qs(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function vg(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(jl.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(Eg,e,r),this},jl.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(Sg,e,r),this});function Eg(r,e,t){e.set(r,t)}function Sg(r,e,t){r.length<40?j0(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(q(r),t)}function _g(){return new jl}function le(r,e){const t=_g();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var pa;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(pa||(pa={}));function Q0(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function ar(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const a=e(i);o.int32(a)},n=function(i){const o=i.int32();return e(o)};return Q0("enum",pa.VARINT,t,n)}function ue(r,e){return Q0("message",pa.LENGTH_DELIMITED,r,e)}class ut extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class Ld extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var Ee;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Ee||(Ee={}));var Ql;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Ql||(Ql={}));(function(r){r.codec=()=>ar(Ql)})(Ee||(Ee={}));var ln;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Ee.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Ee.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(ln||(ln={}));var ga;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Ee.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Ee.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(ga||(ga={}));function un(r){if(isNaN(r)||r<=0)throw new L("random bytes length must be a Number bigger than 0");return lc(r)}const Qn=A0;class Y0{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Z0(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return se.createV1(114,this._multihash)}toString(){return Ae.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return Og(this.jwk,t,e,n)}}class xg{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Ig(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return Mg(this.jwk,e,t)}}const Ag=8192,X0=18,Cg=1062,kg=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function Tg(r){return{n:F(r[1],"base64url"),e:F(r[2],"base64url"),d:F(r[3],"base64url"),p:F(r[4],"base64url"),q:F(r[5],"base64url"),dp:F(r[6],"base64url"),dq:F(r[7],"base64url"),qi:F(r[8],"base64url"),kty:"RSA"}}function Ig(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new L("JWK was missing components");return Jt([ot(Uint8Array.from([0])),ot(q(r.n,"base64url")),ot(q(r.e,"base64url")),ot(q(r.d,"base64url")),ot(q(r.p,"base64url")),ot(q(r.q,"base64url")),ot(q(r.dp,"base64url")),ot(q(r.dq,"base64url")),ot(q(r.qi,"base64url"))]).subarray()}function Pg(r){const e=bn(r[1],{offset:0});return{kty:"RSA",n:F(e[0],"base64url"),e:F(e[1],"base64url")}}function Z0(r){if(r.n==null||r.e==null)throw new L("JWK was missing components");return Jt([kg,Wu(Jt([ot(q(r.n,"base64url")),ot(q(r.e,"base64url"))]))]).subarray()}function Rg(r){const e=bn(r);return J0(e)}function J0(r){const e=Tg(r);return Ng(e)}function Dg(r,e){if(r.byteLength>=Cg)throw new sa("Key size is too large");const t=bn(r,{offset:0});return Lg(t,r,e)}function Lg(r,e,t){const n=Pg(r);if(t==null){const s=Qn(ln.encode({Type:Ee.RSA,Data:e}));t=ss(X0,s)}return new Y0(n,t)}function Ng(r){if(Fg(r)>Ag)throw new L("Key size is too large");const e=Bg(r),t=Qn(ln.encode({Type:Ee.RSA,Data:Z0(e.publicKey)})),n=ss(X0,t);return new xg(e.privateKey,new Y0(e.publicKey,n))}function Bg(r){if(r==null)throw new L("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}async function Mg(r,e,t){const n=await mt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();const s=await mt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function Og(r,e,t,n){const s=await mt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await mt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}function Fg(r){if(r.kty!=="RSA")throw new L("invalid key type");if(r.n==null)throw new L("invalid key modulus");return q(r.n,"base64url").length*8}class ef extends E0{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,cc(e);const n=Ci(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(n.length>s?e.create().update(n).digest():n);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=e.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),Vt(i)}update(e){return la(this),this.iHash.update(e),this}digestInto(e){la(this),Ct(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Zi=(r,e,t)=>new ef(r,e).update(t).digest();Zi.create=(r,e)=>new ef(r,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Nd(r){r.lowS!==void 0&&an("lowS",r.lowS),r.prehash!==void 0&&an("prehash",r.prehash)}class Ug extends Error{constructor(e=""){super(e)}}const Yt={Err:Ug,_tlv:{encode:(r,e)=>{const{Err:t}=Yt;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=po(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?po(s.length/2|128):"";return po(r)+i+s+e},decode(r,e){const{Err:t}=Yt;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const u=e.subarray(n,n+c);if(u.length!==c)throw new t("tlv.decode: length bytes not complete");if(u[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const l of u)o=o<<8|l;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=Yt;if(r<gi)throw new e("integer: negative integers are not allowed");let t=po(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=Yt;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return uc(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=Yt,s=we("signature",r),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:u,l}=n.decode(2,c);if(l.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(u)}},hexFromSig(r){const{_tlv:e,_int:t}=Yt,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},gi=BigInt(0),mi=BigInt(1),$g=BigInt(2),bo=BigInt(3),qg=BigInt(4);function Vg(r,e,t){function n(s){const i=r.sqr(s),o=r.mul(i,s);return r.add(r.add(o,r.mul(s,e)),t)}return n}function tf(r,e,t){const{BYTES:n}=r;function s(i){let o;if(typeof i=="bigint")o=i;else{let a=we("private key",i);if(e){if(!e.includes(a.length*2))throw new Error("invalid private key");const c=new Uint8Array(n);c.set(a,c.length-a.length),a=c}try{o=r.fromBytes(a)}catch{throw new Error(`invalid private key: expected ui8a of size ${n}, got ${typeof i}`)}}if(t&&(o=r.create(o)),!r.isValidNot0(o))throw new Error("invalid private key: out of range [1..N-1]");return o}return s}function zg(r,e={}){const{Fp:t,Fn:n}=$0("weierstrass",r,e),{h:s,n:i}=r;Ns(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:o}=e;if(o&&(!t.is0(r.a)||typeof o.beta!="bigint"||typeof o.splitScalar!="function"))throw new Error('invalid endo: expected "beta": bigint and "splitScalar": function');function a(){if(!t.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(T,v,A){const{x:S,y:C}=v.toAffine(),I=t.toBytes(S);if(an("isCompressed",A),A){a();const P=!t.isOdd(C);return Xt(rf(P),I)}else return Xt(Uint8Array.of(4),I,t.toBytes(C))}function u(T){Ct(T);const v=t.BYTES,A=v+1,S=2*v+1,C=T.length,I=T[0],P=T.subarray(1);if(C===A&&(I===2||I===3)){const R=t.fromBytes(P);if(!t.isValid(R))throw new Error("bad point: is not on curve, wrong x");const D=h(R);let N;try{N=t.sqrt(D)}catch(z){const U=z instanceof Error?": "+z.message:"";throw new Error("bad point: is not on curve, sqrt error"+U)}a();const M=t.isOdd(N);return(I&1)===1!==M&&(N=t.neg(N)),{x:R,y:N}}else if(C===S&&I===4){const R=t.fromBytes(P.subarray(v*0,v*1)),D=t.fromBytes(P.subarray(v*1,v*2));if(!f(R,D))throw new Error("bad point: is not on curve");return{x:R,y:D}}else throw new Error(`bad point: got length ${C}, expected compressed=${A} or uncompressed=${S}`)}const l=e.toBytes||c,d=e.fromBytes||u,h=Vg(t,r.a,r.b);function f(T,v){const A=t.sqr(v),S=h(T);return t.eql(A,S)}if(!f(r.Gx,r.Gy))throw new Error("bad curve params: generator point");const p=t.mul(t.pow(r.a,bo),qg),m=t.mul(t.sqr(r.b),BigInt(27));if(t.is0(t.add(p,m)))throw new Error("bad curve params: a or b");function g(T,v,A=!1){if(!t.isValid(v)||A&&t.is0(v))throw new Error(`bad point coordinate ${T}`);return v}function y(T){if(!(T instanceof w))throw new Error("ProjectivePoint expected")}const E=ua((T,v)=>{const{px:A,py:S,pz:C}=T;if(t.eql(C,t.ONE))return{x:A,y:S};const I=T.is0();v==null&&(v=I?t.ONE:t.inv(C));const P=t.mul(A,v),R=t.mul(S,v),D=t.mul(C,v);if(I)return{x:t.ZERO,y:t.ZERO};if(!t.eql(D,t.ONE))throw new Error("invZ was invalid");return{x:P,y:R}}),b=ua(T=>{if(T.is0()){if(e.allowInfinityPoint&&!t.is0(T.py))return;throw new Error("bad point: ZERO")}const{x:v,y:A}=T.toAffine();if(!t.isValid(v)||!t.isValid(A))throw new Error("bad point: x or y not field elements");if(!f(v,A))throw new Error("bad point: equation left != right");if(!T.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function _(T,v,A,S,C){return A=new w(t.mul(A.px,T),A.py,A.pz),v=pi(S,v),A=pi(C,A),v.add(A)}class w{constructor(v,A,S){this.px=g("x",v),this.py=g("y",A,!0),this.pz=g("z",S),Object.freeze(this)}static fromAffine(v){const{x:A,y:S}=v||{};if(!v||!t.isValid(A)||!t.isValid(S))throw new Error("invalid affine point");if(v instanceof w)throw new Error("projective point not allowed");return t.is0(A)&&t.is0(S)?w.ZERO:new w(A,S,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(v){return B0(w,"pz",v)}static fromBytes(v){return Ct(v),w.fromHex(v)}static fromHex(v){const A=w.fromAffine(d(we("pointHex",v)));return A.assertValidity(),A}static fromPrivateKey(v){const A=tf(n,e.allowedPrivateKeyLengths,e.wrapPrivateKey);return w.BASE.multiply(A(v))}static msm(v,A){return U0(w,n,v,A)}precompute(v=8,A=!0){return x.setWindowSize(this,v),A||this.multiply(bo),this}_setWindowSize(v){this.precompute(v)}assertValidity(){b(this)}hasEvenY(){const{y:v}=this.toAffine();if(!t.isOdd)throw new Error("Field doesn't support isOdd");return!t.isOdd(v)}equals(v){y(v);const{px:A,py:S,pz:C}=this,{px:I,py:P,pz:R}=v,D=t.eql(t.mul(A,R),t.mul(I,C)),N=t.eql(t.mul(S,R),t.mul(P,C));return D&&N}negate(){return new w(this.px,t.neg(this.py),this.pz)}double(){const{a:v,b:A}=r,S=t.mul(A,bo),{px:C,py:I,pz:P}=this;let R=t.ZERO,D=t.ZERO,N=t.ZERO,M=t.mul(C,C),B=t.mul(I,I),z=t.mul(P,P),U=t.mul(C,I);return U=t.add(U,U),N=t.mul(C,P),N=t.add(N,N),R=t.mul(v,N),D=t.mul(S,z),D=t.add(R,D),R=t.sub(B,D),D=t.add(B,D),D=t.mul(R,D),R=t.mul(U,R),N=t.mul(S,N),z=t.mul(v,z),U=t.sub(M,z),U=t.mul(v,U),U=t.add(U,N),N=t.add(M,M),M=t.add(N,M),M=t.add(M,z),M=t.mul(M,U),D=t.add(D,M),z=t.mul(I,P),z=t.add(z,z),M=t.mul(z,U),R=t.sub(R,M),N=t.mul(z,B),N=t.add(N,N),N=t.add(N,N),new w(R,D,N)}add(v){y(v);const{px:A,py:S,pz:C}=this,{px:I,py:P,pz:R}=v;let D=t.ZERO,N=t.ZERO,M=t.ZERO;const B=r.a,z=t.mul(r.b,bo);let U=t.mul(A,I),K=t.mul(S,P),Z=t.mul(C,R),de=t.add(A,S),j=t.add(I,P);de=t.mul(de,j),j=t.add(U,K),de=t.sub(de,j),j=t.add(A,C);let ge=t.add(I,R);return j=t.mul(j,ge),ge=t.add(U,Z),j=t.sub(j,ge),ge=t.add(S,C),D=t.add(P,R),ge=t.mul(ge,D),D=t.add(K,Z),ge=t.sub(ge,D),M=t.mul(B,j),D=t.mul(z,Z),M=t.add(D,M),D=t.sub(K,M),M=t.add(K,M),N=t.mul(D,M),K=t.add(U,U),K=t.add(K,U),Z=t.mul(B,Z),j=t.mul(z,j),K=t.add(K,Z),Z=t.sub(U,Z),Z=t.mul(B,Z),j=t.add(j,Z),U=t.mul(K,j),N=t.add(N,U),U=t.mul(ge,j),D=t.mul(de,D),D=t.sub(D,U),U=t.mul(de,K),M=t.mul(ge,M),M=t.add(M,U),new w(D,N,M)}subtract(v){return this.add(v.negate())}is0(){return this.equals(w.ZERO)}multiply(v){const{endo:A}=e;if(!n.isValidNot0(v))throw new Error("invalid scalar: out of range");let S,C;const I=P=>x.wNAFCached(this,P,w.normalizeZ);if(A){const{k1neg:P,k1:R,k2neg:D,k2:N}=A.splitScalar(v),{p:M,f:B}=I(R),{p:z,f:U}=I(N);C=B.add(U),S=_(A.beta,M,z,P,D)}else{const{p:P,f:R}=I(v);S=P,C=R}return w.normalizeZ([S,C])[0]}multiplyUnsafe(v){const{endo:A}=e,S=this;if(!n.isValid(v))throw new Error("invalid scalar: out of range");if(v===gi||S.is0())return w.ZERO;if(v===mi)return S;if(x.hasPrecomputes(this))return this.multiply(v);if(A){const{k1neg:C,k1:I,k2neg:P,k2:R}=A.splitScalar(v),{p1:D,p2:N}=A7(w,S,I,R);return _(A.beta,D,N,C,P)}else return x.wNAFCachedUnsafe(S,v)}multiplyAndAddUnsafe(v,A,S){const C=this.multiplyUnsafe(A).add(v.multiplyUnsafe(S));return C.is0()?void 0:C}toAffine(v){return E(this,v)}isTorsionFree(){const{isTorsionFree:v}=e;return s===mi?!0:v?v(w,this):x.wNAFCachedUnsafe(this,i).is0()}clearCofactor(){const{clearCofactor:v}=e;return s===mi?this:v?v(w,this):this.multiplyUnsafe(s)}toBytes(v=!0){return an("isCompressed",v),this.assertValidity(),l(w,this,v)}toRawBytes(v=!0){return this.toBytes(v)}toHex(v=!0){return is(this.toBytes(v))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}w.BASE=new w(r.Gx,r.Gy,t.ONE),w.ZERO=new w(t.ZERO,t.ONE,t.ZERO),w.Fp=t,w.Fn=n;const k=n.BITS,x=F0(w,e.endo?Math.ceil(k/2):k);return w}function rf(r){return Uint8Array.of(r?2:3)}function Hg(r,e,t={}){Ns(e,{hash:"function"},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=e.randomBytes||lc,s=e.hmac||((S,...C)=>Zi(e.hash,S,Xt(...C))),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o;function u(S){const C=a>>mi;return S>C}function l(S){return u(S)?o.neg(S):S}function d(S,C){if(!o.isValidNot0(C))throw new Error(`invalid signature ${S}: out of range 1..CURVE.n`)}class h{constructor(C,I,P){d("r",C),d("s",I),this.r=C,this.s=I,P!=null&&(this.recovery=P),Object.freeze(this)}static fromCompact(C){const I=o.BYTES,P=we("compactSignature",C,I*2);return new h(o.fromBytes(P.subarray(0,I)),o.fromBytes(P.subarray(I,I*2)))}static fromDER(C){const{r:I,s:P}=Yt.toSig(we("DER",C));return new h(I,P)}assertValidity(){}addRecoveryBit(C){return new h(this.r,this.s,C)}recoverPublicKey(C){const I=i.ORDER,{r:P,s:R,recovery:D}=this;if(D==null||![0,1,2,3].includes(D))throw new Error("recovery id invalid");if(a*$g<I&&D>1)throw new Error("recovery id is ambiguous for h>1 curve");const M=D===2||D===3?P+a:P;if(!i.isValid(M))throw new Error("recovery id 2 or 3 invalid");const B=i.toBytes(M),z=r.fromHex(Xt(rf((D&1)===0),B)),U=o.inv(M),K=b(we("msgHash",C)),Z=o.create(-K*U),de=o.create(R*U),j=r.BASE.multiplyUnsafe(Z).add(z.multiplyUnsafe(de));if(j.is0())throw new Error("point at infinify");return j.assertValidity(),j}hasHighS(){return u(this.s)}normalizeS(){return this.hasHighS()?new h(this.r,o.neg(this.s),this.recovery):this}toBytes(C){if(C==="compact")return Xt(o.toBytes(this.r),o.toBytes(this.s));if(C==="der")return ju(Yt.hexFromSig(this));throw new Error("invalid format")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return is(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return is(this.toBytes("compact"))}}const f=tf(o,t.allowedPrivateKeyLengths,t.wrapPrivateKey),p={isValidPrivateKey(S){try{return f(S),!0}catch{return!1}},normPrivateKeyToScalar:f,randomPrivateKey:()=>{const S=a;return S7(n(N0(S)),S)},precompute(S=8,C=r.BASE){return C.precompute(S,!1)}};function m(S,C=!0){return r.fromPrivateKey(S).toBytes(C)}function g(S){if(typeof S=="bigint")return!1;if(S instanceof r)return!0;const I=we("key",S).length,P=i.BYTES,R=P+1,D=2*P+1;if(!(t.allowedPrivateKeyLengths||o.BYTES===R))return I===R||I===D}function y(S,C,I=!0){if(g(S)===!0)throw new Error("first arg must be private key");if(g(C)===!1)throw new Error("second arg must be public key");return r.fromHex(C).multiply(f(S)).toBytes(I)}const E=e.bits2int||function(S){if(S.length>8192)throw new Error("input is too large");const C=uc(S),I=S.length*8-c;return I>0?C>>BigInt(I):C},b=e.bits2int_modN||function(S){return o.create(E(S))},_=dc(c);function w(S){return Er("num < 2^"+c,S,gi,_),o.toBytes(S)}function k(S,C,I=x){if(["recovered","canonical"].some(de=>de in I))throw new Error("sign() legacy options not supported");const{hash:P}=e;let{lowS:R,prehash:D,extraEntropy:N}=I;R==null&&(R=!0),S=we("msgHash",S),Nd(I),D&&(S=we("prehashed msgHash",P(S)));const M=b(S),B=f(C),z=[w(B),w(M)];if(N!=null&&N!==!1){const de=N===!0?n(i.BYTES):N;z.push(we("extraEntropy",de))}const U=Xt(...z),K=M;function Z(de){const j=E(de);if(!o.isValidNot0(j))return;const ge=o.inv(j),Ye=r.BASE.multiply(j).toAffine(),Be=o.create(Ye.x);if(Be===gi)return;const Ie=o.create(ge*o.create(K+Be*B));if(Ie===gi)return;let Cn=(Ye.x===Be?0:2)|Number(Ye.y&mi),Kt=Ie;return R&&u(Ie)&&(Kt=l(Ie),Cn^=1),new h(Be,Kt,Cn)}return{seed:U,k2sig:Z}}const x={lowS:e.lowS,prehash:!1},T={lowS:e.lowS,prehash:!1};function v(S,C,I=x){const{seed:P,k2sig:R}=k(S,C,I);return h7(e.hash.outputLen,o.BYTES,s)(P,R)}r.BASE.precompute(8);function A(S,C,I,P=T){const R=S;C=we("msgHash",C),I=we("publicKey",I),Nd(P);const{lowS:D,prehash:N,format:M}=P;if("strict"in P)throw new Error("options.strict was renamed to lowS");if(M!==void 0&&!["compact","der","js"].includes(M))throw new Error('format must be "compact", "der" or "js"');const B=typeof R=="string"||Gu(R),z=!B&&!M&&typeof R=="object"&&R!==null&&typeof R.r=="bigint"&&typeof R.s=="bigint";if(!B&&!z)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let U,K;try{if(z)if(M===void 0||M==="js")U=new h(R.r,R.s);else throw new Error("invalid format");if(B){try{M!=="compact"&&(U=h.fromDER(R))}catch(Kt){if(!(Kt instanceof Yt.Err))throw Kt}!U&&M!=="der"&&(U=h.fromCompact(R))}K=r.fromHex(I)}catch{return!1}if(!U||D&&U.hasHighS())return!1;N&&(C=e.hash(C));const{r:Z,s:de}=U,j=b(C),ge=o.inv(de),Ye=o.create(j*ge),Be=o.create(Z*ge),Ie=r.BASE.multiplyUnsafe(Ye).add(K.multiplyUnsafe(Be));return Ie.is0()?!1:o.create(Ie.x)===Z}return Object.freeze({getPublicKey:m,getSharedSecret:y,sign:v,verify:A,utils:p,Point:r,Signature:h})}function Kg(r){const e={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=Bs(e.n,r.nBitLength),s={Fp:t,Fn:n,allowedPrivateKeyLengths:r.allowedPrivateKeyLengths,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,wrapPrivateKey:r.wrapPrivateKey,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:e,curveOpts:s}}function Wg(r){const{CURVE:e,curveOpts:t}=Kg(r),n={hash:r.hash,hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:e,curveOpts:t,ecdsaOpts:n}}function Gg(r,e){return Object.assign({},e,{ProjectivePoint:e.Point,CURVE:r})}function jg(r){const{CURVE:e,curveOpts:t,ecdsaOpts:n}=Wg(r),s=zg(e,t),i=Hg(s,n,t);return Gg(r,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Qg(r,e){const t=n=>jg({...r,hash:n});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ma={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")};BigInt(0);const Yg=BigInt(1),Yl=BigInt(2),Bd=(r,e)=>(r+e/Yl)/e;function Xg(r){const e=ma.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),u=r*r*r%e,l=u*u*r%e,d=ye(l,t,e)*l%e,h=ye(d,t,e)*l%e,f=ye(h,Yl,e)*u%e,p=ye(f,s,e)*f%e,m=ye(p,i,e)*p%e,g=ye(m,a,e)*m%e,y=ye(g,c,e)*g%e,E=ye(y,a,e)*m%e,b=ye(E,t,e)*l%e,_=ye(b,o,e)*p%e,w=ye(_,n,e)*u%e,k=ye(w,Yl,e);if(!Xl.eql(Xl.sqr(k),r))throw new Error("Cannot find square root");return k}const Xl=Bs(ma.p,void 0,void 0,{sqrt:Xg}),Dr=Qg({...ma,Fp:Xl,lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{const e=ma.n,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-Yg*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=t,o=BigInt("0x100000000000000000000000000000000"),a=Bd(i*r,e),c=Bd(-n*r,e);let u=be(r-a*t-c*s,e),l=be(-a*n-c*i,e);const d=u>o,h=l>o;if(d&&(u=e-u),h&&(l=e-l),u>o||l>o)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:d,k1:u,k2neg:h,k2:l}}}},A0),Zg=32;function Jg(r,e,t){const n=Ls.digest(e instanceof Uint8Array?e:e.subarray());if(hc(n))return n.then(({digest:s})=>(t?.signal?.throwIfAborted(),Dr.sign(s,r).toDERRawBytes())).catch(s=>{throw s.name==="AbortError"?s:new Pd(String(s))});try{return Dr.sign(n.digest,r).toDERRawBytes()}catch(s){throw new Pd(String(s))}}function e9(r,e,t,n){const s=Ls.digest(t instanceof Uint8Array?t:t.subarray());if(hc(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),Dr.verify(e,i,r))).catch(i=>{throw i.name==="AbortError"?i:new Rd(String(i))});try{return n?.signal?.throwIfAborted(),Dr.verify(e,s.digest,r)}catch(i){throw new Rd(String(i))}}class nf{type="secp256k1";raw;_key;constructor(e){this._key=s9(e),this.raw=r9(this._key)}toMultihash(){return Wi.digest(Ft(this))}toCID(){return se.createV1(114,this.toMultihash())}toString(){return Ae.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return e9(this._key,t,e,n)}}class t9{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=n9(e),this.publicKey=new nf(t??i9(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return Jg(this.raw,e,t)}}function sf(r){return new t9(r)}function of(r){return new nf(r)}function r9(r){return Dr.ProjectivePoint.fromHex(r).toRawBytes(!0)}function n9(r){try{return Dr.getPublicKey(r,!0),r}catch(e){throw new J2(String(e))}}function s9(r){try{return Dr.ProjectivePoint.fromHex(r),r}catch(e){throw new sa(String(e))}}function i9(r){try{return Dr.getPublicKey(r,!0)}catch(e){throw new J2(String(e))}}async function o9(r,e){return Z7()}function zt(r,e){const{Type:t,Data:n}=ln.decode(r),s=n??new Uint8Array;switch(t){case Ee.RSA:return Dg(s,e);case Ee.Ed25519:return W0(s);case Ee.secp256k1:return of(s);case Ee.ECDSA:return y0(s);default:throw new Hi}}function a9(r){const{Type:e,Data:t}=ln.decode(r.digest),n=t??new Uint8Array;switch(e){case Ee.Ed25519:return W0(n);case Ee.secp256k1:return of(n);case Ee.ECDSA:return y0(n);default:throw new Hi}}function Ft(r){return ln.encode({Type:Ee[r.type],Data:r.raw})}function c9(r){const e=ga.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Ee.RSA:return Rg(t);case Ee.Ed25519:return K0(t);case Ee.secp256k1:return sf(t);case Ee.ECDSA:return qp(t);default:throw new Hi}}function l9(r){if(r.byteLength===Bt)return K0(r);if(r.byteLength===Zg)return sf(r);const e=bn(r),t=e[2]?.[0];if(t===Lp||t===Np||t===Bp)return m0(e);if(e.length>8)return J0(e);throw new L("Could not extract private key from raw bytes")}function Ji(r){return ga.encode({Type:Ee[r.type],Data:r.raw})}const af=Symbol.for("nodejs.util.inspect.custom"),u9=114;class i1{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Uu]=!0;toString(){return this.string==null&&(this.string=Ae.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return se.createV1(u9,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[af](){return`PeerId(${this.toString()})`}}class cf extends i1{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class lf extends i1{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class uf extends i1{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const d9=2336;class df{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Wi.digest(q(this.url))}[af](){return`PeerId(${this.url})`}[Uu]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return se.createV1(d9,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=F(e)),e.toString()===this.toString())}}const h9=114,Md=2336;function yt(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=Tt(Ae.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return eo(se.parse(r));throw new L('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return Ht(t)}function as(r){if(r.type==="Ed25519")return new lf({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new uf({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new cf({multihash:r.toCID().multihash,publicKey:r});throw new Hi}function f9(r){return as(r.publicKey)}function Ht(r){if(g9(r))return new cf({multihash:r});if(p9(r))try{const e=a9(r);if(e.type==="Ed25519")return new lf({multihash:r,publicKey:e});if(e.type==="secp256k1")return new uf({multihash:r,publicKey:e})}catch{const t=F(r.digest);return new df(new URL(t))}throw new t8("Supplied PeerID Multihash is invalid")}function eo(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==h9&&r.code!==Md)throw new e8("Supplied PeerID CID is invalid");if(r.code===Md){const e=F(r.multihash.digest);return new df(new URL(e))}return Ht(r.multihash)}function p9(r){return r.code===Wi.code}function g9(r){return r.code===Ls.code}const m9=8,o1=1024*1024*4;let y9=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},hf=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},w9=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Od=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function ff(r){return r[Symbol.asyncIterator]!=null}function pf(r,e){if(r.byteLength>e)throw new hf("Message length too long")}const fc=r=>{const e=Ve(r),t=At(e);return rn(r,t),fc.bytes=e,t};fc.bytes=0;function ya(r,e){e=e??{};const t=e.lengthEncoder??fc,n=e?.maxDataLength??o1;function*s(i){pf(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return ff(r)?async function*(){for await(const i of r)yield*s(i)}():function*(){for(const i of r)yield*s(i)}()}ya.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??fc,n=e?.maxDataLength??o1;return pf(r,n),new Y(t(r.byteLength),r)};var zr;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(zr||(zr={}));const a1=r=>{const e=Xi(r);return a1.bytes=Ve(e),e};a1.bytes=0;function wa(r,e){const t=new Y;let n=zr.LENGTH,s=-1;const i=e?.lengthDecoder??a1,o=e?.maxLengthLength??m9,a=e?.maxDataLength??o1;function*c(){for(;t.byteLength>0;){if(n===zr.LENGTH)try{if(s=i(t),s<0)throw new y9("Invalid message length");if(s>a)throw new hf("Message length too long");const u=i.bytes;t.consume(u),e?.onLength!=null&&e.onLength(s),n=zr.DATA}catch(u){if(u instanceof RangeError){if(t.byteLength>o)throw new w9("Message length length too long");break}throw u}if(n===zr.DATA){if(t.byteLength<s)break;const u=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(u),yield u,n=zr.LENGTH}}}return ff(r)?async function*(){for await(const u of r)t.append(u),yield*c();if(t.byteLength>0)throw new Od("Unexpected end of input")}():function*(){for(const u of r)t.append(u),yield*c();if(t.byteLength>0)throw new Od("Unexpected end of input")}()}wa.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return wa(n,{...e??{},onLength:i=>{t=i}})};function fe(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}let Fd=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function De(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new Fd(t?.errorMessage,t?.errorCode,t?.errorName));let n;const s=new Fd(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((i,o)=>{n=()=>{o(s)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}class b9{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=fe(),this.haveNext=fe()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=fe(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=fe(),await De(this.readNext.promise,t?.signal,t)}}function gf(){return new b9}class v9 extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}function ba(r,e){const t=gf();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const s=new Y;return{read:async o=>{if(o?.signal?.throwIfAborted(),o?.bytes==null){const{done:c,value:u}=await De(n.next(),o?.signal);return c===!0?null:u}for(;s.byteLength<o.bytes;){const{value:c,done:u}=await De(n.next(),o?.signal);if(u===!0)throw new v9("unexpected end of input");s.append(c)}const a=s.sublist(0,o.bytes);return s.consume(o.bytes),a},write:async(o,a)=>{a?.signal?.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=r.source;r.source=async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*o}()}return r}}}class E9 extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class S9 extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class _9 extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function cs(r,e={}){const t=ba(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ve(e.maxDataLength));const n=e?.lengthDecoder??Xi,s=e?.lengthEncoder??rn;return{read:async o=>{let a=-1;const c=new Y;for(;;){c.append(await t.read({...o,bytes:1}));try{a=n(c)}catch(u){if(u instanceof RangeError)continue;throw u}if(a<0)throw new E9("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new _9("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new S9("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new Y(s(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Y(...o.flatMap(u=>[s(u.byteLength),u]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function Ud(){const r=fe();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function x9(){const r=Ud(),e=Ud();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}class $d{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class Vc{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new $d(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new $d(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let A9=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function cr(r={}){return C9(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function C9(r,e){e=e??{};let t=e.onEnd,n=new Vc,s,i,o,a=fe();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((g,y)=>{i=E=>{i=null,n.push(E);try{g(r(n))}catch(b){y(b)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=fe()})}},u=g=>i!=null?i(g):(n.push(g),s),l=g=>(n=new Vc,i!=null?i({error:g}):(n.push({error:g}),s)),d=g=>{if(o)return s;if(e?.objectMode!==!0&&g?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:g})},h=g=>o?s:(o=!0,g!=null?l(g):u({done:!0})),f=()=>(n=new Vc,h(),{done:!0}),p=g=>(h(g),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:f,throw:p,push:d,end:h,get readableLength(){return n.size},onEmpty:async g=>{const y=g?.signal;if(y?.throwIfAborted(),n.isEmpty())return;let E,b;y!=null&&(E=new Promise((_,w)=>{b=()=>{w(new A9)},y.addEventListener("abort",b)}));try{await Promise.race([a.promise,E])}finally{b!=null&&y!=null&&y?.removeEventListener("abort",b)}}},t==null)return s;const m=s;return s={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(g){return m.throw(g),t!=null&&(t(g),t=void 0),{done:!0}},return(){return m.return(),t!=null&&(t(),t=void 0),{done:!0}},push:d,end(g){return m.end(g),t!=null&&(t(g),t=void 0),s},get readableLength(){return m.readableLength},onEmpty:g=>m.onEmpty(g)},s}function k9(r){return r[Symbol.asyncIterator]!=null}async function T9(r,e,t){try{await Promise.all(r.map(async n=>{for await(const s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*I9(r){const e=new AbortController,t=gf();T9(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*P9(r){for(const e of r)yield*e}function Ti(...r){const e=[];for(const t of r)k9(t)||e.push(t);return e.length===r.length?P9(e):I9(r)}function ls(r,...e){if(r==null)throw new Error("Empty pipeline");if(zc(r)){const n=r;r=()=>n.source}else if(yf(r)||mf(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&zc(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)zc(t[n])&&(t[n]=D9(t[n]));return R9(...t)}const R9=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},mf=r=>r?.[Symbol.asyncIterator]!=null,yf=r=>r?.[Symbol.iterator]!=null,zc=r=>r==null?!1:r.sink!=null&&r.source!=null,D9=r=>e=>{const t=r.sink(e);if(t?.then!=null){const n=cr({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let s;const i=r.source;if(mf(i))s=async function*(){yield*i,n.end()};else if(yf(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Ti(n,s())}return r.source},Ii=65535,qd=Ii-16,to=!!globalThis.process?.env?.DUMP_SESSION_KEYS;/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function wf(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Zl(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function Hc(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Ze(r,...e){if(!wf(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function Vd(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function L9(r,e){Ze(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ir(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function us(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function N9(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}const B9=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function M9(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Jl(r){if(typeof r=="string")r=M9(r);else if(wf(r))r=eu(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function O9(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function F9(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const U9=(r,e)=>{function t(n,...s){if(Ze(n),!B9)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){const l=s[0];if(!l)throw new Error("nonce / iv required");r.varSizeNonce?Ze(l):Ze(l,r.nonceLength)}const i=r.tagLength;i&&s[1]!==void 0&&Ze(s[1]);const o=e(n,...s),a=(l,d)=>{if(d!==void 0){if(l!==2)throw new Error("cipher output not supported");Ze(d)}};let c=!1;return{encrypt(l,d){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Ze(l),a(o.encrypt.length,d),o.encrypt(l,d)},decrypt(l,d){if(Ze(l),i&&l.length<i)throw new Error("invalid ciphertext length: smaller than tagLength="+i);return a(o.decrypt.length,d),o.decrypt(l,d)}}}return Object.assign(t,r),t};function zd(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!q9(e))throw new Error("invalid output, must be aligned");return e}function Hd(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=4,u=0;r.setUint32(e+c,o,n),r.setUint32(e+u,a,n)}function $9(r,e,t){Zl(t);const n=new Uint8Array(16),s=N9(n);return Hd(s,0,BigInt(e),t),Hd(s,8,BigInt(r),t),n}function q9(r){return r.byteOffset%4===0}function eu(r){return Uint8Array.from(r)}const bf=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),V9=bf("expand 16-byte k"),z9=bf("expand 32-byte k"),H9=Ir(V9),K9=Ir(z9);function J(r,e){return r<<e|r>>>32-e}function tu(r){return r.byteOffset%4===0}const vo=64,W9=16,vf=2**32-1,Kd=new Uint32Array;function G9(r,e,t,n,s,i,o,a){const c=s.length,u=new Uint8Array(vo),l=Ir(u),d=tu(s)&&tu(i),h=d?Ir(s):Kd,f=d?Ir(i):Kd;for(let p=0;p<c;o++){if(r(e,t,n,l,o,a),o>=vf)throw new Error("arx: counter overflow");const m=Math.min(vo,c-p);if(d&&m===vo){const g=p/4;if(p%4!==0)throw new Error("arx: invalid block position");for(let y=0,E;y<W9;y++)E=g+y,f[E]=h[E]^l[y];p+=vo;continue}for(let g=0,y;g<m;g++)y=p+g,i[y]=s[y]^u[g];p+=m}}function j9(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:i,rounds:o}=O9({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return Hc(s),Hc(o),Zl(i),Zl(t),(a,c,u,l,d=0)=>{Ze(a),Ze(c),Ze(u);const h=u.length;if(l===void 0&&(l=new Uint8Array(h)),Ze(l),Hc(d),d<0||d>=vf)throw new Error("arx: counter overflow");if(l.length<h)throw new Error(`arx: output (${l.length}) is shorter than data (${h})`);const f=[];let p=a.length,m,g;if(p===32)f.push(m=eu(a)),g=K9;else if(p===16&&t)m=new Uint8Array(32),m.set(a),m.set(a,16),g=H9,f.push(m);else throw new Error(`arx: invalid 32-byte key, got length=${p}`);tu(c)||f.push(c=eu(c));const y=Ir(m);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(g,y,Ir(c.subarray(0,16)),y),c=c.subarray(16)}const E=16-s;if(E!==c.length)throw new Error(`arx: nonce must be ${E} or 16 bytes`);if(E!==12){const _=new Uint8Array(12);_.set(c,i?0:12-c.length),c=_,f.push(c)}const b=Ir(c);return G9(r,g,y,b,u,l,d,o),us(...f),l}}const Pe=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class Q9{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Jl(e),Ze(e,32);const t=Pe(e,0),n=Pe(e,2),s=Pe(e,4),i=Pe(e,6),o=Pe(e,8),a=Pe(e,10),c=Pe(e,12),u=Pe(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|u<<8)&8191,this.r[9]=u>>>5&127;for(let l=0;l<8;l++)this.pad[l]=Pe(e,16+2*l)}process(e,t,n=!1){const s=n?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],u=o[2],l=o[3],d=o[4],h=o[5],f=o[6],p=o[7],m=o[8],g=o[9],y=Pe(e,t+0),E=Pe(e,t+2),b=Pe(e,t+4),_=Pe(e,t+6),w=Pe(e,t+8),k=Pe(e,t+10),x=Pe(e,t+12),T=Pe(e,t+14);let v=i[0]+(y&8191),A=i[1]+((y>>>13|E<<3)&8191),S=i[2]+((E>>>10|b<<6)&8191),C=i[3]+((b>>>7|_<<9)&8191),I=i[4]+((_>>>4|w<<12)&8191),P=i[5]+(w>>>1&8191),R=i[6]+((w>>>14|k<<2)&8191),D=i[7]+((k>>>11|x<<5)&8191),N=i[8]+((x>>>8|T<<8)&8191),M=i[9]+(T>>>5|s),B=0,z=B+v*a+A*(5*g)+S*(5*m)+C*(5*p)+I*(5*f);B=z>>>13,z&=8191,z+=P*(5*h)+R*(5*d)+D*(5*l)+N*(5*u)+M*(5*c),B+=z>>>13,z&=8191;let U=B+v*c+A*a+S*(5*g)+C*(5*m)+I*(5*p);B=U>>>13,U&=8191,U+=P*(5*f)+R*(5*h)+D*(5*d)+N*(5*l)+M*(5*u),B+=U>>>13,U&=8191;let K=B+v*u+A*c+S*a+C*(5*g)+I*(5*m);B=K>>>13,K&=8191,K+=P*(5*p)+R*(5*f)+D*(5*h)+N*(5*d)+M*(5*l),B+=K>>>13,K&=8191;let Z=B+v*l+A*u+S*c+C*a+I*(5*g);B=Z>>>13,Z&=8191,Z+=P*(5*m)+R*(5*p)+D*(5*f)+N*(5*h)+M*(5*d),B+=Z>>>13,Z&=8191;let de=B+v*d+A*l+S*u+C*c+I*a;B=de>>>13,de&=8191,de+=P*(5*g)+R*(5*m)+D*(5*p)+N*(5*f)+M*(5*h),B+=de>>>13,de&=8191;let j=B+v*h+A*d+S*l+C*u+I*c;B=j>>>13,j&=8191,j+=P*a+R*(5*g)+D*(5*m)+N*(5*p)+M*(5*f),B+=j>>>13,j&=8191;let ge=B+v*f+A*h+S*d+C*l+I*u;B=ge>>>13,ge&=8191,ge+=P*c+R*a+D*(5*g)+N*(5*m)+M*(5*p),B+=ge>>>13,ge&=8191;let Ye=B+v*p+A*f+S*h+C*d+I*l;B=Ye>>>13,Ye&=8191,Ye+=P*u+R*c+D*a+N*(5*g)+M*(5*m),B+=Ye>>>13,Ye&=8191;let Be=B+v*m+A*p+S*f+C*h+I*d;B=Be>>>13,Be&=8191,Be+=P*l+R*u+D*c+N*a+M*(5*g),B+=Be>>>13,Be&=8191;let Ie=B+v*g+A*m+S*p+C*f+I*h;B=Ie>>>13,Ie&=8191,Ie+=P*d+R*l+D*u+N*c+M*a,B+=Ie>>>13,Ie&=8191,B=(B<<2)+B|0,B=B+z|0,z=B&8191,B=B>>>13,U+=B,i[0]=z,i[1]=U,i[2]=K,i[3]=Z,i[4]=de,i[5]=j,i[6]=ge,i[7]=Ye,i[8]=Be,i[9]=Ie}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;us(n)}update(e){Vd(this),e=Jl(e),Ze(e);const{buffer:t,blockLen:n}=this,s=e.length;for(let i=0;i<s;){const o=Math.min(n-this.pos,s-i);if(o===n){for(;n<=s-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){us(this.h,this.r,this.buffer,this.pad)}digestInto(e){Vd(this),L9(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)e[i++]=n[o]>>>0,e[i++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function Y9(r){const e=(n,s)=>r(s).update(Jl(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const X9=Y9(r=>new Q9(r));function Z9(r,e,t,n,s,i=20){let o=r[0],a=r[1],c=r[2],u=r[3],l=e[0],d=e[1],h=e[2],f=e[3],p=e[4],m=e[5],g=e[6],y=e[7],E=s,b=t[0],_=t[1],w=t[2],k=o,x=a,T=c,v=u,A=l,S=d,C=h,I=f,P=p,R=m,D=g,N=y,M=E,B=b,z=_,U=w;for(let Z=0;Z<i;Z+=2)k=k+A|0,M=J(M^k,16),P=P+M|0,A=J(A^P,12),k=k+A|0,M=J(M^k,8),P=P+M|0,A=J(A^P,7),x=x+S|0,B=J(B^x,16),R=R+B|0,S=J(S^R,12),x=x+S|0,B=J(B^x,8),R=R+B|0,S=J(S^R,7),T=T+C|0,z=J(z^T,16),D=D+z|0,C=J(C^D,12),T=T+C|0,z=J(z^T,8),D=D+z|0,C=J(C^D,7),v=v+I|0,U=J(U^v,16),N=N+U|0,I=J(I^N,12),v=v+I|0,U=J(U^v,8),N=N+U|0,I=J(I^N,7),k=k+S|0,U=J(U^k,16),D=D+U|0,S=J(S^D,12),k=k+S|0,U=J(U^k,8),D=D+U|0,S=J(S^D,7),x=x+C|0,M=J(M^x,16),N=N+M|0,C=J(C^N,12),x=x+C|0,M=J(M^x,8),N=N+M|0,C=J(C^N,7),T=T+I|0,B=J(B^T,16),P=P+B|0,I=J(I^P,12),T=T+I|0,B=J(B^T,8),P=P+B|0,I=J(I^P,7),v=v+A|0,z=J(z^v,16),R=R+z|0,A=J(A^R,12),v=v+A|0,z=J(z^v,8),R=R+z|0,A=J(A^R,7);let K=0;n[K++]=o+k|0,n[K++]=a+x|0,n[K++]=c+T|0,n[K++]=u+v|0,n[K++]=l+A|0,n[K++]=d+S|0,n[K++]=h+C|0,n[K++]=f+I|0,n[K++]=p+P|0,n[K++]=m+R|0,n[K++]=g+D|0,n[K++]=y+N|0,n[K++]=E+M|0,n[K++]=b+B|0,n[K++]=_+z|0,n[K++]=w+U|0}const J9=j9(Z9,{counterRight:!1,counterLength:4,allowShortKeys:!1}),em=new Uint8Array(16),Wd=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(em.subarray(t))},tm=new Uint8Array(32);function Gd(r,e,t,n,s){const i=r(e,t,tm),o=X9.create(i);s&&Wd(o,s),Wd(o,n);const a=$9(n.length,s?s.length:0,!0);o.update(a);const c=o.digest();return us(i,a),c}const rm=r=>(e,t,n)=>({encrypt(i,o){const a=i.length;o=zd(a+16,o,!1),o.set(i);const c=o.subarray(0,-16);r(e,t,c,c,1);const u=Gd(r,e,t,c,n);return o.set(u,a),us(u),o},decrypt(i,o){o=zd(i.length-16,o,!1);const a=i.subarray(0,-16),c=i.subarray(-16),u=Gd(r,e,t,a,n);if(!F9(c,u))throw new Error("invalid tag");return o.set(i.subarray(0,-16)),r(e,t,o,o,1),us(u),o}}),jd=U9({blockSize:64,nonceLength:12,tagLength:16},rm(J9));function nm(r,e,t){return cc(r),t===void 0&&(t=new Uint8Array(r.outputLen)),Zi(r,Ci(t),Ci(e))}const Kc=Uint8Array.from([0]),Qd=Uint8Array.of();function sm(r,e,t,n=32){cc(r),tn(n);const s=r.outputLen;if(n>255*s)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(n/s);t===void 0&&(t=Qd);const o=new Uint8Array(i*s),a=Zi.create(r,e),c=a._cloneInto(),u=new Uint8Array(a.outputLen);for(let l=0;l<i;l++)Kc[0]=l+1,c.update(l===0?Qd:u).update(t).update(Kc).digestInto(u),o.set(u,s*l),a._cloneInto(c);return a.destroy(),c.destroy(),Vt(u,Kc),o.slice(0,n)}const im={hashSHA256(r){return Qn(r.subarray())},getHKDF(r,e){const t=nm(Qn,e,r),s=sm(Qn,t,void 0,96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const r=mo.utils.randomPrivateKey();return{publicKey:mo.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:mo.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return mo.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return jd(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,s){return jd(n,e,t).decrypt(r.subarray(),s)}},om=im;function am(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}const va=r=>{const e=At(2);return e[0]=r>>8,e[1]=r,e};va.bytes=2;const Qo=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Qo.bytes=2;function cm(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function Ef(r,e){!e.enabled||!to||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${F(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${F(r.privateKey,"hex")}`)):e("Missing local static keys."))}function Sf(r,e){!e.enabled||!to||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${F(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${F(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function lm(r,e){!e.enabled||!to||e(r?`REMOTE_STATIC_PUBLIC_KEY ${F(r.subarray(),"hex")}`:"Missing remote static public key.")}function _f(r,e){!e.enabled||!to||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${F(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function xf(r,e,t){!t.enabled||!to||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&F(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&F(e.k,"hex")}`))}function ds(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=At(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}class yi extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=yi.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}const um=0,dm=4294967295,hm="Cipherstate has reached maximum n, a new handshake must be performed";class fm{n;bytes;view;constructor(e=um){this.n=e,this.bytes=ee(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>dm)throw new Error(hm)}}const Yn=ee(0);class Eo{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new fm(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const s=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),s}}class pm{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const n=q(t,"utf-8");this.h=mm(e,n),this.ck=this.h,this.cs=new Eo(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new Eo(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new Y(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Yn);return[new Eo(this.crypto,e),new Eo(this.crypto,t)]}}class gm{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:n,prologue:s,initiator:i,s:o,e:a,rs:c,re:u}=e;this.crypto=t,this.ss=new pm(t,n),this.ss.mixHash(s),this.initiator=i,this.s=o,this.e=a,this.rs=c,this.re=u}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const s=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(s),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class Af extends gm{writeMessageA(e){return new Y(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new Y(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Y(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new yi(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new yi(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new yi(`handshake stage 2 validation fail: ${t.message}`)}}}function mm(r,e){if(e.length<=32){const t=ee(32);return t.set(e),t}else return r.hash(e)}var Ea;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);if(t.streamMuxers!=null)for(const i of t.streamMuxers)n.uint32(18),n.string(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={webtransportCerthashes:[],streamMuxers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.webtransportCerthashes!=null&&i.webtransportCerthashes.length===s.limits.webtransportCerthashes)throw new ut('Decode error - map field "webtransportCerthashes" had too many elements');i.webtransportCerthashes.push(t.bytes());break}case 2:{if(s.limits?.streamMuxers!=null&&i.streamMuxers.length===s.limits.streamMuxers)throw new ut('Decode error - map field "streamMuxers" had too many elements');i.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Ea||(Ea={}));var Sa;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),Ea.codec().encode(t.extensions,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={identityKey:ee(0),identitySig:ee(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=Ea.codec().decode(t,t.uint32(),{limits:s.limits?.extensions});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Sa||(Sa={}));async function Cf(r,e,t){const n=await r.sign(Tf(e));return Sa.encode({identityKey:Ft(r.publicKey),identitySig:n,extensions:t})}async function kf(r,e,t){try{const n=Sa.decode(r),s=zt(n.identityKey);if(t?.equals(s)===!1)throw new Error(`Payload identity key ${s} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const i=Tf(e);if(!await s.verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new Y5(n.message)}}function Tf(r){const e=q("noise-libp2p-static-key:");return r instanceof Uint8Array?sr([e,r],e.length+r.length):(r.prepend(e),r)}async function ym(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:u}=r,l=await Cf(i,a.publicKey,u),d=new Af({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});Ef(d.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(d.writeMessageA(Yn),e),t.trace("Stage 0 - Initiator finished sending first message."),Sf(d.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const h=d.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),_f(d.re,t),lm(d.rs,t),t.trace("Initiator going to check remote's signature...");const f=await kf(h,d.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(d.writeMessageC(l),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[p,m]=d.ss.split();return xf(p,m,t),{payload:f,encrypt:g=>p.encryptWithAd(Yn,g),decrypt:(g,y)=>m.decryptWithAd(Yn,g,y)}}async function wm(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:u}=r,l=await Cf(i,a.publicKey,u),d=new Af({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});Ef(d.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),d.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),_f(d.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(d.writeMessageB(l),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Sf(d.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const h=d.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const f=await kf(h,d.rs,c),[p,m]=d.ss.split();return xf(p,m,t),{payload:f,encrypt:g=>m.encryptWithAd(Yn,g),decrypt:(g,y)=>p.decryptWithAd(Yn,g,y)}}const Yd=16;function bm(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=qd){let i=s+qd;i>n.length&&(i=n.length);let o;n instanceof Uint8Array?o=r.encrypt(n.subarray(s,i)):o=r.encrypt(n.sublist(s,i)),e?.encryptedPackets.increment(),yield new Y(va(o.byteLength),o)}}}function vm(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=Ii){let i=s+Ii;if(i>n.length&&(i=n.length),i-Yd<s)throw new Error("Invalid chunk");const o=n.sublist(s,i),a=n.subarray(s,i-Yd);try{const c=r.decrypt(o,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}class Em{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:n,extensions:s,crypto:i,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=i??om;this.crypto=am(c),this.extensions={webtransportCerthashes:[],...s},this.metrics=a?cm(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??ee(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[rt]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const n=cs(e,{lengthEncoder:va,lengthDecoder:Qo,maxDataLength:Ii}),s=await this.performHandshakeInitiator(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=zt(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:as(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const n of e){const s=t.get(n);if(s!=null)return s}if(e.length)throw new X5("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const n=cs(e,{lengthEncoder:va,lengthDecoder:Qo,maxDataLength:Ii}),s=await this.performHandshakeResponder(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=zt(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:as(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await ym({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async performHandshakeResponder(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await wm({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async createSecureConnection(e,t){const[n,s]=x9(),i=e.unwrap();return await ls(n,bm(t,this.metrics),i,o=>wa(o,{lengthDecoder:Qo}),vm(t,this.metrics),n),s}}function Sm(r={}){return e=>new Em(e,r)}function If(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}class Fn extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}class Pf extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}class Rf extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}class _m extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}class xm extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}class Am extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}class Cm extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}}class Df extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}const km=new Set([Fn.name,Pf.name,Rf.name,xm.name,Am.name,Cm.name,Df.name]),c1=256*1024,Tm=16*1024*1024,Im={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:c1,maxStreamWindowSize:Tm,maxMessageSize:64*1024};function Pm(r){if(r.keepAliveInterval<=0)throw new L("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new L("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new L("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<c1)throw new L("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new L("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new L("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new L("MaxMessageSize must be greater than a kilobyte")}var Ce;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Ce||(Ce={}));var Se;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Se||(Se={}));Object.values(Se).filter(r=>typeof r!="string");const Rm=0;var Lt;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Lt||(Lt={}));const wi=12,Xd=2**24;function Dm(r){if(r[0]!==Rm)throw new Fn("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*Xd+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*Xd+(r[9]<<16)+(r[10]<<8)+r[11]}}class Lm{source;buffer;frameInProgress;constructor(e){this.source=Nm(e),this.buffer=new Y,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:n,length:s}=t;n===Ce.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new _m("decoding frame already in progress");if(this.buffer.length<wi)return;const e=Dm(this.buffer.subarray(0,wi));return this.buffer.consume(wi),e}async readBytes(e){if(this.buffer.length<e){for await(const n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}}function Nm(r){if(r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){const e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function Zd(r){const e=new Uint8Array(wi);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function Bm(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function Mm(r,e){const t=If(r).return?.();Bm(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}const Om=5e3;function Wc(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class Lf{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=fe(),this.closed=fe(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??Om,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=cr({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new Fl(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(t);Wc(s)&&await s}const n=()=>{Mm(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Y(s):s;const i=this.sendData(s,t);Wc(i)&&(this.sendingData=fe(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await De(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await De(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await De(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await De(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();Wc(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new J5("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}function l1(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function Fm(r){return r[Symbol.asyncIterator]!=null}function Jd(r){return r?.then!=null}function Nf(r,e){let t=0;if(Fm(r))return async function*(){for await(const c of r){const u=e(c,t++);Jd(u)&&await u,yield c}}();const n=l1(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();if(typeof e(s,t++)?.then=="function")return async function*(){yield s;for(const c of n){const u=e(c,t++);Jd(u)&&await u,yield c}}();const a=e;return function*(){yield s;for(const c of n)a(c,t++),yield c}()}var St;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(St||(St={}));class Um extends Lf{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=St.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=c1,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=Nf(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-wi,e.length),s=this.getSendFlags();this.sendFrame({type:Ce.Data,flag:s,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:Ce.WindowUpdate,flag:Se.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Se.FIN;this.sendFrame({type:Ce.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n;const s=()=>{this.status==="open"||this.status==="closing"?n(new Rr("Stream aborted")):t()};e.signal?.addEventListener("abort",s);try{await new Promise((i,o)=>{this.sendWindowCapacityUpdate=()=>{i()},n=o,t=i})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new Df("Receive window exceeded");const n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&Se.ACK)===Se.ACK&&this.state===St.SYNSent&&(this.state=St.Established),(e&Se.FIN)===Se.FIN&&this.remoteCloseWrite(),(e&Se.RST)===Se.RST&&this.reset()}getSendFlags(){switch(this.state){case St.Init:return this.state=St.SYNSent,Se.SYN;case St.SYNReceived:return this.state=St.Established,Se.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Ce.WindowUpdate,flag:e,streamID:this._id,length:s})}}const Bf="/yamux/1.0.0",$m=500;class qm{protocol=Bf;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[rt]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new Vm(this._components,{...this._init,...e})}}class Vm{protocol=Bf;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...Im,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),Pm(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=cr({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{const s=()=>{const a=If(n);if(a.return!=null){const c=a.return();zm(c)&&c.catch(u=>{this.log?.("could not cause sink source to return",u)})}};let i,o;try{const a=new Lm(n);try{this.closeController.signal.addEventListener("abort",s);for await(const c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}i=Lt.NormalTermination}catch(a){km.has(a.name)?(this.log?.error("protocol error in sink",a),i=Lt.ProtocolError):(this.log?.error("internal error in sink",a),i=Lt.InternalError),o=a}this.log?.trace("muxer sink ended"),o!=null?this.abort(o,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new Ks("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Ks("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new s0("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,St.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new Ks("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Ks("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new Ks("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??Lt.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){const n=AbortSignal.timeout($m);e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Lt.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new L("Stream already exists with that id");const i=new Um({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){const e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){const{streamID:n,type:s,length:i}=e;if(this.log?.trace("received frame %o",e),n===0)switch(s){case Ce.Ping:{this.handlePing(e);return}case Ce.GoAway:{this.handleGoAway(i);return}default:throw new Fn("Invalid frame type")}else switch(e.type){case Ce.Data:case Ce.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new Fn("Invalid frame type")}}handlePing(e){if(e.flag===Se.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Se.ACK);else if(e.flag===Se.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Fn("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new Pf("ping not requested");if(this.activePing.id!==e)throw new Rf("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Lt[e]??"unknown"),this.remoteGoAway=e;for(const t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:n,flag:s,type:i}=e;(s&Se.SYN)===Se.SYN&&this.incomingStream(n);const o=this._streams.get(n);if(o===void 0){if(i===Ce.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",n);return}switch(i){case Ce.WindowUpdate:{o.handleWindowUpdate(e);return}case Ce.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new L("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Ce.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Ce.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,St.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===Ce.Data){if(t===void 0)throw new Fn("Invalid frame");this.source.push(new Y(Zd(e),t))}else this.source.push(Zd(e))}sendPing(e,t=Se.SYN){t===Se.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:Ce.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Lt.NormalTermination){this.log?.("sending GoAway reason=%s",Lt[e]),this.localGoAway=e,this.sendFrame({type:Ce.GoAway,flag:0,streamID:0,length:e})}}function zm(r){return r!=null&&typeof r.then=="function"}function Hm(r={}){return e=>new qm(e,r)}var _a;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:ee(0),payloadType:ee(0),payload:ee(0),signature:ee(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(_a||(_a={}));class Km extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class Ut{static createFromProtobuf=e=>{const t=_a.decode(e),n=zt(t.publicKey);return new Ut({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,o=e.marshal(),a=eh(s,i,o),c=await t.sign(a.subarray(),n);return new Ut({publicKey:t.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const s=Ut.createFromProtobuf(e);if(!await s.validate(t,n))throw new Km("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=_a.encode({publicKey:Ft(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:pe(this.marshal(),e.marshal())}async validate(e,t){const n=eh(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const eh=(r,e,t)=>{const n=q(r),s=rn(n.byteLength),i=rn(e.length),o=rn(t.length);return new Y(s,n,i,e,o,t)};function Wm(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}class pt extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class Pi extends Error{static name="ValidationError";name="ValidationError"}class Gm extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class jm extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}class Qm{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",u=2**(8*s)-1;for(;;){const l=this.readAtomically(()=>{const d=this.readChar();if(d===void 0)return;const h=Number.parseInt(d,e);if(!Number.isNaN(h))return h});if(l===void 0)break;if(i*=e,i+=l,i>u||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[a]=e(i.subarray(0,o));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const Mf=45,Ym=15,hs=new Qm;function Of(r){if(!(r.length>Ym))return hs.new(r).parseWith(()=>hs.readIPv4Addr())}function Ff(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Mf))return hs.new(r).parseWith(()=>hs.readIPv6Addr())}function ru(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>Mf)return;const t=hs.new(r).parseWith(()=>hs.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function dn(r){return!!Of(r)}function u1(r){return!!Ff(r)}const fs=4,nu=6,su=273,Xm=33,$t=41,Ms=42,Zm=43,d1=53,h1=54,pc=55,f1=56,Jm=132,ey=301,ty=302,ry=400,Uf=421,ny=444,sy=445,iy=446,oy=447,ay=448,cy=449,ly=454,uy=460,dy=461,hy=465,fy=466,py=480,gy=481,my=443,yy=477,wy=478,by=479,vy=277,Ey=275,Sy=276,_y=280,xy=281,$f=290,Ay=777;function th(r){return e=>F(e,r)}function rh(r){return e=>q(e,r)}function ni(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Un(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function Cy(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=q(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Un(n);return sr([t,s],t.length+s.length)}function ky(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Tr.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Un(n);return sr([t,s],t.length+s.length)}function nh(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=F(e,"base32"),s=ni(t);return`${n}:${s}`}const qf=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new pt("Invalid byte value in IP address");e[n]=s}),e},Ty=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=dn(t[n]);let o;i&&(o=qf(t[n]),t[n]=F(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,F(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new pt("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},Iy=function(r){if(r.byteLength!==4)throw new pt("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},Py=function(r){if(r.byteLength!==16)throw new pt("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const s=r[n],i=r[n+1],o=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new pt(`Invalid IPv6 address "${t}"`)}};function Ry(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new pt(`Invalid IPv6 address "${r}"`)}}const Gc=Object.values(zl).map(r=>r.decoder),Dy=function(){let r=Gc[0].or(Gc[1]);return Gc.slice(2).forEach(e=>r=r.or(e)),r}();function Ly(r){return Dy.decode(r)}function Ny(r){return e=>r.encoder.encode(e)}function By(r){if(parseInt(r).toString()!==r)throw new Pi("Value must be an integer")}function My(r){if(r<0)throw new Pi("Value must be a positive integer, or zero")}function Oy(r){return e=>{if(e>r)throw new Pi(`Value must be smaller than or equal to ${r}`)}}function Fy(...r){return e=>{for(const t of r)t(e)}}const So=Fy(By,My,Oy(65535)),Oe=-1;class Uy{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new jm(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}}const qt=new Uy,$y=[{code:fs,name:"ip4",size:32,valueToBytes:qf,bytesToValue:Iy,validate:r=>{if(!dn(r))throw new Pi(`Invalid IPv4 address "${r}"`)}},{code:nu,name:"tcp",size:16,valueToBytes:Un,bytesToValue:ni,validate:So},{code:su,name:"udp",size:16,valueToBytes:Un,bytesToValue:ni,validate:So},{code:Xm,name:"dccp",size:16,valueToBytes:Un,bytesToValue:ni,validate:So},{code:$t,name:"ip6",size:128,valueToBytes:Ty,bytesToValue:Py,stringToValue:Ry,validate:r=>{if(!u1(r))throw new Pi(`Invalid IPv6 address "${r}"`)}},{code:Ms,name:"ip6zone",size:Oe},{code:Zm,name:"ipcidr",size:8,bytesToValue:th("base10"),valueToBytes:rh("base10")},{code:d1,name:"dns",size:Oe,resolvable:!0},{code:h1,name:"dns4",size:Oe,resolvable:!0},{code:pc,name:"dns6",size:Oe,resolvable:!0},{code:f1,name:"dnsaddr",size:Oe,resolvable:!0},{code:Jm,name:"sctp",size:16,valueToBytes:Un,bytesToValue:ni,validate:So},{code:ey,name:"udt"},{code:ty,name:"utp"},{code:ry,name:"unix",size:Oe,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:Uf,name:"p2p",aliases:["ipfs"],size:Oe,bytesToValue:th("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?rh("base58btc")(r):se.parse(r).multihash.bytes},{code:ny,name:"onion",size:96,bytesToValue:nh,valueToBytes:Cy},{code:sy,name:"onion3",size:296,bytesToValue:nh,valueToBytes:ky},{code:iy,name:"garlic64",size:Oe},{code:oy,name:"garlic32",size:Oe},{code:ay,name:"tls"},{code:cy,name:"sni",size:Oe},{code:ly,name:"noise"},{code:uy,name:"quic"},{code:dy,name:"quic-v1"},{code:hy,name:"webtransport"},{code:fy,name:"certhash",size:Oe,bytesToValue:Ny(Ku),valueToBytes:Ly},{code:py,name:"http"},{code:gy,name:"http-path",size:Oe,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:my,name:"https"},{code:yy,name:"ws"},{code:wy,name:"wss"},{code:by,name:"p2p-websocket-star"},{code:vy,name:"p2p-stardust"},{code:Ey,name:"p2p-webrtc-star"},{code:Sy,name:"p2p-webrtc-direct"},{code:_y,name:"webrtc-direct"},{code:xy,name:"webrtc"},{code:$f,name:"p2p-circuit"},{code:Ay,name:"memory",size:Oe}];$y.forEach(r=>{qt.addProtocol(r)});function qy(r){const e=[];let t=0;for(;t<r.length;){const n=Xi(r,t),s=qt.getProtocol(n),i=Ve(n),o=Ky(s,r,t+i);let a=0;o>0&&s.size===Oe&&(a=Ve(o));const c=i+a+o,u={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(o>0){const l=t+i+a,d=r.subarray(l,l+o);u.value=s.bytesToValue?.(d)??F(d)}e.push(u),t+=c}return e}function Vy(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const s=qt.getProtocol(n.code),i=Ve(n.code);let o,a=0,c=0;n.value!=null&&(o=s.valueToBytes?.(n.value)??q(n.value),a=o.byteLength,s.size===Oe&&(c=Ve(a)));const u=new Uint8Array(i+c+a);let l=0;fa(n.code,u,l),l+=i,o!=null&&(s.size===Oe&&(fa(a,u,l),l+=c),u.set(o,l)),n.bytes=u}t.push(n.bytes),e+=n.bytes.byteLength}return sr(t,e)}function zy(r){if(r.charAt(0)!=="/")throw new pt('String multiaddr must start with "/"');const e=[];let t="protocol",n="",s="";for(let i=1;i<r.length;i++){const o=r.charAt(i);o!=="/"&&(t==="protocol"?s+=r.charAt(i):n+=r.charAt(i));const a=i===r.length-1;if(o==="/"||a){const c=qt.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(a)throw new pt(`Component ${s} was missing value`);t="value"}else if(t==="value"){const u={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new pt(`Component ${s} was missing value`);u.value=c.stringToValue?.(n)??n}e.push(u),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new pt("Incomplete multiaddr");return e}function Hy(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=qt.getProtocol(e.code);if(t==null)throw new pt(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function Ky(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Xi(e,t)}const Wy=Symbol.for("nodejs.util.inspect.custom"),Vf=Symbol.for("@multiformats/multiaddr"),Gy=[d1,h1,pc,f1];class jy extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function Qy(r){if(r==null&&(r="/"),gc(r))return r.getComponents();if(r instanceof Uint8Array)return qy(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),zy(r);if(Array.isArray(r))return r;throw new pt("Must be a string, Uint8Array, Component[], or another Multiaddr")}class $n{[Vf]=!0;#e;#r;#t;constructor(e="/",t={}){this.#e=Qy(e),t.validate!==!1&&Yy(this)}get bytes(){return this.#t==null&&(this.#t=Vy(this.#e)),this.#t}toString(){return this.#r==null&&(this.#r=Hy(this.#e)),this.#r}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";for(const{code:a,name:c,value:u}of this.#e)a===Ms&&(i=`%${u??""}`),Gy.includes(a)&&(t="tcp",s=443,n=`${u??""}${i}`,e=a===pc?6:4),(a===nu||a===su)&&(t=c==="tcp"?"tcp":"udp",s=parseInt(u??"")),(a===fs||a===$t)&&(t="tcp",n=`${u??""}${i}`,e=a===$t?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}getComponents(){return[...this.#e]}protos(){return this.#e.map(({code:e,value:t})=>{const n=qt.getProtocol(e);return{code:e,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return this.#e.map(({code:e})=>e)}protoNames(){return this.#e.map(({name:e})=>e)}tuples(){return this.#e.map(({code:e,value:t})=>{if(t==null)return[e];const n=qt.getProtocol(e),s=[e];return t!=null&&s.push(n.valueToBytes?.(t)??q(t)),s})}stringTuples(){return this.#e.map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){const t=new $n(e);return new $n([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Gm(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new $n(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new $n(this.#e.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#e.forEach(({code:n,value:s})=>{n===Uf&&e.push([n,s]),n===$f&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?F(Ae.decode(`z${n}`),"base58btc"):F(se.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(const e of this.#e)if(qt.getProtocol(e.code).path)return e.value??null;return null}equals(e){return pe(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=p1.get(t.name);if(n==null)throw new jy(`no available resolver for ${t.name}`);return(await n(this,e)).map(i=>W(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(this.#e.length!==2||this.#e[0].code!==fs&&this.#e[0].code!==$t||this.#e[1].code!==nu&&this.#e[1].code!==su)}[Wy](){return`Multiaddr(${this.toString()})`}}function Yy(r){r.getComponents().forEach(e=>{const t=qt.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function Xy(r,e,t){let n=0;for(const s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function Zy(r,e,t,n){let s=0;for(const i of r)if(!(s<t)){if(s>n)break;if(i!==e[s])return!1;s++}return!0}function Jy(r){switch(r.length){case Ri:return r.join(".");case Di:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function ew(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function tw(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const Ri=4,Di=16,rw=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function zf(r,e){e.length===Di&&r.length===Ri&&Xy(e,0,11)&&(e=e.slice(12)),e.length===Ri&&r.length===Di&&Zy(r,rw,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function nw(r,e){if(typeof e=="string"&&(e=ru(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function sw(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=Ri,s=Of(e);if(s==null&&(n=Di,s=Ff(e),s==null))throw new Error("Failed to parse given CIDR: "+r);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=Hf(i,8*n);return{network:zf(s,o),mask:o}}function Hf(r,e){if(e!==8*Ri&&e!==8*Di)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}class Kf{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=sw(e));else{const n=ru(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){const i=ru(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=Hf(s,8*n.length);this.network=zf(n,this.mask)}}contains(e){return nw({network:this.network,mask:this.mask},e)}toString(){const e=ew(this.mask),t=e!==-1?String(e):tw(this.mask);return Jy(this.network)+"/"+t}}function iw(r,e){return new Kf(r).contains(e)}function ow(r){let e,t;if(r.getComponents().forEach(n=>{(n.name==="ip4"||n.name==="ip6")&&(t=n.value),n.name==="ipcidr"&&(e=n.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new Kf(t,e)}const p1=new Map;function gc(r){return!!r?.[Vf]}function W(r){return new $n(r)}function qe(r){const e=qt.getProtocol(r);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}const aw="libp2p-peer-record",cw=Uint8Array.from([3,1]);var xa;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=ue((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={multiaddr:ee(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const u=s.uint32();switch(u>>>3){case 1:{a.multiaddr=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),n),t.encode=s=>le(s,t.codec()),t.decode=(s,i)=>ce(s,t.codec(),i)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peerId:ee(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new ut('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(xa||(xa={}));class lt{static createFromProtobuf=e=>{const t=xa.decode(e),n=Ht(Tt(t.peerId)),s=(t.addresses??[]).map(o=>W(o.multiaddr)),i=t.seq;return new lt({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=aw;static CODEC=cw;peerId;multiaddrs;seqNumber;domain=lt.DOMAIN;codec=lt.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=xa.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof lt)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!Wm(this.multiaddrs,e.multiaddrs))}}function nt(r,e){const t=cs(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}const lw=290,uw=1,Wf=2e3,dw=100,_o=`${rc}-circuit-relay`;BigInt(1<<17);const Aa="/libp2p/circuit/relay/0.2.0/hop",sh="/libp2p/circuit/relay/0.2.0/stop",ih=300,hw=4096,fw=.001;var ps;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),function(n){n.codec=()=>ar(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=ue((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),gs.codec().encode(n.peer,s)),n.reservation!=null&&(s.uint32(26),Ca.codec().encode(n.reservation,s)),n.limit!=null&&(s.uint32(34),ms.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(40),Ge.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=gs.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=Ca.codec().decode(n,n.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=ms.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=Ge.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>le(n,r.codec()),r.decode=(n,s)=>ce(n,r.codec(),s)})(ps||(ps={}));var Qt;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),function(n){n.codec=()=>ar(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=ue((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),gs.codec().encode(n.peer,s)),n.limit!=null&&(s.uint32(26),ms.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(32),Ge.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=gs.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=ms.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=Ge.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>le(n,r.codec()),r.decode=(n,s)=>ce(n,r.codec(),s)})(Qt||(Qt={}));var gs;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:ee(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new ut('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(gs||(gs={}));var Ca;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),Ta.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new ut('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=Ta.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Ca||(Ca={}));var ms;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(ms||(ms={}));var Ge;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Ge||(Ge={}));var iu;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(iu||(iu={}));(function(r){r.codec=()=>ar(iu)})(Ge||(Ge={}));var ka;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={relay:ee(0),peer:ee(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(ka||(ka={}));var Ta;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),ka.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:ee(0),payloadType:ee(0),signature:ee(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=ka.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Ta||(Ta={}));const pw=r=>r.toString().split("/").slice(1),ro=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),G=r=>({match:e=>ro(t=>t===r).match(e),pattern:r}),Os=()=>({match:r=>ro(e=>typeof e=="string").match(r),pattern:"{string}"}),Li=()=>({match:r=>ro(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),oe=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{Ae.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),Ia=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{Ku.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),ne=r=>({match:e=>{const t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),je=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Q=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function he(...r){function e(s){let i=pw(s);for(const o of r){const a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const gw=oe(),mw=he(gw),mc=Q(G("dns4"),Os()),yc=Q(G("dns6"),Os()),wc=Q(G("dnsaddr"),Os()),g1=Q(G("dns"),Os());he(mc,ne(oe()));he(yc,ne(oe()));he(wc,ne(oe()));const yw=he(je(g1,wc,mc,yc),ne(oe())),Gf=Q(G("ip4"),ro(dn)),jf=Q(G("ip6"),ro(u1)),m1=je(Gf,jf),er=je(m1,g1,mc,yc,wc),ww=he(je(m1,Q(je(g1,wc,mc,yc),ne(oe())))),oh=he(Gf),ah=he(jf),bw=he(m1),y1=Q(er,G("tcp"),Li()),no=Q(er,G("udp"),Li()),Pa=he(Q(y1,ne(oe())));he(no);const w1=Q(no,G("quic"),ne(oe())),bc=Q(no,G("quic-v1"),ne(oe())),vw=je(w1,bc);he(w1);const Ew=he(bc),ou=je(er,y1,no,w1,bc),Qf=je(Q(ou,G("ws"),ne(oe()))),Ni=he(Qf),Yf=je(Q(ou,G("wss"),ne(oe())),Q(ou,G("tls"),ne(Q(G("sni"),Os())),G("ws"),ne(oe()))),Ra=he(Yf),Xf=Q(no,G("webrtc-direct"),ne(Ia()),ne(Ia()),ne(oe())),ch=he(Xf),Zf=Q(bc,G("webtransport"),ne(Ia()),ne(Ia()),ne(oe())),lh=he(Zf),Da=je(Qf,Yf,Q(y1,ne(oe())),Q(vw,ne(oe())),Q(er,ne(oe())),Xf,Zf,oe()),Jf=he(Da),Sw=Q(Da,G("p2p-circuit"),oe()),Lr=he(Sw),_w=je(Q(Da,G("p2p-circuit"),G("webrtc"),ne(oe())),Q(Da,G("webrtc"),ne(oe())),Q(G("webrtc"),ne(oe()))),La=he(_w),xw=je(Q(er,G("tcp"),Li(),G("http"),ne(oe())),Q(er,G("http"),ne(oe())));he(xw);const Aw=je(Q(er,G("tcp"),je(Q(G("443"),G("http")),Q(Li(),G("https")),Q(Li(),G("tls"),G("http"))),ne(oe())),Q(er,G("tls"),G("http"),ne(oe())),Q(er,G("https"),ne(oe())));he(Aw);const Cw=je(Q(G("memory"),Os(),ne(oe())));he(Cw);function tt(r){const e=new globalThis.AbortController;function t(){e.abort();for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}class uh extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class kw extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class Tw extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function dh(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class hh{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const e3=he(Q(Jf.matchers[0],G("p2p-circuit"))),t3=he(G("p2p-circuit"));function bi(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function jc(r){const e=Tt(Ae.decode(`z${r}`));return Ht(e)}class vn{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return bi(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return bi(this.map.values(),e=>e.key)}values(){return bi(this.map.values(),e=>e.value)}get size(){return this.map.size}}class tr{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return bi(this.set.entries(),e=>{const t=jc(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=jc(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return bi(this.set.values(),e=>jc(e))}intersection(e){const t=new tr;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new tr;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new tr;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}function r3(r,e,t,n){cc(r);const s=Qp({dkLen:32,asyncTick:10},n),{c:i,dkLen:o,asyncTick:a}=s;if(tn(i),tn(o),tn(a),i<1)throw new Error("iterations (c) should be >= 1");const c=bd(e),u=bd(t),l=new Uint8Array(o),d=Zi.create(r,c),h=d._cloneInto().update(u);return{c:i,dkLen:o,asyncTick:a,DK:l,PRF:d,PRFSalt:h}}function n3(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),Vt(s),t}function Iw(r,e,t,n){const{c:s,dkLen:i,DK:o,PRF:a,PRFSalt:c}=r3(r,e,t,n);let u;const l=new Uint8Array(4),d=fi(l),h=new Uint8Array(a.outputLen);for(let f=1,p=0;p<i;f++,p+=a.outputLen){const m=o.subarray(p,p+a.outputLen);d.setInt32(0,f,!1),(u=c._cloneInto(u)).update(l).digestInto(h),m.set(h.subarray(0,m.length));for(let g=1;g<s;g++){a._cloneInto(u).update(h).digestInto(h);for(let y=0;y<m.length;y++)m[y]^=h[y]}}return n3(a,c,o,u,h)}async function s3(r,e,t,n){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:c,PRFSalt:u}=r3(r,e,t,n);let l;const d=new Uint8Array(4),h=fi(d),f=new Uint8Array(c.outputLen);for(let p=1,m=0;m<i;p++,m+=c.outputLen){const g=a.subarray(m,m+c.outputLen);h.setInt32(0,p,!1),(l=u._cloneInto(l)).update(d).digestInto(f),g.set(f.subarray(0,g.length)),await jp(s-1,o,()=>{c._cloneInto(l).update(f).digestInto(f);for(let y=0;y<g.length;y++)g[y]^=f[y]})}return n3(c,u,a,l,f)}const Ys=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),gr=new Uint32Array(80);class Pw extends Yu{constructor(){super(64,20,8,!1),this.A=Ys[0]|0,this.B=Ys[1]|0,this.C=Ys[2]|0,this.D=Ys[3]|0,this.E=Ys[4]|0}get(){const{A:e,B:t,C:n,D:s,E:i}=this;return[e,t,n,s,i]}set(e,t,n,s,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)gr[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)gr[c]=Nc(gr[c-3]^gr[c-8]^gr[c-14]^gr[c-16],1);let{A:n,B:s,C:i,D:o,E:a}=this;for(let c=0;c<80;c++){let u,l;c<20?(u=S0(s,i,o),l=1518500249):c<40?(u=s^i^o,l=1859775393):c<60?(u=_0(s,i,o),l=2400959708):(u=s^i^o,l=3395469782);const d=Nc(n,5)+u+a+l+gr[c]|0;a=o,o=i,i=Nc(s,30),s=n,n=d}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(n,s,i,o,a)}roundClean(){Vt(gr)}destroy(){this.set(0,0,0,0,0),Vt(this.buffer)}}const Rw=Qu(()=>new Pw),Dw=Rw,b1=C0,fh={sha1:Dw,"sha2-256":Qn,"sha2-512":b1};function ph(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(fh).join(" / ");throw new L(`Hash '${s}' is unknown or not supported. Must be ${a}`)}const i=fh[s],o=Iw(i,r,e,{c:t,dkLen:n});return Gi.encode(o).substring(1)}const v1={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},i3={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},o3=new globalThis.TextEncoder;function Lw(r,e){const t=v1[e];let n=i3[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function Nw(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=v1[e];let s=i3[e],i=r;for(;i.length>0;){const o=o3.encodeInto(i,t);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(t[a]),s=BigInt.asUintN(e,s*n)}return s}function Bw(r,{size:e=32,utf8Buffer:t}={}){if(!v1[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return Nw(r,e,t);r=o3.encode(r)}return Lw(r,e)}const E1={hash:r=>Number(Bw(r,{size:32})),hashV:(r,e)=>Mw(E1.hash(r,e))};function Mw(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),q(e,"base16")}const a3=64;class Xr{fp;h;seed;constructor(e,t,n,s=2){if(s>a3)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=ee(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?pe(this.fp,e.fp):!1}}function Na(r,e){return Math.floor(Math.random()*(e-r))+r}class xo{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Xr))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Xr))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Xr))throw new TypeError("Invalid Fingerprint");const t=Na(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof Xr))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const Ow=500;class gh{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??E1,this.seed=e.seed??Na(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=q(e));const t=new Xr(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new xo(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new xo(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[n,s];let o=i[Na(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new xo(this.bucketSize));for(let a=0;a<Ow;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new xo(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=q(e));const t=new Xr(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=q(e));const t=new Xr(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const Fw={1:.5,2:.84,4:.95,8:.98};function Uw(r=.001){return r>.002?2:r>1e-5?4:8}function $w(r,e=.001){const t=Uw(e),n=Fw[t],s=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),a3);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class qw{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??E1,this.seed=e.seed??Na(0,Math.pow(2,10)),this.filterSeries=[new gh({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=q(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new gh({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=q(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=q(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function ys(r,e=.001,t){return new qw({...$w(r,e)})}class Vw{filter;constructor(e,t){this.filter=ys(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function zw(r,e=.001){return new Vw(r,e)}class Hw extends vn{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function c3(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new Hw({name:e,metrics:t}):n=new vn,n}function mh(r){const{stream:e,remoteAddr:t,logger:n,onDataRead:s,onDataWrite:i}=r,o=n.forComponent("libp2p:stream:converter");let a=!1,c=!1;const u=e.close.bind(e);e.close=async p=>{await u(p),f(!0)};const l=e.abort.bind(e);e.abort=p=>{l(p),f(!0)};const d=e.sink.bind(e);e.sink=async p=>{try{await d(ls(p,m=>Nf(m,g=>i?.(g))))}catch(m){m.type!=="aborted"&&o.error("%s error in sink",t,m)}finally{c=!0,f()}};const h={log:o,sink:e.sink,source:async function*(){try{for await(const p of e.source)s?.(p),yield p}finally{a=!0,f()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function f(p){p===!0&&(a=!0,c=!0),a&&c&&h.timeline.close==null&&(h.timeline.close=Date.now())}return h}class ie extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}let Kw=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function rr(r,e,t,n){const s=new Kw(n?.errorMessage,n?.errorCode);return t?.aborted===!0?Promise.reject(s):new Promise((i,o)=>{function a(){t?.removeEventListener("abort",l),r.removeEventListener(e,c),n?.errorEvent!=null&&r.removeEventListener(n.errorEvent,u)}const c=d=>{try{if(n?.filter?.(d)===!1)return}catch(h){a(),o(h);return}a(),i(d)},u=d=>{a(),o(d.detail)},l=()=>{a(),o(s)};t?.addEventListener("abort",l),r.addEventListener(e,c),n?.errorEvent!=null&&r.addEventListener(n.errorEvent,u)})}function Ba(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class Ww extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let Gw=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},jw=class{deferred;signal;constructor(e){this.signal=e,this.deferred=fe(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Rr)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Qw(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let Yw=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Qw(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Rr),this.cleanup())}async join(e={}){const t=new jw(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await De(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},so=class extends He{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Ba(this.emitEmpty.bind(this),1),this.emitIdle=Ba(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Gw;const n=new Yw(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:s}),this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Rr)}),this.clear()}async onEmpty(e){this.size!==0&&await rr(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await rr(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await rr(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=cr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail)},o=()=>{n()},a=()=>{n(new Rr("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("error",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("error",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}};class Bi extends so{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}class Xw extends He{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(Aa,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(Aa)],orders:[()=>Math.random()<.5?1:-1,(n,s)=>{const i=yh(n),o=yh(s);return i>o?-1:o>i?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new Bi({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p",n.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p - %e",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const n=tt([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}}function yh(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(F(e)).getTime()}class Zw extends He{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??Wf,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(t3.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(e3.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new Ul(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>W(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function Jw(r){return new Zw(r)}const eb="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let tb=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=eb[t[r]&63];return e};const rb=60*1e3*10,nb=60*1e3*5,sb=30*1e3;class ib extends He{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new vn,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??dw,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??Wf,this.started=!1,this.relayFilter=ys(100),this.reserveQueue=new Bi({concurrency:t?.reservationConcurrency??uw,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#r(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(_o)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[_o]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#t()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=tb();return this.pendingReservations.push(e),this.#t(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Ul("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new Tw("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Ul("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const p=this.connectionManager.getConnections(e);let m=!1;if(p.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),p.map(g=>g.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),m=!0),m&&dh(i.reservation.expire)>rb)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#r(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new uh("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const a=await this.connectionManager.openConnection(e,{signal:o});if(Lr.matches(a.remoteAddr))throw new kw("not creating reservation over relayed connection");const c=await this.#e(a,{signal:o}),u=dh(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+u).toString());const l=Math.min(Math.max(u-nb,sb),Math.pow(2,31)-1),d=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async p=>{this.log.error("could not refresh reservation to relay %p - %e",e,p),await this.#r(e)}).catch(p=>{this.log.error("could not remove expired reservation to relay %p - %e",e,p)})},l);let h;if(t==="discovered"){const p=this.pendingReservations.pop();if(p==null)throw new uh("Made reservation on relay but did not need any more discovered relays");h={timeout:d,reservation:c,type:t,connection:a.id,id:p}}else h={timeout:d,reservation:c,type:t,connection:a.id};this.reservations.set(e,h),await this.peerStore.merge(e,{tags:{[_o]:{value:1,ttl:u}}}),this.#t();const f={relay:e,details:h};return this.safeDispatchEvent("relay:created-reservation",{detail:f}),f}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#r(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(Aa,t),i=nt(n).pb(ps);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:ps.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %o",o),o.status===Ge.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const u of o.reservation.addrs){let l=W(u);l.getPeerId()==null&&(l=l.encapsulate(`/p2p/${e.remotePeer}`)),l=W(l.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(l.toString())}return o.reservation.addrs=[...c].map(u=>W(u).bytes),o.reservation}const a=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#r(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[_o]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#t())}#t(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=ys(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}const ob=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(W)}catch{return!1}return!0},wh={maxInboundStopStreams:ih,maxOutboundStopStreams:ih};class ab{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??wh.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??wh.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new Xw(e,{filter:t.discoveryFilter??zw(hw,fw)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,s)})}),this.reservationStore=new ib(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[rt]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[ns](){return this.discovery!=null?["@libp2p/identify"]:[]}[$u]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(sh,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Ai(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await sc(this.discovery,this.reservationStore),await this.registrar.unhandle(sh),this.started=!1}async dial(e,t){if(e.protoCodes().filter(f=>f===lw).length!==1){const f="Invalid circuit relay address";throw this.log.error(f,e),new hi(f)}const n=e.toString().split("/p2p-circuit"),s=W(n[0]),i=W(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const f=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${f}`),new hi(`C${f}`)}const c=yt(o),u=yt(a);let d=this.connectionManager.getConnections(c)[0];d==null?(await this.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new ie("circuit-relay:open-connection")),d=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new ie("circuit-relay:reuse-connection"));let h;try{t.onProgress?.(new ie("circuit-relay:open-hop-stream")),h=await d.newStream(Aa,t);const f=nt(h),p=f.pb(ps);t.onProgress?.(new ie("circuit-relay:write-connect-message")),await p.write({type:ps.Type.CONNECT,peer:{id:u.toMultihash().bytes,addrs:[W(i).bytes]}},t),t.onProgress?.(new ie("circuit-relay:read-connect-response"));const m=await p.read(t);if(m.status!==Ge.OK)throw new ve(`failed to connect via relay with status ${m?.status?.toString()??"undefined"}`);const g=new hh(m.limit),y=mh({stream:f.unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:g.onData,onDataWrite:g.onData});return this.log("new outbound relayed connection %a",y.remoteAddr),await this.upgrader.upgradeOutbound(y,{...t,limits:g.getLimits()})}catch(f){throw this.log.error("circuit relay dial to destination %p via relay %p failed",u,c,f),h?.abort(f),f}}createListener(e){return Jw({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>e3.exactMatch(t)||t3.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Lr.exactMatch(t))}async onStop({connection:e,stream:t},n){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(l){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",l)}const s=nt(t).pb(Qt),i=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:Qt.Type.STATUS,status:Ge.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(i.type!==Qt.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Qt.Type.STATUS,status:Ge.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!ob(i)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Qt.Type.STATUS,status:Ge.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}const o=Ht(Tt(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:Qt.Type.STATUS,status:Ge.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await s.write({type:Qt.Type.STATUS,status:Ge.OK},{signal:n});const a=new hh(i.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const u=mh({stream:s.unwrap().unwrap(),remoteAddr:c,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",u.remoteAddr),await this.upgrader.upgradeInbound(u,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",u.remoteAddr)}}function cb(r={}){return e=>new ab(e,r)}function lb(r){return r[Symbol.asyncIterator]!=null}function ws(r){if(lb(r))return(async()=>{for await(const e of r);})();for(const e of r);}const Ao=globalThis.CustomEvent??Event;async function*vc(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,s=new EventTarget,i=[];let o=fe(),a=fe(),c=!1,u,l=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const p of r){if(i.length===t&&(o=fe(),await o.promise),l)break;const m={done:!1};i.push(m),p().then(g=>{m.done=!0,m.ok=!0,m.value=g,s.dispatchEvent(new Ao("task-complete"))},g=>{m.done=!0,m.err=g,s.dispatchEvent(new Ao("task-complete"))})}c=!0,s.dispatchEvent(new Ao("task-complete"))}catch(p){u=p,s.dispatchEvent(new Ao("task-complete"))}});function d(){return n?i[0]?.done:!!i.find(p=>p.done)}function*h(){for(;i.length>0&&i[0].done;){const p=i[0];if(i.shift(),p.ok)yield p.value;else throw l=!0,o.resolve(),p.err;o.resolve()}}function*f(){for(;d();)for(let p=0;p<i.length;p++)if(i[p].done){const m=i[p];if(i.splice(p,1),p--,m.ok)yield m.value;else throw l=!0,o.resolve(),m.err;o.resolve()}}for(;;){if(d()||(a=fe(),await a.promise),u!=null||(n?yield*h():yield*f(),u!=null))throw u;if(c&&i.length===0)break}}const ub="0.1.0",db="id",hb="id/push",fb="1.0.0",pb="1.0.0",gb=1024*8,mb=32,yb=1e3;var bs;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new ut('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new ut('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(bs||(bs={}));const ht={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:gb,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:mb};function wb(r){if(r!=null&&r.length>0)try{return W(r)}catch{}}function bb(r,e){return e??r.userAgent}async function l3(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new ve("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:W(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=zt(s.publicKey);if(!as(c).equals(n.remotePeer))throw new ve("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord;const u=await Ut.openAndCertify(c,lt.DOMAIN);let l=lt.createFromProtobuf(u.payload);const d=eo(u.publicKey.toCID());if(!l.peerId.equals(d))throw new ve("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(l.peerId))throw new ve("signing key does not match remote PeerId");let h;try{h=await r.get(l.peerId)}catch(f){if(f.name!=="NotFoundError")throw f}if(h!=null&&(i.metadata=h.metadata,h.peerRecordEnvelope!=null)){const f=Ut.createFromProtobuf(h.peerRecordEnvelope),p=lt.createFromProtobuf(f.payload);p.seqNumber>=l.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,l.seqNumber),l=p,c=h.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=l.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:l.seqNumber,addresses:l.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=q(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=q(s.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const a={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>W(c)),observedAddr:s.observedAddr==null?void 0:W(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class u3{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??ht.timeout,this.maxInboundStreams=t.maxInboundStreams??ht.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??ht.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??ht.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??ht.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??ht.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??ht.protocolPrefix}/${ub}`,agentVersion:bb(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:q(this.host.agentVersion),ProtocolVersion:q(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class vb extends u3{connectionManager;concurrency;_push;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??ht.protocolPrefix}/${hb}/${pb}`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??ht.concurrency,this._push=Ba(this.sendPushMessage.bind(this),t.debounce??yb),(t.runOnSelfUpdate??ht.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",n=>{this.push().catch(s=>{this.log.error("error pushing updates to peers - %e",s)})})}[rt]=["@libp2p/identify-push"];async push(){this._push()}async sendPushMessage(){if(this.isStarted())try{const e=this.addressManager.getAddresses().map(l=>l.decapsulateCode(qe("p2p").code)),t=new lt({peerId:this.peerId,multiaddrs:e}),n=await Ut.seal(t,this.privateKey),s=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),o=F(i.metadata.get("AgentVersion")??q(this.host.agentVersion)),a=F(i.metadata.get("ProtocolVersion")??q(this.host.protocolVersion)),c=this;async function*u(){for(const l of c.connectionManager.getConnections())(await c.peerStore.get(l.remotePeer)).protocols.includes(c.protocol)&&(yield async()=>{let h;const f=AbortSignal.timeout(c.timeout);try{h=await l.newStream(c.protocol,{signal:f,runOnLimitedConnection:c.runOnLimitedConnection}),await nt(h,{maxDataLength:c.maxMessageSize}).pb(bs).write({listenAddrs:e.map(m=>m.bytes),signedPeerRecord:n.marshal(),protocols:s,agentVersion:o,protocolVersion:a},{signal:f}),await h.close({signal:f})}catch(p){c.log.error("could not push identify update to peer",p),h?.abort(p)}})}await ws(vc(u(),{concurrency:this.concurrency}))}catch(e){this.log.error("error pushing updates to peers - %e",e)}}async handleProtocol(e){const{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const s={signal:AbortSignal.timeout(this.timeout)},o=await nt(n,{maxDataLength:this.maxMessageSize}).pb(bs).read(s);await n.close(s),await l3(this.peerStore,this.events,this.log,t,o)}catch(s){this.log.error("received invalid message",s),n.abort(s);return}this.log.trace("handled push from %p",t.remotePeer)}}function Eb(r){try{for(const{code:e,value:t}of r.getComponents())if(t!=null&&e===$t)return iw("2000::/3",t)}catch{}return!1}function Fs(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Rn={},bh;function Sb(){return bh||(bh=1,function(){var r,e,t,n,s,i,o,a;a=function(c){var u,l,d,h;return u=(c&255<<24)>>>24,l=(c&255<<16)>>>16,d=(c&65280)>>>8,h=c&255,[u,l,d,h].join(".")},o=function(c){var u,l,d,h,f,p;for(u=[],d=h=0;h<=3&&c.length!==0;d=++h){if(d>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),f=p[0],l=p[1],c=c.substring(l),u.push(f)}if(c.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var u,l,d,h,f;for(h=0,u=10,l="9",d=0,c.length>1&&c[d]==="0"&&(c[d+1]==="x"||c[d+1]==="X"?(d+=2,u=16):"0"<=c[d+1]&&c[d+1]<="9"&&(d++,u=8,l="7")),f=d;d<c.length;){if("0"<=c[d]&&c[d]<=l)h=h*u+(t(c[d])-n)>>>0;else if(u===16)if("a"<=c[d]&&c[d]<="f")h=h*u+(10+t(c[d])-i)>>>0;else if("A"<=c[d]&&c[d]<="F")h=h*u+(10+t(c[d])-s)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");d++}if(d===f)throw new Error("empty octet");return[h,d]},r=function(){function c(u,l){var d,h,f;if(typeof u!="string")throw new Error("Missing `net' parameter");if(l||(f=u.split("/",2),u=f[0],l=f[1]),l||(l=32),typeof l=="string"&&l.indexOf(".")>-1){try{this.maskLong=o(l)}catch{throw new Error("Invalid mask: "+l)}for(d=h=32;h>=0;d=--h)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(l||l===0)this.bitmask=parseInt(l,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(u)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+l);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new c(u)),u instanceof c?this.contains(u.base)&&this.contains(u.broadcast||u.last):(o(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(u){return u==null&&(u=1),new c(a(this.netLong+this.size*u),this.mask)},c.prototype.forEach=function(u){var l,d,h;for(h=o(this.first),d=o(this.last),l=0;h<=d;)u(a(h),h,l),l++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),Rn.ip2long=o,Rn.long2ip=a,Rn.Netmask=r}.call(Rn)),Rn}var _b=Sb();const xb=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],Ab=xb.map(r=>new _b.Netmask(r));function S1(r){for(const e of Ab)if(e.contains(r))return!0;return!1}function Cb(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function kb(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return S1(s)}function Tb(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function Ib(r){const e=r.split(":"),t=e[e.length-1];return S1(t)}function Pb(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function En(r){if(dn(r))return S1(r);if(Cb(r))return kb(r);if(Tb(r))return Ib(r);if(u1(r))return Pb(r)}function d3(r){try{for(const{code:e}of r.getComponents())if(e!==Ms)return e===fs||e===$t}catch{}return!1}function Mi(r){try{if(!d3(r))return!1;const[[,e]]=r.stringTuples();return e==null?!1:En(e)??!1}catch{}return!0}class Rb extends u3{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??ht.protocolPrefix}/${db}/${fb}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??ht.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const s=n.detail;this.identify(s).catch(i=>{i.name!==Vu.name&&this.log.error("error during identify trigged by connection:open",i)})})}[rt]=["@libp2p/identify"];async _identify(e,t={}){let n;if(t.signal==null){const s=AbortSignal.timeout(this.timeout);t={...t,signal:s}}try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const i=await nt(n,{maxDataLength:this.maxMessageSize}).pb(bs).read(t);return await n.close(t),i}catch(s){throw n?.abort(s),s}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new ve("public key was missing from identify message");const a=zt(s),c=eo(a.toCID());if(!e.remotePeer.equals(c))throw new ve("identified peer does not match the expected peer");if(this.peerId.equals(c))throw new ve("identified peer is our own peer id?");return this.maybeAddObservedAddress(o),this.log("identify completed for peer %p and protocols %o",c,i),l3(this.peerStore,this.events,this.log,e,n)}maybeAddObservedAddress(e){const t=wb(e);if(t==null)return;if(this.log.trace("our observed address was %a",t),Mi(t)){this.log.trace("our observed address was private");return}const n=t.getComponents();if((n[0].code===$t||n[0].code===Ms&&n[1].code===$t)&&!Eb(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Pa.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t))}async handleProtocol(e){const{connection:t,stream:n}=e,s=AbortSignal.timeout(this.timeout);try{const i=await this.peerStore.get(this.peerId),o=this.addressManager.getAddresses().map(l=>l.decapsulateCode(qe("p2p").code));let a=i.peerRecordEnvelope;if(o.length>0&&a==null){const l=new lt({peerId:this.peerId,multiaddrs:o});a=(await Ut.seal(l,this.privateKey)).marshal().subarray()}let c=t.remoteAddr.bytes;ww.matches(t.remoteAddr)||(c=void 0),await nt(n).pb(bs).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Ft(this.privateKey.publicKey),listenAddrs:o.map(l=>l.bytes),signedPeerRecord:a,observedAddr:c,protocols:i.protocols},{signal:s}),await n.close({signal:s})}catch(i){this.log.error("could not respond to identify request",i),n.abort(i)}}}function Db(r={}){return e=>new Rb(e,r)}function Lb(r={}){return e=>new vb(e,r)}const Qc=32,Nb="1.0.0",Bb="ping",Mb="ipfs",Ob=1e4,Fb=2,Ub=1;class $b{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??Mb}/${Bb}/${Nb}`,this.timeout=t.timeout??Ob,this.maxInboundStreams=t.maxInboundStreams??Fb,this.maxOutboundStreams=t.maxOutboundStreams??Ub,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[rt]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,n=Date.now(),s=ba(t);let i=!1;Promise.resolve().then(async()=>{for(;;){const o=AbortSignal.timeout(this.timeout);o.addEventListener("abort",()=>{t?.abort(new nc("ping timeout"))});const a=await s.read({bytes:Qc,signal:o});await s.write(a,{signal:o}),i=!0}}).catch(o=>{i&&o.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,o),t?.abort(o))}).finally(()=>{const o=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,o);const a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t?.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);const n=Date.now(),s=un(Qc),i=await this.components.connectionManager.openConnection(e,t);let o;if(t.signal==null){const a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{o=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const a=ba(o),[,c]=await Promise.all([a.write(s,t),a.read({...t,bytes:Qc})]),u=Date.now()-n;if(!pe(s,c.subarray()))throw new r8(`Received wrong ping ack after ${u}ms`);return this.log("ping %p complete in %dms",i.remotePeer,u),u}catch(a){throw this.log.error("error while pinging %p",i.remotePeer,a),o?.abort(a),a}finally{o!=null&&await o.close(t)}}}function qb(r={}){return e=>new $b(e,r)}var Xe;(function(r){(function(n){n.FIN="FIN",n.STOP_SENDING="STOP_SENDING",n.RESET="RESET",n.FIN_ACK="FIN_ACK"})(r.Flag||(r.Flag={}));let e;(function(n){n[n.FIN=0]="FIN",n[n.STOP_SENDING=1]="STOP_SENDING",n[n.RESET=2]="RESET",n[n.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(n){n.codec=()=>ar(e)}(r.Flag||(r.Flag={}));let t;r.codec=()=>(t==null&&(t=ue((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.flag!=null&&(s.uint32(8),r.Flag.codec().encode(n.flag,s)),n.message!=null&&(s.uint32(18),s.bytes(n.message)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.flag=r.Flag.codec().decode(n);break}case 2:{o.message=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>le(n,r.codec()),r.decode=(n,s)=>ce(n,r.codec(),s)})(Xe||(Xe={}));const Vb=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"];Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890");const zb=2*1024*1024,Hb=30*1e3,h3=16*1024;function Kb(r=h3){const e=Ve(r-Ve(r)),t=1+Ve(Object.keys(Xe.Flag).length-1),n=1,s=r-e-t-n,i=Ve(s);return e+t+n+i}const Wb=Kb(),Gb=5e3,jb=5e3,Qb=3e4,f3="/webrtc",au="/webrtc-signaling/0.0.1";var vh=function(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,i;n<s;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))},Yb=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}(),Xb=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}(),Zb=function(){function r(e,t,n,s){this.name=e,this.version=t,this.os=n,this.bot=s,this.type="bot-device"}return r}(),Jb=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}(),ev=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}(),tv=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,rv=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,Eh=3,nv=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",tv]],Sh=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function sv(r){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new ev:typeof navigator<"u"?ov(navigator.userAgent):cv()}function iv(r){return r!==""&&nv.reduce(function(e,t){var n=t[0],s=t[1];if(e)return e;var i=s.exec(r);return!!i&&[n,i]},!1)}function ov(r){var e=iv(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new Jb;var s=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);s?s.length<Eh&&(s=vh(vh([],s,!0),lv(Eh-s.length),!0)):s=[];var i=s.join("."),o=av(r),a=rv.exec(r);return a&&a[1]?new Zb(t,i,o,a[1]):new Yb(t,i,o)}function av(r){for(var e=0,t=Sh.length;e<t;e++){var n=Sh[e],s=n[0],i=n[1],o=i.exec(r);if(o)return s}return null}function cv(){var r=typeof process<"u"&&process.version;return r?new Xb(process.version.slice(1)):null}function lv(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}class p3 extends Error{constructor(e){super(e),this.name="TimeoutError"}}let uv=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const _h=r=>globalThis.DOMException===void 0?new uv(r):new DOMException(r),xh=r=>{const e=r.reason===void 0?_h("This operation was aborted."):r.reason;return e instanceof Error?e:_h(e)};function Ec(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,a;const u=new Promise((l,d)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:f}=e;f.aborted&&d(xh(f)),a=()=>{d(xh(f))},f.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(l,d);return}const h=new p3;o=i.setTimeout.call(void 0,()=>{if(n){try{l(n())}catch(f){d(f)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?l():s instanceof Error?d(s):(h.message=s??`Promise timed out after ${t} milliseconds`,d(h))},t),(async()=>{try{l(await r)}catch(f){d(f)}})()}).finally(()=>{u.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return u.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},u}const Ah=sv(),g3=Ah!=null&&Ah.name==="firefox",m3=async function*(){},y3=async r=>{};function dv(r,e,t=Qb,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);const s=fe();let i=!1;r.bufferedAmountLowThreshold=0;const o=()=>{i||(n.log("%s drain channel closed before drain",e),s.resolve())};r.addEventListener("close",o,{once:!0}),r.addEventListener("bufferedamountlow",()=>{i=!0,r.removeEventListener("close",o),s.resolve()}),await Ec(s.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(s=>{n.log.error("error closing outbound stream",s)})}async function Ch(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??Vb.map(e=>({urls:[e]})),r}class kh{log;peerConnection;remoteAddr;timeline;metrics;source=m3();sink=y3;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection,s=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",s),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}class hv extends Lf{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){const t=e.onEnd;switch(e.onEnd=s=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Ec(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(i){this.log.error("error receiving FIN_ACK",i)}}).then(()=>{this.incomingData.end(),t?.(s)}).catch(i=>{this.log.error("error ending stream",i)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=cr(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??Hb,this.maxBufferedAmount=e.maxBufferedAmount??zb,this.maxMessageSize=(e.maxMessageSize??h3)-Wb,this.receiveFinAck=fe(),this.finAckTimeout=e.closeTimeout??Gb,this.openTimeout=e.openTimeout??jb,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new Fl("Unknown datachannel state")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(i=>{this.log.error("error closing stream after channel closed",i)})},this.channel.onerror=s=>{this.log.trace("received onerror event"),this.closeController.abort();const i=s.error;this.abort(i)},this.channel.onmessage=async s=>{const{data:i}=s;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))};const n=this;Promise.resolve().then(async()=>{for await(const s of wa(this.incomingData)){const i=n.processIncomingProtobuf(s);i!=null&&n.sourcePush(new Y(i))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new Fl(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const n=AbortSignal.timeout(this.openTimeout),s=tt([this.closeController.signal,n]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await rr(this.channel,"open",s)}finally{s.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){const n=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),s=tt([this.closeController.signal,n]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await rr(this.channel,"bufferedamountlow",s)}catch(i){throw n.aborted?new nc(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):i}finally{s.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(n){this.log.error("error while sending message",n)}}async sendData(e){const t=e.byteLength;for(e=e.sublist();e.byteLength>0;){const n=Math.min(e.byteLength,this.maxMessageSize),s=e.subarray(0,n),i=Xe.encode({message:s}),o=ya.single(i);this.log.trace("sending %d/%d bytes on channel",s.byteLength,t),await this._sendMessage(o),e.consume(n)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(Xe.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(Xe.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await De(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(n){this.log.error("failed to await FIN_ACK",n)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(Xe.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=Xe.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===Xe.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Xe.Flag.FIN_ACK).catch(n=>{this.log.error("error sending FIN_ACK immediately",n)})),t.flag===Xe.Flag.RESET&&this.reset(),t.flag===Xe.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===Xe.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());const t=Xe.encode({flag:e}),n=ya.single(t);try{return await this._sendMessage(n,!1),!0}catch(s){this.log.error("could not send flag %s - %e",e.toString(),s)}return!1}}function cu(r){const{channel:e,direction:t,handshake:n}=r;return new hv({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}class w3{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??f3,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}const s={},i=cu({channel:n,direction:"inbound",onEnd:o=>{s.onEnd(o)},logger:e.logger,...this.dataChannelOptions});s.stream=i,s.channel=n,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==i.id)},this.bufferedStreams.push(s)}}createStreamMuxer(e){return new fv(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class fv{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??f3,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}const s=n.id,i=cu({channel:n,direction:"inbound",onEnd:()=>{this.#e(i,n),this.log("incoming channel %s ended",s)},logger:this.logger,...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(i)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),this.#e(n.stream,n.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(n.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),dv(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(n=>n.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}source=m3();sink=y3;newStream(){const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const n=cu({channel:e,direction:"outbound",onEnd:()=>{this.#e(n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),this.metrics?.increment({outgoing_stream:!0}),n}}const b3=globalThis.RTCPeerConnection,v3=globalThis.RTCSessionDescription,pv=globalThis.RTCIceCandidate;class gv extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class _r extends gv{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}var xt;(function(r){(function(n){n.SDP_OFFER="SDP_OFFER",n.SDP_ANSWER="SDP_ANSWER",n.ICE_CANDIDATE="ICE_CANDIDATE"})(r.Type||(r.Type={}));let e;(function(n){n[n.SDP_OFFER=0]="SDP_OFFER",n[n.SDP_ANSWER=1]="SDP_ANSWER",n[n.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(n){n.codec=()=>ar(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=ue((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.data!=null&&(s.uint32(18),s.string(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.data=n.string();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>le(n,r.codec()),r.decode=(n,s)=>ce(n,r.codec(),s)})(xt||(xt={}));const E3=async(r,e,t)=>{try{const n=fe();for(mv(r,n);;){const s=await Promise.race([n.promise,e.read({signal:t.signal}).catch(()=>{})]);if(s==null){t.signal?.throwIfAborted();break}if(s.type!==xt.Type.ICE_CANDIDATE)throw new ve("ICE candidate message expected");const i=JSON.parse(s.data??"null");if(i===""||i===null){t.onProgress?.(new ie("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const o=new pv(i);t.log.trace("%s received new ICE candidate %o",t.direction,i);try{t.onProgress?.(new ie("webrtc:add-ice-candidate",o.candidate)),await r.addIceCandidate(o)}catch(a){t.log.error("%s bad candidate received",t.direction,i,a)}}}catch(n){if(t.log.error("%s error parsing ICE candidate",t.direction,n),t.signal?.aborted===!0&&_1(r)!=="connected")throw n}};function _1(r){return g3?r.iceConnectionState:r.connectionState}function mv(r,e){r[g3?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(_1(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new t0("RTCPeerConnection was closed"));break}}}async function yv({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:s,connectionManager:i,transportManager:o,log:a,logger:c,onProgress:u}){const{baseAddr:l}=vv(s);n?.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",l);const d=l.getPeerId();if(d==null)throw new L("Relay peer was missing");const h=i.getConnections(yt(d));let f,p=!1;h.length===0?(u?.(new ie("webrtc:dial-relay")),f=await o.dial(l,{signal:t,onProgress:u}),p=!0):(u?.(new ie("webrtc:reuse-relay-connection")),f=h[0]);try{u?.(new ie("webrtc:open-signaling-stream"));const m=await f.newStream(au,{signal:t,runOnLimitedConnection:!0}),g=nt(m).pb(xt),y=new b3(r),E=new w3({logger:c},{peerConnection:y,dataChannelOptions:e});try{const b=y.createDataChannel("init");y.onicecandidate=({candidate:x})=>{const T=JSON.stringify(x?.toJSON()??null);a.trace("initiator sending ICE candidate %o",x),g.write({type:xt.Type.ICE_CANDIDATE,data:T},{signal:t}).catch(v=>{a.error("error sending ICE candidate",v)})},y.onicecandidateerror=x=>{a.error("initiator ICE candidate error",x)};const _=await y.createOffer().catch(x=>{throw a.error("could not execute createOffer",x),new _r("Failed to set createOffer")});a.trace("initiator send SDP offer %s",_.sdp),u?.(new ie("webrtc:send-sdp-offer")),await g.write({type:xt.Type.SDP_OFFER,data:_.sdp},{signal:t}),await y.setLocalDescription(_).catch(x=>{throw a.error("could not execute setLocalDescription",x),new _r("Failed to set localDescription")}),u?.(new ie("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const w=await g.read({signal:t});if(w.type!==xt.Type.SDP_ANSWER)throw new _r("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",w.data);const k=new v3({type:"answer",sdp:w.data});return await y.setRemoteDescription(k).catch(x=>{throw a.error("could not execute setRemoteDescription",x),new _r("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),u?.(new ie("webrtc:read-ice-candidates")),await E3(y,g,{direction:"initiator",signal:t,log:a,onProgress:u}),a.trace("initiator connected, closing init channel"),b.close(),u?.(new ie("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await m.close({signal:t}),a.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:y,muxerFactory:E}}catch(b){throw a.error("outgoing signaling error",b),y.close(),m.abort(b),b}finally{y.onicecandidate=null,y.onicecandidateerror=null}}finally{if(p)try{await f.close({signal:t})}catch(m){f.abort(m)}}}const Th=he(Jf.matchers[0],G("p2p-circuit"));class x1 extends He{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(n=>Th.exactMatch(n)).map(n=>n.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof x1)).map(e=>e.getAddrs().filter(t=>Th.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function wv({peerConnection:r,stream:e,signal:t,connection:n,log:s}){s.trace("new inbound signaling stream");const i=nt(e).pb(xt);try{r.onicecandidate=({candidate:l})=>{const d=JSON.stringify(l?.toJSON()??null);s.trace("recipient sending ICE candidate %s",d),i.write({type:xt.Type.ICE_CANDIDATE,data:d},{signal:t}).catch(h=>{s.error("error sending ICE candidate",h)})},s.trace("recipient read SDP offer");const a=await i.read({signal:t});if(a.type!==xt.Type.SDP_OFFER)throw new _r(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);s.trace("recipient received SDP offer %s",a.data);const c=new v3({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(l=>{throw s.error("could not execute setRemoteDescription",l),new _r("Failed to set remoteDescription")});const u=await r.createAnswer().catch(l=>{throw s.error("could not execute createAnswer",l),new _r("Failed to create answer")});s.trace("recipient send SDP answer %s",u.sdp),await i.write({type:xt.Type.SDP_ANSWER,data:u.sdp},{signal:t}),await r.setLocalDescription(u).catch(l=>{throw s.error("could not execute setLocalDescription",l),new _r("Failed to set localDescription")}),s.trace("recipient read candidates until connected"),await E3(r,i,{direction:"recipient",signal:t,log:s})}catch(a){if(_1(r)!=="connected")throw s.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}const o=W(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",o),{remoteAddress:o}}class bv{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[$u]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[rt]=["@libp2p/transport"];[ns]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(au,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(au),this._started=!1}createListener(e){return new x1(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(La.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:s,muxerFactory:i}=await yv({rtcConfiguration:await Ch(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new kh(this.components,{peerConnection:s,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(s,o),a}async _onProtocol({connection:e,stream:t},n){const s=new b3(await Ch(this.init.rtcConfiguration)),i=new w3(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:o}=await wv({peerConnection:s,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});const a=new kh(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:o,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,muxerFactory:i,signal:n}),this._closeOnShutdown(s,a)}catch(o){throw this.log.error("incoming signaling error",o),s.close(),t.abort(o),o}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}function vv(r){const e=r.toString().split("/webrtc/");if(e.length!==2)throw new L("webrtc protocol was not present in multiaddr");if(!e[0].includes("/p2p-circuit"))throw new L("p2p-circuit protocol was not present in multiaddr");let t=W(e[0]);const s=W("/"+e[1]).getPeerId();if(s==null)throw new L("destination peer id was missing");const i=t.protos().pop();if(i===void 0)throw new L("invalid multiaddr");return i.name!=="p2p"&&(t=t.encapsulate(`/p2p/${s}`)),{baseAddr:t,peerId:yt(s)}}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const Ev="[object ArrayBuffer]";class ae{static isArrayBuffer(e){return Object.prototype.toString.call(e)===Ev}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=ae.toUint8Array(e),s=ae.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const s=new Uint8Array(n);let i=0;for(const o of t){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const Yc="string",Sv=/^[0-9a-f\s]+$/i,_v=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,xv=/^[a-zA-Z0-9-_]+$/;class Ih{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){const t=ae.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}}class Rt{static toString(e,t=!1){const n=ae.toArrayBuffer(e),s=new DataView(n);let i="";for(let o=0;o<n.byteLength;o+=2){const a=s.getUint16(o,t);i+=String.fromCharCode(a)}return i}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return n}}class _e{static isHex(e){return typeof e===Yc&&Sv.test(e)}static isBase64(e){return typeof e===Yc&&_v.test(e)}static isBase64Url(e){return typeof e===Yc&&xv.test(e)}static ToString(e,t="utf8"){const n=ae.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Rt.toString(n,!0);case"utf16":case"utf16be":return Rt.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Rt.fromString(e,!0);case"utf16":case"utf16be":return Rt.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=ae.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!_e.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!_e.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=_e.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return Ih.fromString(e);case"utf16":case"utf16be":return Rt.fromString(e);case"utf16le":case"usc2":return Rt.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=_e.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return Ih.toString(e);case"utf16":case"utf16be":return Rt.toString(e);case"utf16le":case"usc2":return Rt.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){const t=ae.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){const t=ae.toUint8Array(e);let n="";const s=t.length;for(let i=0;i<s;i++){const o=t[i];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!_e.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);n[s/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return Rt.toString(e,t)}static FromUtf16String(e,t=!1){return Rt.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}_e.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function vs(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function hn(r,e,t=-1){const n=t;let s=r,i=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(r<o){let c;if(n<0)c=new ArrayBuffer(a),i=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}const u=new Uint8Array(c);for(let l=a-1;l>=0;l--){const d=Math.pow(2,l*e);u[i-l-1]=Math.floor(s/d),s-=u[i-l-1]*d}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function lu(...r){let e=0,t=0;for(const i of r)e+=i.length;const n=new ArrayBuffer(e),s=new Uint8Array(n);for(const i of r)s.set(i,t),t+=i.length;return s}function S3(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;const n=vs(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=r[a];return i[0]&=127,vs(i,8)-n}function Av(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,a=hn(o,8,n),c=new Uint8Array(a);return c[0]|=128,a}let s=hn(e,8,n),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=a[c];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function Cv(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function at(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,s=new Array(n);for(let o=0;o<n;o++)s[o]="0";return s.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function Ma(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function A1(r){let e=0,t=0;for(let s=0;s<r.length;s++){const i=r[s];e+=i.byteLength}const n=new Uint8Array(e);for(let s=0;s<r.length;s++){const i=r[s];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function lr(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class C1{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return A1(this.items)}}const Xs=[new Uint8Array([1])],Ph="0123456789",Us="",It=new ArrayBuffer(0),k1=new Uint8Array(0),Oi="EndOfContent",_3="OCTET STRING",x3="BIT STRING";function ur(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var s;super(...n);const i=n[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?ae.toUint8Array(i.valueHex):k1}fromBER(n,s,i){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!lr(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",It)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:_e.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Sn{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Us,warnings:n=[],valueBeforeDecode:s=k1}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=ae.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:_e.ToHex(this.valueBeforeDecodeView)}}}Sn.NAME="baseBlock";class st extends Sn{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}st.NAME="valueBlock";class A3 extends ur(Sn){constructor({idBlock:e={}}={}){var t,n,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?ae.toUint8Array(e.valueHex):k1,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",It}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=hn(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=i[c]|128;a[o]=i[o-1]}return a.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)n[i+1]=s[i]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){const s=ae.toUint8Array(e);if(!lr(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,u=this.valueHexView=new Uint8Array(255),l=255;for(;i[c]&128;){if(u[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===l){l+=255;const h=new Uint8Array(l);for(let f=0;f<u.length;f++)h[f]=u[f];u=this.valueHexView=new Uint8Array(l)}}this.blockLength=c+1,u[c-1]=i[c]&127;const d=new Uint8Array(c);for(let h=0;h<c;h++)d[h]=u[h];u=this.valueHexView=new Uint8Array(c),u.set(d),this.blockLength<=9?this.tagNumber=vs(u,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}A3.NAME="identificationBlock";class C3 extends Sn{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){const s=ae.toUint8Array(e);if(!lr(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=s.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=vs(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const s=hn(this.length,8);if(s.byteLength>127)return this.error="Too big length",It;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)n[o+1]=i[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}C3.NAME="lengthBlock";const $={};class Qe extends Sn{constructor({name:e=Us,optional:t=!1,primitiveSchema:n,...s}={},i){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new A3(s),this.lenBlock=new C3(s),this.valueBlock=i?new i(s):new st(s)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const n=t||new C1;t||k3(this);const s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(i)}return t?It:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():_e.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=_e.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return Cv(t,n)}}Qe.NAME="BaseBlock";function k3(r){var e;if(r instanceof $.Constructed)for(const t of r.valueBlock.value)k3(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class T3 extends Qe{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Us,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}T3.NAME="BaseStringBlock";class I3 extends ur(st){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}I3.NAME="PrimitiveValueBlock";var P3;class R3 extends Qe{constructor(e={}){super(e,I3),this.idBlock.isConstructed=!1}}P3=R3;$.Primitive=P3;R3.NAME="PRIMITIVE";function kv(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function Sc(r,e=0,t=r.length){const n=e;let s=new Qe({},st);const i=new Sn;if(!lr(i,r,e,t))return s.error=i.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=a,t-=s.idBlock.blockLength,a=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=a,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=Qe;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=$.EndOfContent;break;case 1:c=$.Boolean;break;case 2:c=$.Integer;break;case 3:c=$.BitString;break;case 4:c=$.OctetString;break;case 5:c=$.Null;break;case 6:c=$.ObjectIdentifier;break;case 10:c=$.Enumerated;break;case 12:c=$.Utf8String;break;case 13:c=$.RelativeObjectIdentifier;break;case 14:c=$.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=$.Sequence;break;case 17:c=$.Set;break;case 18:c=$.NumericString;break;case 19:c=$.PrintableString;break;case 20:c=$.TeletexString;break;case 21:c=$.VideotexString;break;case 22:c=$.IA5String;break;case 23:c=$.UTCTime;break;case 24:c=$.GeneralizedTime;break;case 25:c=$.GraphicString;break;case 26:c=$.VisibleString;break;case 27:c=$.GeneralString;break;case 28:c=$.UniversalString;break;case 29:c=$.CharacterString;break;case 30:c=$.BmpString;break;case 31:c=$.DATE;break;case 32:c=$.TimeOfDay;break;case 33:c=$.DateTime;break;case 34:c=$.Duration;break;default:{const u=s.idBlock.isConstructed?new $.Constructed:new $.Primitive;u.idBlock=s.idBlock,u.lenBlock=s.lenBlock,u.warnings=s.warnings,s=u}}break;case 2:case 3:case 4:default:c=s.idBlock.isConstructed?$.Constructed:$.Primitive}return s=kv(s,c),a=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:a,result:s}}function Xc(r){if(!r.byteLength){const e=new Qe({},st);return e.error="Input buffer has zero length",{offset:-1,result:e}}return Sc(ae.toUint8Array(r).slice(),0,r.byteLength)}function Tv(r,e){return r?1:e}class Pr extends st{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const s=ae.toUint8Array(e);if(!lr(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;Tv(this.isIndefiniteForm,n)>0;){const o=Sc(s,i,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Oi)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Oi?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const n=t||new C1;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?It:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}Pr.NAME="ConstructedValueBlock";var D3;class $s extends Qe{constructor(e={}){super(e,Pr),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}D3=$s;$.Constructed=D3;$s.NAME="CONSTRUCTED";class L3 extends st{fromBER(e,t,n){return t}toBER(e){return It}}L3.override="EndOfContentValueBlock";var N3;class B3 extends Qe{constructor(e={}){super(e,L3),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}N3=B3;$.EndOfContent=N3;B3.NAME=Oi;var M3;class Oa extends Qe{constructor(e={}){super(e,st),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}M3=Oa;$.Null=M3;Oa.NAME="NULL";class O3 extends ur(st){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=ae.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const s=ae.toUint8Array(e);return lr(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,S3.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}O3.NAME="BooleanValueBlock";var F3;let U3=class extends Qe{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,O3),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};F3=U3;$.Boolean=F3;U3.NAME="BOOLEAN";class $3 extends ur(Pr){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Pr.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===Oi){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==_3)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?Pr.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}$3.NAME="OctetStringValueBlock";var T1;class qn extends Qe{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},$3),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){const o=Sc(i,0,i.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return $s.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=_e.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof T1&&e.push(t.valueBlock.valueHexView);return ae.concat(e)}}T1=qn;$.OctetString=T1;qn.NAME=_3;class q3 extends ur(Pr){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=Pr.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(const a of this.value){const c=a.constructor.NAME;if(c===Oi){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==x3)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const u=a.valueBlock;if(this.unusedBits>0&&u.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=u.unusedBits}return s}const i=ae.toUint8Array(e);if(!lr(this,i,t,n))return-1;const o=i.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=Sc(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return Pr.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return It;const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}q3.NAME="BitStringValueBlock";var V3;class z3 extends Qe{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},q3),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return $s.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),s=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}}V3=z3;$.BitString=V3;z3.NAME=x3;var H3;function Iv(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e);let i=n.slice(0);const o=i.length-1,a=s.slice(0),c=a.length-1;let u=0;const l=c<o?o:c;let d=0;for(let h=l;h>=0;h--,d++){switch(!0){case d<a.length:u=i[o-d]+a[c-d]+t[0];break;default:u=i[o-d]+t[0]}switch(t[0]=u/10,!0){case d>=i.length:i=lu(new Uint8Array([u%10]),i);break;default:i[o-d]=u%10}}return t[0]>0&&(i=lu(t,i)),i}function Rh(r){if(r>=Xs.length)for(let e=Xs.length;e<=r;e++){const t=new Uint8Array([0]);let n=Xs[e-1].slice(0);for(let s=n.length-1;s>=0;s--){const i=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=i[0]/10,n[s]=i[0]%10}t[0]>0&&(n=lu(t,n)),Xs.push(n)}return Xs[r]}function Pv(r,e){let t=0;const n=new Uint8Array(r),s=new Uint8Array(e),i=n.slice(0),o=i.length-1,a=s.slice(0),c=a.length-1;let u,l=0;for(let d=c;d>=0;d--,l++)switch(u=i[o-l]-a[c-l]-t,!0){case u<0:t=1,i[o-l]=u+10;break;default:t=0,i[o-l]=u}if(t>0)for(let d=o-c+1;d>=0;d--,l++)if(u=i[o-l]-t,u<0)t=1,i[o-l]=u+10;else{t=0,i[o-l]=u;break}return i.slice()}class I1 extends ur(st){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=S3.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(Av(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){const i=this.fromBER(e,t,n);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,s;const i=this.valueHexView;let o="",a=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let u=0;u<8;u++){if((s&1)===1)switch(n){case e:t=Pv(Rh(n),t),o="-";break;default:t=Iv(t,Rh(n))}n++,s>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=Ph.charAt(t[c]));return a===!1&&(o+=Ph.charAt(0)),o}}H3=I1;I1.NAME="IntegerValueBlock";Object.defineProperty(H3.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var vi;class Xn extends Qe{constructor(e={}){super(e,I1),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Ma(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Ma();const t=BigInt(e),n=new C1,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(_e.FromHex(s));if(t<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const u=BigInt(`0x${_e.ToHex(a)}`)+t,l=ae.toUint8Array(_e.FromHex(u.toString(16)));l[0]|=128,n.write(l)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new vi({valueHex:n.final()})}convertToDER(){const e=new vi({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new vi({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}vi=Xn;$.Integer=vi;Xn.NAME="INTEGER";var K3;class W3 extends Xn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}K3=W3;$.Enumerated=K3;W3.NAME="ENUMERATED";class uu extends ur(st){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const s=ae.toUint8Array(e);if(!lr(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=vs(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Ma();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=hn(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",It;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n}toString(){let e="";if(this.isHexOnly)e=_e.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}uu.NAME="sidBlock";class G3 extends st{constructor({value:e=Us,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new uu;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,It;t.push(s)}return A1(t)}fromString(e){this.value=[];let t=0,n=0,s="",i=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+a,i=!1}else{const o=new uu;if(s>Number.MAX_SAFE_INTEGER){Ma();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}G3.NAME="ObjectIdentifierValueBlock";var j3;class Hr extends Qe{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,G3),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}j3=Hr;$.ObjectIdentifier=j3;Hr.NAME="OBJECT IDENTIFIER";class du extends ur(Sn){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const s=ae.toUint8Array(e);if(!lr(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=i[a]&127,this.blockLength++,(i[a]&128)!==0);a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=vs(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=hn(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",It;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=_e.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}du.NAME="relativeSidBlock";class Q3 extends st{constructor({value:e=Us,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new du;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const n=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,It;n.push(i)}return A1(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;const i=new du;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Q3.NAME="RelativeObjectIdentifierValueBlock";var Y3;class X3 extends Qe{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Q3),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Y3=X3;$.RelativeObjectIdentifier=Y3;X3.NAME="RelativeObjectIdentifier";var Z3;class Et extends $s{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}Z3=Et;$.Sequence=Z3;Et.NAME="SEQUENCE";var J3;let e4=class extends $s{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};J3=e4;$.Set=J3;e4.NAME="SET";class t4 extends ur(st){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Us}toJSON(){return{...super.toJSON(),value:this.value}}}t4.NAME="StringValueBlock";class r4 extends t4{}r4.NAME="SimpleStringValueBlock";class dt extends T3{constructor({...e}={}){super(e,r4)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,ae.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}}dt.NAME="SIMPLE STRING";class n4 extends dt{fromBuffer(e){this.valueBlock.valueHexView=ae.toUint8Array(e);try{this.valueBlock.value=_e.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=_e.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(_e.FromUtf8String(e)),this.valueBlock.value=e}}n4.NAME="Utf8StringValueBlock";var s4;class _n extends n4{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}s4=_n;$.Utf8String=s4;_n.NAME="UTF8String";class i4 extends dt{fromBuffer(e){this.valueBlock.value=_e.ToUtf16String(e),this.valueBlock.valueHexView=ae.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(_e.FromUtf16String(e))}}i4.NAME="BmpStringValueBlock";var o4;class a4 extends i4{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}o4=a4;$.BmpString=o4;a4.NAME="BMPString";class c4 extends dt{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=hn(e.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)n[s*4+c+a]=o[c]}this.valueBlock.value=e}}c4.NAME="UniversalStringValueBlock";var l4;class u4 extends c4{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}l4=u4;$.UniversalString=l4;u4.NAME="UniversalString";var d4;class h4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}d4=h4;$.NumericString=d4;h4.NAME="NumericString";var f4;class p4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}f4=p4;$.PrintableString=f4;p4.NAME="PrintableString";var g4;class m4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}g4=m4;$.TeletexString=g4;m4.NAME="TeletexString";var y4;class w4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}y4=w4;$.VideotexString=y4;w4.NAME="VideotexString";var b4;class v4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}b4=v4;$.IA5String=b4;v4.NAME="IA5String";var E4;class S4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}E4=S4;$.GraphicString=E4;S4.NAME="GraphicString";var _4;class P1 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}_4=P1;$.VisibleString=_4;P1.NAME="VisibleString";var x4;class A4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}x4=A4;$.GeneralString=x4;A4.NAME="GeneralString";var C4;class k4 extends dt{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}C4=k4;$.CharacterString=C4;k4.NAME="CharacterString";var T4;class R1 extends P1{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,ae.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=at(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=at(this.month,2),t[2]=at(this.day,2),t[3]=at(this.hour,2),t[4]=at(this.minute,2),t[5]=at(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}T4=R1;$.UTCTime=T4;R1.NAME="UTCTime";var I4;class P4 extends R1{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",s="",i=0,o,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const d=new Number(e[e.length-1]);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let d=1,h=n.indexOf("+"),f="";if(h===-1&&(h=n.indexOf("-"),d=-1),h!==-1){if(f=n.substring(h+1),n=n.substring(0,h),f.length!==2&&f.length!==4)throw new Error("Wrong input string for conversion");let p=parseInt(f.substring(0,2),10);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");if(a=d*p,f.length===4){if(p=parseInt(f.substring(2,4),10),isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");c=d*p}}}let u=n.indexOf(".");if(u===-1&&(u=n.indexOf(",")),u!==-1){const d=new Number(`0${n.substring(u)}`);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");i=d.valueOf(),s=n.substring(0,u)}else s=n;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,u!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let d=60*i;this.minute=Math.floor(d),d=60*(d-this.minute),this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){let d=60*i;this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,u!==-1){const d=1e3*i;this.millisecond=Math.floor(d)}break;default:throw new Error("Wrong input string for conversion")}const l=o.exec(s);if(l===null)throw new Error("Wrong input string for conversion");for(let d=1;d<l.length;d++)switch(d){case 1:this.year=parseInt(l[d],10);break;case 2:this.month=parseInt(l[d],10);break;case 3:this.day=parseInt(l[d],10);break;case 4:this.hour=parseInt(l[d],10)+a;break;case 5:this.minute=parseInt(l[d],10)+c;break;case 6:this.second=parseInt(l[d],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=d.getUTCFullYear(),this.month=d.getUTCMonth(),this.day=d.getUTCDay(),this.hour=d.getUTCHours(),this.minute=d.getUTCMinutes(),this.second=d.getUTCSeconds(),this.millisecond=d.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(at(this.year,4)),t.push(at(this.month,2)),t.push(at(this.day,2)),t.push(at(this.hour,2)),t.push(at(this.minute,2)),t.push(at(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(at(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}I4=P4;$.GeneralizedTime=I4;P4.NAME="GeneralizedTime";var R4;class D4 extends _n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}R4=D4;$.DATE=R4;D4.NAME="DATE";var L4;class N4 extends _n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}L4=N4;$.TimeOfDay=L4;N4.NAME="TimeOfDay";var B4;class M4 extends _n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}B4=M4;$.DateTime=B4;M4.NAME="DateTime";var O4;class F4 extends _n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}O4=F4;$.Duration=O4;F4.NAME="Duration";var U4;class $4 extends _n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}U4=$4;$.TIME=U4;$4.NAME="TIME";const jt="/",q4=new TextEncoder().encode(jt),Co=q4[0];class ke{_buf;constructor(e,t){if(typeof e=="string")this._buf=q(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Co)throw new Error("Invalid key")}toString(e="utf8"){return F(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new ke(e.join(jt))}static random(){return new ke(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new ke(e):typeof e.uint8Array=="function"?new ke(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=q4),this._buf[0]!==Co){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Co,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Co;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return ke.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(jt).slice(1)}type(){return Rv(this.baseNamespace())}name(){return Dv(this.baseNamespace())}instance(e){return new ke(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(jt)||(e+=jt),e+=this.type(),new ke(e)}parent(){const e=this.list();return e.length===1?new ke(jt):new ke(e.slice(0,-1).join(jt))}child(e){return this.toString()===jt?e:e.toString()===jt?this:new ke(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return ke.withNamespaces([...this.namespaces(),...Lv(e.map(t=>t.namespaces()))])}}function Rv(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function Dv(r){const e=r.split(":");return e[e.length-1]}function Lv(r){return[].concat(...r)}function Nv(r){return e=>new bv(e,r)}const Bv=[qe("tcp").code,qe("dns").code,qe("dnsaddr").code,qe("dns4").code,qe("dns6").code];function Dh(r){return V4("sni",r)?.[1]}function Lh(r){const e=V4("tcp",r)?.[1];return e==null?"":`:${e}`}function V4(r,e){let t;try{t=qe(r).code}catch{return}for(const[n,s]of e)if(n===t&&s!=null)return[n,s]}function Nh(r){return r.some(([e,t])=>e===qe("tls").code)}function vt(r,e,t){const n=z4[qe(r).name];if(n==null)throw new Error(`Can't interpret protocol ${qe(r).name}`);const s=n(e,t);return r===qe("ip6").code?`[${s}]`:s}const z4={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${vt(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${vt(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${vt(t[0],t[1]??"",e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${vt(t[0],t[1]??"",e)}`},http:(r,e)=>{const t=Nh(e),n=Dh(e),s=Lh(e);if(t&&n!=null)return`https://${n}${s}`;const i=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=vt(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${i}${a}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=vt(t[0],t[1]??"",e),s=decodeURIComponent(r);return`${n}/${s}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return vt(t[0],t[1]??"",e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return vt(t[0],t[1]??"",e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=vt(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=Nh(e),n=Dh(e),s=Lh(e);if(t&&n!=null)return`wss://${n}${s}`;const i=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=vt(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${i}${a}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=vt(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`}};function Mv(r,e){const n=W(r).stringTuples(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=qe(s[0]),o=z4[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let a=o(s[1]??"",n);return Bv.includes(s[0])&&(a=a.replace(/^.*:\/\//,""),s[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}const Ov=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",i)}function s(){n(),e()}function i(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",i)})},Fv=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const s of n){try{await Ov(r)}catch(i){if(i.message==="socket closed")break;throw i}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(s)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((s,i)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{r.close()})})});var Dn={},Zs={},Bh;function Uv(){if(Bh)return Zs;Bh=1,Object.defineProperty(Zs,"__esModule",{value:!0});class r{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(n){if(this.isStopped)return;const s={value:n,done:!1};if(this.pullQueue.length){const i=this.pullQueue.shift();i&&i.resolve(s)}else this.pushQueue.push(Promise.resolve(s)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const n of this.pullQueue)n.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(n){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const s of this.pullQueue)s.reject(n);this.pullQueue.length=0}else{const s=Promise.reject(n);s.catch(()=>{}),this.pushQueue.push(s)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:n=>{const s=this.pushQueue.shift();return s?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),s):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((i,o)=>{this.pullQueue.push({resolve:i,reject:o})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class e{constructor(n,{highWaterMark:s=100,lowWaterMark:i=1}={}){const o=new r;o.highWaterMark=s,o.lowWaterMark=i,o.removeCallback=n({push:a=>o.push(a),stop:()=>o.stop(),fail:a=>o.fail(a),on:(a,c)=>{o.eventHandlers[a]=c}})||(()=>{}),this[Symbol.asyncIterator]=()=>o[Symbol.asyncIterator](),Object.freeze(this)}}return Zs.EventIterator=e,Zs.default=e,Zs}var Mh;function $v(){if(Mh)return Dn;Mh=1,Object.defineProperty(Dn,"__esModule",{value:!0});const r=Uv();Dn.EventIterator=r.EventIterator;function e(t,n,s){return new r.EventIterator(({push:i})=>(this.addEventListener(t,i,n),()=>this.removeEventListener(t,i,n)),s)}return Dn.subscribe=e,Dn.default=r.EventIterator,Dn}var qv=$v();function Oh(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}const Vv=r=>{r.binaryType="arraybuffer";const e=async()=>{await new Promise((i,o)=>{if(n){i();return}if(s!=null){o(s);return}const a=l=>{r.removeEventListener("open",c),r.removeEventListener("error",u),l()},c=()=>{a(i)},u=l=>{a(()=>{o(l.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",u)})},t=async function*(){const i=new qv.EventIterator(({push:o,stop:a,fail:c})=>{const u=d=>{let h=null;typeof d.data=="string"&&(h=q(d.data)),Oh(d.data)&&(h=new Uint8Array(d.data)),d.data instanceof Uint8Array&&(h=d.data),h!=null&&o(h)},l=d=>{c(d.error??new Error("Socket error"))};return r.addEventListener("message",u),r.addEventListener("error",l),r.addEventListener("close",a),()=>{r.removeEventListener("message",u),r.removeEventListener("error",l),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of i)yield Oh(o)?new Uint8Array(o):o}();let n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",i=>{n||(s=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},zv=(r,e)=>{e=e??{};const t=Vv(r);let n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,s=parseInt(o.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:Fv(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}},Hv=WebSocket,Kv={"http:":"ws:","https:":"wss:"},Fh="ws:",Wv=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??Fh}${r}`),r.startsWith("/")&&e!=null){const n=e.protocol??Fh,s=e.host,i=e.port!=null&&s?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${s}${i}${r}`}const t=new URL(r);for(const[n,s]of Object.entries(Kv))t.protocol===n&&(t.protocol=s);return t};function Gv(r,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const n=Wv(r,t),s=new Hv(n.toString(),e.websocket);return zv(s,e)}function H4(r){return r.filter(e=>Ra.exactMatch(e)||Ni.exactMatch(e))}function jv(){throw new Error("WebSocket Servers can not be created in the browser!")}const Qv=500;function Yv(r,e,t){const n=t.logger.forComponent("libp2p:websockets:maconn"),s=t.metrics,i=t.metricPrefix??"",o={log:n,async sink(a){try{await r.sink(async function*(){for await(const c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){const c=Date.now();if(a.signal==null){const l=AbortSignal.timeout(Qv);a={...a,signal:l}}const u=()=>{const{host:l,port:d}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",l,d,Date.now()-c),this.abort(new Rr("Socket close timeout"))};a.signal?.addEventListener("abort",u);try{await r.close()}catch(l){n.error("error closing WebSocket gracefully",l),this.abort(l)}finally{a.signal?.removeEventListener("abort",u),o.timeline.close=Date.now()}},abort(a){const{host:c,port:u}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,u,a),r.destroy(),o.timeline.close=Date.now(),s?.increment({[`${i}error`]:!0})}};return r.socket.addEventListener("close",()=>{s?.increment({[`${i}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}let Xv=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[$u]=!0;[Symbol.toStringTag]="@libp2p/websockets";[rt]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=await this._connect(e,t),s=Yv(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s,t);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const s=fe(),i=Gv(Mv(e),this.init);i.socket.addEventListener("error",()=>{const o=new t0(`Could not connect to ${e.toString()}`);this.log.error("connection error:",o),this.metrics?.dialerEvents.increment({error:!0}),s.reject(o)});try{t.onProgress?.(new ie("websockets:open-connection")),await De(Promise.race([i.connected(),s.promise]),t.signal)}catch(o){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),o}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return jv({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):H4(e)}dialFilter(e){return this.listenFilter(e)}};function Zv(r={}){return e=>new Xv(e,r)}function Fa(r){if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}const{hasOwnProperty:K4}=Object.prototype,{propertyIsEnumerable:Jv}=Object,Es=(r,e,t)=>{Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},eE=void 0,Uh={concatArrays:!1,ignoreUndefined:!1},_c=r=>{const e=[];for(const t in r)K4.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)Jv.call(r,n)&&e.push(n)}return e};function qs(r){return Array.isArray(r)?tE(r):Fa(r)?rE(r):r}function tE(r){const e=r.slice(0,0);return _c(r).forEach(t=>{Es(e,t,qs(r[t]))}),e}function rE(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return _c(r).forEach(t=>{Es(e,t,qs(r[t]))}),e}const W4=(r,e,t,n)=>(t.forEach(s=>{typeof e[s]>"u"&&n.ignoreUndefined||(s in r&&r[s]!==Object.getPrototypeOf(r)?Es(r,s,hu(r[s],e[s],n)):Es(r,s,qs(e[s])))}),r),nE=(r,e,t)=>{let n=r.slice(0,0),s=0;return[r,e].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)K4.call(i,a)&&(o.push(String(a)),i===r?Es(n,s++,i[a]):Es(n,s++,qs(i[a])));n=W4(n,i,_c(i).filter(a=>!o.includes(a)),t)}),n};function hu(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?nE(r,e,t):!Fa(e)||!Fa(r)?qs(e):W4(r,e,_c(e),t)}function D1(...r){const e=hu(qs(Uh),this!==eE&&this||{},Uh);let t={_:{}};for(const n of r)if(n!==void 0){if(!Fa(n))throw new TypeError("`"+n+"` is not an Option Object");t=hu(t,{_:n},e)}return t._}var Zc={exports:{}},$h;function sE(){return $h||($h=1,function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,u,l){this.fn=c,this.context=u,this.once=l||!1}function i(c,u,l,d,h){if(typeof l!="function")throw new TypeError("The listener must be a function");var f=new s(l,d||c,h),p=t?t+u:u;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],f]:c._events[p].push(f):(c._events[p]=f,c._eventsCount++),c}function o(c,u){--c._eventsCount===0?c._events=new n:delete c._events[u]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var u=[],l,d;if(this._eventsCount===0)return u;for(d in l=this._events)e.call(l,d)&&u.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(l)):u},a.prototype.listeners=function(u){var l=t?t+u:u,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,p=new Array(f);h<f;h++)p[h]=d[h].fn;return p},a.prototype.listenerCount=function(u){var l=t?t+u:u,d=this._events[l];return d?d.fn?1:d.length:0},a.prototype.emit=function(u,l,d,h,f,p){var m=t?t+u:u;if(!this._events[m])return!1;var g=this._events[m],y=arguments.length,E,b;if(g.fn){switch(g.once&&this.removeListener(u,g.fn,void 0,!0),y){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,l),!0;case 3:return g.fn.call(g.context,l,d),!0;case 4:return g.fn.call(g.context,l,d,h),!0;case 5:return g.fn.call(g.context,l,d,h,f),!0;case 6:return g.fn.call(g.context,l,d,h,f,p),!0}for(b=1,E=new Array(y-1);b<y;b++)E[b-1]=arguments[b];g.fn.apply(g.context,E)}else{var _=g.length,w;for(b=0;b<_;b++)switch(g[b].once&&this.removeListener(u,g[b].fn,void 0,!0),y){case 1:g[b].fn.call(g[b].context);break;case 2:g[b].fn.call(g[b].context,l);break;case 3:g[b].fn.call(g[b].context,l,d);break;case 4:g[b].fn.call(g[b].context,l,d,h);break;default:if(!E)for(w=1,E=new Array(y-1);w<y;w++)E[w-1]=arguments[w];g[b].fn.apply(g[b].context,E)}}return!0},a.prototype.on=function(u,l,d){return i(this,u,l,d,!1)},a.prototype.once=function(u,l,d){return i(this,u,l,d,!0)},a.prototype.removeListener=function(u,l,d,h){var f=t?t+u:u;if(!this._events[f])return this;if(!l)return o(this,f),this;var p=this._events[f];if(p.fn)p.fn===l&&(!h||p.once)&&(!d||p.context===d)&&o(this,f);else{for(var m=0,g=[],y=p.length;m<y;m++)(p[m].fn!==l||h&&!p[m].once||d&&p[m].context!==d)&&g.push(p[m]);g.length?this._events[f]=g.length===1?g[0]:g:o(this,f)}return this},a.prototype.removeAllListeners=function(u){var l;return u?(l=t?t+u:u,this._events[l]&&o(this,l)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a}(Zc)),Zc.exports}var iE=sE();const oE=Fs(iE);function aE(r,e,t){let n=0,s=r.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}let cE=class{#e=[];enqueue(e,t){t={priority:0,...t};const n={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(n);return}const s=aE(this.#e,n,(i,o)=>o.priority-i.priority);this.#e.splice(s,0,n)}setPriority(e,t){const n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};class lE extends oE{#e;#r;#t=0;#f;#a;#p=0;#s;#c;#n;#g;#i=0;#l;#o;#m;#b=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:cE,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#r=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#f=e.intervalCap,this.#a=e.interval,this.#n=new e.queueClass,this.#g=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#m=e.throwOnTimeout===!0,this.#o=e.autoStart===!1}get#v(){return this.#r||this.#t<this.#f}get#E(){return this.#i<this.#l}#S(){this.#i--,this.#u(),this.emit("next")}#_(){this.#w(),this.#y(),this.#c=void 0}get#x(){const e=Date.now();if(this.#s===void 0){const t=this.#p-e;if(t<0)this.#t=this.#e?this.#i:0;else return this.#c===void 0&&(this.#c=setTimeout(()=>{this.#_()},t)),!0}return!1}#u(){if(this.#n.size===0)return this.#s&&clearInterval(this.#s),this.#s=void 0,this.emit("empty"),this.#i===0&&this.emit("idle"),!1;if(!this.#o){const e=!this.#x;if(this.#v&&this.#E){const t=this.#n.dequeue();return t?(this.emit("active"),t(),e&&this.#y(),!0):!1}}return!1}#y(){this.#r||this.#s!==void 0||(this.#s=setInterval(()=>{this.#w()},this.#a),this.#p=Date.now()+this.#a)}#w(){this.#t===0&&this.#i===0&&this.#s&&(clearInterval(this.#s),this.#s=void 0),this.#t=this.#e?this.#i:0,this.#d()}#d(){for(;this.#u(););}get concurrency(){return this.#l}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#l=e,this.#d()}async#A(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){this.#n.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#b++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#m,...t},new Promise((n,s)=>{this.#n.enqueue(async()=>{this.#i++,this.#t++;try{t.signal?.throwIfAborted();let i=e({signal:t.signal});t.timeout&&(i=Ec(Promise.resolve(i),{milliseconds:t.timeout})),t.signal&&(i=Promise.race([i,this.#A(t.signal)]));const o=await i;n(o),this.emit("completed",o)}catch(i){if(i instanceof p3&&!t.throwOnTimeout){n();return}s(i),this.emit("error",i)}finally{this.#S()}},t),this.emit("add"),this.#u()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#o?(this.#o=!1,this.#d(),this):this}pause(){this.#o=!0}clear(){this.#n=new this.#g}async onEmpty(){this.#n.size!==0&&await this.#h("empty")}async onSizeLessThan(e){this.#n.size<e||await this.#h("next",()=>this.#n.size<e)}async onIdle(){this.#i===0&&this.#n.size===0||await this.#h("idle")}async#h(e,t){return new Promise(n=>{const s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#n.size}sizeBy(e){return this.#n.filter(e).length}get pending(){return this.#i}get isPaused(){return this.#o}}function G4(r){const e=[Nr.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const j4=60;function Q4(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Nr[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Nr[e.type],TTL:e.TTL??e.ttl??j4,data:e.data instanceof Uint8Array?F(e.data):e.data}))}}const uE=4;function qh(r,e={}){const t=new lE({concurrency:e.queryConcurrency??uE});return async(n,s={})=>{const i=new URLSearchParams;i.set("name",n),G4(s.types).forEach(a=>{i.append("type",Nr[a])}),s.onProgress?.(new ie("dns:query",{detail:n}));const o=await t.add(async()=>{const a=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(a.status!==200)throw new Error(`Unexpected HTTP status: ${a.status} - ${a.statusText}`);const c=Q4(await a.json());return s.onProgress?.(new ie("dns:response",{detail:c})),c},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function dE(){return[qh("https://cloudflare-dns.com/dns-query"),qh("https://dns.google/resolve")]}var Jc,Vh;function hE(){return Vh||(Vh=1,Jc=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}),Jc}var fE=hE();const pE=Fs(fE);class gE{lru;constructor(e){this.lru=pE(e)}get(e,t){let n=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){n=!1;break}s.push(...o)}if(n)return Q4({answers:s})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Nr[a.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??j4)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function mE(r){return new gE(r)}const yE=1e3;let wE=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=mE(e.cacheSize??yE),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=dE())}async query(e,t={}){const n=G4(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new ie("dns:cache",{detail:s})),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const u=await c(e,{...t,types:n});for(const l of u.Answer)this.cache.add(e,l);return u}catch(u){a.push(u),t.onProgress?.(new ie("dns:error",{detail:u}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var Nr;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Nr||(Nr={}));function bE(r={}){return new wE(r)}const it=-1,fu={},vE={},EE=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,it,"ip6zone"],[43,8,"ipcidr"],[53,it,"dns",!0],[54,it,"dns4",!0],[55,it,"dns6",!0],[56,it,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,it,"unix",!1,!0],[421,it,"ipfs"],[421,it,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,it,"garlic64"],[448,0,"tls"],[449,it,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,it,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,it,"http-path"],[777,it,"memory"]];EE.forEach(r=>{const e=SE(...r);vE[e.code]=e,fu[e.name]=e});function SE(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function _E(r){{if(fu[r]!=null)return fu[r];throw new Error(`no protocol with name: ${r}`)}}const xE=32,{code:AE}=_E("dnsaddr");class CE extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const Y4=async function(e,t={}){const n=t.maxRecursiveDepth??xE;if(n===0)throw new CE("Max recursive depth reached");const[,s]=e.stringTuples().find(([u])=>u===AE)??[],o=await(t?.dns??bE()).query(`_dnsaddr.${s}`,{signal:t?.signal,types:[Nr.TXT]}),a=e.getPeerId(),c=[];for(const u of o.Answer){const l=u.data.replace(/["']/g,"").trim().split("=")[1];if(l==null||a!=null&&!l.includes(a))continue;const d=W(l);if(l.startsWith("/dnsaddr")){const h=await d.resolve({...t,maxRecursiveDepth:n-1});c.push(...h.map(f=>f.toString()))}else c.push(d.toString())}return c},kE={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:Y4}},transportManager:{faultTolerance:xi.FATAL_ALL}};async function TE(r){const e=D1(kE,r);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new L("Private network is enforced, but no protector was provided");return e}const Ss=1e3,_s=Ss*60,xs=_s*60,fn=xs*24,IE=fn*7,PE=fn*365.25;function X4(r,e){try{if(typeof r=="string"&&r.length>0)return RE(r);if(typeof r=="number"&&isFinite(r))return e?.long?LE(r):DE(r);throw new Error("Value is not a string or number.")}catch(t){const n=NE(t)?`${t.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function RE(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!e)return NaN;const t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*PE;case"weeks":case"week":case"w":return t*IE;case"days":case"day":case"d":return t*fn;case"hours":case"hour":case"hrs":case"hr":case"h":return t*xs;case"minutes":case"minute":case"mins":case"min":case"m":return t*_s;case"seconds":case"second":case"secs":case"sec":case"s":return t*Ss;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}function DE(r){const e=Math.abs(r);return e>=fn?`${Math.round(r/fn)}d`:e>=xs?`${Math.round(r/xs)}h`:e>=_s?`${Math.round(r/_s)}m`:e>=Ss?`${Math.round(r/Ss)}s`:`${r}ms`}function LE(r){const e=Math.abs(r);return e>=fn?ko(r,e,fn,"day"):e>=xs?ko(r,e,xs,"hour"):e>=_s?ko(r,e,_s,"minute"):e>=Ss?ko(r,e,Ss,"second"):`${r} ms`}function ko(r,e,t,n){const s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function NE(r){return typeof r=="object"&&r!==null&&"message"in r}function BE(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=X4,t.destroy=u,Object.keys(r).forEach(l=>{t[l]=r[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let d=0;for(let h=0;h<l.length;h++)d=(d<<5)-d+l.charCodeAt(h),d|=0;return t.colors[Math.abs(d)%t.colors.length]}t.selectColor=e;function t(l){let d,h=null,f,p;function m(...g){if(!m.enabled)return;const y=m,E=Number(new Date),b=E-(d||E);y.diff=b,y.prev=d,y.curr=E,d=E,g[0]=t.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let _=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(k,x)=>{if(k==="%%")return"%";_++;const T=t.formatters[x];if(typeof T=="function"){const v=g[_];k=T.call(y,v),g.splice(_,1),_--}return k}),t.formatArgs.call(y,g),(y.log||t.log).apply(y,g)}return m.namespace=l,m.useColors=t.useColors(),m.color=t.selectColor(l),m.extend=n,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(f!==t.namespaces&&(f=t.namespaces,p=t.enabled(l)),p),set:g=>{h=g}}),typeof t.init=="function"&&t.init(m),m}function n(l,d){const h=t(this.namespace+(typeof d>"u"?":":d)+l);return h.log=this.log,h}function s(l){t.save(l),t.namespaces=l,t.names=[],t.skips=[];let d;const h=(typeof l=="string"?l:"").split(/[\s,]+/),f=h.length;for(d=0;d<f;d++)h[d]&&(l=h[d].replace(/\*/g,".*?"),l[0]==="-"?t.skips.push(new RegExp("^"+l.substr(1)+"$")):t.names.push(new RegExp("^"+l+"$")))}function i(){const l=[...t.names.map(a),...t.skips.map(a).map(d=>"-"+d)].join(",");return t.enable(""),l}function o(l){if(l[l.length-1]==="*")return!0;let d,h;for(d=0,h=t.skips.length;d<h;d++)if(t.skips[d].test(l))return!1;for(d=0,h=t.names.length;d<h;d++)if(t.names[d].test(l))return!0;return!1}function a(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function c(l){return l instanceof Error?l.stack??l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var ME={};const Ua=zE(),OE=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function FE(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function UE(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+X4(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}const $E=console.debug??console.log??(()=>{});function qE(r){try{r?Ua?.setItem("debug",r):Ua?.removeItem("debug")}catch{}}function VE(){let r;try{r=Ua?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=ME.DEBUG),r}function zE(){try{return localStorage}catch{}}function HE(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const ct=BE({formatArgs:UE,save:qE,load:VE,useColors:FE,setupFormatters:HE,colors:OE,storage:Ua,log:$E});ct.formatters.b=r=>r==null?"undefined":Ae.baseEncode(r);ct.formatters.t=r=>r==null?"undefined":Tr.baseEncode(r);ct.formatters.m=r=>r==null?"undefined":Gi.baseEncode(r);ct.formatters.p=r=>r==null?"undefined":r.toString();ct.formatters.c=r=>r==null?"undefined":r.toString();ct.formatters.k=r=>r==null?"undefined":r.toString();ct.formatters.a=r=>r==null?"undefined":r.toString();ct.formatters.e=r=>r==null?"undefined":zh(r.stack)??zh(r.message)??r.toString();function KE(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Z4(){return{forComponent(r){return WE(r)}}}function WE(r){let e=KE(`${r}:trace`);return ct.enabled(`${r}:trace`)&&ct.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=ct(`${r}:trace`)),Object.assign(ct(r),{error:ct(`${r}:error`),trace:e})}function zh(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function GE(r){return r[Symbol.asyncIterator]!=null}function $a(r){if(GE(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}let Fi=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};class jE extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class QE{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Fi)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function YE(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class XE{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=YE(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Fi),this.cleanup())}async join(e={}){const t=new QE(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await De(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}function Hh(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class Kh extends He{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=Hh(this.emitEmpty.bind(this),1),this.emitIdle=Hh(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new jE;const n=new XE(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Fi)}),this.clear()}async onEmpty(e){this.size!==0&&await rr(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await rr(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await rr(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=cr({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},o=()=>{n()},a=()=>{n(new Fi("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}}const J4="lock:worker:request-read",e6="lock:worker:abort-read-request",t6="lock:worker:release-read",r6="lock:master:grant-read",n6="lock:master:error-read",s6="lock:worker:request-write",i6="lock:worker:abort-write-request",o6="lock:worker:release-write",a6="lock:master:grant-write",c6="lock:master:error-write",l6="lock:worker:finalize",u6="mortice",ZE={singleProcess:!1},Wh=(r,e,t,n,s,i,o,a,c)=>u=>{if(u.data==null)return;const l={type:u.data.type,name:u.data.name,identifier:u.data.identifier};l.type===s&&r.safeDispatchEvent(t,{detail:{name:l.name,identifier:l.identifier,handler:async()=>{e.postMessage({type:c,name:l.name,identifier:l.identifier}),await new Promise(d=>{const h=f=>{if(f?.data==null)return;const p={type:f.data.type,name:f.data.name,identifier:f.data.identifier};p.type===a&&p.identifier===l.identifier&&(e.removeEventListener("message",h),d())};e.addEventListener("message",h)})},onError:d=>{e.postMessage({type:o,name:l.name,identifier:l.identifier,error:{message:d.message,name:d.name,stack:d.stack}})}}}),l.type===i&&r.safeDispatchEvent(n,{detail:{name:l.name,identifier:l.identifier}}),l.type===l6&&r.safeDispatchEvent("finalizeRequest",{detail:{name:l.name}})},JE=(r=10)=>Math.random().toString().substring(2,r+2);class eS{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(u6)}readLock(e){return this.sendRequest(J4,e6,r6,n6,t6,e)}writeLock(e){return this.sendRequest(s6,i6,a6,c6,o6,e)}finalize(){this.channel.postMessage({type:l6,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,i,o){o?.signal?.throwIfAborted();const a=JE();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,u)=>{const l=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};o?.signal?.addEventListener("abort",l,{once:!0});const d=h=>{if(h.data?.identifier===a&&(h.data?.type===n&&(this.channel.removeEventListener("message",d),o?.signal?.removeEventListener("abort",l),c(()=>{this.channel.postMessage({type:i,identifier:a,name:this.name})})),h.data.type===s)){this.channel.removeEventListener("message",d),o?.signal?.removeEventListener("abort",l);const f=new Error;h.data.error!=null&&(f.message=h.data.error.message,f.name=h.data.error.name,f.stack=h.data.error.stack),u(f)}};this.channel.addEventListener("message",d)})}}const tS=r=>{if(r=Object.assign({},ZE,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel(u6),n=new He;return t.addEventListener("message",Wh(n,t,"requestReadLock","abortReadLockRequest",J4,e6,n6,t6,r6)),t.addEventListener("message",Wh(n,t,"requestWriteLock","abortWriteLockRequest",s6,i6,c6,o6,a6)),n}return new eS(r.name)},Zr=new Map;let Js;function d6(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function rS(r){if(Js==null&&(Js=tS(r),!d6(Js))){const e=Js;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=Zr.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortReadLockRequest",a),i.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=Zr.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortWriteLockRequest",a),i.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,s=Zr.get(n);s?.finalize()})}return Js}async function el(r,e){let t,n;const s=new Promise((o,a)=>{t=o,n=a}),i=()=>{n(new Fi)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",i),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),s}const nS=(r,e)=>{let t=Zr.get(r);if(t!=null)return t;const n=rS(e);if(d6(n))return t=n,Zr.set(r,t),t;const s=new Kh({concurrency:1});let i;return t={async readLock(o){if(i!=null)return el(i,o);i=new Kh({concurrency:e.concurrency,autoStart:!1});const a=i,c=el(i,o);return s.add(async()=>{a.start(),await a.onIdle().then(()=>{i===a&&(i=null)})}),c},async writeLock(o){return i=null,el(s,o)},finalize:()=>{Zr.delete(r)},queue:s},Zr.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},sS={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function iS(r){const e=Object.assign({},sS,r);return nS(e.name,e)}const oS=36e5,aS=216e5;var Jr;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=ue((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:"",value:ee(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const u=s.uint32();switch(u>>>3){case 1:{a.key=s.string();break}case 2:{a.value=s.bytes();break}default:{s.skipType(u&7);break}}}return a})),n),t.encode=s=>le(s,t.codec()),t.decode=(s,i)=>ce(s,t.codec(),i)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),function(t){let n;t.codec=()=>(n==null&&(n=ue((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),Va.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const u=s.uint32();switch(u>>>3){case 1:{a.key=s.string();break}case 2:{a.value=Va.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(u&7);break}}}return a})),n),t.encode=s=>le(s,t.codec()),t.decode=(s,i)=>ce(s,t.codec(),i)}(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),qa.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:i,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new ut('Decode error - map field "addresses" had too many elements');i.addresses.push(qa.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new ut('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new Ld('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(c.key,c.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new Ld('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(c.key,c.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Jr||(Jr={}));var qa;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={multiaddr:ee(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(qa||(qa={}));var Va;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Va||(Va={}));function cS(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=zt(e.publicKey,t);return as(n)}function lS(r,e,t){const n=Jr.decode(e);return si(r,n,t)}function si(r,e,t){const n=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...e,id:cS(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:W(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function uS(r,e){return dS(r.addresses,e.addresses)&&hS(r.protocols,e.protocols)&&fS(r.publicKey,e.publicKey)&&pS(r.peerRecordEnvelope,e.peerRecordEnvelope)&&gS(r.metadata,e.metadata)&&mS(r.tags,e.tags)}function dS(r,e){return f6(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!pe(t.multiaddr,n.multiaddr)))}function hS(r,e){return f6(r,e,(t,n)=>t===n)}function fS(r,e){return h6(r,e)}function pS(r,e){return h6(r,e)}function gS(r,e){return p6(r,e,(t,n)=>pe(t,n))}function mS(r,e){return p6(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function h6(r,e){return r==null&&e==null?!0:r!=null&&e!=null?pe(r,e):!1}function f6(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function p6(r,e,t){if(r.size!==e.size)return!1;for(const[n,s]of r.entries()){const i=e.get(n);if(i==null||!t(s,i))return!1}return!0}const g6="/peers/";function To(r){if(!di(r)||r.type==null)throw new L("Invalid PeerId");const e=r.toCID().toString();return new ke(`${g6}${e}`)}async function yS(r,e,t,n,s){const i=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=W(o.multiaddr)),!gc(o.multiaddr))throw new L("Multiaddr was invalid");if(!await e(r,o.multiaddr,s))continue;const a=o.isCertified??!1,c=o.multiaddr.toString(),u=i.get(c);u!=null?o.isCertified=u.isCertified||a:i.set(c,{multiaddr:o.multiaddr,isCertified:a})}return[...i.values()].sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:o,multiaddr:a})=>{const c=a.getPeerId();return r.equals(c)&&(a=a.decapsulate(W(`/p2p/${r}`))),{isCertified:o,multiaddr:a.bytes}})}async function tl(r,e,t,n){if(e==null)throw new L("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new L("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new L("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,u=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=Io(h,{validate:Gh})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=Io(h,{validate:jh,map:Qh})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(h=>({isCertified:!1,multiaddr:h}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const h=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[f,p]of h)p==null?a.delete(f):a.set(f,p);a=Io([...a.entries()],{validate:Gh})}if(e.tags!=null){const h=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),f=new Map(c);for(const[p,m]of h)m==null?f.delete(p):f.set(p,m);c=Io([...f.entries()],{validate:jh,map:Qh})}e.peerRecordEnvelope!=null&&(u=e.peerRecordEnvelope)}let l;s?.id.publicKey!=null?l=Ft(s.id.publicKey):e.publicKey!=null?l=Ft(e.publicKey):r.publicKey!=null&&(l=Ft(r.publicKey));const d={addresses:await yS(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((h,f)=>h.localeCompare(f)),metadata:a,tags:c,publicKey:l,peerRecordEnvelope:u};return d.addresses.forEach(h=>{h.observed=n.existingPeer?.peerPB.addresses?.find(f=>pe(f.multiaddr,f.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete d.publicKey,d}function Io(r,e){const t=new Map;for(const[n,s]of r)s!=null&&e.validate(n,s);for(const[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function Gh(r,e){if(typeof r!="string")throw new L("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new L("Metadata value must be a Uint8Array")}function jh(r,e){if(typeof r!="string")throw new L("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new L("Tag value must be an integer");if(e.value<0||e.value>100)throw new L("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new L("Tag ttl must be an integer");if(e.ttl<0)throw new L("Tag ttl must be between greater than 0")}}function Qh(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function m6(r){const e=r.toString().split("/")[2],t=se.parse(e,Tr);return eo(t)}function rl(r,e,t){const n=m6(r);return lS(n,e,t)}function wS(r,e){return{prefix:g6,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(rl(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(rl(n.key,n.value,e),rl(s.key,s.value,e)))}}class bS{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=c3({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??oS,this.maxPeerAge=t.maxPeerAge??aS}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:iS({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){const n=this.getLock(e);try{const s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(To(e),t)}async load(e,t){const n=To(e),s=await this.datastore.get(n,t),i=Jr.decode(s);if(this.#t(e,i))throw await this.datastore.delete(n,t),new nr;return si(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const s=await this.#e(e,n),i=await tl(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#r(e,i,s)}async patch(e,t,n){const s=await this.#e(e,n),i=await tl(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return this.#r(e,i,s)}async merge(e,t,n){const s=await this.#e(e,n),i=await tl(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#r(e,i,s)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(wS(e??{},this.maxAddressAge),e)){const s=m6(t);if(s.equals(this.peerId))continue;const i=Jr.decode(n);if(this.#t(s,i)){await this.datastore.delete(t,e);continue}yield si(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=To(e),s=await this.datastore.get(n,t),i=Jr.decode(s);if(this.#t(e,i))throw await this.datastore.delete(n,t),new nr;return{peerPB:i,peer:si(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#r(e,t,n,s){t.updated=Date.now();const i=Jr.encode(t);return await this.datastore.put(To(e),i,s),{peer:si(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!uS(t,n.peerPB)}}#t(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return n&&i.length===0}}class vS{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new bS(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return $a(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,n){const s=di(t)?t:di(t?.expectedPeer)?t.expectedPeer:void 0,i=di(t)||t===void 0?n:t,o=await Ut.openAndCertify(e,lt.DOMAIN,i),a=eo(o.publicKey.toCID());if(s?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,a),!1;const c=lt.createFromProtobuf(o.payload);let u;try{u=await this.get(a,i)}catch(l){if(l.name!=="NotFoundError")throw l}if(u?.peerRecordEnvelope!=null){const l=Ut.createFromProtobuf(u.peerRecordEnvelope),d=lt.createFromProtobuf(l.payload);if(d.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",d.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(l=>({isCertified:!0,multiaddr:l}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function ES(r,e={}){return new vS(r,e)}class za extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=za.name;code=za.code;constructor(e="Not Found"){super(e)}}function SS(r){return r[Symbol.asyncIterator]!=null}function Ln(r,e){let t=0;if(SS(r))return async function*(){for await(const c of r)await e(c,t++)&&(yield c)}();const n=l1(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for(const c of n)await e(c,t++)&&(yield c)}();const a=e;return function*(){o===!0&&(yield s);for(const c of n)a(c,t++)&&(yield c)}()}function _S(r){return r[Symbol.asyncIterator]!=null}function Yh(r,e){return _S(r)?async function*(){yield*(await $a(r)).sort(e)}():function*(){yield*$a(r).sort(e)}()}function xS(r){return r[Symbol.asyncIterator]!=null}function pu(r,e){return xS(r)?async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}}()}class AS{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await ws(this.putMany(e,n)),e=[],await ws(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const s=e.prefix;n=Ln(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>Ln(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Yh(s,i),n)),e.offset!=null){let s=0;const i=e.offset;n=Ln(n,()=>s++>=i)}return e.limit!=null&&(n=pu(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;n=Ln(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>Ln(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Yh(s,i),n)),e.offset!=null){const s=e.offset;let i=0;n=Ln(n,()=>i++>=s)}return e.limit!=null&&(n=pu(n,e.limit)),n}}class CS extends AS{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new za;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,s]of this.data.entries())yield{key:new ke(n),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new ke(n),t?.signal?.throwIfAborted()}}class kS extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function ir(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new kS({name:e,metrics:t}):n=new Map,n}const Xh=864e13,TS=448,nl=449,IS=53,PS=54,RS=55,DS=56;class LS{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=ir({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const s=En(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?Xh-Date.now():0,lastVerified:s?Xh-Date.now():void 0})})}remove(e){const t=this.findHost(e);let n=!1;for(const[s,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",s,i.domain,new Error("where")),this.mappings.delete(s),n=n||i.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n].multiaddr.stringTuples(),o=i[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(i,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:W(`/${i.map(l=>[qe(l[0]).name,l[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let n=0;n<e.length;n++)if(e[n][0]===TS&&e[n+1]?.[0]!==nl)return e.splice(n+1,0,[nl,t]),!0;return!1}confirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("marking %s to %s DNS mapping as verified",i,o.domain),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("removing verification of %s to %s DNS mapping",i,o.domain),s=s||o.verified,o.verified=!1,o.expires=Date.now()+t);return s}findHost(e){for(const t of e.stringTuples())if(t[0]===nl||t[0]===IS||t[0]===PS||t[0]===RS||t[0]===DS)return t[1]}}const sl=4,il=41,ol=6,NS=273;class BS{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=ir({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const n of this.mappings.values())for(const s of n)if(s.externalIp===t[0][1])return!0;return!1}add(e,t,n,s=t,i="tcp"){const o=`${e}-${t}-${i}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:dn(n)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),n=t[0][1]??"",s=t[1][0]===ol?"tcp":"udp",i=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let u=0;u<c.length;u++){const l=c[u];l.externalIp===n&&l.externalPort===i&&l.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,n,i,s),o=o||l.verified,c.splice(u,1),u--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:n}of e){const s=n.stringTuples();let i;if((s[0][0]===sl||s[0][0]===il)&&s[1][0]===ol?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===sl||s[0][0]===il)&&s[1][0]===NS&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const a of o)s[0][0]=a.externalFamily===4?sl:il,s[0][1]=a.externalIp,s[1][1]=`${a.externalPort}`,t.push({multiaddr:W(`/${s.map(c=>[qe(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const s=e.stringTuples()[0][1];let i=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){const n=e.stringTuples(),s=n[0][1]??"",i=n[1][0]===ol?"tcp":"udp",o=parseInt(n[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let u=0;u<c.length;u++){const l=c[u];l.externalIp===s&&l.externalPort===o&&l.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,s,o,i),a=a||l.verified,l.verified=!1,l.expires=Date.now()+t)}return a}}function MS(r){try{for(const{code:e,value:t}of r.getComponents())if(e!==Ms&&t!=null){if(e===fs)return t.startsWith("169.254.");if(e===$t)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}const OS={maxObservedAddresses:10};class FS{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=ir({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??OS.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Mi(e)||MS(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:W(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),i}}const US=[fs,$t,d1,h1,pc,f1];function Zh(r){try{for(const{code:e}of r.getComponents())if(e!==Ms)return US.includes(e)}catch{}return!1}const $S={maxObservedAddresses:10};class qS{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=ir({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??$S.maxObservedAddresses}get(e,t){if(Mi(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let s=this.addresses.get(n);return s==null&&(s={verified:!Zh(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),i}unconfirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),i}toKey(e){if(Zh(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const Jh=6e4,e2={addressVerificationTTL:Jh*10,addressVerificationRetry:Jh*5},VS=r=>r;function al(r,e){const t=r.getPeerId();return t!=null&&yt(t).equals(e)&&(r=r.decapsulate(W(`/p2p/${e.toString()}`))),r}class zS{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new FS(e,t),this.dnsMappings=new LS(e,t),this.ipMappings=new BS(e,t),this.transportAddresses=new qS(e,t),this.announceFilter=t.announceFilter??VS,this.observedAddressFilter=ys(1024),this.addressVerificationTTL=t.addressVerificationTTL??e2.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??e2.addressVerificationRetry,this._updatePeerStoreAddresses=Ba(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>W(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>W(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>W(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=al(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=al(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=al(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const s=W(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(W(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.add(e,t,n,s,i),this.observed.removePrefixed(`/ip${dn(n)?4:6}/${n}/${i}/${s}`)}removePublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.remove(W(`/ip${dn(n)?4:6}/${n}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||En(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),s=[i=>Ni.exactMatch(i)||Ra.exactMatch(i),i=>Pa.exactMatch(i),i=>Ew.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=n.filter(u=>u.getAddrs().filter(l=>l.toOptions().family===4&&i(l)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(u=>u.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var t2;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(t2||(t2={}));class HS extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class KS extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class cl extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class r2 extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class WS extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class GS extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class jS extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class n2 extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class QS extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class YS extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class XS extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class ZS extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class JS extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class Po extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class Ro extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class e_ extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class t_{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Z4())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>zu(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const r_=["metrics","connectionProtector","dns"],n_=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function s_(r={}){const e=new t_(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!n_.includes(s)){const o=e.components[s];if(o==null&&!r_.includes(s))throw new HS(`${s} not set`);return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}function i_(r){const e={};for(const t of Object.values(r.components))for(const n of o_(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of a_(t))if(e[n]!==!0)throw new KS(`Service "${c_(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function o_(r){return Array.isArray(r?.[rt])?r[rt]:[]}function a_(r){return Array.isArray(r?.[ns])?r[ns]:[]}function c_(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}const l_=4,u_=41;function d_(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Ni.matches(e))return!1;const t=e.stringTuples();return t[0][0]===l_||t[0][0]===u_?!!En(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}const s2=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},h_=new WeakMap;function f_({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(s2());let i,o,a;const c=r??clearTimeout,u=()=>{c(i),a(s2())},l=()=>{s&&s.removeEventListener("abort",u)},d=new Promise((h,f)=>{o=()=>{l(),h(n)},a=f,i=(e??setTimeout)(o,t)});return s&&s.addEventListener("abort",u,{once:!0}),h_.set(d,()=>{c(i),i=null,o()}),d}}const y6=f_();class p_{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new g_}async consume(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new Ww("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await y6(a)}return o}penalty(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){const s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class g_{storage;constructor(){this.storage=new Map}incrby(e,t,n){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function w6(r){if(di(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getPeerId();t=n==null?void 0:yt(n),e.forEach(s=>{if(!gc(s))throw new qu("Invalid multiaddr");const i=s.getPeerId();if(i==null){if(t!=null)throw new L("Multiaddrs must all have the same peer id or have no peer id")}else{const o=yt(i);if(t?.equals(o)!==!0)throw new L("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!mw.exactMatch(n)),{peerId:t,multiaddrs:e}}const m_=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function y_(r,e){const t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??m_;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}async function w_(r,e){let t=!1;for(const s of p1.keys())if(t=r.protoNames().includes(s),t)break;if(!t)return[r];const n=await r.resolve(e);return e.log("resolved %s to",r,n.map(s=>s.toString())),n}function gu(r){try{let e;if(typeof r=="string"?e=W(r):e=r,!e.protoNames().includes("ipcidr")){const n=e.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(n)}return ow(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}class b_{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>gu(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const s=new vn;for(const c of e){const u=c.remotePeer;if(!s.has(u)){s.set(u,0);try{const l=await this.peerStore.get(u);s.set(u,[...l.tags.values()].reduce((d,h)=>d+h.value,0))}catch(l){l.name!=="NotFoundError"&&this.log.error("error loading peer tags",l)}}}const i=this.sortConnections(e,s),o=Math.max(t-n,0),a=[];for(const c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(l=>l.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===o)break;await Promise.all(a.map(async c=>{await y_(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,s)=>{const i=n.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{const i=t.get(n.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}const b6=1e4,v_=1e4,i2=1e4,v6=25,E_=5,S_=10,__=5,x_="last-dial-failure",A_="last-dial-success",E6=500,C_=100,S6=50;class k_ extends so{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}}function T_(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function o2(r){if(!d3(r))return!1;const{address:e}=r.nodeAddress();return T_(e)}function I_(r,e){const t=Pa.exactMatch(r.multiaddr),n=Pa.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const s=Ra.exactMatch(r.multiaddr),i=Ra.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=Ni.exactMatch(r.multiaddr),a=Ni.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=La.exactMatch(r.multiaddr),u=La.exactMatch(e.multiaddr);if(c&&!u)return-1;if(!c&&u)return 1;const l=ch.exactMatch(r.multiaddr),d=ch.exactMatch(e.multiaddr);if(l&&!d)return-1;if(!l&&d)return 1;const h=lh.exactMatch(r.multiaddr),f=lh.exactMatch(e.multiaddr);return h&&!f?-1:!h&&f?1:0}function P_(r,e){const t=o2(r.multiaddr),n=o2(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function R_(r,e){const t=Mi(r.multiaddr),n=Mi(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function D_(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function L_(r,e){const t=Lr.exactMatch(r.multiaddr),n=Lr.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function N_(r){return r.sort(I_).sort(D_).sort(L_).sort(R_).sort(P_)}const Do={maxParallelDials:S6,maxDialQueueLength:E6,maxPeerAddrsToDial:v6,dialTimeout:b6};class B_{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Do.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Do.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Do.dialTimeout,this.connections=t.connections??new vn,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[n,s]of Object.entries(t.resolvers??{}))p1.set(n,s);this.queue=new k_({concurrency:t.maxParallelDials??Do.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{n.detail?.name!==Rr.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:s}=w6(e),i=Array.from(this.connections.values()).flat().find(a=>t.force===!0?!1:a.remotePeer.equals(n)?!0:s.find(c=>c.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new ie("dial-queue:already-connected")),i;const o=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;const c=a.options.multiaddrs;if(c==null)return!1;for(const u of s)if(c.has(u.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(const a of s)o.options.multiaddrs.add(a.toString());return t.onProgress?.(new ie("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new hi("Dial queue is full");return this.log("creating dial target for %p",n,s.map(a=>a.toString())),t.onProgress?.(new ie("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new ie("dial-queue:start-dial"));const c=tt([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:t.priority??_6,multiaddrs:new Set(s.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const u=[];for(this.log("starting dial to %p",n);o||s.size>0;){c++,o=!1;const l=[],d=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...d]);const h=await this.calculateMultiaddrs(n,d,{...e,signal:t});for(const f of h){if(i.has(f.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",f.multiaddr,n);continue}l.push(f)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,l.map(f=>f.multiaddr.toString())),e?.onProgress?.(new ie("dial-queue:calculated-addresses",l));for(const f of l){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new hi("Peer had more than maxPeerAddrsToDial");a++;try{const p=await this.components.transportManager.dial(f.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",f.multiaddr);try{await this.components.peerStore.merge(p.remotePeer,{multiaddrs:[p.remoteAddr],metadata:{[A_]:q(Date.now().toString())}})}catch(m){this.log.error("could not update last dial failure key for %p",n,m)}return p}catch(p){if(this.log.error("dial failed to %a",f.multiaddr,p),i.add(f.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[x_]:q(Date.now().toString())}})}catch(m){this.log.error("could not update last dial failure key for %p",n,m)}if(t.aborted)throw new nc(p.message);u.push(p)}}}throw u.length===1?u[0]:new AggregateError(u,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const s=[...t].map(d=>({multiaddr:W(d),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new hi("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new n2("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const d=await this.components.peerStore.get(e);s.push(...d.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:h})=>h.toString()))}catch(d){if(d.name!=="NotFoundError")throw d}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const d=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:h})=>h.toString())),s.push(...d.multiaddrs.map(h=>({multiaddr:h,isCertified:!1})))}catch(d){d.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,d)}}}let i=(await Promise.all(s.map(async d=>{const h=await w_(d.multiaddr,{dns:this.components.dns,...n,log:this.log});return h.length===1&&h[0].equals(d.multiaddr)?d:h.map(f=>({multiaddr:f,isCertified:!1}))}))).flat();if(e!=null){const d=`/p2p/${e.toString()}`;i=i.map(h=>h.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:h.multiaddr.encapsulate(d),isCertified:h.isCertified}:h)}const o=i.filter(d=>{if(this.components.transportManager.dialTransportForMultiaddr(d.multiaddr)==null)return!1;const h=d.multiaddr.getPeerId();return e!=null&&h!=null?e.equals(h):!0}),a=new Map;for(const d of o){const h=d.multiaddr.toString(),f=a.get(h);if(f!=null){f.isCertified=f.isCertified||d.isCertified||!1;continue}a.set(h,d)}const c=[...a.values()];if(c.length===0)throw new XS("The dial request has no valid addresses");const u=[];for(const d of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(d.multiaddr)||u.push(d);const l=this.addressSorter==null?N_(u):u.sort(this.addressSorter);if(l.length===0)throw new n2("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:d})=>d.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",l.map(({multiaddr:d})=>d.toString())),l}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!Lr.matches(s.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}}var ll={},ul,a2;function M_(){if(a2)return ul;a2=1;function r(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return ul=r,r.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},r.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},r.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},n),this._options.unref&&this._timer.unref(),!0},r.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},r.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},r.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},r.prototype.start=r.prototype.try,r.prototype.errors=function(){return this._errors},r.prototype.attempts=function(){return this._attempts},r.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,n=0,s=0;s<this._errors.length;s++){var i=this._errors[s],o=i.message,a=(e[o]||0)+1;e[o]=a,a>=n&&(t=i,n=a)}return t},ul}var c2;function O_(){return c2||(c2=1,function(r){var e=M_();r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)n[s]=t[s];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<n.retries;o++)i.push(this.createTimeout(o,n));return t&&t.forever&&!i.length&&i.push(this.createTimeout(o,n)),i.sort(function(a,c){return a-c}),i},r.createTimeout=function(t,n){var s=n.randomize?Math.random()+1:1,i=Math.round(s*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return i=Math.min(i,n.maxTimeout),i},r.wrap=function(t,n,s){if(n instanceof Array&&(s=n,n=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var o=0;o<s.length;o++){var a=s[o],c=t[a];t[a]=function(l){var d=r.operation(n),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(p){d.retry(p)||(p&&(arguments[0]=d.mainError()),f.apply(this,arguments))}),d.attempt(function(){l.apply(t,h)})}.bind(t,c),t[a].options=n}}}(ll)),ll}var dl,l2;function F_(){return l2||(l2=1,dl=O_()),dl}var U_=F_();const $_=Fs(U_),q_=Object.prototype.toString,V_=r=>q_.call(r)==="[object Error]",z_=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function H_(r){return r&&V_(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:z_.has(r.message):!1}class K_ extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const u2=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function W_(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;const s=$_.operation(e),i=()=>{s.stop(),n(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});const o=()=>{e.signal?.removeEventListener("abort",i),s.stop()};s.attempt(async a=>{try{const c=await r(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof K_)throw c.originalError;if(c instanceof TypeError&&!H_(c))throw c;if(u2(c,a,e),await e.shouldRetry(c)||(s.stop(),n(c)),await e.onFailedAttempt(c),!s.retry(c))throw s.mainError()}catch(u){u2(u,a,e),o(),n(u)}}})})}class G_{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Bi({concurrency:t.maxParallelReconnects??__,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);d2(t)&&(this.queue.has(e)||this.queue.add(async n=>{await W_(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(rc)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>d2(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function d2(r){for(const e of r.tags.keys())if(e.startsWith(rc))return!0;return!1}const _6=50,hl={maxConnections:C_,inboundConnectionThreshold:E_,maxIncomingPendingConnections:S_};class j_{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??hl.maxConnections,this.maxConnections<1)throw new L("Connection Manager maxConnections must be greater than 0");this.connections=new vn,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>gu(n)),this.deny=(t.deny??[]).map(n=>gu(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??hl.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new p_({points:t.inboundConnectionThreshold??hl.inboundConnectionThreshold,duration:1}),this.connectionPruner=new b_({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>W(n))}),this.dialQueue=new B_(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??S6,maxDialQueueLength:t.maxDialQueueLength??E6,maxPeerAddrsToDial:t.maxPeerAddrsToDial??v6,dialTimeout:t.dialTimeout??b6,resolvers:t.resolvers??{dnsaddr:Y4},connections:this.connections}),this.reconnectQueue=new G_({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Ai(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await sc(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new L("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,s=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new ia("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n}=w6(e);if(this.peerId.equals(n))throw new r0("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p",n),t.onProgress?.(new ie("dial-queue:already-connected")),a}const s=await this.dialQueue.dial(e,{...t,priority:t.priority??_6});if(s.status!=="open")throw new e0("Remote closed connection during opening");let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const a of i)if(a.id===s.id&&(o=!0),t.force!==!0&&a.id!==s.id&&a.remoteAddr.equals(s.remoteAddr))return s.abort(new qu("Duplicate multiaddr connection")),a;return o||i.push(s),s}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await s.close(t)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>W(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class fl{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}}const Q_=1.2,Y_=2,X_=5e3,Z_=6e4,J_=5e3;class Ui{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??J_;this.success=new fl(t),this.failure=new fl(t),this.next=new fl(t),this.failureMultiplier=e.failureMultiplier??Y_,this.timeoutMultiplier=e.timeoutMultiplier??Q_,this.minTimeout=e.minTimeout??X_,this.maxTimeout=e.maxTimeout??Z_,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),s=tt([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}const ex=1e4,tx="1.0.0",rx="ping",nx="ipfs",h2=32,sx=!0;class ix{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??nx}/${rx}/${tx}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??ex,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??sx,this.timeout=new Ui({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[rt]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=ba(s);t=Date.now(),await Promise.all([i.write(un(h2),{signal:n}),i.read({bytes:h2,signal:n})]),e.rtt=Date.now()-t,await i.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}class ox{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:F(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:F(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new cl("No content routers available");const n=this,s=new tr;for await(const i of Ti(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new cl("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new cl("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new ia;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new ia;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}class ax{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:F(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new r2("No peer routers available");if(e.toString()===this.peerId.toString())throw new WS("Should not try to find self");const n=this,s=Ti(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new nr}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new r2("No peer routers available");const n=this,s=ys(1024);for await(const i of vc(async function*(){const o=Ti(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class cx extends He{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=tt([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=fe(),yield(await rr(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=tt([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=un(32);let i=Date.now();for await(const o of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await De(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,n)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const x6=32,A6=64;class lx{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=ir({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new GS(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new jS(`Handler already registered for protocol ${e}`);const s=D1.bind({ignoreUndefined:!0})({maxInboundStreams:x6,maxOutboundStreams:A6},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new L("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,n).then(s=>{for(const i of s.protocols){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t)!==!1&&(a.filter?.remove(t),a.onDisconnect?.(t))}}).catch(s=>{s.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,s)})}_onPeerUpdate(e){const{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));for(const i of s){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;for(const i of t){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(s)!==!0&&(a.filter?.add(s),a.onConnect?.(s,n))}}}class ux{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=ir({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=ir({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??xi.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new L("Transport must have a valid tag");if(this.transports.has(t))throw new L(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new e_(`No transport available for address ${String(e)}`);return t?.onProgress?.(new ie("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new ia("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new QS)});const n=[];for(const[i,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",i,c);const u=o.createListener({upgrader:this.components.upgrader});let l=this.listeners.get(i)??[];l==null&&(l=[],this.listeners.set(i,l)),l.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{const d=l.findIndex(h=>h===u);l.splice(d,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),oh.matches(c)?t.ipv4.attempts++:ah.matches(c)&&t.ipv6.attempts++,n.push(u.listen(c).then(()=>{t.errors.delete(c.toString()),oh.matches(c)&&t.ipv4.success++,ah.matches(c)&&t.ipv6.success++},d=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,d),t.errors.set(c.toString(),d),d}))}}const s=await Promise.allSettled(n);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===xi.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new YS(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const Je="/multistream/1.0.0",L1=1024,dx=q(`
`);async function ii(r,e,t){await r.write(e,t)}async function hx(r,e,t){await r.writeV(e,t)}async function fx(r,e){const t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==dx[0])throw e.log.error("Invalid mss message - missing newline",t),new ve("Missing newline");return t.sublist(0,-1)}async function Zn(r,e){const t=await fx(r,e);return F(t.subarray())}async function pl(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return px(r,e[0],t);const n=cs(r,{...t,maxDataLength:L1}),s=e.shift();if(s==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Je,s);const i=q(`${Je}
`),o=q(`${s}
`);await hx(n,[i,o],t),t.log.trace("select: reading multistream-select header");let a=await Zn(n,t);if(t.log.trace('select: read "%s"',a),a===Je&&(t.log.trace("select: reading protocol response"),a=await Zn(n,t),t.log.trace('select: read "%s"',a)),a===s)return{stream:n.unwrap(),protocol:s};for(const c of e){t.log.trace('select: write "%s"',c),await ii(n,q(`${c}
`),t),t.log.trace("select: reading protocol response");const u=await Zn(n,t);if(t.log.trace('select: read "%s" for "%s"',u,c),u===c)return{stream:n.unwrap(),protocol:c}}throw new Vu("protocol selection failed")}function px(r,e,t){const n=r.sink.bind(r),s=r.source;let i=!1,o=!1;const a=fe();let c=!1,u=!1;const l=fe();let d=!1,h=!1;const f=fe(),p=cs({sink:n,source:s},{...t,maxDataLength:L1});r.sink=async E=>{const{sink:b}=p.unwrap();await b(async function*(){let _=!1;for await(const w of E){if(u&&await l.promise,c)yield w;else{u=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Je,e,w.byteLength);const k=`${e}
`;yield new Y(Uint8Array.from([19]),q(`${Je}
`),rn(k.length),q(k),w).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Je,e,w.byteLength),c=!0,u=!1,l.resolve(),m().catch(x=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,x)})}_=!0}_||await m()}())};async function m(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await g()),d||(t.log.trace("optimistic: doing read protocol for %s stream",e),await y())}finally{o=!1,i=!0,a.resolve()}}async function g(){if(u){await l.promise;return}u=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Je,e),await p.writeV([q(`${Je}
`),q(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Je,e)}finally{c=!0,u=!1,l.resolve()}}async function y(){if(h){await f.promise;return}h=!0;try{t.log.trace("optimistic: reading multistream select header");let E=await Zn(p,t);if(t.log.trace('optimistic: read multistream select header "%s"',E),E===Je&&(E=await Zn(p,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',E,e),E!==e)throw new Vu("protocol selection failed")}finally{d=!0,h=!1,f.resolve()}}if(r.source=async function*(){await m(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*p.unwrap().source}(),r.closeRead!=null){const E=r.closeRead.bind(r);r.closeRead=async b=>{i||await m().catch(_=>{t.log.error("could not negotiate protocol before close read",_)}),await E(b)}}if(r.closeWrite!=null){const E=r.closeWrite.bind(r);r.closeWrite=async b=>{i||await m().catch(_=>{t.log.error("could not negotiate protocol before close write",_)}),await E(b)}}if(r.close!=null){const E=r.close.bind(r);r.close=async b=>{const _=[];u&&_.push(l.promise),h&&_.push(f.promise),_.length>0?await De(Promise.all(_),b?.signal):(i=!0,o=!1,a.resolve()),await E(b)}}return{stream:r,protocol:e}}async function gl(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const n=cs(r,{...t,maxDataLength:L1,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const s=await Zn(n,t);if(t.log.trace('handle: read "%s"',s),s===Je){t.log.trace('handle: respond with "%s" for "%s"',Je,s),await ii(n,q(`${Je}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Je,s);continue}if(e.includes(s))return t.log.trace('handle: respond with "%s" for "%s"',s,s),await ii(n,q(`${s}
`),t),t.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:n.unwrap(),protocol:s};if(s==="ls"){const i=new Y(...e.map(o=>ya.single(q(`${o}
`))),q(`
`));t.log.trace('handle: respond with "%s" for %s',e,s),await ii(n,i,t),t.log.trace('handle: responded with "%s" for %s',e,s);continue}t.log.trace('handle: respond with "na" for "%s"',s),await ii(n,q(`na
`),t),t.log('handle: responded with "na" for "%s"',s)}}const gx=500;class mx{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:n,newStream:s,close:i,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[Q5]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new Z5("the connection is being closed");if(this.status==="closed")throw new e0("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new n0("Cannot open protocol stream on limited connection");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(gx);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function yx(r){return new mx(r)}function wx(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return x6}function bx(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??A6}function f2(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}class vx{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=ir({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=ir({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??v_,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??i2,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??i2,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new ZS(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return tt([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await De(this.components.connectionManager.acceptIncomingConnection(e),s),!n)throw new JS("Connection denied");await De(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getPeerId();let s;n!=null&&(s=yt(n),await De(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s,i,o,a,c;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let u=e;if(n?.skipProtection!==!0){const l=this.components.connectionProtector;l!=null&&(e.log("protecting the %s connection",t),u=await l.protect(e,n))}try{if(s=u,n?.skipEncryption!==!0){n?.onProgress?.(new ie(`upgrader:encrypt-${t}-connection`)),{conn:s,remotePeer:i,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(u,n):this._encryptOutbound(u,n));const l={...u,...s};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,l)}else{const l=e.remoteAddr.getPeerId();if(l==null)throw new qu(`${t} connection that skipped encryption must have a peer id`);const d=yt(l);c="native",i=d}if(i.equals(this.components.peerId)){const l=new r0("Can not dial self");throw e.abort(l),l}if(o=s,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new ie(`upgrader:multiplex-${t}-connection`));const l=await(t==="inbound"?this._multiplexInbound({...u,...s},this.streamMuxers,n):this._multiplexOutbound({...u,...s},this.streamMuxers,n));a=l.muxerFactory,o=l.stream}}catch(l){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,l),l}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i,limits:n?.limits})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,limits:c}=e;let u,l,d;a!=null&&(u=a.createStreamMuxer({direction:n,onIncomingStream:p=>{if(d==null)return;const m=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{const g=this.components.registrar.getProtocols(),{stream:y,protocol:E}=await gl(p,g,{signal:m,log:p.log,yieldBytes:!1});if(d==null)return;d.log("incoming stream opened on %s",E);const b=wx(E,this.components.registrar);if(f2(E,"inbound",d)===b){const w=new n8(`Too many inbound protocol streams for protocol "${E}" - limit ${b}`);throw p.abort(w),w}p.source=y.source,p.sink=y.sink,p.protocol=E,y.closeWrite!=null&&(p.closeWrite=y.closeWrite),y.closeRead!=null&&(p.closeRead=y.closeRead),y.close!=null&&(p.close=y.close),await this.components.peerStore.merge(o,{protocols:[E]},{signal:m}),this.components.metrics?.trackProtocolStream(p,d),this._onStream({connection:d,stream:p,protocol:E})}).catch(async g=>{d.log.error("error handling incoming stream id %s - %e",p.id,g),p.timeline.close==null&&await p.close({signal:m}).catch(y=>p.abort(y))})}}),l=async(p,m={})=>{if(u==null)throw new Po("Connection is not multiplexed");d.log.trace("starting new stream for protocols %s",p);const g=await u.newStream();d.log.trace("started new stream %s for protocols %s",g.id,p);try{if(m.signal==null){g.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",p);const w=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);m={...m,signal:w}}g.log.trace("selecting protocol from protocols %s",p);const{stream:y,protocol:E}=await pl(g,p,{...m,log:g.log,yieldBytes:!0});g.log.trace("selected protocol %s",E);const b=bx(E,this.components.registrar,m),_=f2(E,"outbound",d);if(_>=b){const w=new s0(`Too many outbound protocol streams for protocol "${E}" - ${_}/${b}`);throw g.abort(w),w}return await this.components.peerStore.merge(o,{protocols:[E]}),g.source=y.source,g.sink=y.sink,g.protocol=E,y.closeWrite!=null&&(g.closeWrite=y.closeWrite),y.closeRead!=null&&(g.closeRead=y.closeRead),y.close!=null&&(g.close=y.close),this.components.metrics?.trackProtocolStream(g,d),g}catch(y){throw d.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,p,y),g.timeline.close==null&&g.abort(y),y}},Promise.all([u.sink(i.source),i.sink(u.source)]).catch(p=>{d.log.error("error piping data through muxer - %e",p)}));const h=s.timeline;s.timeline=new Proxy(h,{set:(...p)=>(p[1]==="close"&&p[2]!=null&&h.close==null&&(async()=>{try{d.status==="open"&&await d.close()}catch(m){d.log.error("error closing connection after timeline close %e",m)}finally{this.events.safeDispatchEvent("connection:close",{detail:d})}})().catch(m=>{d.log.error("error thrown while dispatching connection:close event %e",m)}),Reflect.set(...p))}),s.timeline.upgraded=Date.now();const f=()=>{throw new Po("Connection is not multiplexed")};return d=yx({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:s.timeline,multiplexer:u?.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:l??f,getStreams:()=>u?.streams??[],close:async p=>{await u?.close(p),await s.close(p)},abort:p=>{s.abort(p),u?.abort(p)}}),this.events.safeDispatchEvent("connection:open",{detail:d}),d.__maConnTimeline=h,d}_onStream(e){const{connection:t,stream:n,protocol:s}=e,{handler:i,options:o}=this.components.registrar.getHandler(s);if(t.limits!=null&&o.runOnLimitedConnection!==!0)throw new n0("Cannot open protocol stream on limited connection");i({connection:t,stream:n})}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await gl(e,n,{...t,log:e.log}),o=this.connectionEncrypters.get(i);if(o==null)throw new Ro(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await o.secureInbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,s),new Ro(s.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const{stream:s,protocol:i}=await pl(e,n,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(i);if(o==null)throw new Ro(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await o.secureOutbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,s),new Ro(s.message)}}async _multiplexOutbound(e,t,n){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:o}=await pl(e,s,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new Po(String(i))}}async _multiplexInbound(e,t,n){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{const{stream:i,protocol:o}=await gl(e,s,{...n,log:e.log}),a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new Po(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const C6="2.8.11",k6="js-libp2p";function Ex(r,e){return`${r??k6}/${e??C6} browser/${globalThis.navigator.userAgent}`}class Sx extends He{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new He,n=t.dispatchEvent.bind(t);t.dispatchEvent=u=>{const l=n(u),d=this.dispatchEvent(new CustomEvent(u.type,{detail:u.detail}));return l||d},this.peerId=e.peerId,this.logger=e.logger??Z4(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??k6,i=e.nodeInfo?.version??C6,o=this.components=s_({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??Ex(s,i)},logger:this.logger,events:t,datastore:e.datastore??new CS,connectionGater:d_(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",ES(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",u=>{if(u.detail.previous==null){const l={id:u.detail.peer.id,multiaddrs:u.detail.peer.addresses.map(d=>d.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:l})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new vx(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((u,l)=>this.configureComponent(`connection-encryption-${l}`,u(this.components))),streamMuxers:(e.streamMuxers??[]).map((u,l)=>this.configureComponent(`stream-muxers-${l}`,u(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new ux(this.components,e.transportManager)),this.configureComponent("connectionManager",new j_(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new ix(this.components,e.connectionMonitor)),this.configureComponent("registrar",new lx(this.components)),this.configureComponent("addressManager",new zS(this.components,e.addresses));const a=(e.peerRouters??[]).map((u,l)=>this.configureComponent(`peer-router-${l}`,u(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new ax(this.components,{routers:a}));const c=(e.contentRouters??[]).map((u,l)=>this.configureComponent(`content-router-${l}`,u(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new ox(this.components,{routers:c})),this.configureComponent("randomWalk",new cx(this.components)),(e.peerDiscovery??[]).forEach((u,l)=>{this.configureComponent(`peer-discovery-${l}`,u(this.components)).addEventListener("peer",h=>{this.#e(h)})}),e.transports?.forEach((u,l)=>{this.components.transportManager.add(this.configureComponent(`transport-${l}`,u(this.components)))}),e.services!=null)for(const u of Object.keys(e.services)){const l=e.services[u],d=l(this.components);if(d==null){this.log.error("service factory %s returned null or undefined instance",u);continue}this.services[u]=d,this.configureComponent(u,d),d[Ml]!=null&&(this.log("registering service %s for content routing",u),c.push(d[Ml])),d[Ol]!=null&&(this.log("registering service %s for peer routing",u),a.push(d[Ol])),d[na]!=null&&(this.log("registering service %s for peer discovery",u),d[na].addEventListener?.("peer",h=>{this.#e(h)}))}i_(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new tr;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new L("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new L("no protocols were provided to open a stream");return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){gc(e)&&(e=yt(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=sr([q("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(n,t),i=zt(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}}async function _x(r={}){r.privateKey??=await o9();const e=new Sx({...await TE(r),peerId:f9(r.privateKey)});return r.start!==!1&&await e.start(),e}var ml,p2;function xx(){if(p2)return ml;p2=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return ml=function(n,s,i){if(typeof s!="string")throw new Error("Input must be string");for(var o=s.length,a=0,c,u,l=0;l<o;l+=1){if(c=s.charCodeAt(l),u=s[l],r(c)&&e(s.charCodeAt(l+1))&&(l+=1,u+=s[l]),a+=n(u),a===i)return s.slice(0,l+1);if(a>i)return s.slice(0,l-u.length+1)}return s},ml}var yl,g2;function Ax(){if(g2)return yl;g2=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return yl=function(n){if(typeof n!="string")throw new Error("Input must be string");for(var s=n.length,i=0,o=null,a=null,c=0;c<s;c++)o=n.charCodeAt(c),e(o)?a!=null&&r(a)?i+=1:i+=3:o<=127?i+=1:o>=128&&o<=2047?i+=2:o>=2048&&o<=65535&&(i+=3),a=o;return i},yl}var wl,m2;function Cx(){if(m2)return wl;m2=1;var r=xx(),e=Ax();return wl=r.bind(null,e),wl}var bl,y2;function kx(){if(y2)return bl;y2=1;var r=Cx(),e=/[\/\?<>\\:\*\|"]/g,t=/[\x00-\x1f\x80-\x9f]/g,n=/^\.+$/,s=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,i=/[\. ]+$/;function o(a,c){if(typeof a!="string")throw new Error("Input must be string");var u=a.replace(e,c).replace(t,c).replace(n,c).replace(s,c).replace(i,c);return r(u,255)}return bl=function(a,c){var u=c&&c.replacement||"",l=o(a,u);return u===""?l:o(l,"")},bl}var Tx=kx();const Ix=Fs(Tx),vl={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function T6(r){const e="AES-GCM";let t=16;const n=12,s="SHA-256",i=16,o=32767,a=mt.get();t*=8;async function c(d,h){const f=a.getRandomValues(new Uint8Array(i)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=q(h));let g;if(h.length===0){g=await a.subtle.importKey("jwk",vl,{name:"AES-GCM"},!0,["encrypt"]);try{const E={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);g=await a.subtle.deriveKey(E,b,{name:e,length:t},!0,["encrypt"])}catch{g=await a.subtle.importKey("jwk",vl,{name:"AES-GCM"},!0,["encrypt"])}}else{const E={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);g=await a.subtle.deriveKey(E,b,{name:e,length:t},!0,["encrypt"])}const y=await a.subtle.encrypt(m,g,d);return sr([f,m.iv,new Uint8Array(y)])}async function u(d,h){const f=d.subarray(0,i),p=d.subarray(i,i+n),m=d.subarray(i+n),g={name:e,iv:p};typeof h=="string"&&(h=q(h));let y;if(h.length===0)try{const b={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},_=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(b,_,{name:e,length:t},!0,["decrypt"])}catch{y=await a.subtle.importKey("jwk",vl,{name:"AES-GCM"},!0,["decrypt"])}else{const b={name:"PBKDF2",salt:f,iterations:o,hash:{name:s}},_=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(b,_,{name:e,length:t},!0,["decrypt"])}const E=await a.subtle.decrypt(g,y,m);return new Uint8Array(E)}return{encrypt:c,decrypt:u}}const Px=16,mu=32,yu=1e4;async function xc(r,e){const n=await T6().encrypt(r,e);return Gi.encode(n)}async function w2(r,e,t){if(r.type==="RSA")return Nx(r,e,t);if(r.type==="Ed25519")return Rx(r,e,t);if(r.type==="secp256k1")return Dx(r,e,t);if(r.type==="ECDSA")return Lx(r,e,t);throw new Hi}async function Rx(r,e,t="libp2p-key"){if(t==="libp2p-key")return xc(Ji(r),e);throw new L(`export format '${t}' is not supported`)}async function Dx(r,e,t="libp2p-key"){if(t==="libp2p-key")return xc(Ji(r),e);throw new L("Export format is not supported")}async function Lx(r,e,t="libp2p-key"){if(t==="libp2p-key")return xc(Ji(r),e);throw new L(`export format '${t}' is not supported`)}async function Nx(r,e,t="pkcs-8"){if(t==="pkcs-8")return Bx(r,e);if(t==="libp2p-key")return xc(Ji(r),e);throw new L("Export format is not supported")}async function Bx(r,e){const t=mt.get(),s=new Et({value:[new Xn({value:0}),new Et({value:[new Hr({value:"1.2.840.113549.1.1.1"}),new Oa]}),new qn({valueHex:r.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=un(Px),a=await s3(b1,e,o,{c:yu,dkLen:mu}),c=un(16),u=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),l=await t.subtle.encrypt({name:"AES-CBC",iv:c},u,i),d=new Et({value:[new qn({valueHex:o}),new Xn({value:yu}),new Xn({value:mu}),new Et({value:[new Hr({value:"1.2.840.113549.2.11"}),new Oa]})]}),h=new Et({value:[new Hr({value:"1.2.840.113549.1.5.13"}),new Et({value:[new Et({value:[new Hr({value:"1.2.840.113549.1.5.12"}),d]}),new Et({value:[new Hr({value:"2.16.840.1.101.3.4.1.42"}),new qn({valueHex:c})]})]})]}),p=new Et({value:[h,new qn({valueHex:l})]}).toBER(),m=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...F(m,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function b2(r,e){try{const t=await Mx(r,e);return c9(t)}catch{}if(!r.includes("BEGIN"))throw new L("Encrypted key was not a libp2p-key or a PEM file");return Ox(r,e)}async function Mx(r,e){const t=Gi.decode(r);return T6().decrypt(t,e)}async function Ox(r,e){const t=mt.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=q(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Xc(i),{iv:a,salt:c,iterations:u,keySize:l,cipherText:d}=Fx(o),h=await s3(b1,e,c,{c:u,dkLen:l}),f=await t.subtle.importKey("raw",h,"AES-CBC",!1,["decrypt"]),p=Ei(await t.subtle.decrypt({name:"AES-CBC",iv:a},f,d)),{result:m}=Xc(p);n=v2(m)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const i=q(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Xc(i);n=v2(o)}else throw new L("Could not parse private key from PEM data");const s=l9(n);if(s.type!=="RSA")throw new L("Could not parse RSA private key from PEM data");return s}function Fx(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new L("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new L("Only pkcs5PBKDF2 key derivation functions are supported");const i=n.valueBlock.value[1],o=Ei(i.valueBlock.value[0].getValue());let a=yu,c=mu;if(i.valueBlock.value.length===3)a=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new L("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const u=e.valueBlock.value[1].valueBlock.value[1],l=u.valueBlock.value[0].toString();if(l!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(l!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(l!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(l!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(l!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new L("Only AES-CBC encryption schemes are supported")}}}}const d=Ei(u.valueBlock.value[1].getValue());return{cipherText:Ei(r.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:d}}function v2(r){return Ei(r.valueBlock.value[2].getValue())}function Ei(r){return new Uint8Array(r,0,r.byteLength)}const Ux="/pkcs8/",wu="/info/",ei=new WeakMap,Fr={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},El={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Nn(r){return r==null||typeof r!="string"?!1:r===Ix(r.trim())&&r.length>0}async function Re(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Ur(r){return new ke(Ux+r)}function Bn(r){return new ke(wu+r)}async function $x(r){const e=Ji(r),t=await Ls.digest(e);return Ae.encode(t.bytes).substring(1)}class qx{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=D1(El,t),this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Fr.minKeyLength)throw new Error(`dek.keyLength must be least ${Fr.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Fr.minSaltLength)throw new Error(`dek.saltLength must be least ${Fr.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Fr.minIterationCount)throw new Error(`dek.iterationCount must be least ${Fr.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?ph(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";ei.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[rt]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},El),t=Math.ceil(Fr.minSaltLength/3)*3;return e.dek.salt=F(un(t),"base64"),e}static get options(){return El}async findKeyByName(e){if(!Nn(e))throw await Re(),new L(`Invalid key name '${e}'`);const t=Bn(e);try{const n=await this.components.datastore.get(t);return JSON.parse(F(n))}catch(n){throw await Re(),this.log.error(n),new nr(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:wu};for await(const n of this.components.datastore.query(t)){const s=JSON.parse(F(n.value));if(s.id===e)return s}throw new L(`Key with id '${e}' does not exist.`)}catch(t){throw await Re(),t}}async importKey(e,t){if(!Nn(e))throw await Re(),new L(`Invalid key name '${e}'`);if(t==null)throw await Re(),new L("Key is required");const n=Ur(e);if(await this.components.datastore.has(n))throw await Re(),new L(`Key '${e}' already exists`);let i,o;try{i=await $x(t);const u=ei.get(this);if(u==null)throw new L("dek missing");const l=u.dek;o=await w2(t,l,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(u){throw await Re(),u}const a={name:e,id:i},c=this.components.datastore.batch();return c.put(n,q(o)),c.put(Bn(e),q(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!Nn(e))throw await Re(),new L(`Invalid key name '${e}'`);const t=Ur(e);try{const n=await this.components.datastore.get(t),s=F(n),i=ei.get(this);if(i==null)throw new L("dek missing");const o=i.dek;return await b2(s,o)}catch(n){throw await Re(),n}}async removeKey(e){if(!Nn(e)||e===this.self)throw await Re(),new L(`Invalid key name '${e}'`);const t=Ur(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(Bn(e)),await s.commit(),n}async listKeys(){const e={prefix:wu},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(F(n.value)));return t}async renameKey(e,t){if(!Nn(e)||e===this.self)throw await Re(),new L(`Invalid old key name '${e}'`);if(!Nn(t)||t===this.self)throw await Re(),new L(`Invalid new key name '${t}'`);const n=Ur(e),s=Ur(t),i=Bn(e),o=Bn(t);if(await this.components.datastore.has(s))throw await Re(),new L(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),u=await this.components.datastore.get(i),l=JSON.parse(F(u));l.name=t;const d=this.components.datastore.batch();return d.put(s,c),d.put(o,q(JSON.stringify(l))),d.delete(n),d.delete(i),await d.commit(),l}catch(c){throw await Re(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Re(),new L(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Re(),new L(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Re(),new L(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=ei.get(this);if(n==null)throw new L("dek missing");const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?ph(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";ei.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(Ur(a.name)),u=F(c),l=await b2(u,s),d=i.toString(),h=await w2(l,d,l.type==="RSA"?"pkcs-8":"libp2p-key"),f=this.components.datastore.batch(),p={name:a.name,id:a.id};f.put(Ur(a.name),q(h)),f.put(Bn(a.name),q(JSON.stringify(p))),await f.commit()}this.log("keychain reconstructed")}}function Vx(r={}){return e=>new qx(e,r)}var Nt;(function(r){(function(n){n.UNUSED="UNUSED",n.CONNECT="CONNECT",n.SYNC="SYNC"})(r.Type||(r.Type={}));let e;(function(n){n[n.UNUSED=0]="UNUSED",n[n.CONNECT=100]="CONNECT",n[n.SYNC=300]="SYNC"})(e||(e={})),function(n){n.codec=()=>ar(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=ue((n,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.observedAddresses!=null)for(const o of n.observedAddresses)s.uint32(18),s.bytes(o);i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={observedAddresses:[]},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{if(i.limits?.observedAddresses!=null&&o.observedAddresses.length===i.limits.observedAddresses)throw new ut('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(n.bytes());break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>le(n,r.codec()),r.decode=(n,s)=>ce(n,r.codec(),s)})(Nt||(Nt={}));function E2(r,e){return Lr.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:yw.matches(r)?!0:bw.matches(r)?En(r.toOptions().host)===!1:!1}const S2=1024*4,_2=100,Lo={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};class zx{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??Lo.timeout,this.retries=t.retries??Lo.retries,this.maxInboundStreams=t.maxInboundStreams??Lo.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Lo.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[ns]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(No,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{Lr.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(No,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(No),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const s={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([No],{signal:s.signal,runOnLimitedConnection:!0});const i=nt(t,{maxDataLength:S2}).pb(Nt);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await i.write({type:Nt.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(d=>d.bytes)},s),this.log("B receiving connect from %p",e.remotePeer);const a=await i.read(s);if(a.type!==Nt.Type.CONNECT)throw this.log("A sent wrong message type"),new ve("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new ve("DCUtR connect message had no multiaddrs");const u=Date.now()-o;this.log("A sending sync, rtt %dms",u),await i.write({type:Nt.Type.SYNC,observedAddresses:[]},s),this.log("A waiting for half RTT"),await y6(u/2),this.log("B dialing",c);const l=await this.connectionManager.openConnection(c,{signal:s.signal,priority:_2,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,l.remoteAddr),await e.close(s);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(s)}}}async attemptUnilateralConnectionUpgrade(e){const n=(await this.peerStore.get(e.remotePeer)).addresses.map(s=>{const i=s.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(s=>E2(s,this.transportManager));if(n.length>0){const s=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);const i=await this.connectionManager.openConnection(n,{signal:s,force:!0});if(Lr.exactMatch(i.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close({signal:s}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const s=nt(e,{maxDataLength:S2}).pb(Nt);this.log("A receiving connect");const i=await s.read(n);if(i.type!==Nt.Type.CONNECT)throw this.log("B sent wrong message type"),new ve("DCUtR message type was incorrect");if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new ve("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(i.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new ve("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await s.write({type:Nt.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(u=>u.bytes)}),this.log("A receiving sync"),(await s.read(n)).type!==Nt.Type.SYNC)throw new ve("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:_2,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(s){this.log.error("incoming DCUtR from %p failed",t.remotePeer,s),e.abort(s)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(!(n==null||n.length===0))try{const s=W(n);if(!E2(s,this.transportManager))continue;t.push(s)}catch{}return t}}const No="/libp2p/dcutr";function Hx(r={}){return e=>new zx(e,r)}const Vs=1e3,N1=60*Vs,io=60*N1,Kx=36*io,Wx="/ipfs/kad/1.0.0",Gx=48*io,jx=24*io,Qx=10,Yx=16384,Xx=io,x2=io,Zx=10*Vs,I6=20,Ac=10,Jx=5*N1,eA=Vs,tA=5*Vs,rA=5*N1,nA=30*Vs,sA=180*Vs,A2=`${rc}-kad-dht`;var Ha;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={key:ee(0),value:ee(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Ha||(Ha={}));function iA(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function oA(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),u=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,u))}class gt{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return Ha.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:iA(this.timeReceived)}}static deserialize(e){const t=Ha.decode(e);return new gt(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=oA(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new gt(e.key,e.value,t)}}function aA(r){return r[Symbol.asyncIterator]!=null}function B1(r,e){let t=0;if(aA(r))return async function*(){for await(const c of r)yield e(c,t++)}();const n=l1(r),{value:s,done:i}=n.next();if(i===!0)return function*(){}();const o=e(s,t++);if(typeof o.then=="function")return async function*(){yield await o;for(const c of n)yield e(c,t++)}();const a=e;return function*(){yield o;for(const c of n)yield a(c,t++)}()}class Ka extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class cA extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class lA extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var C2;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(C2||(C2={}));var me;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(me||(me={}));var Wa;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(Wa||(Wa={}));(function(r){r.codec=()=>ar(Wa)})(me||(me={}));var As;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(As||(As={}));var bu;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(bu||(bu={}));(function(r){r.codec=()=>ar(bu)})(As||(As={}));var Vn;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(const i of t.multiaddrs)n.uint32(18),n.bytes(i);t.connection!=null&&(n.uint32(24),As.codec().encode(t.connection,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:ee(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.multiaddrs!=null&&i.multiaddrs.length===s.limits.multiaddrs)throw new ut('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=As.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Vn||(Vn={}));var Jn;(function(r){let e;r.codec=()=>(e==null&&(e=ue((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.type!=null&&Wa[t.type]!==0&&(n.uint32(8),me.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(const i of t.closer)n.uint32(66),Vn.codec().encode(i,n);if(t.providers!=null)for(const i of t.providers)n.uint32(74),Vn.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={type:me.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.type=me.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(s.limits?.closer!=null&&i.closer.length===s.limits.closer)throw new ut('Decode error - map field "closer" had too many elements');i.closer.push(Vn.codec().decode(t,t.uint32(),{limits:s.limits?.closer$}));break}case 9:{if(s.limits?.providers!=null&&i.providers.length===s.limits.providers)throw new ut('Decode error - map field "providers" had too many elements');i.providers.push(Vn.codec().decode(t,t.uint32(),{limits:s.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>le(t,r.codec()),r.decode=(t,n)=>ce(t,r.codec(),n)})(Jn||(Jn={}));function k2(r,e={}){const t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function vu(r,e={}){const t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function Sl(r,e={}){const t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function Cs(r,e={}){const t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function T2(r,e={}){const t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function Eu(r,e={}){const t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function I2(r,e={}){const t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function uA(r,e={}){const t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function dA(r,e,t){if(t.length===0)throw new L("No records given");const s=F(e).split("/");if(s.length<3)throw new L("Record key does not have a selector function");const i=r[s[1].toString()];if(i==null)throw new lA(`No selector function configured for key type "${s[1]}"`);return t.length===1?0:i(e,t)}function hA(r,e){return 0}const fA={pk:hA};async function M1(r,e,t){const n=e.key,i=F(n).split("/");if(i.length<3)return;const o=r[i[1].toString()];if(o==null)throw new L(`No validator available for key type "${i[1]}"`);await o(n,e.value,t)}const pA=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new L('"key" must be a Uint8Array');if(r.byteLength<5)throw new L("Invalid public key record");if(F(r.subarray(0,4))!=="/pk/")throw new L("key was not prefixed with /pk/");const s=zt(e),i=r.slice(4);if(!pe(i,s.toMultihash().bytes))throw new L("public key does not match passed in key")},gA={pk:pA},mA=q("/pk/");function yA(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const s=En(n);return s==null?!0:!s})}}async function $i(r,e){const t=await Ls.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function or(r,e){return $i(r.toMultihash().bytes,e)}function Si(r,e){return new ke(`${r}/${F(e,"base32")}`,!1)}function wA(r){return sr([mA,r.toMultihash().bytes])}function bA(r){return F(r.subarray(0,4))==="/pk/"}function vA(r){const e=Tt(r.subarray(4));return Ht(e)}function P2(r,e){const t=new Date;return new gt(r,e,t).serialize()}const EA=290,SA=54,_A=55,xA=56,AA=4,CA=41;function kA(r){const e=r.stringTuples();for(const t of e)if(t[0]===EA)return!1;if(e[0][0]===SA||e[0][0]===_A||e[0][0]===xA)return!0;if(e[0][0]===AA||e[0][0]===CA){const t=En(`${e[0][1]}`);return t==null||!t}return!1}function P6(r){const e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:se.createV1(vp,Tt(q(n,"base32"))),peerId:yt(t)}}function _l(r,e,t){const n=typeof e=="string"?e:F(e.multihash.bytes,"base32"),s=[r,n];return t!=null&&s.push(t.toString()),new ke(s.join("/"))}function R6(r){return new Date(Xi(r))}function Mn(r,e,t){return async function*(...n){const s=e.queryTime?.timer(t),i=e.errorTime?.timer(t);let o=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}function D6(r,e,t){return async function(...n){const s=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t);let o=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}class TA{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:n,selectors:s,peerRouting:i,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const n=Si(this.datastorePrefix,e);this.log("fetching record for key %k",n);const s=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);const i=gt.deserialize(s);return await M1(this.validators,i,t),i}async*sendCorrectionRecord(e,t,n,s){this.log("sendCorrection for %b",e);const i=P2(e,n);for(const{value:o,from:a}of t){if(pe(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const l=Si(this.datastorePrefix,e);this.log(`Storing corrected record for key ${l.toString()}`),await this.components.datastore.put(l,i.subarray(),s)}catch(l){this.log.error("Failed error correcting self",l)}continue}let c=!1;const u={type:me.PUT_VALUE,key:e,record:i};for await(const l of this.network.sendRequest(a,u,s))l.name==="PEER_RESPONSE"&&l.record!=null&&pe(l.record.value,gt.deserialize(i).value)&&(c=!0),yield l;if(!c)throw new Ka("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);const s=P2(e,t),i=Si(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray(),n),yield*ls(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),o=>B1(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],u={type:me.PUT_VALUE,key:e,record:s};this.log("send put to %p",a.peer.id);for await(const l of this.network.sendRequest(a.peer.id,u,{...n,path:a.path}))c.push(l),l.name==="PEER_RESPONSE"&&(l.record!=null&&pe(l.record.value,gt.deserialize(s).value)||c.push(Cs({from:a.peer.id,error:new Ka("Value not put correctly"),path:l.path},n)));return c}),o=>vc(o,{ordered:!1,concurrency:Ac}),async function*(o){for await(const a of o)yield*a})}async*get(e,t){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;const s=n.map(a=>a.value);let i=0;try{i=dA(this.selectors,e,s)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw new nr("Best value was not found");yield*this.sendCorrectionRecord(e,n,o,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const i=await this.getLocal(e,t);yield Eu({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}const n=this,s=async function*({peer:i,signal:o,path:a}){for await(const c of n.peerRouting.getValueOrPeers(i.id,e,{...t,signal:o,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield Eu({from:i.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,s,t)}}function IA(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function Bo(r){if(r.id==null)throw new Error("Invalid peer in message");const e=Tt(r.id);return{id:Ht(e),multiaddrs:(r.multiaddrs??[]).map(t=>W(t))}}class PA{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(u,l)=>(u.name==="PROVIDER"&&(l.providers??=[],l.providers.push(...u.providers.map(d=>d.id.toString()))),l)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(u,l)=>(u.name==="PEER_RESPONSE"&&u.messageName==="ADD_PROVIDER"&&(l.providers??=[],l.providers.push(u.from.toString())),l)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);const s=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);const i={type:me.ADD_PROVIDER,key:s,providers:[IA({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=this;async function*c(d){try{a.log("sending provider record for %s to %p",e,d.peer.id);for await(const h of a.network.sendMessage(d.peer.id,i,{...n,path:d.path}))h.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,d.peer.id),o++),yield h}catch(h){a.log.error("error sending provide record to peer %p",d.peer.id,h),yield Cs({from:d.peer.id,error:h,path:d.path},n)}}const u=cr({objectMode:!0}),l=new so({concurrency:Ac});l.addEventListener("idle",()=>{u.end()}),l.addEventListener("error",d=>{this.log.error("error publishing provider record to peer - %e",d)}),l.add(async()=>{const d=[];for await(const h of this.peerRouting.getClosestPeers(s,n))u.push(h),h.name==="FINAL_PEER"&&d.push(h);d.forEach(h=>{l.add(async()=>{for await(const f of c(h))u.push(f)}).catch(f=>{this.log.error("error publishing provider record to peer - %e",f)})})}).catch(d=>{u.end(d)}),yield*u,this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let s=0;const i=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e,t);if(a.length>0){const l=[];for(const d of a.slice(0,n))try{const h=await this.components.peerStore.get(d,t);l.push({id:d,multiaddrs:h.addresses.map(({multiaddr:f})=>f)})}catch(h){if(h.name!=="NotFoundError")throw h;this.log("no peer store entry for %p",d)}if(yield vu({from:this.components.peerId,messageType:me.GET_PROVIDERS,providers:l,path:{index:-1,queued:0,running:0,total:0}},t),yield T2({from:this.components.peerId,providers:l,path:{index:-1,queued:0,running:0,total:0}},t),s+=l.length,s>=n)return}const c=async function*({peer:l,signal:d,path:h}){const f={type:me.GET_PROVIDERS,key:i};yield*o.network.sendRequest(l.id,f,{...t,signal:d,path:h})},u=new tr(a);for await(const l of this.queryManager.run(i,c,t))if(yield l,l.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",l.providers.length,e,l.closer.length);const d=[];for(const h of l.providers)u.has(h.id)||(u.add(h.id),d.push(h));if(d.length>0&&(yield T2({from:l.from,providers:d,path:l.path},t),s+=d.length,s>=n))return}}}class RA extends He{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new Ui({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new L("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield I2({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield k2({to:e,type:s,path:n.path},n);const c=await this._writeReadMessage(i,t,n);i.close(n).catch(u=>{this.log.error("error closing stream to %p",e,u),i?.abort(u)}),yield vu({from:e,messageType:c.type,closer:c.closer.map(Bo),providers:c.providers.map(Bo),record:c.record==null?void 0:gt.deserialize(c.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield Cs({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async*sendMessage(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new L("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield I2({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield k2({to:e,type:s,path:n.path},n),await this._writeMessage(i,t,n),i.close(n).catch(c=>{this.log.error("error closing stream to %p",e,c),i?.abort(c)}),yield vu({from:e,messageType:s,path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),yield Cs({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async _writeMessage(e,t,n){await nt(e).write(t,Jn,n)}async _writeReadMessage(e,t,n){const s=nt(e);await s.write(t,Jn,n);const i=await s.read(Jn,n);return i.closer.forEach(o=>{this.safeDispatchEvent("peer",{detail:Bo(o)})}),i.providers.forEach(o=>{this.safeDispatchEvent("peer",{detail:Bo(o)})}),i}}function _i(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}class O1{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){const s=await or(e.id,n);this.addWithKadId(e,s,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;const s={peer:e,distance:ds(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){const o=this.peerDistances[this.peerDistances.length-1];if(o!=null&&_i(s.distance,o.distance)!==-1)return}let i=!1;for(let o=0;o<this.peerDistances.length;o++){const a=_i(this.peerDistances[o].distance,s.distance);if(a===0||a===1){i=!0,this.peerDistances.splice(o,0,s);break}}i||this.peerDistances.push(s),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const n=await or(e,t),s=ds(n,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return _i(s,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}}class DA{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n;const s=await this.routingTable.find(e,t);if(s!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(s,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n){const s={type:me.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=wA(e),s={index:-1,queued:0,running:0,total:0};for await(const i of this._getValueSingle(e,n,{...t,path:s}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const o=zt(i.record.value),a=as(o);if(!a.equals(e))throw new sa("public key does not match id");if(a.publicKey==null)throw new sa("public key missing");yield Eu({from:e,value:i.record.value,path:s},t)}throw new Ka(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const s=await this.findPeerLocal(e,t);if(s!=null){this.log("found local"),yield Sl({from:this.components.peerId,peer:s,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){const s=this,i=async function*({peer:o,signal:a,path:c}){const u={type:me.FIND_NODE,key:e.toMultihash().bytes};for await(const l of s.network.sendRequest(o.id,u,{...t,signal:a,path:c}))if(yield l,l.name==="PEER_RESPONSE"){const d=l.closer.find(h=>h.id.equals(e));d!=null&&(yield Sl({from:l.from,peer:d,path:l.path},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,i,t))o.name==="FINAL_PEER"&&(n=!0),yield o}if(!n)throw new nr("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await $i(e,t),s=new O1(n,this.routingTable.kBucketSize),i=this,o=async function*({peer:a,path:c,peerKadId:u,signal:l}){i.log("getClosestPeers asking %p",a.id);const d={type:me.FIND_NODE,key:e};yield*i.network.sendRequest(a.id,d,{...t,signal:l,path:c}),s.addWithKadId(a,u,c)};yield*this.queryManager.run(e,o,t),this.log("found %d peers close to %b",s.length,e);for(let{peer:a,path:c}of s.peers)try{if(a.multiaddrs.length===0&&(a=await i.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield Sl({from:this.components.peerId,peer:await i.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(const s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record,n)}catch{const o="invalid record received, discarded";this.log(o),yield Cs({from:s.from,error:new Ka(o),path:n.path},n);continue}yield s}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new cA("invalid record received");await M1(this.validators,new gt(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const n=[];try{const o=Tt(e),a=Ht(o),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:u})=>u)})}catch{}const s=await $i(e,t),i=this.routingTable.closestPeers(s,t);for(const o of i)try{n.push(await this.components.peerStore.getInfo(o,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}}class LA{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){const s=_l(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(s,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);const n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){const s=_l(this.datastorePrefix,e,t),i=rn(n?.time?.getTime()??Date.now());await this.datastore.put(s,i,n)}async loadProviders(e,t){const n=new vn,s=_l(this.datastorePrefix,e);for await(const i of this.datastore.query({prefix:s.toString()},t)){const{peerId:o}=P6(i.key);n.set(o,R6(i.value))}return n}}const NA=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function BA(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const a=[e].flat(),c=[],{addListener:u,removeListener:l}=NA(r),d=(...f)=>{const p=t.multiArgs?f:f[0];t.filter&&!t.filter(p)||(c.push(p),t.count===c.length&&(n(),i(c)))},h=f=>{n(),o(f)};n=()=>{for(const f of a)l(f,d);for(const f of t.rejectionEvents)l(f,h)};for(const f of a)u(f,d);for(const f of t.rejectionEvents)u(f,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=Ec(s,{milliseconds:t.timeout});return i.cancel=n,i}return s}function MA(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=BA(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}async function*OA(r){const{key:e,startingPeers:t,ourPeerId:n,query:s,alpha:i,path:o,numPaths:a,log:c,peersSeen:u,connectionManager:l,signal:d}=r,h=cr({objectMode:!0}),f=new so({concurrency:i,sort:(g,y)=>_i(g.options.distance,y.options.distance)});f.addEventListener("idle",()=>{h.push(uA({path:{index:o,queued:f.queued,running:f.running,total:f.size}},r)),h.end()}),f.addEventListener("error",g=>{c.error("error during query - %e",g.detail)}),d.addEventListener("abort",()=>{f.abort(),h.end(new Rr)});const p=await $i(e,{signal:d});function m(g,y){if(g==null)return;u.add(g.id.toMultihash().bytes);const E=ds(y,p);f.add(async()=>{try{for await(const b of s({...r,key:e,peer:g,path:{index:o,queued:f.queued,running:f.running,total:f.size},numPaths:a,peerKadId:y,signal:d})){if(b.name==="PEER_RESPONSE")for(const _ of b.closer){if(u.has(_.id.toMultihash().bytes)){c("already seen %p in query",_.id);continue}if(n.equals(_.id)){c("not querying ourselves");continue}if(!await l.isDialable(_.multiaddrs)){c("not querying undialable peer");continue}const w=await or(_.id,{signal:d}),k=ds(w,p);if(_i(k,E)!==-1){c("skipping %p as they are not closer to %b than %p",_.id,e,g);continue}c("querying closer peer %p",_.id),m(_,w)}h.push({...b,path:{index:o,queued:f.queued,running:f.running,total:f.size}})}}catch(b){h.push(Cs({from:g.id,error:b,path:{index:o,queued:f.queued,running:f.running-1,total:f.size-1}},r))}},{distance:E}).catch(b=>{c.error("error during query - %e",b)})}await Promise.all(t.map(async g=>{m({id:g,multiaddrs:[]},await or(g,{signal:d}))})),yield*h}class FA{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??I6,this.alpha=t.alpha??Ac,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){const c=AbortSignal.timeout(sA);n={...n,signal:c}}const s=new AbortController,i=tt([this.shutDownController.signal,s.signal,n.signal]);s.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+F(e,"base58btc"));let a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(o("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await MA(this.routingTable,"peer:add",{signal:i,filter:f=>!this.peerId.equals(f.detail)}),o("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial self query before continuing"),await De(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await $i(e,{signal:i}),u=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),l=u.sort(()=>Math.random()>.5?1:-1).reduce((f,p,m)=>(f[m%this.disjointPaths].push(p),f),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(f=>f.length>0);if(u.length===0){o.error("running query with no peers");return}const d=ys(1024),h=l.map((f,p)=>OA({...n,key:e,startingPeers:f,ourPeerId:this.peerId,signal:i,query:t,path:p,numPaths:l.length,alpha:this.alpha,log:o,peersSeen:d,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const f of Ti(...h)){if(f.name==="QUERY_ERROR"&&o.error("query error",f.error),f.name==="PEER_RESPONSE")for(const p of[...f.closer,...f.providers])await this.connectionManager.isDialable(p.multiaddrs,{signal:i})&&await this.routingTable.add(p.id,{signal:i});i.throwIfAborted(),yield f}a=!0}catch(c){if(this.running)throw c}finally{a||(o("query exited early"),s.abort()),i.clear(),o("query finished")}}}function UA(r){return r[Symbol.asyncIterator]!=null}function L6(r){if(UA(r))return(async()=>{let e=0;for await(const t of r)e++;return e})();{let e=0;for(const t of r)e++;return e}}class $A{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??I6,this.interval=t.interval??Jx,this.initialInterval=t.initialInterval??eA,this.queryTimeout=t.queryTimeout??tA,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=D6(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=fe(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const n=AbortSignal.timeout(this.queryTimeout);e.push(n)}const t=tt(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const n=Date.now(),s=await ls(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>pu(o,this.count),async o=>L6(o));t?.throwIfAborted();const i=Date.now()-n;this.log("self-query found %d peers in %dms",s,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:s,duration:i}}))}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class qA extends He{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new so({concurrency:t.concurrency??Qx,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new Ui({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??jx,this.maxQueueSize=t.maxQueueSize??Yx,this.validity=t.validity??Gx,this.interval=t.interval??Xx,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=D6(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(x2)}).catch(e=>{this.log.error("error running reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async cleanUp(e){try{this.safeDispatchEvent("reprovide:start");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:n,peerId:s}=P6(t.key),i=R6(t.value).getTime(),o=i+this.validity,a=Date.now(),c=a>o;this.log.trace("comparing: %d < %d = %s %s",i,a-this.validity,c,c?"(expired)":""),c&&await this.datastore.delete(t.key,e),this.peerId.equals(s)&&a-o<this.reprovideThreshold&&this.queueReprovide(n).catch(u=>{this.log.error("could not reprovide %c - %e",n,u)})}catch(n){this.log.error("error processing datastore key %s - %e",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(x2)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const n=this.reprovideQueue.queue.find(s=>s.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async s=>{if(s.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const i=this.reprovideTimeout.getTimeoutSignal(s);try{await this.reprovide(s.cid,s)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(s=>{this.log.error("could not re-provide key %c - %e",e,s)})}async reprovide(e,t){await ws(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}const VA=20,zA=5e3,HA="kad-close",KA=50;class WA{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??zA,this.peerSetSize=t.peerSetSize??VA,this.closeTagName=t.closeTagName??HA,this.closeTagValue=t.closeTagValue??KA,this.closestPeers=new tr,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await or(this.components.peerId);this.newPeers=new O1(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){const e=new tr(this.newPeers?.peers.map(({peer:s})=>s.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[A2]:{value:1}}})}),...[...n].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[A2]:void 0}})})])}}function Yo(r){return Array.isArray(r?.peers)}class GA{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??YA,this.kBucketSize=t.kBucketSize??F1,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??JA,this.lastPingThreshold=t.lastPingThreshold??nC,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=c3({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await or(e,t),lastPing:Date.now()}}async add(e,t){const n={peerId:e,kadId:await or(e,t),lastPing:0},s=this.addingPeerMap.get(e);if(s!=null)return s;try{const i=this._add(n,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!QA(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const s=n.peers.filter(o=>!(o.peerId.equals(this.localPeer?.peerId)||o.lastPing>Date.now()-this.lastPingThreshold)).sort((o,a)=>o.lastPing<a.lastPing?-1:o.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing);let i=!1;for await(const o of this.ping(s,t))i=!0,await this.remove(o.kadId,t);i&&await this._add(e,t)}*closest(e,t){const n=new O1(e,t?.count??this.kBucketSize);for(const s of this.toIterable())t?.exclude?.some(i=>i.equals(s.peerId))!==!0&&n.addWithKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*B1(n.peers,({peer:s})=>s.id)}count(){function e(t){if(Yo(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){const n=this._determineBucket(e),s=this._indexOf(n,e);if(s>-1){const i=n.peers.splice(s,1)[0];await this.onRemove?.(i,n,t)}}*toIterable(){function*e(t){if(Yo(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+F(ds(e,t),"base16"))}_determineBucket(e){const t=F(e,"base2");function n(s,i=0){return Yo(s)?s:t[i]==="0"?n(s.left,i+1):n(s.right,i+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>pe(n.kadId,t))}async _split(e,t){const n={prefix:"0",depth:e.depth+1,peers:[]},s={prefix:"1",depth:e.depth+1,peers:[]};for(const i of e.peers)F(i.kadId,"base2")[e.depth]==="0"?(n.peers.push(i),await this.onMove?.(i,e,n,t)):(s.peers.push(i),await this.onMove?.(i,e,s,t));jA(e,n,s)}}function jA(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function QA(r,e){return r.lastPing<Date.now()-e}const F1=20,YA=6,XA=20,ZA=100,JA=3,eC=20,tC=100,R2="kad-peer",rC=1,nC=6e5,sC=!0,iC=1e3;class oC extends He{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??F1,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??R2,this.peerTagValue=t.peerTagValue??rC,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??sC,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??iC,this.shutdownController=new AbortController,this.pingOldContactQueue=new Bi({concurrency:t.pingOldContactConcurrency??eC,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??tC}),this.pingOldContactTimeout=new Ui({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Bi({concurrency:t.pingNewContactConcurrency??XA,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??ZA}),this.pingNewContactTimeout=new Ui({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new GA(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new WA(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,await Ai(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=tt([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const n of await this.components.peerStore.all({filters:[s=>s.protocols.includes(this.protocol)&&s.tags.has(R2)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await sc(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const n=[];for(const s of e){if(this.kb.get(s.kadId)==null){this.log("asked to ping contact %p that was not in routing table",s.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{const i=this.pingOldContactQueue.find(s.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",s.peerId),await i.join(t)?void 0:s;if(!await this.pingOldContactQueue.add(async a=>{const c=this.pingOldContactTimeout.getTimeoutSignal(),u=tt([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(s,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),u.clear()}},{peerId:s.peerId,signal:t?.signal}))return s})}for await(const s of vc(n))s!=null&&(yield s)}async verifyNewContact(e,t){const n=this.pingNewContactTimeout.getTimeoutSignal(),s=tt([n,this.shutdownController.signal,t?.signal]);try{const i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:s})):await this.pingNewContactQueue.add(async o=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,o)),{peerId:e.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),s.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(n){return this.log("error pinging old contact %p - %e",e.peerId,n),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){const n=await or(e,t);return this.kb.get(n)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");const n=await or(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,s=20,i=0;function o(a){if(Yo(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<s&&(s=a.peers.length),a.peers.length>i&&(i=a.peers.length);return}o(a.left),o(a.right)}o(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(n)}}const aC=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Mo=15;class cC{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:n,routingTable:s,refreshInterval:i,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=s,this.refreshInterval=i??rA,this.refreshQueryTimeout=o??nA,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const n=this._maxCommonPrefix(),s=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${s.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(s.map(async(i,o)=>{try{if(await this._refreshCommonPrefixLength(o,i,e,t),this._numPeersForCpl(n)===0){const a=Math.min(2*(o+1),s.length-1);for(let c=o+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,i,e,t)}catch(u){this.log.error(u)}}}catch(a){this.log.error(a)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n,s){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const o=tt([s?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const a=await L6(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:o}));this.log(`found ${a} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{o.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Mo&&(e=Mo);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=un(2),n=(t[1]<<8)+t[0],s=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),i=Tt(s);return Ht(i)}_makePeerId(e,t,n){if(n>Mo)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Mo}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,u=aC[c],l=new ArrayBuffer(34),d=new DataView(l,0,l.byteLength);return d.setUint8(0,Ls.code),d.setUint8(1,32),d.setUint32(2,u,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=ds(this.routingTable.kb.localPeer.kadId,e);let n=0;for(const s of t)if(s===0)n++;else break;yield n}}}class lC{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new ve("Missing key");let n;try{n=se.decode(t.key)}catch{throw new ve("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async s=>{const i=Tt(s.id),o=Ht(i),a=s.multiaddrs.map(c=>W(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class uC{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:n,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new ve("Invalid FIND_NODE message received - key was missing");const n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});pe(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(qe("p2p").code))});const s={type:me.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(o=>o.bytes)})),providers:[]};return s.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",s.closer.length,t.key,e),s}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}}class dC{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:n,providers:s,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new ve("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=se.decode(t.key)}catch{throw new ve("Invalid CID")}this.log("%p asking for providers for %s",e,n);const[s,i]=await Promise.all([$a(B1(await this.providers.getProviders(n),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)}})),this.peerRouting.getClosestPeersOffline(t.key)]),o={type:me.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class hC{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new ve("Invalid key");const s={type:me.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(bA(n)){this.log("is public key");const a=vA(n);let c;try{const u=await this.peerStore.get(a);if(u.id.publicKey==null)throw new nr("No public key found in key book");c=Ft(u.id.publicKey)}catch(u){if(u.name!=="NotFoundError")throw u}if(c!=null)return this.log("returning found public key"),s.record=new gt(n,c,new Date).serialize(),s}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return i!=null&&(this.log("had record for %b in local datastore",n),s.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),s.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=Si(this.datastorePrefix,e);let n;try{n=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}const s=gt.deserialize(n);if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>Kx){await this.datastore.delete(t);return}return s}}class fC{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class pC{components;validators;log;datastorePrefix;constructor(e,t){const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){const s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new ve(s)}try{const s=gt.deserialize(t.record);await M1(this.validators,s),s.timeReceived=new Date;const i=Si(this.datastorePrefix,s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(s){this.log("did not put record for key %b into datastore %o",n,s)}return t}}class gC{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[me.GET_VALUE.toString()]:new hC(e,t),[me.PUT_VALUE.toString()]:new pC(e,t),[me.FIND_NODE.toString()]:new uC(e,t),[me.ADD_PROVIDER.toString()]:new lC(e,t),[me.GET_PROVIDERS.toString()]:new dC(e,t),[me.PING.toString()]:new fC(e,t)}}async handleMessage(e,t){const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){const t="unknown";Promise.resolve().then(async()=>{const{stream:n,connection:s}=e,i=()=>{n.abort(new nc)};let o=AbortSignal.timeout(this.incomingMessageTimeout);o.addEventListener("abort",i);const a=nt(n).pb(Jn);try{for(;;){const c=await a.read({signal:o}),u=this.metrics?.rpcTime?.timer(c.type.toString()),l=this.metrics?.rpcTime?.timer(c.type.toString());let d=!1;try{this.log("incoming %s from %p",c.type,s.remotePeer);const h=await this.handleMessage(s.remotePeer,c);h!=null&&await a.write(h,{signal:o})}catch(h){throw d=!0,l?.(),h}finally{d||u?.()}o.removeEventListener("abort",i),o=AbortSignal.timeout(this.incomingMessageTimeout),o.addEventListener("abort",i)}}catch(c){n.abort(c)}}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}}class mC extends He{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:n,logPrefix:s}=t;this.components=e,this.log=e.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class yC{dht;constructor(e){this.dht=e}async provide(e,t={}){await ws(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await ws(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new nr("Could not find value for key")}}class wC{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new nr("Peer not found")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const bC=32,vC=64;class EC extends He{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const n=t.logPrefix??"libp2p:kad-dht",s=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",o={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??F1,this.a=t.alpha??Ac,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??Wx,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??bC,this.maxOutboundStreams=t.maxOutboundStreams??vC,this.peerInfoMapper=t.peerInfoMapper??yA,this.onPeerConnectTimeout=t.onPeerConnectTimeout??Zx,this.providers=new LA(e,{...t.providers,logPrefix:n,datastorePrefix:s}),this.validators={...gA,...t.validators},this.selectors={...fA,...t.selectors},this.network=new RA(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:i}),this.routingTable=new oC(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const a=fe();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new FA(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:i,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new DA(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new TA(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:s}),this.contentRouting=new PA(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new cC(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new gC(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:i,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new mC(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new $A(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:o}),this.reprovider=new qA(e,{...t.reprovide,logPrefix:n,metricsPrefix:i,datastorePrefix:s,contentRouting:this.contentRouting,operationMetrics:o}),this.network.addEventListener("peer",c=>{const u=c.detail;this.onPeerConnect(u).catch(l=>{this.log.error("could not add %p to routing table",u.id,l)}),this.dispatchEvent(new CustomEvent("peer",{detail:u}))}),this.topologyListener.addEventListener("peer",c=>{const u=c.detail;Promise.resolve().then(async()=>{const l=await this.components.peerStore.get(u),d={id:u,multiaddrs:l.addresses.map(({multiaddr:h})=>h),protocols:l.protocols};await this.onPeerConnect(d)}).catch(l=>{this.log.error("could not add %p to routing table - %e - %e",u,l)})}),this.dhtPeerRouting=new wC(this),this.dhtContentRouting=new yC(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const u=c.detail.peer.addresses.some(({multiaddr:d})=>kA(d)),l=this.getMode();u&&l==="client"?await this.setMode("server"):l==="server"&&!u&&await this.setMode("client")}).catch(u=>{this.log.error("error setting dht server mode",u)})}),this.get=Mn(this.get.bind(this),o,"GET_VALUE"),this.findProviders=Mn(this.findProviders.bind(this),o,"FIND_PROVIDERS"),this.findPeer=Mn(this.findPeer.bind(this),o,"FIND_PEER"),this.getClosestPeers=Mn(this.getClosestPeers.bind(this),o,"GET_CLOSEST_PEERS"),this.provide=Mn(this.provide.bind(this),o,"PROVIDE"),this.put=Mn(this.put.bind(this),o,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[rt]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[ns]=["@libp2p/identify","@libp2p/ping"];get[Ml](){return this.dhtContentRouting}get[Ol](){return this.dhtPeerRouting}get[na](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await Ai(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await Ai(this.querySelf))}async stop(){this.running=!1,await sc(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var D2;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(D2||(D2={}));function SC(r={}){return e=>new EC(e,r)}const _C=O("dns4"),xC=O("dns6"),AC=O("dnsaddr"),pn=xe(O("dns"),AC,_C,xC),Cc=xe(O("ip4"),O("ip6")),ks=xe(H(Cc,O("tcp")),H(pn,O("tcp"))),kc=H(Cc,O("udp")),CC=H(kc,O("utp")),kC=H(kc,O("quic")),TC=H(kc,O("quic-v1")),Su=xe(H(ks,O("ws")),H(pn,O("ws"))),Ga=xe(H(Su,O("p2p")),Su),_u=xe(H(ks,O("wss")),H(pn,O("wss")),H(ks,O("tls"),O("ws")),H(pn,O("tls"),O("ws"))),ja=xe(H(_u,O("p2p")),_u),xu=xe(H(ks,O("http")),H(Cc,O("http")),H(pn,O("http"))),Au=xe(H(ks,O("https")),H(Cc,O("https")),H(pn,O("https"))),L2=H(kc,O("webrtc-direct"),O("certhash")),N6=xe(H(L2,O("p2p")),L2),N2=H(TC,O("webtransport"),O("certhash"),O("certhash")),B6=xe(H(N2,O("p2p")),N2),M6=xe(H(Ga,O("p2p-webrtc-star"),O("p2p")),H(ja,O("p2p-webrtc-star"),O("p2p")),H(Ga,O("p2p-webrtc-star")),H(ja,O("p2p-webrtc-star")));xe(H(Ga,O("p2p-websocket-star"),O("p2p")),H(ja,O("p2p-websocket-star"),O("p2p")),H(Ga,O("p2p-websocket-star")),H(ja,O("p2p-websocket-star")));const O6=xe(H(xu,O("p2p-webrtc-direct"),O("p2p")),H(Au,O("p2p-webrtc-direct"),O("p2p")),H(xu,O("p2p-webrtc-direct")),H(Au,O("p2p-webrtc-direct"))),gn=xe(Su,_u,xu,Au,M6,O6,ks,CC,kC,pn,N6,B6);xe(H(gn,O("p2p-stardust"),O("p2p")),H(gn,O("p2p-stardust")));const xr=xe(H(gn,O("p2p")),M6,O6,N6,B6,O("p2p")),B2=xe(H(xr,O("p2p-circuit"),xr),H(xr,O("p2p-circuit")),H(O("p2p-circuit"),xr),H(gn,O("p2p-circuit")),H(O("p2p-circuit"),gn),O("p2p-circuit")),F6=()=>xe(H(B2,F6),B2),Kr=F6(),IC=xe(H(Kr,xr,Kr),H(xr,Kr),H(Kr,xr),Kr,xr);xe(H(Kr,O("webrtc"),O("p2p")),H(Kr,O("webrtc")),H(gn,O("webrtc"),O("p2p")),H(gn,O("webrtc")),O("webrtc"));function U6(r){function e(t){let n;try{n=W(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function H(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:U6(e),partialMatch:e}}function xe(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:U6(e),partialMatch:e}}function O(r){const e=r;function t(s){let i;try{i=W(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const PC="bootstrap",RC=50,DC=1e3;class LC extends He{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??DC,this.list=[];for(const n of t.list){if(!IC.matches(n)){this.log.error("Invalid multiaddr");continue}const s=W(n),i=s.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:yt(i),multiaddrs:[s]};this.list.push(o)}this._init=t}[na]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[rt]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??PC]:{value:this._init.tagValue??RC,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function NC(r){return e=>new LC(e,r)}class BC{mode;connections;activeTransfer;finished;selectedFile;activePeerId;activeStream;transferConnectionId;reconnected;constructor(){this.mode="idle",this.connections=new Map,this.activeTransfer=!1,this.finished=!1,this.selectedFile=null,this.activePeerId=null,this.activeStream=null,this.transferConnectionId=null,this.reconnected=!1}setMode(e){this.mode=e}getMode(){return this.mode}reset(){this.mode="idle",this.connections.clear(),this.activeTransfer=!1,this.finished=!1,this.selectedFile=null,this.activePeerId=null,this.activeStream=null,this.transferConnectionId=null}addConnection(e,t){const n=this.connections.get(e.toString())||new Map;n.set(t.id,t),this.connections.set(e.toString(),n)}removeConnection(e,t){const n=this.connections.get(e);n?.delete(t),n&&this.connections.set(e,n)}removeAllConnectionsWithPeer(e){this.connections.delete(e)}getConnectionsForPeer(e){return this.connections.get(e)}getAllConnections(){return Array.from(this.connections.values())}setActiveTransfer(){this.activeTransfer=!0}clearActiveTransfer(){this.activeTransfer=!1}isTransferActive(){return!!this.activeTransfer}setTransferConnectionId(e){this.transferConnectionId=e}getTransferConnectionId(){return this.transferConnectionId}setSelectedFile(e){this.selectedFile=e}getSelectedFile(){return this.selectedFile}clearSelectedFile(){this.selectedFile=null}setActivePeer(e){this.activePeerId=e}getActivePeer(){return this.activePeerId}setActiveStream(e){this.activeStream=e}getActiveStream(){return this.activeStream}setReconnected(e){this.reconnected=e}hasReconnected(){return this.reconnected||!1}isFinished(){return this.finished||!1}declareFinished(){this.finished=!0}}class MC{node;appState;errorHandler;config;fileTransferHandler;retryAttempts;constructor(e,t,n,s,i){this.node=e,this.appState=t,this.errorHandler=n,this.config=s,this.fileTransferHandler=i,this.retryAttempts=new Map}async onConnectionEstablished(e){const t=e.detail,n=t.remotePeer,s=n.toString(),i=t.remoteAddr.toString();console.log(`Connection OPENED with: ${s} on ${i}`),this.appState.addConnection(n,t),await this.handleConnectionType(t,s,i)}async onConnectionClosed(e){const t=e.detail.remotePeer.toString(),n=e.detail.id;this.appState.isTransferActive()&&t===this.appState.getActivePeer()&&this.appState.getTransferConnectionId()===n&&!this.appState.isFinished()&&!this.appState.hasReconnected()&&(console.log("LOST CONNECTION"),this.errorHandler.reconnecting(),this.appState.getMode()==="sender"?await this.onSenderConnectionError(e.detail.remotePeer):this.appState.getMode()==="receiver"&&await this.onReceiverConnectionError(t)),this.appState.removeConnection(t,n)}async onReceiverConnectionError(e){let t;try{await new Promise((n,s)=>{t=i=>{i.detail.remotePeer.toString()===e&&this.appState.isTransferActive()&&(this.appState.setReconnected(!0),this.errorHandler.reconnected(),this.onConnectionEstablished(i),n())},this.node.addEventListener("connection:open",t),setTimeout(()=>{s(new Error("Timeout: Waited 30 seconds for reconnection, but none occurred."))},3e4)})}catch(n){console.error(n),await this.fileTransferHandler.transferComplete(),this.errorHandler.tryAgainError()}finally{t&&this.node.removeEventListener("connection:open",t)}}async onSenderConnectionError(e){const t=e.toString(),n=2e3;let s=this.retryAttempts.get(t)||0;for(;s<4;){console.log(`Attempting to reconnect to ${t}...`);try{const i=await this.dialPeer(e,{signal:AbortSignal.timeout(5e3)});console.log(`Reconnected to ${t}`),this.errorHandler.reconnected(),this.appState.setReconnected(!0),this.handleConnectionType(i,t,i.remoteAddr.toString());break}catch{s++,this.retryAttempts.set(t,s),await new Promise(o=>setTimeout(o,n*s))}}s>=4&&(this.appState.declareFinished(),await this.node.stop(),this.errorHandler.tryAgainError())}async dialPeer(e,t={}){try{return await this.node.dial(e,t)}catch(n){throw n}}async closePeer(e){const t=this.appState.getConnectionsForPeer(e.toString());if(t)for(const n of t.values())n&&(await n.close(),t.delete(n.id))}async handleConnectionType(e,t,n){const s=this.config.getRelayAddress();if(n.includes("/webrtc")){if(console.log(n.includes("/webrtc"),"WebRTC connection established"),this.appState.getMode()==="sender"&&this.appState.getSelectedFile()!=null){const i=W(n),o=await this.node.dialProtocol(i,this.config.getFileTransferProtocol());this.appState.setTransferConnectionId(e.id),this.appState.setActivePeer(t),this.appState.setActiveStream(o);try{console.log("Starting file transfer with",t),await this.fileTransferHandler.startFileTransfer()}catch{this.onSenderConnectionError(e.remotePeer)}}}else n===s&&console.log(`Direct relay connection established for ${t}`)}}/**
 * @license
 * web-streams-polyfill v4.1.0
 * Copyright 2024 Mattias Buelens, Diwank Singh Tomer and other contributors.
 * This code is released under the MIT license.
 * SPDX-License-Identifier: MIT
 */function qi(){}function Te(r){return typeof r=="object"&&r!==null||typeof r=="function"}const $6=qi;function X(r,e){try{Object.defineProperty(r,"name",{value:e,configurable:!0})}catch{}}const U1=Promise,OC=Promise.resolve.bind(U1),FC=Promise.prototype.then,UC=Promise.reject.bind(U1),$C=OC;function ze(r){return new U1(r)}function te(r){return ze(e=>e(r))}function V(r){return UC(r)}function Mt(r,e,t){return FC.call(r,e,t)}function kt(r,e,t){Mt(Mt(r,e,t),void 0,$6)}function xl(r,e){kt(r,e)}function Cu(r,e){kt(r,void 0,e)}function sn(r,e,t){return Mt(r,e,t)}function oo(r){Mt(r,void 0,$6)}let on=r=>{if(typeof queueMicrotask=="function")on=queueMicrotask;else{const e=te(void 0);on=t=>Mt(e,t)}return on(r)};function Ts(r,e,t){if(typeof r!="function")throw new TypeError("Argument is not a function");return Function.prototype.apply.call(r,e,t)}function zs(r,e,t){try{return te(Ts(r,e,t))}catch(n){return V(n)}}let wt=class{constructor(){this._cursor=0,this._size=0,this._front={_elements:[],_next:void 0},this._back=this._front,this._cursor=0,this._size=0}get length(){return this._size}push(e){const t=this._back;let n=t;t._elements.length===16383&&(n={_elements:[],_next:void 0}),t._elements.push(e),n!==t&&(this._back=n,t._next=n),++this._size}shift(){const e=this._front;let t=e;const n=this._cursor;let s=n+1;const i=e._elements,o=i[n];return s===16384&&(t=e._next,s=0),--this._size,this._cursor=s,e!==t&&(this._front=t),i[n]=void 0,o}forEach(e){let t=this._cursor,n=this._front,s=n._elements;for(;!(t===s.length&&n._next===void 0||t===s.length&&(n=n._next,s=n._elements,t=0,s.length===0));)e(s[t]),++t}peek(){const e=this._front,t=this._cursor;return e._elements[t]}};const q6=Symbol("[[AbortSteps]]"),V6=Symbol("[[ErrorSteps]]"),$1=Symbol("[[CancelSteps]]"),q1=Symbol("[[PullSteps]]"),V1=Symbol("[[ReleaseSteps]]");function z6(r,e){r._ownerReadableStream=e,e._reader=r,e._state==="readable"?ku(r):e._state==="closed"?function(t){ku(t),K6(t)}(r):H6(r,e._storedError)}function z1(r,e){return _t(r._ownerReadableStream,e)}function Zt(r){const e=r._ownerReadableStream;e._state==="readable"?H1(r,new TypeError("Reader was released and can no longer be used to monitor the stream's closedness")):function(t,n){H6(t,n)}(r,new TypeError("Reader was released and can no longer be used to monitor the stream's closedness")),e._readableStreamController[V1](),e._reader=void 0,r._ownerReadableStream=void 0}function Qa(r){return new TypeError("Cannot "+r+" a stream using a released reader")}function ku(r){r._closedPromise=ze((e,t)=>{r._closedPromise_resolve=e,r._closedPromise_reject=t})}function H6(r,e){ku(r),H1(r,e)}function H1(r,e){r._closedPromise_reject!==void 0&&(oo(r._closedPromise),r._closedPromise_reject(e),r._closedPromise_resolve=void 0,r._closedPromise_reject=void 0)}function K6(r){r._closedPromise_resolve!==void 0&&(r._closedPromise_resolve(void 0),r._closedPromise_resolve=void 0,r._closedPromise_reject=void 0)}const M2=Number.isFinite||function(r){return typeof r=="number"&&isFinite(r)},qC=Math.trunc||function(r){return r<0?Math.ceil(r):Math.floor(r)};function Ar(r,e){if(r!==void 0&&typeof(t=r)!="object"&&typeof t!="function")throw new TypeError(`${e} is not an object.`);var t}function Mr(r,e){if(typeof r!="function")throw new TypeError(`${e} is not a function.`)}function W6(r,e){if(!function(t){return typeof t=="object"&&t!==null||typeof t=="function"}(r))throw new TypeError(`${e} is not an object.`)}function mn(r,e,t){if(r===void 0)throw new TypeError(`Parameter ${e} is required in '${t}'.`)}function O2(r,e,t){if(r===void 0)throw new TypeError(`${e} is required in '${t}'.`)}function G6(r){return Number(r)}function F2(r){return r===0?0:r}function K1(r,e){const t=Number.MAX_SAFE_INTEGER;let n=Number(r);if(n=F2(n),!M2(n))throw new TypeError(`${e} is not a finite number`);if(n=function(s){return F2(qC(s))}(n),n<0||n>t)throw new TypeError(`${e} is outside the accepted range of 0 to ${t}, inclusive`);return M2(n)&&n!==0?n:0}function W1(r,e){if(!mr(r))throw new TypeError(`${e} is not a ReadableStream.`)}function es(r){return new Wr(r)}function j6(r,e){r._reader._readRequests.push(e)}function G1(r,e,t){const n=r._reader._readRequests.shift();t?n._closeSteps():n._chunkSteps(e)}function Tc(r){return r._reader._readRequests.length}function Q6(r){const e=r._reader;return e!==void 0&&!!Cr(e)}class Wr{constructor(e){if(mn(e,1,"ReadableStreamDefaultReader"),W1(e,"First parameter"),kr(e))throw new TypeError("This stream has already been locked for exclusive reading by another reader");z6(this,e),this._readRequests=new wt}get closed(){return Cr(this)?this._closedPromise:V(Oo("closed"))}cancel(e=void 0){return Cr(this)?this._ownerReadableStream===void 0?V(Qa("cancel")):z1(this,e):V(Oo("cancel"))}read(){if(!Cr(this))return V(Oo("read"));if(this._ownerReadableStream===void 0)return V(Qa("read from"));let e,t;const n=ze((s,i)=>{e=s,t=i});return Vi(this,{_chunkSteps:s=>e({value:s,done:!1}),_closeSteps:()=>e({value:void 0,done:!0}),_errorSteps:s=>t(s)}),n}releaseLock(){if(!Cr(this))throw Oo("releaseLock");this._ownerReadableStream!==void 0&&function(e){Zt(e);const t=new TypeError("Reader was released");Y6(e,t)}(this)}}function Cr(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_readRequests")&&r instanceof Wr}function Vi(r,e){const t=r._ownerReadableStream;t._disturbed=!0,t._state==="closed"?e._closeSteps():t._state==="errored"?e._errorSteps(t._storedError):t._readableStreamController[q1](e)}function Y6(r,e){const t=r._readRequests;r._readRequests=new wt,t.forEach(n=>{n._errorSteps(e)})}function Oo(r){return new TypeError(`ReadableStreamDefaultReader.prototype.${r} can only be used on a ReadableStreamDefaultReader`)}var Al,Cl,kl;function oi(r){return r.slice()}function X6(r,e,t,n,s){new Uint8Array(r).set(new Uint8Array(t,n,s),e)}Object.defineProperties(Wr.prototype,{cancel:{enumerable:!0},read:{enumerable:!0},releaseLock:{enumerable:!0},closed:{enumerable:!0}}),X(Wr.prototype.cancel,"cancel"),X(Wr.prototype.read,"read"),X(Wr.prototype.releaseLock,"releaseLock"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(Wr.prototype,Symbol.toStringTag,{value:"ReadableStreamDefaultReader",configurable:!0});let yn=r=>(yn=typeof r.transfer=="function"?e=>e.transfer():typeof structuredClone=="function"?e=>structuredClone(e,{transfer:[e]}):e=>e,yn(r)),wn=r=>(wn=typeof r.detached=="boolean"?e=>e.detached:e=>e.byteLength===0,wn(r));function Z6(r,e,t){if(r.slice)return r.slice(e,t);const n=t-e,s=new ArrayBuffer(n);return X6(s,0,r,e,n),s}function ai(r,e){const t=r[e];if(t!=null){if(typeof t!="function")throw new TypeError(`${String(e)} is not a function`);return t}}function U2(r){try{const e=r.done,t=r.value;return Mt($C(t),n=>({done:e,value:n}))}catch(e){return V(e)}}const ao=(kl=(Al=Symbol.asyncIterator)!==null&&Al!==void 0?Al:(Cl=Symbol.for)===null||Cl===void 0?void 0:Cl.call(Symbol,"Symbol.asyncIterator"))!==null&&kl!==void 0?kl:"@@asyncIterator";function J6(r,e="sync",t){if(t===void 0)if(e==="async"){if((t=ai(r,ao))===void 0)return function(s){const i={next(){let o;try{o=e5(s)}catch(a){return V(a)}return U2(o)},return(o){let a;try{const c=ai(s.iterator,"return");if(c===void 0)return te({done:!0,value:o});a=Ts(c,s.iterator,[o])}catch(c){return V(c)}return Te(a)?U2(a):V(new TypeError("The iterator.return() method must return an object"))}};return{iterator:i,nextMethod:i.next,done:!1}}(J6(r,"sync",ai(r,Symbol.iterator)))}else t=ai(r,Symbol.iterator);if(t===void 0)throw new TypeError("The object is not iterable");const n=Ts(t,r,[]);if(!Te(n))throw new TypeError("The iterator method must return an object");return{iterator:n,nextMethod:n.next,done:!1}}function e5(r){const e=Ts(r.nextMethod,r.iterator,[]);if(!Te(e))throw new TypeError("The iterator.next() method must return an object");return e}class t5{constructor(e,t){this._ongoingPromise=void 0,this._isFinished=!1,this._reader=e,this._preventCancel=t}next(){const e=()=>this._nextSteps();return this._ongoingPromise=this._ongoingPromise?sn(this._ongoingPromise,e,e):e(),this._ongoingPromise}return(e){const t=()=>this._returnSteps(e);return this._ongoingPromise=this._ongoingPromise?sn(this._ongoingPromise,t,t):t(),this._ongoingPromise}_nextSteps(){if(this._isFinished)return Promise.resolve({value:void 0,done:!0});const e=this._reader;let t,n;const s=ze((i,o)=>{t=i,n=o});return Vi(e,{_chunkSteps:i=>{this._ongoingPromise=void 0,on(()=>t({value:i,done:!1}))},_closeSteps:()=>{this._ongoingPromise=void 0,this._isFinished=!0,Zt(e),t({value:void 0,done:!0})},_errorSteps:i=>{this._ongoingPromise=void 0,this._isFinished=!0,Zt(e),n(i)}}),s}_returnSteps(e){if(this._isFinished)return Promise.resolve({value:e,done:!0});this._isFinished=!0;const t=this._reader;if(!this._preventCancel){const n=z1(t,e);return Zt(t),sn(n,()=>({value:e,done:!0}))}return Zt(t),te({value:e,done:!0})}}const r5={next(){return $2(this)?this._asyncIteratorImpl.next():V(q2("next"))},return(r){return $2(this)?this._asyncIteratorImpl.return(r):V(q2("return"))},[ao](){return this}};function $2(r){if(!Te(r)||!Object.prototype.hasOwnProperty.call(r,"_asyncIteratorImpl"))return!1;try{return r._asyncIteratorImpl instanceof t5}catch{return!1}}function q2(r){return new TypeError(`ReadableStreamAsyncIterator.${r} can only be used on a ReadableSteamAsyncIterator`)}Object.defineProperty(r5,ao,{enumerable:!1});const n5=Number.isNaN||function(r){return r!=r};function V2(r){const e=Z6(r.buffer,r.byteOffset,r.byteOffset+r.byteLength);return new Uint8Array(e)}function Tu(r){const e=r._queue.shift();return r._queueTotalSize-=e.size,r._queueTotalSize<0&&(r._queueTotalSize=0),e.value}function j1(r,e,t){if(typeof(n=t)!="number"||n5(n)||n<0||t===1/0)throw new RangeError("Size must be a finite, non-NaN, non-negative number.");var n;r._queue.push({value:e,size:t}),r._queueTotalSize+=t}function Or(r){r._queue=new wt,r._queueTotalSize=0}function s5(r){return r===DataView}class zn{constructor(){throw new TypeError("Illegal constructor")}get view(){if(!Tl(this))throw Il("view");return this._view}respond(e){if(!Tl(this))throw Il("respond");if(mn(e,1,"respond"),e=K1(e,"First parameter"),this._associatedReadableByteStreamController===void 0)throw new TypeError("This BYOB request has been invalidated");if(wn(this._view.buffer))throw new TypeError("The BYOB request's buffer has been detached and so cannot be used as a response");ea(this._associatedReadableByteStreamController,e)}respondWithNewView(e){if(!Tl(this))throw Il("respondWithNewView");if(mn(e,1,"respondWithNewView"),!ArrayBuffer.isView(e))throw new TypeError("You can only respond with array buffer views");if(this._associatedReadableByteStreamController===void 0)throw new TypeError("This BYOB request has been invalidated");if(wn(e.buffer))throw new TypeError("The given view's buffer has been detached and so cannot be used as a response");ta(this._associatedReadableByteStreamController,e)}}Object.defineProperties(zn.prototype,{respond:{enumerable:!0},respondWithNewView:{enumerable:!0},view:{enumerable:!0}}),X(zn.prototype.respond,"respond"),X(zn.prototype.respondWithNewView,"respondWithNewView"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(zn.prototype,Symbol.toStringTag,{value:"ReadableStreamBYOBRequest",configurable:!0});class wr{constructor(){throw new TypeError("Illegal constructor")}get byobRequest(){if(!Gr(this))throw ti("byobRequest");return Pu(this)}get desiredSize(){if(!Gr(this))throw ti("desiredSize");return g5(this)}close(){if(!Gr(this))throw ti("close");if(this._closeRequested)throw new TypeError("The stream has already been closed; do not close it again!");const e=this._controlledReadableByteStream._state;if(e!=="readable")throw new TypeError(`The stream (in ${e} state) is not in the readable state and cannot be closed`);ci(this)}enqueue(e){if(!Gr(this))throw ti("enqueue");if(mn(e,1,"enqueue"),!ArrayBuffer.isView(e))throw new TypeError("chunk must be an array buffer view");if(e.byteLength===0)throw new TypeError("chunk must have non-zero byteLength");if(e.buffer.byteLength===0)throw new TypeError("chunk's buffer must have non-zero byteLength");if(this._closeRequested)throw new TypeError("stream is closed or draining");const t=this._controlledReadableByteStream._state;if(t!=="readable")throw new TypeError(`The stream (in ${t} state) is not in the readable state and cannot be enqueued to`);Jo(this,e)}error(e=void 0){if(!Gr(this))throw ti("error");ft(this,e)}[$1](e){i5(this),Or(this);const t=this._cancelAlgorithm(e);return Ic(this),t}[q1](e){const t=this._controlledReadableByteStream;if(this._queueTotalSize>0)return void p5(this,e);const n=this._autoAllocateChunkSize;if(n!==void 0){let s;try{s=new ArrayBuffer(n)}catch(o){return void e._errorSteps(o)}const i={buffer:s,bufferByteLength:n,byteOffset:0,byteLength:n,bytesFilled:0,minimumFill:1,elementSize:1,viewConstructor:Uint8Array,readerType:"default"};this._pendingPullIntos.push(i)}j6(t,e),xn(this)}[V1](){if(this._pendingPullIntos.length>0){const e=this._pendingPullIntos.peek();e.readerType="none",this._pendingPullIntos=new wt,this._pendingPullIntos.push(e)}}}function Gr(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_controlledReadableByteStream")&&r instanceof wr}function Tl(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_associatedReadableByteStreamController")&&r instanceof zn}function xn(r){if(function(t){const n=t._controlledReadableByteStream;return n._state!=="readable"||t._closeRequested||!t._started?!1:!!(Q6(n)&&Tc(n)>0||Y1(n)&&w5(n)>0||g5(t)>0)}(r)){if(r._pulling)return void(r._pullAgain=!0);r._pulling=!0,kt(r._pullAlgorithm(),()=>(r._pulling=!1,r._pullAgain&&(r._pullAgain=!1,xn(r)),null),t=>(ft(r,t),null))}}function i5(r){Q1(r),r._pendingPullIntos=new wt}function o5(r,e){let t=!1;r._state==="closed"&&(t=!0);const n=a5(e);e.readerType==="default"?G1(r,n,t):function(s,i,o){const a=s._reader,c=a._readIntoRequests.shift();o?c._closeSteps(i):c._chunkSteps(i)}(r,n,t)}function Xo(r,e){for(let t=0;t<e.length;++t)o5(r,e[t])}function a5(r){const e=r.bytesFilled,t=r.elementSize;return new r.viewConstructor(r.buffer,r.byteOffset,e/t)}function Zo(r,e,t,n){r._queue.push({buffer:e,byteOffset:t,byteLength:n}),r._queueTotalSize+=n}function c5(r,e,t,n){let s;try{s=Z6(e,t,t+n)}catch(i){throw ft(r,i),i}Zo(r,s,0,n)}function l5(r,e){e.bytesFilled>0&&c5(r,e.buffer,e.byteOffset,e.bytesFilled),ts(r)}function u5(r,e){const t=Math.min(r._queueTotalSize,e.byteLength-e.bytesFilled),n=e.bytesFilled+t;let s=t,i=!1;const o=n-n%e.elementSize;o>=e.minimumFill&&(s=o-e.bytesFilled,i=!0);const a=r._queue;for(;s>0;){const c=a.peek(),u=Math.min(s,c.byteLength),l=e.byteOffset+e.bytesFilled;X6(e.buffer,l,c.buffer,c.byteOffset,u),c.byteLength===u?a.shift():(c.byteOffset+=u,c.byteLength-=u),r._queueTotalSize-=u,d5(r,u,e),s-=u}return i}function d5(r,e,t){t.bytesFilled+=e}function h5(r){r._queueTotalSize===0&&r._closeRequested?(Ic(r),co(r._controlledReadableByteStream)):xn(r)}function Q1(r){r._byobRequest!==null&&(r._byobRequest._associatedReadableByteStreamController=void 0,r._byobRequest._view=null,r._byobRequest=null)}function Iu(r){const e=[];for(;r._pendingPullIntos.length>0&&r._queueTotalSize!==0;){const t=r._pendingPullIntos.peek();u5(r,t)&&(ts(r),e.push(t))}return e}function VC(r,e,t,n){const s=r._controlledReadableByteStream,i=e.constructor,o=function(h){return s5(h)?1:h.BYTES_PER_ELEMENT}(i),{byteOffset:a,byteLength:c}=e,u=t*o;let l;try{l=yn(e.buffer)}catch(h){return void n._errorSteps(h)}const d={buffer:l,bufferByteLength:l.byteLength,byteOffset:a,byteLength:c,bytesFilled:0,minimumFill:u,elementSize:o,viewConstructor:i,readerType:"byob"};if(r._pendingPullIntos.length>0)return r._pendingPullIntos.push(d),void z2(s,n);if(s._state!=="closed"){if(r._queueTotalSize>0){if(u5(r,d)){const h=a5(d);return h5(r),void n._chunkSteps(h)}if(r._closeRequested){const h=new TypeError("Insufficient bytes to fill elements in the given buffer");return ft(r,h),void n._errorSteps(h)}}r._pendingPullIntos.push(d),z2(s,n),xn(r)}else{const h=new i(d.buffer,d.byteOffset,0);n._closeSteps(h)}}function f5(r,e){const t=r._pendingPullIntos.peek();Q1(r),r._controlledReadableByteStream._state==="closed"?function(n,s){s.readerType==="none"&&ts(n);const i=n._controlledReadableByteStream;if(Y1(i)){const o=[];for(let a=0;a<w5(i);++a)o.push(ts(n));Xo(i,o)}}(r,t):function(n,s,i){if(d5(0,s,i),i.readerType==="none"){l5(n,i);const c=Iu(n);return void Xo(n._controlledReadableByteStream,c)}if(i.bytesFilled<i.minimumFill)return;ts(n);const o=i.bytesFilled%i.elementSize;if(o>0){const c=i.byteOffset+i.bytesFilled;c5(n,i.buffer,c-o,o)}i.bytesFilled-=o;const a=Iu(n);o5(n._controlledReadableByteStream,i),Xo(n._controlledReadableByteStream,a)}(r,e,t),xn(r)}function ts(r){return r._pendingPullIntos.shift()}function Ic(r){r._pullAlgorithm=void 0,r._cancelAlgorithm=void 0}function ci(r){const e=r._controlledReadableByteStream;if(!r._closeRequested&&e._state==="readable")if(r._queueTotalSize>0)r._closeRequested=!0;else{if(r._pendingPullIntos.length>0){const t=r._pendingPullIntos.peek();if(t.bytesFilled%t.elementSize!=0){const n=new TypeError("Insufficient bytes to fill elements in the given buffer");throw ft(r,n),n}}Ic(r),co(e)}}function Jo(r,e){const t=r._controlledReadableByteStream;if(r._closeRequested||t._state!=="readable")return;const{buffer:n,byteOffset:s,byteLength:i}=e;if(wn(n))throw new TypeError("chunk's buffer is detached and so cannot be enqueued");const o=yn(n);if(r._pendingPullIntos.length>0){const a=r._pendingPullIntos.peek();if(wn(a.buffer))throw new TypeError("The BYOB request's buffer has been detached and so cannot be filled with an enqueued chunk");Q1(r),a.buffer=yn(a.buffer),a.readerType==="none"&&l5(r,a)}if(Q6(t))(function(a){const c=a._controlledReadableByteStream._reader;for(;c._readRequests.length>0;){if(a._queueTotalSize===0)return;p5(a,c._readRequests.shift())}})(r),Tc(t)===0?Zo(r,o,s,i):(r._pendingPullIntos.length>0&&ts(r),G1(t,new Uint8Array(o,s,i),!1));else if(Y1(t)){Zo(r,o,s,i);const a=Iu(r);Xo(r._controlledReadableByteStream,a)}else Zo(r,o,s,i);xn(r)}function ft(r,e){const t=r._controlledReadableByteStream;t._state==="readable"&&(i5(r),Or(r),Ic(r),F5(t,e))}function p5(r,e){const t=r._queue.shift();r._queueTotalSize-=t.byteLength,h5(r);const n=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);e._chunkSteps(n)}function Pu(r){if(r._byobRequest===null&&r._pendingPullIntos.length>0){const e=r._pendingPullIntos.peek(),t=new Uint8Array(e.buffer,e.byteOffset+e.bytesFilled,e.byteLength-e.bytesFilled),n=Object.create(zn.prototype);(function(s,i,o){s._associatedReadableByteStreamController=i,s._view=o})(n,r,t),r._byobRequest=n}return r._byobRequest}function g5(r){const e=r._controlledReadableByteStream._state;return e==="errored"?null:e==="closed"?0:r._strategyHWM-r._queueTotalSize}function ea(r,e){const t=r._pendingPullIntos.peek();if(r._controlledReadableByteStream._state==="closed"){if(e!==0)throw new TypeError("bytesWritten must be 0 when calling respond() on a closed stream")}else{if(e===0)throw new TypeError("bytesWritten must be greater than 0 when calling respond() on a readable stream");if(t.bytesFilled+e>t.byteLength)throw new RangeError("bytesWritten out of range")}t.buffer=yn(t.buffer),f5(r,e)}function ta(r,e){const t=r._pendingPullIntos.peek();if(r._controlledReadableByteStream._state==="closed"){if(e.byteLength!==0)throw new TypeError("The view's length must be 0 when calling respondWithNewView() on a closed stream")}else if(e.byteLength===0)throw new TypeError("The view's length must be greater than 0 when calling respondWithNewView() on a readable stream");if(t.byteOffset+t.bytesFilled!==e.byteOffset)throw new RangeError("The region specified by view does not match byobRequest");if(t.bufferByteLength!==e.buffer.byteLength)throw new RangeError("The buffer of view has different capacity than byobRequest");if(t.bytesFilled+e.byteLength>t.byteLength)throw new RangeError("The region specified by view is larger than byobRequest");const n=e.byteLength;t.buffer=yn(e.buffer),f5(r,n)}function m5(r,e,t,n,s,i,o){e._controlledReadableByteStream=r,e._pullAgain=!1,e._pulling=!1,e._byobRequest=null,e._queue=e._queueTotalSize=void 0,Or(e),e._closeRequested=!1,e._started=!1,e._strategyHWM=i,e._pullAlgorithm=n,e._cancelAlgorithm=s,e._autoAllocateChunkSize=o,e._pendingPullIntos=new wt,r._readableStreamController=e,kt(te(t()),()=>(e._started=!0,xn(e),null),a=>(ft(e,a),null))}function Il(r){return new TypeError(`ReadableStreamBYOBRequest.prototype.${r} can only be used on a ReadableStreamBYOBRequest`)}function ti(r){return new TypeError(`ReadableByteStreamController.prototype.${r} can only be used on a ReadableByteStreamController`)}function zC(r,e){if((r=`${r}`)!="byob")throw new TypeError(`${e} '${r}' is not a valid enumeration value for ReadableStreamReaderMode`);return r}function y5(r){return new jr(r)}function z2(r,e){r._reader._readIntoRequests.push(e)}function w5(r){return r._reader._readIntoRequests.length}function Y1(r){const e=r._reader;return e!==void 0&&!!en(e)}Object.defineProperties(wr.prototype,{close:{enumerable:!0},enqueue:{enumerable:!0},error:{enumerable:!0},byobRequest:{enumerable:!0},desiredSize:{enumerable:!0}}),X(wr.prototype.close,"close"),X(wr.prototype.enqueue,"enqueue"),X(wr.prototype.error,"error"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(wr.prototype,Symbol.toStringTag,{value:"ReadableByteStreamController",configurable:!0});class jr{constructor(e){if(mn(e,1,"ReadableStreamBYOBReader"),W1(e,"First parameter"),kr(e))throw new TypeError("This stream has already been locked for exclusive reading by another reader");if(!Gr(e._readableStreamController))throw new TypeError("Cannot construct a ReadableStreamBYOBReader for a stream not constructed with a byte source");z6(this,e),this._readIntoRequests=new wt}get closed(){return en(this)?this._closedPromise:V(Fo("closed"))}cancel(e=void 0){return en(this)?this._ownerReadableStream===void 0?V(Qa("cancel")):z1(this,e):V(Fo("cancel"))}read(e,t={}){if(!en(this))return V(Fo("read"));if(!ArrayBuffer.isView(e))return V(new TypeError("view must be an array buffer view"));if(e.byteLength===0)return V(new TypeError("view must have non-zero byteLength"));if(e.buffer.byteLength===0)return V(new TypeError("view's buffer must have non-zero byteLength"));if(wn(e.buffer))return V(new TypeError("view's buffer has been detached"));let n;try{n=function(c,u){var l;return Ar(c,u),{min:K1((l=c?.min)!==null&&l!==void 0?l:1,`${u} has member 'min' that`)}}(t,"options")}catch(c){return V(c)}const s=n.min;if(s===0)return V(new TypeError("options.min must be greater than 0"));if(function(c){return s5(c.constructor)}(e)){if(s>e.byteLength)return V(new RangeError("options.min must be less than or equal to view's byteLength"))}else if(s>e.length)return V(new RangeError("options.min must be less than or equal to view's length"));if(this._ownerReadableStream===void 0)return V(Qa("read from"));let i,o;const a=ze((c,u)=>{i=c,o=u});return b5(this,e,s,{_chunkSteps:c=>i({value:c,done:!1}),_closeSteps:c=>i({value:c,done:!0}),_errorSteps:c=>o(c)}),a}releaseLock(){if(!en(this))throw Fo("releaseLock");this._ownerReadableStream!==void 0&&function(e){Zt(e);const t=new TypeError("Reader was released");v5(e,t)}(this)}}function en(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_readIntoRequests")&&r instanceof jr}function b5(r,e,t,n){const s=r._ownerReadableStream;s._disturbed=!0,s._state==="errored"?n._errorSteps(s._storedError):VC(s._readableStreamController,e,t,n)}function v5(r,e){const t=r._readIntoRequests;r._readIntoRequests=new wt,t.forEach(n=>{n._errorSteps(e)})}function Fo(r){return new TypeError(`ReadableStreamBYOBReader.prototype.${r} can only be used on a ReadableStreamBYOBReader`)}function Ru(r,e){const{highWaterMark:t}=r;if(t===void 0)return e;if(n5(t)||t<0)throw new RangeError("Invalid highWaterMark");return t}function E5(r){const{size:e}=r;return e||(()=>1)}function S5(r,e){Ar(r,e);const t=r?.highWaterMark,n=r?.size;return{highWaterMark:t===void 0?void 0:G6(t),size:n===void 0?void 0:HC(n,`${e} has member 'size' that`)}}function HC(r,e){return Mr(r,e),t=>G6(r(t))}function KC(r,e,t){return Mr(r,t),n=>zs(r,e,[n])}function WC(r,e,t){return Mr(r,t),()=>zs(r,e,[])}function GC(r,e,t){return Mr(r,t),n=>Ts(r,e,[n])}function jC(r,e,t){return Mr(r,t),(n,s)=>zs(r,e,[n,s])}function _5(r,e){if(!Hn(r))throw new TypeError(`${e} is not a WritableStream.`)}Object.defineProperties(jr.prototype,{cancel:{enumerable:!0},read:{enumerable:!0},releaseLock:{enumerable:!0},closed:{enumerable:!0}}),X(jr.prototype.cancel,"cancel"),X(jr.prototype.read,"read"),X(jr.prototype.releaseLock,"releaseLock"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(jr.prototype,Symbol.toStringTag,{value:"ReadableStreamBYOBReader",configurable:!0});class br{constructor(e={},t={}){e===void 0?e=null:W6(e,"First parameter");const n=S5(t,"Second parameter"),s=function(o,a){Ar(o,a);const c=o?.abort,u=o?.close,l=o?.start,d=o?.type,h=o?.write;return{abort:c===void 0?void 0:KC(c,o,`${a} has member 'abort' that`),close:u===void 0?void 0:WC(u,o,`${a} has member 'close' that`),start:l===void 0?void 0:GC(l,o,`${a} has member 'start' that`),write:h===void 0?void 0:jC(h,o,`${a} has member 'write' that`),type:d}}(e,"First parameter");if(QC(this),s.type!==void 0)throw new RangeError("Invalid type is specified");const i=E5(n);(function(o,a,c,u){const l=Object.create(Xa.prototype);let d,h,f,p;d=a.start!==void 0?()=>a.start(l):()=>{},h=a.write!==void 0?m=>a.write(m,l):()=>te(void 0),f=a.close!==void 0?()=>a.close():()=>te(void 0),p=a.abort!==void 0?m=>a.abort(m):()=>te(void 0),XC(o,l,d,h,f,p,c,u)})(this,s,Ru(n,1),i)}get locked(){if(!Hn(this))throw $o("locked");return rs(this)}abort(e=void 0){return Hn(this)?rs(this)?V(new TypeError("Cannot abort a stream that already has a writer")):Ya(this,e):V($o("abort"))}close(){return Hn(this)?rs(this)?V(new TypeError("Cannot close a stream that already has a writer")):Ot(this)?V(new TypeError("Cannot close an already-closing stream")):A5(this):V($o("close"))}getWriter(){if(!Hn(this))throw $o("getWriter");return x5(this)}}function x5(r){return new yr(r)}function QC(r){r._state="writable",r._storedError=void 0,r._writer=void 0,r._writableStreamController=void 0,r._writeRequests=new wt,r._inFlightWriteRequest=void 0,r._closeRequest=void 0,r._inFlightCloseRequest=void 0,r._pendingAbortRequest=void 0,r._backpressure=!1}function Hn(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_writableStreamController")&&r instanceof br}function rs(r){return r._writer!==void 0}function Ya(r,e){var t;if(r._state==="closed"||r._state==="errored")return te(void 0);r._writableStreamController._abortReason=e,(t=r._writableStreamController._abortController)===null||t===void 0||t.abort(e);const n=r._state;if(n==="closed"||n==="errored")return te(void 0);if(r._pendingAbortRequest!==void 0)return r._pendingAbortRequest._promise;let s=!1;n==="erroring"&&(s=!0,e=void 0);const i=ze((o,a)=>{r._pendingAbortRequest={_promise:void 0,_resolve:o,_reject:a,_reason:e,_wasAlreadyErroring:s}});return r._pendingAbortRequest._promise=i,s||X1(r,e),i}function A5(r){const e=r._state;if(e==="closed"||e==="errored")return V(new TypeError(`The stream (in ${e} state) is not in the writable state and cannot be closed`));const t=ze((i,o)=>{const a={_resolve:i,_reject:o};r._closeRequest=a}),n=r._writer;var s;return n!==void 0&&r._backpressure&&e==="writable"&&rd(n),j1(s=r._writableStreamController,P5,0),Pc(s),t}function Du(r,e){r._state!=="writable"?Z1(r):X1(r,e)}function X1(r,e){const t=r._writableStreamController;r._state="erroring",r._storedError=e;const n=r._writer;n!==void 0&&k5(n,e),!function(s){return!(s._inFlightWriteRequest===void 0&&s._inFlightCloseRequest===void 0)}(r)&&t._started&&Z1(r)}function Z1(r){r._state="errored",r._writableStreamController[V6]();const e=r._storedError;if(r._writeRequests.forEach(n=>{n._reject(e)}),r._writeRequests=new wt,r._pendingAbortRequest===void 0)return void Uo(r);const t=r._pendingAbortRequest;if(r._pendingAbortRequest=void 0,t._wasAlreadyErroring)return t._reject(e),void Uo(r);kt(r._writableStreamController[q6](t._reason),()=>(t._resolve(),Uo(r),null),n=>(t._reject(n),Uo(r),null))}function Ot(r){return r._closeRequest!==void 0||r._inFlightCloseRequest!==void 0}function Uo(r){r._closeRequest!==void 0&&(r._closeRequest._reject(r._storedError),r._closeRequest=void 0);const e=r._writer;e!==void 0&&td(e,r._storedError)}function J1(r,e){const t=r._writer;t!==void 0&&e!==r._backpressure&&(e?function(n){Rc(n)}(t):rd(t)),r._backpressure=e}Object.defineProperties(br.prototype,{abort:{enumerable:!0},close:{enumerable:!0},getWriter:{enumerable:!0},locked:{enumerable:!0}}),X(br.prototype.abort,"abort"),X(br.prototype.close,"close"),X(br.prototype.getWriter,"getWriter"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(br.prototype,Symbol.toStringTag,{value:"WritableStream",configurable:!0});class yr{constructor(e){if(mn(e,1,"WritableStreamDefaultWriter"),_5(e,"First parameter"),rs(e))throw new TypeError("This stream has already been locked for exclusive writing by another writer");this._ownerWritableStream=e,e._writer=this;const t=e._state;if(t==="writable")!Ot(e)&&e._backpressure?Rc(this):H2(this),ra(this);else if(t==="erroring")Nu(this,e._storedError),ra(this);else if(t==="closed")H2(this),ra(n=this),N5(n);else{const s=e._storedError;Nu(this,s),L5(this,s)}var n}get closed(){return $r(this)?this._closedPromise:V(qr("closed"))}get desiredSize(){if(!$r(this))throw qr("desiredSize");if(this._ownerWritableStream===void 0)throw li("desiredSize");return function(e){const t=e._ownerWritableStream,n=t._state;return n==="errored"||n==="erroring"?null:n==="closed"?0:R5(t._writableStreamController)}(this)}get ready(){return $r(this)?this._readyPromise:V(qr("ready"))}abort(e=void 0){return $r(this)?this._ownerWritableStream===void 0?V(li("abort")):function(t,n){return Ya(t._ownerWritableStream,n)}(this,e):V(qr("abort"))}close(){if(!$r(this))return V(qr("close"));const e=this._ownerWritableStream;return e===void 0?V(li("close")):Ot(e)?V(new TypeError("Cannot close an already-closing stream")):C5(this)}releaseLock(){if(!$r(this))throw qr("releaseLock");this._ownerWritableStream!==void 0&&T5(this)}write(e=void 0){return $r(this)?this._ownerWritableStream===void 0?V(li("write to")):I5(this,e):V(qr("write"))}}function $r(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_ownerWritableStream")&&r instanceof yr}function C5(r){return A5(r._ownerWritableStream)}function YC(r,e){r._closedPromiseState==="pending"?td(r,e):function(t,n){L5(t,n)}(r,e)}function k5(r,e){r._readyPromiseState==="pending"?B5(r,e):function(t,n){Nu(t,n)}(r,e)}function T5(r){const e=r._ownerWritableStream,t=new TypeError("Writer was released and can no longer be used to monitor the stream's closedness");k5(r,t),YC(r,t),e._writer=void 0,r._ownerWritableStream=void 0}function I5(r,e){const t=r._ownerWritableStream,n=t._writableStreamController,s=function(a,c){if(a._strategySizeAlgorithm===void 0)return 1;try{return a._strategySizeAlgorithm(c)}catch(u){return Lu(a,u),1}}(n,e);if(t!==r._ownerWritableStream)return V(li("write to"));const i=t._state;if(i==="errored")return V(t._storedError);if(Ot(t)||i==="closed")return V(new TypeError("The stream is closing or closed and cannot be written to"));if(i==="erroring")return V(t._storedError);const o=function(a){return ze((c,u)=>{const l={_resolve:c,_reject:u};a._writeRequests.push(l)})}(t);return function(a,c,u){try{j1(a,c,u)}catch(d){return void Lu(a,d)}const l=a._controlledWritableStream;!Ot(l)&&l._state==="writable"&&J1(l,ed(a)),Pc(a)}(n,e,s),o}Object.defineProperties(yr.prototype,{abort:{enumerable:!0},close:{enumerable:!0},releaseLock:{enumerable:!0},write:{enumerable:!0},closed:{enumerable:!0},desiredSize:{enumerable:!0},ready:{enumerable:!0}}),X(yr.prototype.abort,"abort"),X(yr.prototype.close,"close"),X(yr.prototype.releaseLock,"releaseLock"),X(yr.prototype.write,"write"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(yr.prototype,Symbol.toStringTag,{value:"WritableStreamDefaultWriter",configurable:!0});const P5={};class Xa{constructor(){throw new TypeError("Illegal constructor")}get abortReason(){if(!Pl(this))throw Rl("abortReason");return this._abortReason}get signal(){if(!Pl(this))throw Rl("signal");if(this._abortController===void 0)throw new TypeError("WritableStreamDefaultController.prototype.signal is not supported");return this._abortController.signal}error(e=void 0){if(!Pl(this))throw Rl("error");this._controlledWritableStream._state==="writable"&&D5(this,e)}[q6](e){const t=this._abortAlgorithm(e);return Za(this),t}[V6](){Or(this)}}function Pl(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_controlledWritableStream")&&r instanceof Xa}function XC(r,e,t,n,s,i,o,a){e._controlledWritableStream=r,r._writableStreamController=e,e._queue=void 0,e._queueTotalSize=void 0,Or(e),e._abortReason=void 0,e._abortController=function(){if(typeof AbortController=="function")return new AbortController}(),e._started=!1,e._strategySizeAlgorithm=a,e._strategyHWM=o,e._writeAlgorithm=n,e._closeAlgorithm=s,e._abortAlgorithm=i;const c=ed(e);J1(r,c),kt(te(t()),()=>(e._started=!0,Pc(e),null),u=>(e._started=!0,Du(r,u),null))}function Za(r){r._writeAlgorithm=void 0,r._closeAlgorithm=void 0,r._abortAlgorithm=void 0,r._strategySizeAlgorithm=void 0}function R5(r){return r._strategyHWM-r._queueTotalSize}function Pc(r){const e=r._controlledWritableStream;if(!r._started||e._inFlightWriteRequest!==void 0)return;if(e._state==="erroring")return void Z1(e);if(r._queue.length===0)return;const t=r._queue.peek().value;t===P5?function(n){const s=n._controlledWritableStream;(function(o){o._inFlightCloseRequest=o._closeRequest,o._closeRequest=void 0})(s),Tu(n);const i=n._closeAlgorithm();Za(n),kt(i,()=>(function(o){o._inFlightCloseRequest._resolve(void 0),o._inFlightCloseRequest=void 0,o._state==="erroring"&&(o._storedError=void 0,o._pendingAbortRequest!==void 0&&(o._pendingAbortRequest._resolve(),o._pendingAbortRequest=void 0)),o._state="closed";const a=o._writer;a!==void 0&&N5(a)}(s),null),o=>(function(a,c){a._inFlightCloseRequest._reject(c),a._inFlightCloseRequest=void 0,a._pendingAbortRequest!==void 0&&(a._pendingAbortRequest._reject(c),a._pendingAbortRequest=void 0),Du(a,c)}(s,o),null))}(r):function(n,s){const i=n._controlledWritableStream;(function(a){a._inFlightWriteRequest=a._writeRequests.shift()})(i);const o=n._writeAlgorithm(s);kt(o,()=>{(function(c){c._inFlightWriteRequest._resolve(void 0),c._inFlightWriteRequest=void 0})(i);const a=i._state;if(Tu(n),!Ot(i)&&a==="writable"){const c=ed(n);J1(i,c)}return Pc(n),null},a=>(i._state==="writable"&&Za(n),function(c,u){c._inFlightWriteRequest._reject(u),c._inFlightWriteRequest=void 0,Du(c,u)}(i,a),null))}(r,t)}function Lu(r,e){r._controlledWritableStream._state==="writable"&&D5(r,e)}function ed(r){return R5(r)<=0}function D5(r,e){const t=r._controlledWritableStream;Za(r),X1(t,e)}function $o(r){return new TypeError(`WritableStream.prototype.${r} can only be used on a WritableStream`)}function Rl(r){return new TypeError(`WritableStreamDefaultController.prototype.${r} can only be used on a WritableStreamDefaultController`)}function qr(r){return new TypeError(`WritableStreamDefaultWriter.prototype.${r} can only be used on a WritableStreamDefaultWriter`)}function li(r){return new TypeError("Cannot "+r+" a stream using a released writer")}function ra(r){r._closedPromise=ze((e,t)=>{r._closedPromise_resolve=e,r._closedPromise_reject=t,r._closedPromiseState="pending"})}function L5(r,e){ra(r),td(r,e)}function td(r,e){r._closedPromise_reject!==void 0&&(oo(r._closedPromise),r._closedPromise_reject(e),r._closedPromise_resolve=void 0,r._closedPromise_reject=void 0,r._closedPromiseState="rejected")}function N5(r){r._closedPromise_resolve!==void 0&&(r._closedPromise_resolve(void 0),r._closedPromise_resolve=void 0,r._closedPromise_reject=void 0,r._closedPromiseState="resolved")}function Rc(r){r._readyPromise=ze((e,t)=>{r._readyPromise_resolve=e,r._readyPromise_reject=t}),r._readyPromiseState="pending"}function Nu(r,e){Rc(r),B5(r,e)}function H2(r){Rc(r),rd(r)}function B5(r,e){r._readyPromise_reject!==void 0&&(oo(r._readyPromise),r._readyPromise_reject(e),r._readyPromise_resolve=void 0,r._readyPromise_reject=void 0,r._readyPromiseState="rejected")}function rd(r){r._readyPromise_resolve!==void 0&&(r._readyPromise_resolve(void 0),r._readyPromise_resolve=void 0,r._readyPromise_reject=void 0,r._readyPromiseState="fulfilled")}Object.defineProperties(Xa.prototype,{abortReason:{enumerable:!0},signal:{enumerable:!0},error:{enumerable:!0}}),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(Xa.prototype,Symbol.toStringTag,{value:"WritableStreamDefaultController",configurable:!0});const K2=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:void 0,ZC=function(){const r=K2?.DOMException;return function(e){if(typeof e!="function"&&typeof e!="object"||e.name!=="DOMException")return!1;try{return new e,!0}catch{return!1}}(r)?r:void 0}()||function(){const r=function(e,t){this.message=e||"",this.name=t||"Error",Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)};return X(r,"DOMException"),r.prototype=Object.create(Error.prototype),Object.defineProperty(r.prototype,"constructor",{value:r,writable:!0,configurable:!0}),r}();function W2(r,e,t,n,s,i){const o=es(r),a=x5(e);r._disturbed=!0;let c=!1,u=te(void 0);return ze((l,d)=>{let h;if(i!==void 0){if(h=()=>{const w=i.reason!==void 0?i.reason:new ZC("Aborted","AbortError"),k=[];n||k.push(()=>e._state==="writable"?Ya(e,w):te(void 0)),s||k.push(()=>r._state==="readable"?_t(r,w):te(void 0)),E(()=>Promise.all(k.map(x=>x())),!0,w)},i.aborted)return void h();i.addEventListener("abort",h)}var f,p,m;if(y(r,o._closedPromise,w=>(n?b(!0,w):E(()=>Ya(e,w),!0,w),null)),y(e,a._closedPromise,w=>(s?b(!0,w):E(()=>_t(r,w),!0,w),null)),f=r,p=o._closedPromise,m=()=>(t?b():E(()=>function(w){const k=w._ownerWritableStream,x=k._state;return Ot(k)||x==="closed"?te(void 0):x==="errored"?V(k._storedError):C5(w)}(a)),null),f._state==="closed"?m():xl(p,m),Ot(e)||e._state==="closed"){const w=new TypeError("the destination writable stream closed before all data could be piped to it");s?b(!0,w):E(()=>_t(r,w),!0,w)}function g(){const w=u;return Mt(u,()=>w!==u?g():void 0)}function y(w,k,x){w._state==="errored"?x(w._storedError):Cu(k,x)}function E(w,k,x){function T(){return kt(w(),()=>_(k,x),v=>_(!0,v)),null}c||(c=!0,e._state!=="writable"||Ot(e)?T():xl(g(),T))}function b(w,k){c||(c=!0,e._state!=="writable"||Ot(e)?_(w,k):xl(g(),()=>_(w,k)))}function _(w,k){return T5(a),Zt(o),i!==void 0&&i.removeEventListener("abort",h),w?d(k):l(void 0),null}oo(ze((w,k)=>{(function x(T){T?w():Mt(c?te(!0):Mt(a._readyPromise,()=>ze((v,A)=>{Vi(o,{_chunkSteps:S=>{u=Mt(I5(a,S),void 0,qi),v(!1)},_closeSteps:()=>v(!0),_errorSteps:A})})),x,k)})(!1)}))})}class vr{constructor(){throw new TypeError("Illegal constructor")}get desiredSize(){if(!qo(this))throw Vo("desiredSize");return nd(this)}close(){if(!qo(this))throw Vo("close");if(!Rs(this))throw new TypeError("The stream is not in a state that permits close");Is(this)}enqueue(e=void 0){if(!qo(this))throw Vo("enqueue");if(!Rs(this))throw new TypeError("The stream is not in a state that permits enqueue");return Ps(this,e)}error(e=void 0){if(!qo(this))throw Vo("error");Br(this,e)}[$1](e){Or(this);const t=this._cancelAlgorithm(e);return Ja(this),t}[q1](e){const t=this._controlledReadableStream;if(this._queue.length>0){const n=Tu(this);this._closeRequested&&this._queue.length===0?(Ja(this),co(t)):zi(this),e._chunkSteps(n)}else j6(t,e),zi(this)}[V1](){}}function qo(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_controlledReadableStream")&&r instanceof vr}function zi(r){if(M5(r)){if(r._pulling)return void(r._pullAgain=!0);r._pulling=!0,kt(r._pullAlgorithm(),()=>(r._pulling=!1,r._pullAgain&&(r._pullAgain=!1,zi(r)),null),e=>(Br(r,e),null))}}function M5(r){const e=r._controlledReadableStream;return!Rs(r)||!r._started?!1:kr(e)&&Tc(e)>0?!0:nd(r)>0}function Ja(r){r._pullAlgorithm=void 0,r._cancelAlgorithm=void 0,r._strategySizeAlgorithm=void 0}function Is(r){if(!Rs(r))return;const e=r._controlledReadableStream;r._closeRequested=!0,r._queue.length===0&&(Ja(r),co(e))}function Ps(r,e){if(!Rs(r))return;const t=r._controlledReadableStream;if(kr(t)&&Tc(t)>0)G1(t,e,!1);else{let n;try{n=r._strategySizeAlgorithm(e)}catch(s){throw Br(r,s),s}try{j1(r,e,n)}catch(s){throw Br(r,s),s}}zi(r)}function Br(r,e){const t=r._controlledReadableStream;t._state==="readable"&&(Or(r),Ja(r),F5(t,e))}function nd(r){const e=r._controlledReadableStream._state;return e==="errored"?null:e==="closed"?0:r._strategyHWM-r._queueTotalSize}function Rs(r){const e=r._controlledReadableStream._state;return!r._closeRequested&&e==="readable"}function O5(r,e,t,n,s,i,o){e._controlledReadableStream=r,e._queue=void 0,e._queueTotalSize=void 0,Or(e),e._started=!1,e._closeRequested=!1,e._pullAgain=!1,e._pulling=!1,e._strategySizeAlgorithm=o,e._strategyHWM=i,e._pullAlgorithm=n,e._cancelAlgorithm=s,r._readableStreamController=e,kt(te(t()),()=>(e._started=!0,zi(e),null),a=>(Br(e,a),null))}function Vo(r){return new TypeError(`ReadableStreamDefaultController.prototype.${r} can only be used on a ReadableStreamDefaultController`)}function JC(r,e){return Gr(r._readableStreamController)?function(t){let n,s,i,o,a,c=es(t),u=!1,l=!1,d=!1,h=!1,f=!1;const p=ze(x=>{a=x});function m(x){Cu(x._closedPromise,T=>(x!==c||(ft(i._readableStreamController,T),ft(o._readableStreamController,T),h&&f||a(void 0)),null))}function g(){en(c)&&(Zt(c),c=es(t),m(c)),Vi(c,{_chunkSteps:x=>{on(()=>{l=!1,d=!1;const T=x;let v=x;if(!h&&!f)try{v=V2(x)}catch(A){return ft(i._readableStreamController,A),ft(o._readableStreamController,A),void a(_t(t,A))}h||Jo(i._readableStreamController,T),f||Jo(o._readableStreamController,v),u=!1,l?E():d&&b()})},_closeSteps:()=>{u=!1,h||ci(i._readableStreamController),f||ci(o._readableStreamController),i._readableStreamController._pendingPullIntos.length>0&&ea(i._readableStreamController,0),o._readableStreamController._pendingPullIntos.length>0&&ea(o._readableStreamController,0),h&&f||a(void 0)},_errorSteps:()=>{u=!1}})}function y(x,T){Cr(c)&&(Zt(c),c=y5(t),m(c));const v=T?o:i,A=T?i:o;b5(c,x,1,{_chunkSteps:S=>{on(()=>{l=!1,d=!1;const C=T?f:h;if(T?h:f)C||ta(v._readableStreamController,S);else{let I;try{I=V2(S)}catch(P){return ft(v._readableStreamController,P),ft(A._readableStreamController,P),void a(_t(t,P))}C||ta(v._readableStreamController,S),Jo(A._readableStreamController,I)}u=!1,l?E():d&&b()})},_closeSteps:S=>{u=!1;const C=T?f:h,I=T?h:f;C||ci(v._readableStreamController),I||ci(A._readableStreamController),S!==void 0&&(C||ta(v._readableStreamController,S),!I&&A._readableStreamController._pendingPullIntos.length>0&&ea(A._readableStreamController,0)),C&&I||a(void 0)},_errorSteps:()=>{u=!1}})}function E(){if(u)return l=!0,te(void 0);u=!0;const x=Pu(i._readableStreamController);return x===null?g():y(x._view,!1),te(void 0)}function b(){if(u)return d=!0,te(void 0);u=!0;const x=Pu(o._readableStreamController);return x===null?g():y(x._view,!0),te(void 0)}function _(x){if(h=!0,n=x,f){const T=oi([n,s]),v=_t(t,T);a(v)}return p}function w(x){if(f=!0,s=x,h){const T=oi([n,s]),v=_t(t,T);a(v)}return p}function k(){}return i=j2(k,E,_),o=j2(k,b,w),m(c),[i,o]}(r):function(t,n){const s=es(t);let i,o,a,c,u,l=!1,d=!1,h=!1,f=!1;const p=ze(b=>{u=b});function m(){return l?(d=!0,te(void 0)):(l=!0,Vi(s,{_chunkSteps:b=>{on(()=>{d=!1;const _=b,w=b;h||Ps(a._readableStreamController,_),f||Ps(c._readableStreamController,w),l=!1,d&&m()})},_closeSteps:()=>{l=!1,h||Is(a._readableStreamController),f||Is(c._readableStreamController),h&&f||u(void 0)},_errorSteps:()=>{l=!1}}),te(void 0))}function g(b){if(h=!0,i=b,f){const _=oi([i,o]),w=_t(t,_);u(w)}return p}function y(b){if(f=!0,o=b,h){const _=oi([i,o]),w=_t(t,_);u(w)}return p}function E(){}return a=ec(E,m,g),c=ec(E,m,y),Cu(s._closedPromise,b=>(Br(a._readableStreamController,b),Br(c._readableStreamController,b),h&&f||u(void 0),null)),[a,c]}(r)}function ek(r){return Te(e=r)&&e.getReader!==void 0?function(t){let n;function s(){let o;try{o=t.read()}catch(a){return V(a)}return sn(o,a=>{if(!Te(a))throw new TypeError("The promise returned by the reader.read() method must fulfill with an object");if(a.done)Is(n._readableStreamController);else{const c=a.value;Ps(n._readableStreamController,c)}})}function i(o){try{return te(t.cancel(o))}catch(a){return V(a)}}return n=ec(qi,s,i,0),n}(r.getReader()):function(t){let n;const s=J6(t,"async");function i(){let a;try{a=e5(s)}catch(c){return V(c)}return sn(te(a),c=>{if(!Te(c))throw new TypeError("The promise returned by the iterator.next() method must fulfill with an object");if(c.done)Is(n._readableStreamController);else{const u=c.value;Ps(n._readableStreamController,u)}})}function o(a){const c=s.iterator;let u;try{u=ai(c,"return")}catch(l){return V(l)}return u===void 0?te(void 0):sn(zs(u,c,[a]),l=>{if(!Te(l))throw new TypeError("The promise returned by the iterator.return() method must fulfill with an object")})}return n=ec(qi,i,o,0),n}(r);var e}function tk(r,e,t){return Mr(r,t),n=>zs(r,e,[n])}function rk(r,e,t){return Mr(r,t),n=>zs(r,e,[n])}function nk(r,e,t){return Mr(r,t),n=>Ts(r,e,[n])}function sk(r,e){if((r=`${r}`)!="bytes")throw new TypeError(`${e} '${r}' is not a valid enumeration value for ReadableStreamType`);return r}function G2(r,e){Ar(r,e);const t=r?.preventAbort,n=r?.preventCancel,s=r?.preventClose,i=r?.signal;return i!==void 0&&function(o,a){if(!function(c){if(typeof c!="object"||c===null)return!1;try{return typeof c.aborted=="boolean"}catch{return!1}}(o))throw new TypeError(`${a} is not an AbortSignal.`)}(i,`${e} has member 'signal' that`),{preventAbort:!!t,preventCancel:!!n,preventClose:!!s,signal:i}}Object.defineProperties(vr.prototype,{close:{enumerable:!0},enqueue:{enumerable:!0},error:{enumerable:!0},desiredSize:{enumerable:!0}}),X(vr.prototype.close,"close"),X(vr.prototype.enqueue,"enqueue"),X(vr.prototype.error,"error"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(vr.prototype,Symbol.toStringTag,{value:"ReadableStreamDefaultController",configurable:!0});let We=class{constructor(e={},t={}){e===void 0?e=null:W6(e,"First parameter");const n=S5(t,"Second parameter"),s=function(i,o){Ar(i,o);const a=i,c=a?.autoAllocateChunkSize,u=a?.cancel,l=a?.pull,d=a?.start,h=a?.type;return{autoAllocateChunkSize:c===void 0?void 0:K1(c,`${o} has member 'autoAllocateChunkSize' that`),cancel:u===void 0?void 0:tk(u,a,`${o} has member 'cancel' that`),pull:l===void 0?void 0:rk(l,a,`${o} has member 'pull' that`),start:d===void 0?void 0:nk(d,a,`${o} has member 'start' that`),type:h===void 0?void 0:sk(h,`${o} has member 'type' that`)}}(e,"First parameter");if(sd(this),s.type==="bytes"){if(n.size!==void 0)throw new RangeError("The strategy for a byte stream cannot have a size function");(function(i,o,a){const c=Object.create(wr.prototype);let u,l,d;u=o.start!==void 0?()=>o.start(c):()=>{},l=o.pull!==void 0?()=>o.pull(c):()=>te(void 0),d=o.cancel!==void 0?f=>o.cancel(f):()=>te(void 0);const h=o.autoAllocateChunkSize;if(h===0)throw new TypeError("autoAllocateChunkSize must be greater than 0");m5(i,c,u,l,d,a,h)})(this,s,Ru(n,0))}else{const i=E5(n);(function(o,a,c,u){const l=Object.create(vr.prototype);let d,h,f;d=a.start!==void 0?()=>a.start(l):()=>{},h=a.pull!==void 0?()=>a.pull(l):()=>te(void 0),f=a.cancel!==void 0?p=>a.cancel(p):()=>te(void 0),O5(o,l,d,h,f,c,u)})(this,s,Ru(n,1),i)}}get locked(){if(!mr(this))throw Vr("locked");return kr(this)}cancel(e=void 0){return mr(this)?kr(this)?V(new TypeError("Cannot cancel a stream that already has a reader")):_t(this,e):V(Vr("cancel"))}getReader(e=void 0){if(!mr(this))throw Vr("getReader");return function(t,n){Ar(t,n);const s=t?.mode;return{mode:s===void 0?void 0:zC(s,`${n} has member 'mode' that`)}}(e,"First parameter").mode===void 0?es(this):y5(this)}pipeThrough(e,t={}){if(!mr(this))throw Vr("pipeThrough");mn(e,1,"pipeThrough");const n=function(i,o){Ar(i,o);const a=i?.readable;O2(a,"readable","ReadableWritablePair"),W1(a,`${o} has member 'readable' that`);const c=i?.writable;return O2(c,"writable","ReadableWritablePair"),_5(c,`${o} has member 'writable' that`),{readable:a,writable:c}}(e,"First parameter"),s=G2(t,"Second parameter");if(kr(this))throw new TypeError("ReadableStream.prototype.pipeThrough cannot be used on a locked ReadableStream");if(rs(n.writable))throw new TypeError("ReadableStream.prototype.pipeThrough cannot be used on a locked WritableStream");return oo(W2(this,n.writable,s.preventClose,s.preventAbort,s.preventCancel,s.signal)),n.readable}pipeTo(e,t={}){if(!mr(this))return V(Vr("pipeTo"));if(e===void 0)return V("Parameter 1 is required in 'pipeTo'.");if(!Hn(e))return V(new TypeError("ReadableStream.prototype.pipeTo's first argument must be a WritableStream"));let n;try{n=G2(t,"Second parameter")}catch(s){return V(s)}return kr(this)?V(new TypeError("ReadableStream.prototype.pipeTo cannot be used on a locked ReadableStream")):rs(e)?V(new TypeError("ReadableStream.prototype.pipeTo cannot be used on a locked WritableStream")):W2(this,e,n.preventClose,n.preventAbort,n.preventCancel,n.signal)}tee(){if(!mr(this))throw Vr("tee");return oi(JC(this))}values(e=void 0){if(!mr(this))throw Vr("values");return function(t,n){const s=es(t),i=new t5(s,n),o=Object.create(r5);return o._asyncIteratorImpl=i,o}(this,function(t,n){return Ar(t,n),{preventCancel:!!t?.preventCancel}}(e,"First parameter").preventCancel)}[ao](e){return this.values(e)}static from(e){return ek(e)}};function ec(r,e,t,n=1,s=()=>1){const i=Object.create(We.prototype);return sd(i),O5(i,Object.create(vr.prototype),r,e,t,n,s),i}function j2(r,e,t){const n=Object.create(We.prototype);return sd(n),m5(n,Object.create(wr.prototype),r,e,t,0,void 0),n}function sd(r){r._state="readable",r._reader=void 0,r._storedError=void 0,r._disturbed=!1}function mr(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_readableStreamController")&&r instanceof We}function kr(r){return r._reader!==void 0}function _t(r,e){if(r._disturbed=!0,r._state==="closed")return te(void 0);if(r._state==="errored")return V(r._storedError);co(r);const t=r._reader;if(t!==void 0&&en(t)){const n=t._readIntoRequests;t._readIntoRequests=new wt,n.forEach(s=>{s._closeSteps(void 0)})}return sn(r._readableStreamController[$1](e),qi)}function co(r){r._state="closed";const e=r._reader;if(e!==void 0&&(K6(e),Cr(e))){const t=e._readRequests;e._readRequests=new wt,t.forEach(n=>{n._closeSteps()})}}function F5(r,e){r._state="errored",r._storedError=e;const t=r._reader;t!==void 0&&(H1(t,e),Cr(t)?Y6(t,e):v5(t,e))}function Vr(r){return new TypeError(`ReadableStream.prototype.${r} can only be used on a ReadableStream`)}Object.defineProperties(We,{from:{enumerable:!0}}),Object.defineProperties(We.prototype,{cancel:{enumerable:!0},getReader:{enumerable:!0},pipeThrough:{enumerable:!0},pipeTo:{enumerable:!0},tee:{enumerable:!0},values:{enumerable:!0},locked:{enumerable:!0}}),X(We.from,"from"),X(We.prototype.cancel,"cancel"),X(We.prototype.getReader,"getReader"),X(We.prototype.pipeThrough,"pipeThrough"),X(We.prototype.pipeTo,"pipeTo"),X(We.prototype.tee,"tee"),X(We.prototype.values,"values"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(We.prototype,Symbol.toStringTag,{value:"ReadableStream",configurable:!0}),Object.defineProperty(We.prototype,ao,{value:We.prototype.values,writable:!0,configurable:!0});const ik=r=>r.byteLength;X(ik,"size");const ok=()=>1;X(ok,"size");function ak(r,e){Br(r._readable._readableStreamController,e),id(r,e)}function id(r,e){lk(r._transformStreamController),Lu(r._writable._writableStreamController,e),ck(r)}function ck(r){r._backpressure&&U5(r,!1)}function U5(r,e){r._backpressureChangePromise!==void 0&&r._backpressureChangePromise_resolve(),r._backpressureChangePromise=ze(t=>{r._backpressureChangePromise_resolve=t}),r._backpressure=e}class On{constructor(){throw new TypeError("Illegal constructor")}get desiredSize(){if(!zo(this))throw Ho("desiredSize");return nd(this._controlledTransformStream._readable._readableStreamController)}enqueue(e=void 0){if(!zo(this))throw Ho("enqueue");uk(this,e)}error(e=void 0){if(!zo(this))throw Ho("error");var t;t=e,ak(this._controlledTransformStream,t)}terminate(){if(!zo(this))throw Ho("terminate");(function(e){const t=e._controlledTransformStream;Is(t._readable._readableStreamController);const n=new TypeError("TransformStream terminated");id(t,n)})(this)}}function zo(r){return!!Te(r)&&!!Object.prototype.hasOwnProperty.call(r,"_controlledTransformStream")&&r instanceof On}function lk(r){r._transformAlgorithm=void 0,r._flushAlgorithm=void 0,r._cancelAlgorithm=void 0}function uk(r,e){const t=r._controlledTransformStream,n=t._readable._readableStreamController;if(!Rs(n))throw new TypeError("Readable side is not in a state that permits enqueue");try{Ps(n,e)}catch(i){throw id(t,i),t._readable._storedError}(function(i){return!M5(i)})(n)!==t._backpressure&&U5(t,!0)}function Ho(r){return new TypeError(`TransformStreamDefaultController.prototype.${r} can only be used on a TransformStreamDefaultController`)}Object.defineProperties(On.prototype,{enqueue:{enumerable:!0},error:{enumerable:!0},terminate:{enumerable:!0},desiredSize:{enumerable:!0}}),X(On.prototype.enqueue,"enqueue"),X(On.prototype.error,"error"),X(On.prototype.terminate,"terminate"),typeof Symbol.toStringTag=="symbol"&&Object.defineProperty(On.prototype,Symbol.toStringTag,{value:"TransformStreamDefaultController",configurable:!0});var Dl={exports:{}};/*! streamsaver. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */var Q2;function dk(){return Q2||(Q2=1,function(r){((e,t)=>{r.exports=t()})("streamSaver",()=>{const e=typeof window=="object"?window:this;e.HTMLElement||console.warn("streamsaver is meant to run on browsers main thread");let t=null,n=!1;const s=p=>{try{p()}catch{}},i=e.WebStreamsPolyfill||{},o=e.isSecureContext;let a=/constructor/i.test(e.HTMLElement)||!!e.safari||!!e.WebKitPoint;const c=o||"MozAppearance"in document.documentElement.style?"iframe":"navigate",u={createWriteStream:f,WritableStream:e.WritableStream||i.WritableStream,supported:!0,version:{full:"2.0.5",major:2,minor:0,dot:5},mitm:"https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0"};function l(p){if(!p)throw new Error("meh");const m=document.createElement("iframe");return m.hidden=!0,m.src=p,m.loaded=!1,m.name="iframe",m.isIframe=!0,m.postMessage=(...g)=>m.contentWindow.postMessage(...g),m.addEventListener("load",()=>{m.loaded=!0},{once:!0}),document.body.appendChild(m),m}function d(p){const m="width=200,height=100",g=document.createDocumentFragment(),y={frame:e.open(p,"popup",m),loaded:!1,isIframe:!1,isPopup:!0,remove(){y.frame.close()},addEventListener(...b){g.addEventListener(...b)},dispatchEvent(...b){g.dispatchEvent(...b)},removeEventListener(...b){g.removeEventListener(...b)},postMessage(...b){y.frame.postMessage(...b)}},E=b=>{b.source===y.frame&&(y.loaded=!0,e.removeEventListener("message",E),y.dispatchEvent(new Event("load")))};return e.addEventListener("message",E),y}try{new Response(new ReadableStream),o&&!("serviceWorker"in navigator)&&(a=!0)}catch{a=!0}s(()=>{const{readable:p}=new TransformStream,m=new MessageChannel;m.port1.postMessage(p,[p]),m.port1.close(),m.port2.close(),n=!0,Object.defineProperty(u,"TransformStream",{configurable:!1,writable:!1,value:TransformStream})});function h(){t||(t=o?l(u.mitm):d(u.mitm))}function f(p,m,g){let y={size:null,pathname:null,writableStrategy:void 0,readableStrategy:void 0},E=0,b=null,_=null,w=null;if(Number.isFinite(m)?([g,m]=[m,g],console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),y.size=g,y.writableStrategy=m):m&&m.highWaterMark?(console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),y.size=g,y.writableStrategy=m):y=m||{},!a){h(),_=new MessageChannel,p=encodeURIComponent(p.replace(/\//g,":")).replace(/['()]/g,escape).replace(/\*/g,"%2A");const x={transferringReadable:n,pathname:y.pathname||Math.random().toString().slice(-6)+"/"+p,headers:{"Content-Type":"application/octet-stream; charset=utf-8","Content-Disposition":"attachment; filename*=UTF-8''"+p}};y.size&&(x.headers["Content-Length"]=y.size);const T=[x,"*",[_.port2]];if(n){const v=c==="iframe"?void 0:{transform(S,C){if(!(S instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");E+=S.length,C.enqueue(S),b&&(location.href=b,b=null)},flush(){b&&(location.href=b)}};w=new u.TransformStream(v,y.writableStrategy,y.readableStrategy);const A=w.readable;_.port1.postMessage({readableStream:A},[A])}_.port1.onmessage=v=>{v.data.download?c==="navigate"?(t.remove(),t=null,E?location.href=v.data.download:b=v.data.download):(t.isPopup&&(t.remove(),t=null,c==="iframe"&&l(u.mitm)),l(v.data.download)):v.data.abort&&(k=[],_.port1.postMessage("abort"),_.port1.onmessage=null,_.port1.close(),_.port2.close(),_=null)},t.loaded?t.postMessage(...T):t.addEventListener("load",()=>{t.postMessage(...T)},{once:!0})}let k=[];return!a&&w&&w.writable||new u.WritableStream({write(x){if(!(x instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");if(a){k.push(x);return}_.port1.postMessage(x),E+=x.length,b&&(location.href=b,b=null)},close(){if(a){const x=new Blob(k,{type:"application/octet-stream; charset=utf-8"}),T=document.createElement("a");T.href=URL.createObjectURL(x),T.download=p,T.click()}else _.port1.postMessage("end")},abort(){k=[],_.port1.postMessage("abort"),_.port1.onmessage=null,_.port1.close(),_.port2.close(),_=null}},y.writableStrategy)}return u})}(Dl)),Dl.exports}var hk=dk();const Ll=Fs(hk);class fk{node;appState;progressTracker;uiManager;protocol;wakeLock=null;hash;transferProgressBytes;receivedFileStream=null;receivedFileWriter=null;fileNameFromHeader;fileSizeFromHeader;fileTypeFromHeader;fileHashFromHeader;headerReceived;receivedBytesTotal;constructor(e,t,n,s){this.node=e,this.appState=t,this.progressTracker=n,this.uiManager=s,this.protocol="/fileferry/filetransfer/1.0.0",this.wakeLock=null,this.hash=2166136261,this.transferProgressBytes=0,this.receivedFileStream=null,this.receivedFileWriter=null,this.fileNameFromHeader="downloaded_file",this.fileSizeFromHeader=0,this.fileTypeFromHeader="application/octet-stream",this.fileHashFromHeader=0,this.headerReceived=!1,this.receivedBytesTotal=0,Ll.WritableStream=br,Ll.mitm="https://fileferry.xyz/streamsaver/mitm.html",window.WritableStream=br}setupFileTransferProtocol(){const e=async({stream:t,connection:n})=>{this.appState.isTransferActive()&&!this.appState.hasReconnected()||(this.getWakelock(),this.appState.setActivePeer(n.remotePeer.toString()),this.appState.setTransferConnectionId(n.id),this.appState.isTransferActive()&&this.appState.hasReconnected()&&(console.log("Resuming file transfer after reconnection."),this.appState.setReconnected(!1)),this.appState.setActiveStream(t),this.appState.setActiveTransfer(),await this.handleFileTransfer(),this.appState.isFinished()&&await this.transferComplete())};this.node.handle(this.protocol,e)}async startFileTransfer(){try{if(this.appState.isTransferActive()&&!this.appState.hasReconnected())return;this.uiManager.hideQrCodePopup();const e=this.appState.getActiveStream(),t=this.appState.getSelectedFile();if(!e||!t)throw new Error("No active stream or file to start transfer.");this.appState.isTransferActive()&&this.appState.hasReconnected()?(console.log("Resuming file transfer after reconnection."),this.appState.setReconnected(!1)):this.appState.setActiveTransfer(),await this.sendFileToStream(e,t),this.appState.isFinished()&&await this.transferComplete()}catch(e){throw e}}async handleFileTransfer(){try{const e=this.appState.getActiveStream();if(!e)throw new Error("No active stream to handle transfer.");await this.receiveFileFromStream(e),this.appState.isFinished()&&await this.transferComplete()}catch{}}async sendFileToStream(e,t,n=16384,s=200){try{const i=await this.createFileHeader(t),o=new TextEncoder().encode(i+`
`);let a=0;const c=e.channel,u=c.bufferedAmountLowThreshold||1024*64;let l,d=new Promise(p=>{l=p});const h=async p=>{try{for await(const m of p)new TextDecoder().decode(m.subarray()).trim()==="ACK"&&l&&l()}catch(m){console.error("Error in ACK handler:",m)}},f=async function*(){yield new Y(o),await new Promise(m=>setTimeout(m,1));let p=0;for(let m=0;m<t.size;m+=n){c.readyState!=="open"&&console.log(`Stream is no longer open. Current state: ${c.readyState}`);const g=t.slice(m,Math.min(m+n,t.size)),y=new Uint8Array(await g.arrayBuffer());if(a<this.transferProgressBytes){a+=y.length;continue}yield new Y(y),p++,c.bufferedAmount>u&&await new Promise((E,b)=>{const _=()=>{k(),E()},w=()=>{k(),this.closeActiveStream(e),console.log("Closing active stream due to channel close."),b(new Error("Stream closed by remote"))},k=()=>{c.removeEventListener("bufferedamountlow",_),c.removeEventListener("close",w)};c.addEventListener("bufferedamountlow",_,{once:!0}),c.addEventListener("close",w,{once:!0})}),a+=y.length,this.transferProgressBytes+=y.length,this.progressTracker.updateProgress(this.transferProgressBytes,t.size,"send"),p%s===0&&this.transferProgressBytes<=t.size&&(await d,d=new Promise(E=>{l=E}))}}.bind(this);for(await ls(f(),e,h),this.progressTracker.updateProgress(this.transferProgressBytes,t.size,"send",!0);e.status==="open"||e.status==="closing";)await new Promise(p=>setTimeout(p,100));this.appState.declareFinished()}catch(i){throw i}}async createFileHeader(e){return JSON.stringify({name:e.name,size:e.size,type:e.type||"application/octet-stream",hash:await this.senderHash()})}async receiveFileFromStream(e){const n=new TextEncoder().encode("ACK");let s=0;const i=cr({objectMode:!0});ls(i,e.sink).catch(o=>{o.code!=="ERR_STREAM_RESET"&&console.error("Failed to pipe ACKs to sender:",o)});try{for await(const o of e.source){if(!o||o.length===0)continue;const a=o.subarray();if(this.headerReceived)this.receivedFileWriter!=null&&(await this.receivedFileWriter.write(a),this.hash=this.fnv1aHash(a,this.hash),this.receivedBytesTotal+=a.length,this.progressTracker.updateProgress(this.receivedBytesTotal,this.fileSizeFromHeader,"receive"),s++,s%200===0&&this.receivedBytesTotal<=this.fileSizeFromHeader&&i.push(n));else{const c=this.parseFileHeader(a);c.header&&(this.fileNameFromHeader=c.header.name||this.fileNameFromHeader,this.fileSizeFromHeader=c.header.size||this.fileSizeFromHeader,this.fileTypeFromHeader=c.header.type||this.fileTypeFromHeader,this.fileHashFromHeader=Number(c.header.hash)||this.fileHashFromHeader,this.headerReceived=!0,console.log(`Receiving file: ${this.fileNameFromHeader} (${this.fileSizeFromHeader} bytes)`),this.receivedFileStream===null&&(this.receivedFileStream=Ll.createWriteStream(this.fileNameFromHeader,{size:this.fileSizeFromHeader})),this.receivedFileWriter===null&&(this.receivedFileWriter=this.receivedFileStream.getWriter())),c.bodyData&&c.bodyData.length>0&&this.receivedFileWriter!=null&&(await this.receivedFileWriter.write(c.bodyData),this.receivedBytesTotal+=c.bodyData.length,this.progressTracker.updateProgress(this.receivedBytesTotal,this.fileSizeFromHeader,"receive"),s++,s%200===0&&i.push(n))}if(this.headerReceived&&this.receivedBytesTotal>=this.fileSizeFromHeader&&this.fileSizeFromHeader>0){this.progressTracker.updateProgress(this.receivedBytesTotal,this.fileSizeFromHeader,"receive",!0),this.uiManager.showReceivedFileDetails(this.fileNameFromHeader,this.fileSizeFromHeader),this.hash!=this.fileHashFromHeader&&this.uiManager.showErrorPopup(`Sorry mate, the file's hash does not match. The file may be corrupted.
Hash received: `+this.fileHashFromHeader+`
 Computed Hash from Transfer: `+this.hash),this.receivedFileWriter?.close(),this.receivedFileWriter=null,await this.closeActiveStream(e),this.appState.declareFinished();break}}}catch(o){throw o}finally{i.end()}}async closeActiveStream(e){e&&(await e.close(),e.id===this.appState.getActiveStream()?.id&&this.appState.setActiveStream(null))}parseFileHeader(e){try{const t=new TextDecoder("utf-8",{fatal:!1}).decode(e),n=t.indexOf(`
`);if(n!==-1){const s=t.substring(0,n),o=new TextEncoder().encode(s+`
`).length;try{const a=JSON.parse(s),c=o<e.byteLength?e.subarray(o):null;return{header:a,bodyData:c}}catch{return{header:null,bodyData:e}}}return{header:null,bodyData:e}}catch{return{header:null,bodyData:e}}}async getWakelock(){if("wakeLock"in navigator){async function e(){let t=null;try{return t=await navigator.wakeLock.request("screen"),t}catch{return null}}this.wakeLock=await e()||null}}async releaseWakelock(){this.wakeLock?.release().catch(e=>{})}fnv1aHash(e,t){let n=t;for(let s of e)n=(s^n)*16777619&4294967295;return n}async senderHash(){const e=this.appState.getSelectedFile(),t=16384;if(e===null)return 0;const n=async function*(){for(let i=0;i<e.size;i+=t){const a=await e.slice(i,Math.min(i+t,e.size)).arrayBuffer();yield new Uint8Array(a)}}.bind(this);let s=this.hash;for await(const i of n())s=this.fnv1aHash(i,s);return s}async transferComplete(){if(this.appState.isTransferActive()&&this.appState.getMode()==="receiver")try{this.receivedFileWriter?.close(),this.closeActiveStream(this.appState.getActiveStream())}catch{}await this.node.stop(),this.releaseWakelock()}}class pk{geoLocUrl;hostUrl;geoUserUrl;cacheKey;cacheDuration;constructor(){this.geoLocUrl="https://raw.githubusercontent.com/pradt2/always-online-stun/master/geoip_cache.txt",this.hostUrl="https://raw.githubusercontent.com/pradt2/always-online-stun/master/valid_ipv4s.txt",this.geoUserUrl="https://geoip.fileferry.xyz",this.cacheKey="userGeoData",this.cacheDuration=48*60*60*1e3}async getClosestStunServers(){try{const e=await this.fetchGeoData(),t=await this.getUserGeoData(),n=await this.fetchStunServers();if(typeof t.lat!="number"||typeof t.lon!="number")throw new Error("User's geographic data is incomplete or invalid.");const s=this.findClosestServers(t,e,n);if(!s||s.length===0)throw new Error("No valid STUN servers could be determined.");return this.appendStunString(s)}catch{this.clearExpiredCache();return}}appendStunString(e){return e.map(t=>`stun:${t}`)}async fetchGeoData(){return await(await fetch(this.geoLocUrl)).json()}async getUserGeoData(){const e=this.getCachedGeoData();if(e)return e;const t=await fetch(this.geoUserUrl);if(!t.ok)throw new Error(`Failed to fetch user geo data: ${t.status} ${t.statusText}`);const n=await t.json();return this.setCachedGeoData(n),n}calculateDistance(e,t,n,s){return Math.sqrt(Math.pow(e-n,2)+Math.pow(t-s,2))}findClosestServers(e,t,n){const{lat:s,lon:i}=e;return n.trim().split(`
`).map(c=>{const u=c.split(":")[0];if(!t[u])return[c,1/0];const[l,d]=t[u];if(typeof l!="number"||typeof d!="number")return[c,1/0];const h=this.calculateDistance(s,i,l,d);return[c,h]}).sort(([,c],[,u])=>c-u).map(([c])=>c).slice(0,3)}getCachedGeoData(){const e=localStorage.getItem(this.cacheKey);if(e){const t=JSON.parse(e);if(t.expiry&&t.expiry>Date.now())return t.data;localStorage.removeItem(this.cacheKey)}return null}setCachedGeoData(e){const t={data:e,expiry:Date.now()+this.cacheDuration};localStorage.setItem(this.cacheKey,JSON.stringify(t))}clearExpiredCache(){localStorage.removeItem(this.cacheKey)}async fetchStunServers(){return await(await fetch(this.hostUrl)).text()}validateStunServer(e){return!!(e&&e.includes(":")&&e.split(":").length===2)}}var Ko={exports:{}},Y2;function gk(){return Y2||(Y2=1,function(r,e){var t=globalThis.require&&e||{};(function(n,s){let i=globalThis.crypto;s._sep=/[\s,:-]+/,s._mword="mnemonic",s._normalize=function(o){return o.normalize("NFKD").trim().toLowerCase()},s.generate=async function(o=128){let a=o/8,c=i.getRandomValues(new Uint8Array(a));return await s.encode(c)},s.encode=async function(o){let a=8*o.length,c=a/32;o=new Uint8Array(o);let u=await i.subtle.digest("SHA-256",o),l=new Uint8Array(u),d="";o.forEach(function(y){let E=y.toString(2).padStart(8,"0");d+=E});let f=l[0].toString(2);f=f.padStart(8,"0");let p=f.slice(0,c);d+=p;let m=[];for(let y=0;y<a+c;y+=11){let E=parseInt(d.slice(y,y+11).padStart(8,"0"),2);m.push(E)}return m.map(function(y){return s.base2048[y]}).join(" ")},s.verify=async function(o){return await s.decode(o),!0},s.checksum=s.verify,s.decode=async function(o,a){o=s._normalize(o);let c=[];o.split(s._sep).forEach(function(b){let _=s.base2048.indexOf(b);if(_<0){let w=new Error(`dashphrase.js: decode failed: unknown word '${b}'`);throw w.code="E_UNKNOWN_WORD",w}c.push(_)});let l=c.map(function(b){return b.toString(2).padStart(11,"0")}).join(""),d=Math.floor(l.length/32),h=l.length-d,f=l.slice(-d),p=[];for(let b=0;b<h;b+=8){let _=l.slice(b,b+8),w=parseInt(_,2);w>=0&&p.push(w)}let m=Uint8Array.from(p),g=await i.subtle.digest("SHA-256",m),E=new Uint8Array(g)[0].toString(2).padStart(8,"0").slice(0,d);if(E!==f&&a?.verify!==!1){let b=new Error(`dashphrase.js: bad checksum: expected '${E}' but got '${f}'`);throw b.code="E_BAD_CHECKSUM",b}return m},s.toSeed=async function(o,a="",c={}){c.verify!==!1&&await s.verify(o),o=s._normalize(o),a=a.normalize("NFKD");let l=new TextEncoder().encode(o),d=new TextEncoder().encode(s._mword+a),m=await s._pbkdf2(l,d,2048,512,"SHA-512");return new Uint8Array(m)},s.pbkdf2=s.toSeed,s._pbkdf2=async function(a,c,u,l,d){let h=!1,f=await i.subtle.importKey("raw",a,{name:"PBKDF2"},h,["deriveKey"]);h=!0;let p=await i.subtle.deriveKey({name:"PBKDF2",salt:c,iterations:u,hash:d},f,{name:"HMAC",hash:d,length:l},h,["sign","verify"]),m=await i.subtle.exportKey("raw",p);return new Uint8Array(m)},s._sha256=async function(o,a=""){o=s._normalize(o),a=a.normalize("NFKD");let c=new TextEncoder().encode(o),u=new TextEncoder().encode(a),l=new Uint8Array(c.length+u.length),d=0;for(let f=0;f<c.length;f+=1)l[d]=c[f],d+=1;for(let f=0;f<u.length;f+=1)l[d]=u[f],d+=1;let h=await i.subtle.digest("SHA-256",l);return new Uint8Array(h)},s.CATMONIC="cat swing flag economy stadium alone churn speed unique patch report train",s.ZOOMONIC="zoo zoo zoo zoo zoo zoo zoo zoo zoo zoo zoo wrong",s.ZECRET="TREZOR",s.ZEED="ac27495480225222079d7be181583751e86f571027b0497b5b5d11218e0a8a13332572917f0f8e5a589620c6f15b11c61dee327651a14c34e18231052e48c069",s.base2048="abandon ability able about above absent absorb abstract absurd abuse access accident account accuse achieve acid acoustic acquire across act action actor actress actual adapt add addict address adjust admit adult advance advice aerobic affair afford afraid again age agent agree ahead aim air airport aisle alarm album alcohol alert alien all alley allow almost alone alpha already also alter always amateur amazing among amount amused analyst anchor ancient anger angle angry animal ankle announce annual another answer antenna antique anxiety any apart apology appear apple approve april arch arctic area arena argue arm armed armor army around arrange arrest arrive arrow art artefact artist artwork ask aspect assault asset assist assume asthma athlete atom attack attend attitude attract auction audit august aunt author auto autumn average avocado avoid awake aware away awesome awful awkward axis baby bachelor bacon badge bag balance balcony ball bamboo banana banner bar barely bargain barrel base basic basket battle beach bean beauty because become beef before begin behave behind believe below belt bench benefit best betray better between beyond bicycle bid bike bind biology bird birth bitter black blade blame blanket blast bleak bless blind blood blossom blouse blue blur blush board boat body boil bomb bone bonus book boost border boring borrow boss bottom bounce box boy bracket brain brand brass brave bread breeze brick bridge brief bright bring brisk broccoli broken bronze broom brother brown brush bubble buddy budget buffalo build bulb bulk bullet bundle bunker burden burger burst bus business busy butter buyer buzz cabbage cabin cable cactus cage cake call calm camera camp can canal cancel candy cannon canoe canvas canyon capable capital captain car carbon card cargo carpet carry cart case cash casino castle casual cat catalog catch category cattle caught cause caution cave ceiling celery cement census century cereal certain chair chalk champion change chaos chapter charge chase chat cheap check cheese chef cherry chest chicken chief child chimney choice choose chronic chuckle chunk churn cigar cinnamon circle citizen city civil claim clap clarify claw clay clean clerk clever click client cliff climb clinic clip clock clog close cloth cloud clown club clump cluster clutch coach coast coconut code coffee coil coin collect color column combine come comfort comic common company concert conduct confirm congress connect consider control convince cook cool copper copy coral core corn correct cost cotton couch country couple course cousin cover coyote crack cradle craft cram crane crash crater crawl crazy cream credit creek crew cricket crime crisp critic crop cross crouch crowd crucial cruel cruise crumble crunch crush cry crystal cube culture cup cupboard curious current curtain curve cushion custom cute cycle dad damage damp dance danger daring dash daughter dawn day deal debate debris decade december decide decline decorate decrease deer defense define defy degree delay deliver demand demise denial dentist deny depart depend deposit depth deputy derive describe desert design desk despair destroy detail detect develop device devote diagram dial diamond diary dice diesel diet differ digital dignity dilemma dinner dinosaur direct dirt disagree discover disease dish dismiss disorder display distance divert divide divorce dizzy doctor document dog doll dolphin domain donate donkey donor door dose double dove draft dragon drama drastic draw dream dress drift drill drink drip drive drop drum dry duck dumb dune during dust dutch duty dwarf dynamic eager eagle early earn earth easily east easy echo ecology economy edge edit educate effort egg eight either elbow elder electric elegant element elephant elevator elite else embark embody embrace emerge emotion employ empower empty enable enact end endless endorse enemy energy enforce engage engine enhance enjoy enlist enough enrich enroll ensure enter entire entry envelope episode equal equip era erase erode erosion error erupt escape essay essence estate eternal ethics evidence evil evoke evolve exact example excess exchange excite exclude excuse execute exercise exhaust exhibit exile exist exit exotic expand expect expire explain expose express extend extra eye eyebrow fabric face faculty fade faint faith fall false fame family famous fan fancy fantasy farm fashion fat fatal father fatigue fault favorite feature february federal fee feed feel female fence festival fetch fever few fiber fiction field figure file film filter final find fine finger finish fire firm first fiscal fish fit fitness fix flag flame flash flat flavor flee flight flip float flock floor flower fluid flush fly foam focus fog foil fold follow food foot force forest forget fork fortune forum forward fossil foster found fox fragile frame frequent fresh friend fringe frog front frost frown frozen fruit fuel fun funny furnace fury future gadget gain galaxy gallery game gap garage garbage garden garlic garment gas gasp gate gather gauge gaze general genius genre gentle genuine gesture ghost giant gift giggle ginger giraffe girl give glad glance glare glass glide glimpse globe gloom glory glove glow glue goat goddess gold good goose gorilla gospel gossip govern gown grab grace grain grant grape grass gravity great green grid grief grit grocery group grow grunt guard guess guide guilt guitar gun gym habit hair half hammer hamster hand happy harbor hard harsh harvest hat have hawk hazard head health heart heavy hedgehog height hello helmet help hen hero hidden high hill hint hip hire history hobby hockey hold hole holiday hollow home honey hood hope horn horror horse hospital host hotel hour hover hub huge human humble humor hundred hungry hunt hurdle hurry hurt husband hybrid ice icon idea identify idle ignore ill illegal illness image imitate immense immune impact impose improve impulse inch include income increase index indicate indoor industry infant inflict inform inhale inherit initial inject injury inmate inner innocent input inquiry insane insect inside inspire install intact interest into invest invite involve iron island isolate issue item ivory jacket jaguar jar jazz jealous jeans jelly jewel job join joke journey joy judge juice jump jungle junior junk just kangaroo keen keep ketchup key kick kid kidney kind kingdom kiss kit kitchen kite kitten kiwi knee knife knock know lab label labor ladder lady lake lamp language laptop large later latin laugh laundry lava law lawn lawsuit layer lazy leader leaf learn leave lecture left leg legal legend leisure lemon lend length lens leopard lesson letter level liar liberty library license life lift light like limb limit link lion liquid list little live lizard load loan lobster local lock logic lonely long loop lottery loud lounge love loyal lucky luggage lumber lunar lunch luxury lyrics machine mad magic magnet maid mail main major make mammal man manage mandate mango mansion manual maple marble march margin marine market marriage mask mass master match material math matrix matter maximum maze meadow mean measure meat mechanic medal media melody melt member memory mention menu mercy merge merit merry mesh message metal method middle midnight milk million mimic mind minimum minor minute miracle mirror misery miss mistake mix mixed mixture mobile model modify mom moment monitor monkey monster month moon moral more morning mosquito mother motion motor mountain mouse move movie much muffin mule multiply muscle museum mushroom music must mutual myself mystery myth naive name napkin narrow nasty nation nature near neck need negative neglect neither nephew nerve nest net network neutral never news next nice night noble noise nominee noodle normal north nose notable note nothing notice novel now nuclear number nurse nut oak obey object oblige obscure observe obtain obvious occur ocean october odor off offer office often oil okay old olive olympic omit once one onion online only open opera opinion oppose option orange orbit orchard order ordinary organ orient original orphan ostrich other outdoor outer output outside oval oven over own owner oxygen oyster ozone pact paddle page pair palace palm panda panel panic panther paper parade parent park parrot party pass patch path patient patrol pattern pause pave payment peace peanut pear peasant pelican pen penalty pencil people pepper perfect permit person pet phone photo phrase physical piano picnic picture piece pig pigeon pill pilot pink pioneer pipe pistol pitch pizza place planet plastic plate play please pledge pluck plug plunge poem poet point polar pole police pond pony pool popular portion position possible post potato pottery poverty powder power practice praise predict prefer prepare present pretty prevent price pride primary print priority prison private prize problem process produce profit program project promote proof property prosper protect proud provide public pudding pull pulp pulse pumpkin punch pupil puppy purchase purity purpose purse push put puzzle pyramid quality quantum quarter question quick quit quiz quote rabbit raccoon race rack radar radio rail rain raise rally ramp ranch random range rapid rare rate rather raven raw razor ready real reason rebel rebuild recall receive recipe record recycle reduce reflect reform refuse region regret regular reject relax release relief rely remain remember remind remove render renew rent reopen repair repeat replace report require rescue resemble resist resource response result retire retreat return reunion reveal review reward rhythm rib ribbon rice rich ride ridge rifle right rigid ring riot ripple risk ritual rival river road roast robot robust rocket romance roof rookie room rose rotate rough round route royal rubber rude rug rule run runway rural sad saddle sadness safe sail salad salmon salon salt salute same sample sand satisfy satoshi sauce sausage save say scale scan scare scatter scene scheme school science scissors scorpion scout scrap screen script scrub sea search season seat second secret section security seed seek segment select sell seminar senior sense sentence series service session settle setup seven shadow shaft shallow share shed shell sheriff shield shift shine ship shiver shock shoe shoot shop short shoulder shove shrimp shrug shuffle shy sibling sick side siege sight sign silent silk silly silver similar simple since sing siren sister situate six size skate sketch ski skill skin skirt skull slab slam sleep slender slice slide slight slim slogan slot slow slush small smart smile smoke smooth snack snake snap sniff snow soap soccer social sock soda soft solar soldier solid solution solve someone song soon sorry sort soul sound soup source south space spare spatial spawn speak special speed spell spend sphere spice spider spike spin spirit split spoil sponsor spoon sport spot spray spread spring spy square squeeze squirrel stable stadium staff stage stairs stamp stand start state stay steak steel stem step stereo stick still sting stock stomach stone stool story stove strategy street strike strong struggle student stuff stumble style subject submit subway success such sudden suffer sugar suggest suit summer sun sunny sunset super supply supreme sure surface surge surprise surround survey suspect sustain swallow swamp swap swarm swear sweet swift swim swing switch sword symbol symptom syrup system table tackle tag tail talent talk tank tape target task taste tattoo taxi teach team tell ten tenant tennis tent term test text thank that theme then theory there they thing this thought three thrive throw thumb thunder ticket tide tiger tilt timber time tiny tip tired tissue title toast tobacco today toddler toe together toilet token tomato tomorrow tone tongue tonight tool tooth top topic topple torch tornado tortoise toss total tourist toward tower town toy track trade traffic tragic train transfer trap trash travel tray treat tree trend trial tribe trick trigger trim trip trophy trouble truck true truly trumpet trust truth try tube tuition tumble tuna tunnel turkey turn turtle twelve twenty twice twin twist two type typical ugly umbrella unable unaware uncle uncover under undo unfair unfold unhappy uniform unique unit universe unknown unlock until unusual unveil update upgrade uphold upon upper upset urban urge usage use used useful useless usual utility vacant vacuum vague valid valley valve van vanish vapor various vast vault vehicle velvet vendor venture venue verb verify version very vessel veteran viable vibrant vicious victory video view village vintage violin virtual virus visa visit visual vital vivid vocal voice void volcano volume vote voyage wage wagon wait walk wall walnut want warfare warm warrior wash wasp waste water wave way wealth weapon wear weasel weather web wedding weekend weird welcome west wet whale what wheat wheel when where whip whisper wide width wife wild will win window wine wing wink winner winter wire wisdom wise wish witness wolf woman wonder wood wool word work world worry worth wrap wreck wrestle wrist write wrong yard year yellow you young youth zebra zero zone zoo".normalize("NFKD").split(" "),n.DashPhrase=s})(globalThis.window||{},t),r.exports=t}(Ko,Ko.exports)),Ko.exports}var mk=gk();const yk=Fs(mk);class wk{apiUrl;constructor(e){this.apiUrl=e}async generatePhrase(){const e=await yk.generate(16);let t;do t=self.crypto.getRandomValues(new Uint32Array(1))[0];while(t>=Math.floor(2**32/100)*100);return t=t%100,[t,...e.split(" ")].join("-")}async registerPhrase(e,t){try{const n=await this.makeApiRequest("/phrase","POST",{Maddr:t.toString(),Phrase:e});if(!n.ok)throw new Error(`Failed to register phrase. Status: ${n.status}`);return await n.json()}catch(n){throw this.handleApiError(n),n}}async lookupPhrase(e){try{const t=await this.makeApiRequest(`/phrase/${encodeURIComponent(e)}`,"GET");if(!t.ok)throw new Error(`Failed to lookup phrase. Status: ${t.status}`);return await t.json()}catch(t){throw this.handleApiError(t),t}}async makeApiRequest(e,t,n=null){const s=`${this.apiUrl}${e}`,i={method:t,headers:{"Content-type":"application/json; charset=UTF-8"}};return n&&(i.body=JSON.stringify(n)),await fetch(s,i)}handleApiError(e){console.error("API Error:",e)}validatePhrase(e){return!!(e!=null&&e.trim().length>0&&/^\d{1,3}-(?:[a-z]{3,8})-(?:[a-z]{3,8})$/.test(e))}sanitizePhrase(e){return e.trim().toLowerCase()}}const bk=[.2,3/8,5/9,2/3],vk=(r,e)=>t=>{const n=4*r+t-4,s="*-04-39?2$%%$%%'$%''%'''%')(%'))%(++'(++'(+.'+-.',/3',33)-/5)-43).36)058*18<+37<+4:<,4:E,5<A-7>C/8@F/:EH/<EK0=FM1?IP2@KS3BNV4DPY5FS\\6HV_6IXb7K[e8N^i9Pam;Rdp<Tgt".charCodeAt(n)-35,i=n>8?s:1,o=e/i|0,a=e%i,c=i-a,u=n>8?o*bk[t]+(r>5)&-2:s,l=o-u;return{t:c*l+a*l+a,o:[[c,l],[a,l+1]],i:u}},An=r=>new Uint8Array(r),ui=r=>{const e=new Error(`lean-qr error ${r}`);throw e.code=r,e},Wo=r=>"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:".indexOf(r),Bu=r=>r.charCodeAt(0),$5=(...r)=>(e,t)=>r.forEach(n=>n(e,t)),q5=r=>e=>{e.eci!==r&&(e.push(7,4),e.push(r,8),e.eci=r)},od=r=>(e,t)=>{e.push(4,4),e.push(r.length,8+8*(t>9)),r.forEach(n=>e.push(n,8))},Hs=(r,e,t,n,s=(o,a)=>t(o.length,a),i=n?o=>$5(q5(n),r(o)):r)=>(i.test=e,i.l=t,i.est=s,i.eci=n&&[n],i),V5=Hs(r=>(e,t)=>{e.push(1,4),e.push(r.length,10+2*(t>26)+2*(t>9));let n=0;for(;n<r.length-2;n+=3)e.push(+r.slice(n,n+3),10);n<r.length-1?e.push(+r.slice(n),7):n<r.length&&e.push(+r[n],4)},r=>/[0-9]/.test(r),(r,e)=>14+2*(e>26)+2*(e>9)+10*r/3),z5=Hs(r=>(e,t)=>{e.push(2,4),e.push(r.length,9+2*(t>26)+2*(t>9));let n=0;for(;n<r.length-1;n+=2)e.push(45*Wo(r[n])+Wo(r[n+1]),11);n<r.length&&e.push(Wo(r[n]),6)},r=>Wo(r)>=0,(r,e)=>13+2*(e>26)+2*(e>9)+5.5*r),Ds=Hs(r=>od([...r].map(Bu)),r=>Bu(r)<128,(r,e)=>12+8*(e>9)+8*r);Ds._=!0,Ds.u=!0;const ad=Hs(Ds,r=>Bu(r)<256,Ds.l,3);ad._=!0;const X2=new TextEncoder,cd=Hs(r=>od(X2.encode(r)),()=>1,0,26,(r,e)=>12+8*(e>9)+8*X2.encode(r).length);cd._=!0;let Mu=()=>{const r=new Map,e=new TextDecoder("sjis"),t=An(2);for(let n=0;n<7973;++n)t[0]=n/192+129+64*(n>5951),t[1]=n%192+64,r.set(e.decode(t),n);return r.delete("�"),Mu=()=>r,r};const ld=Hs(r=>(e,t)=>{e.push(8,4),e.push(r.length,8+2*(t>26)+2*(t>9));for(const n of r)e.push(Mu().get(n),13)},r=>Mu().has(r),(r,e)=>12+2*(e>26)+2*(e>9)+13*r);ld._=!0;const H5=[V5,z5,Ds,ad,ld,cd],Ek={auto:(r,{modes:e=H5}={})=>(t,n)=>{const s=e.map((l,d)=>{const h=new Map,f=(p,m)=>(h.has(p)||h.set(p,m(p,n)),h.get(p));return{m:l,h:1<<d,C:l.est("",n),S:l.l?(p,m)=>f(m-p,l.l):(p,m)=>f(r.slice(p,m),l.est)}});let i=[{v:0}],o=0,a=0,c=-1;for(const l of[...r,""]){let d=0;if(l)for(const h of s)h.m.test(l)&&(d|=h.h);if(!l||d!==c){if(c!==-1){const h=new Set(i.map(p=>p.D)),f=[];for(const{m:p,C:m,S:g,h:y}of s)if(c&y){const E=g(o,a);for(const b of p.eci??h)if(!p.u||!b){let _;for(const w of i)if(w.D===b||p.eci){const k=w.m===p&&w.D===b,x=k?w.V:w,T=p._&&k?w.v+E-m:x.v+12*(x.D!==b)+(k?g(k?w.$:o,a):E);(!_||T<_.v)&&(_={$:k?w.$:o,V:x,m:p,D:b,A:a,v:T})}_&&f.push(_)}}i=f}c=d,o=a}a+=l.length}i.length||ui(5);const u=[];for(let l=i.reduce((d,h)=>h.v<d.v?h:d);l.m;l=l.V)u.push(l.m(r.slice(l.$,l.A)));u.reverse().forEach(l=>l(t,n))},multi:$5,eci:q5,bytes:od,numeric:V5,alphaNumeric:z5,ascii:Ds,iso8859_1:ad,shift_jis:ld,utf8:cd},Sk=()=>({F:An(2956),I:0,push(r,e){for(let t=e,n=8-(7&this.I);t>0;t-=n,n=8)this.F[this.I>>3]|=r<<n>>t,this.I+=t<n?t:n}}),Nl=(r,e=r*r,t=An(e))=>({size:r,K:t,get:(n,s)=>n>=0&&n<r&&!!(1&t[s*r+n]),toString({on:n="##",off:s="  ",lf:i=`
`,padX:o=4,padY:a=4}={}){let c="";for(let u=-a;u<r+a;++u){for(let l=-o;l<r+o;++l)c+=this.get(l,u)?n:s;c+=i}return c},toImageData(n,{on:s=[0,0,0],off:i=[0,0,0,0],padX:o=4,padY:a=4}={}){const c=r+2*o,u=r+2*a,l=n.createImageData(c,u),d=new Uint32Array(l.data.buffer);l.data.set([...s,255]);const h=d[0];l.data.set([...i,255]);const f=d[0];for(let p=0;p<u;++p)for(let m=0;m<c;++m)d[p*c+m]=this.get(m-o,p-a)?h:f;return l},toCanvas(n,s){const i=n.getContext("2d"),o=this.toImageData(i,s);n.width=o.width,n.height=o.height,i.putImageData(o,0,0)},toDataURL({type:n="image/png",scale:s=1,...i}={}){const o=document.createElement("canvas"),a=o.getContext("2d"),c=this.toImageData(a,i);return o.width=c.width*s,o.height=c.height*s,a.putImageData(c,0,0),a.imageSmoothingEnabled=!1,a.globalCompositeOperation="copy",a.drawImage(o,0,0,c.width,c.height,0,0,o.width,o.height),o.toDataURL(n,1)}}),Bl=[(r,e)=>!(1&(r^e)),(r,e)=>!(1&e),r=>!(r%3),(r,e)=>!((r+e)%3),(r,e)=>!(1&(r/3^e>>1)),(r,e)=>!((r&e&1)+r*e%3),(r,e)=>!((r&e&1)+r*e%3&1),(r,e)=>!((1&(r^e))+r*e%3&1)],tc=An(511);for(let r=0,e=1;r<255;e=2*e^285*(e>127))tc[tc[e+255]=r++]=e;const K5=r=>tc[r%255],W5=r=>tc[r+255],_k=(r,e)=>{const t=An(r.length+e.length-1);for(let n=0;n<r.length;++n)for(let s=0;s<e.length;++s)t[n+s]^=K5(r[n]+e[s]);return t.map(W5)},xk=(r,e)=>{const t=An(r.length+e.length-1);t.set(r,0);for(let n=0;n<r.length;++n)if(t[n]){const s=W5(t[n]);for(let i=0;i<e.length;++i)t[n+i]^=K5(e[i]+s)}return t.slice(r.length)},Ou=[[0],[0,0]];for(let r=1;r<30;++r)Ou.push(_k(Ou[r],[0,r]));const Ak=(r,e)=>{const t=[[],[]];let n=0,s=0;for(const[o,a]of e.o)for(let c=0;c<o;++c,n+=a){const u=r.slice(n,n+a);t[0].push(u),t[1].push(xk(u,Ou[e.i])),s+=a+e.i}const i=An(s);s=0;for(const o of t)for(let a,c=0;s!==a;++c){a=s;for(const u of o)c<u.length&&(i[s++]=u[c])}return i},G5=(r,e,t)=>{let n=r<<=t;for(let s=134217728;s>>=1;)n&s&&(n^=e*(s>>t));return n|r},Ck=({size:r,K:e},t)=>{const n=(o,a,c,u)=>{for(;c-- >0;o+=r)e.fill(u,o,o+a)},s=(o,a,c)=>{for(let u=0;u++<3;c-=2)n(a*r+o-(c>>1)*(r+1),c,c,2|u)},i=2*((r-13)/(1+(t/7|0))/2+.75|0);if(t>1)for(let o=r-7;o>8;o-=i){for(let a=o;a>8;a-=i)s(o,a,5);o<r-7&&s(o,6,5)}if(t>6)for(let o=G5(t,7973,12),a=1;a<7;++a)for(let c=12;c-- >9;o>>=1)e[a*r-c]=2|1&o;n(7,2,9,2),n(r-8,8,9,2);for(let o=0;o<r;++o)e[6*r+o]=3^1&o;s(3,3,7),s(r-4,3,7);for(let o=0;o<r;++o)for(let a=o;a<r;++a)e[a*r+o]=e[o*r+a];e[(r-8)*r+8]=3},kk=({size:r,K:e})=>{const t=[];for(let n=r-2,s=r,i=-1;n>=0;n-=2){for(n===5&&(n=4);s+=i,s!==-1&&s!==r;){const o=s*r+n;e[o+1]||t.push(o+1),e[o]||t.push(o)}i*=-1}return t},Tk=({K:r},e,t)=>e.forEach((n,s)=>r[n]=t[s>>3]>>(7&~s)&1),Ik=({size:r,K:e},t,n,s)=>{for(let o=0;o<r;++o)for(let a=0;a<r;++a){const c=o*r+a;e[c]^=t(a,o)&(e[c]>>1^1)}let i=21522^G5((1^s)<<3|n,1335,10);for(let o=0;o++<8;i>>=1)e[(o-(o<7))*r+8]=1&i,e[9*r-o]=1&i;for(let o=8;--o,i;i>>=1)e[8*r+o-(o<7)]=1&i,e[(r-o)*r+8]=1&i},Pk=({size:r,K:e},t=0,n=0)=>{for(let s=0;s<r;++s){for(let i=0;i<2;++i)for(let o,a=0,c=0,u=0;a<r;++a){const l=1&e[i?s*r+a:a*r+s];n+=l,c=(c>>1|2098176)&(3047517^l-1),2049&c&&(t+=40),l!==o&&(u=0),o=l,t+=++u===5?3:u>5}if(s)for(let i=r+s,o=5*e[s-1]^e[s];i<r*r;i+=r){const a=5*e[i-1]^e[i];t+=3*!(1&(o|a)|4&(o^a)),o=a}}return t+10*(10*Math.abs(n/(r*r)-1)|0)},Z2=[],Fu=(r=ui(1),{minCorrectionLevel:e=0,maxCorrectionLevel:t=3,minVersion:n=1,maxVersion:s=40,mask:i,trailer:o=60433,...a}={})=>{t<e&&ui(3),s<n&&ui(2),typeof r=="string"&&(r=Ek.auto(r,a));for(let c=n,u=0;c<=s;++c){let l=Z2[c];l||(Z2[c]=l=Nl(4*c+17),Ck(l,c),l.p=kk(l));const d=vk(c,l.p.length>>3);if(8*d(e).t<u)continue;const h=Sk();r(h,c),u=h.I;for(let f=t;f>=e;--f){const p=d(f);if(8*p.t<u)continue;for(h.I=u+11&-8;h.I<8*p.t;)h.push(o,16);const m=Nl(l.size,l.K);return Tk(m,l.p,Ak(h.F,p)),(Bl[i??-1]?[Bl[i]]:Bl).map((g,y)=>{const E=Nl(m.size,m.K);return Ik(E,g,i??y,f),E.s=Pk(E),E}).reduce((g,y)=>y.s<g.s?y:g)}}ui(4)};Fu.with=(...r)=>(e,t)=>Fu(e,{modes:[...H5,...r],...t});class Rk{appState;elements;theme="light";onFileSelected=()=>{};onPhraseEntered=()=>{};onReceiveModeRequested=()=>{};constructor(e){this.appState=e,this.elements=this.getUIElements(),this.initTheme(),this.clearPhrase()}showSenderMode(){this.hideElement("initialDropUI"),this.showElement("fileInfoArea")}showSendingInProgress(){this.hideElement("fileInfoArea"),this.showElement("sendInProgress")}showReceiverMode(){this.hideElement("initialReceiveUI"),this.showElement("receiveInProgress")}showHome(){window.location.assign(window.location.origin)}showSendWindow(){this.showElement("goBackButton","flex"),this.hideElement("goSendButton"),this.hideElement("goReceiveButton"),this.showElement("sendWindow"),this.hideElement("receiveWindow")}showReceiveWindow(){this.showElement("goBackButton","flex"),this.hideElement("goSendButton"),this.hideElement("goReceiveButton"),this.showElement("receiveWindow"),this.hideElement("sendWindow")}resetUI(){this.showHome(),this.clearFileDisplay(),this.hideErrorPopup()}initTheme(){this.theme=localStorage.theme||this.getSystemTheme(),document.documentElement.classList.add(this.theme)}toggleTheme(){this.theme==="light"?(this.theme="dark",localStorage.theme="dark",document.documentElement.classList.remove("light"),document.documentElement.classList.add("dark")):(this.theme="light",localStorage.theme="light",document.documentElement.classList.remove("dark"),document.documentElement.classList.add("light"))}getSystemTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?(localStorage.theme="dark","dark"):(localStorage.theme="light","light")}displaySelectedFile(e){this.updateElement("fileNameDisplay",e.name),this.updateElement("fileSizeDisplay",`${(e.size/1024/1024).toFixed(2)} MB`)}showFileProgress(e,t){const{percentage:n,current:s,total:i,rate:o}=e,a=t==="send"?"sendProgressBar":"receiveProgressBar",c=t==="send"?"sendProgressText":"receiveProgressText",u=t==="send"?"sendRate":"receiveRate";this.updateProgressBar(a,n),this.updateElement(c,`${s} MB / ${i} MB`),this.updateElement(u,`${o} Mbps`)}showReceivedFileDetails(e,t){this.updateElement("receivedFileName",e),this.updateElement("receivedFileSize",`${(t/1024/1024).toFixed(2)} MB`)}showTransferComplete(e){const t=e==="send"?"sendInProgress":"receiveInProgress",n=e==="send"?"sendComplete":"receiveComplete";this.hideElement(t),this.showElement(n)}updateProgressBar(e,t){const n=document.getElementById(e);n&&(n.style.width=`${t}%`)}clearFileDisplay(){this.updateElement("fileNameDisplay",""),this.updateElement("fileSizeDisplay","")}showReconnecting(){this.appState.getMode()==="sender"?(this.hideElement("sendInProgress"),this.showElement("reconnectingSend")):this.appState.getMode()==="receiver"&&(this.hideElement("receiveInProgress"),this.showElement("reconnectingReceive"))}hideReconnecting(){this.appState.getMode()==="sender"?(this.hideElement("reconnectingSend"),this.showElement("sendInProgress")):this.appState.getMode()==="receiver"&&(this.hideElement("reconnectingReceive"),this.showElement("receiveInProgress"))}showErrorPopup(e){this.updateElement("errorMessageText",e),this.elements.errorWindow?.classList.remove("hidden")}hideErrorPopup(){this.elements.errorWindow?.classList.add("hidden")}setupEventListeners(){this.setupFileHandlers(),this.setupButtonHandlers(),this.setupErrorHandlers()}setupFileHandlers(){const e=this.elements.dropZone,t=this.elements.fileInput;e?.addEventListener("dragover",this.handleDragOver.bind(this)),e?.addEventListener("drop",this.handleFileDrop.bind(this)),t?.addEventListener("change",this.handleFileSelect.bind(this))}setupButtonHandlers(){this.elements.sun?.addEventListener("click",()=>this.toggleTheme()),this.elements.moon?.addEventListener("click",()=>this.toggleTheme()),this.elements.selectFileButton?.addEventListener("click",()=>this.elements.fileInput?.click()),this.elements.goSendButton?.addEventListener("click",this.showSendWindow.bind(this)),this.elements.goReceiveButton?.addEventListener("click",this.showReceiveWindow.bind(this)),this.elements.goBackButton?.addEventListener("click",this.showHome.bind(this)),this.elements.copyPhraseButton?.addEventListener("click",this.copyPhrase.bind(this)),this.elements.shareButton?.addEventListener("click",this.copyShareLink.bind(this)),this.elements.receiveModeButton?.addEventListener("click",()=>{const t=document.getElementById("phraseInput").value.trim();if(!t){this.showErrorPopup("Please enter a valid phrase.");return}this.showReceiverMode(),this.onPhraseEntered(t)}),this.elements.qrCodeButton?.addEventListener("click",this.showQrCodePopup.bind(this)),this.elements.closePopupButton?.addEventListener("click",this.hideQrCodePopup.bind(this)),this.elements.qrCodePopup?.addEventListener("click",e=>{e.target===this.elements.qrCodePopup&&this.hideQrCodePopup()})}showQrCodePopup(){this.showElement("qrCodePopup","flex")}hideQrCodePopup(){this.hideElement("qrCodePopup")}generateQRCode(e){const t=Fu(e);this.elements.qrCodeCanvas?(t.toCanvas(this.elements.qrCodeCanvas),console.log("QR Code generated and displayed.")):console.error("QR Code canvas element not found.")}setupErrorHandlers(){const e=this.elements.errorWindow,t=this.elements.closeErrorButton;e?.addEventListener("click",n=>{n.target===e&&(this.hideErrorPopup(),this.resetUI())}),t?.addEventListener("click",()=>{this.hideErrorPopup(),this.resetUI()})}handleDragOver(e){e.preventDefault()}handleFileDrop(e){e.preventDefault();let t=null;if(e.dataTransfer?.items){const n=[...e.dataTransfer.items].find(s=>s.kind==="file");n&&(t=n.getAsFile())}else e.dataTransfer?.files&&e.dataTransfer.files.length>0&&(t=e.dataTransfer.files[0]);t&&(this.appState.setSelectedFile(t),this.displaySelectedFile(t),this.onFileSelected(t))}handleFileSelect(e){const t=e.target;if(t.files&&t.files[0]){const n=t.files[0];this.appState.setSelectedFile(n),this.displaySelectedFile(n),this.onFileSelected(n)}}copyShareLink(){if(this.elements.generatedPhraseDisplay?.innerText){const e=this.elements.generatedPhraseDisplay.innerText,t=`${window.location.origin}/receive?phrase=${e}`;navigator.clipboard.writeText(t)}}showPhrase(e){const t=`${window.location.origin}/receive?phrase=${e}`;this.generateQRCode(t),this.updateElement("generatedPhraseDisplay",e),this.updateElement("qrCodePhrase",e),this.showElement("qrCodePhrase")}copyPhrase(){this.elements.generatedPhraseDisplay?.innerText&&navigator.clipboard.writeText(this.elements.generatedPhraseDisplay.innerText)}clearPhrase(){const e=document.getElementById("phraseInput");e&&(e.value="")}updateElement(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}showElement(e,t="block"){const n=document.getElementById(e);n&&(n.style.display=t)}hideElement(e){const t=document.getElementById(e);t&&(t.style.display="none")}getUIElements(){return{dropZone:document.getElementById("drop_zone"),fileInput:document.getElementById("fileInput"),copyPhraseButton:document.getElementById("copyPhraseButton"),receiveModeButton:document.getElementById("receiveModeButton"),goSendButton:document.getElementById("goSendButton"),goReceiveButton:document.getElementById("goReceiveButton"),goBackButton:document.getElementById("goBackButton"),selectFileButton:document.getElementById("selectFileButton"),errorWindow:document.getElementById("errorWindow"),closeErrorButton:document.getElementById("closeErrorButton"),generatedPhraseDisplay:document.getElementById("generatedPhraseDisplay"),qrCodeButton:document.getElementById("qrCodeButton"),qrCodePopup:document.getElementById("qrCodePopup"),closePopupButton:document.getElementById("closeQrCodePopup"),qrCodeCanvas:document.getElementById("qrCodeCanvas"),qrCodePhrase:document.getElementById("qrCodePhrase"),shareButton:document.getElementById("shareButton"),sun:document.getElementById("sun"),moon:document.getElementById("moon")}}}class Dk{uiManager;lastUpdateTime;lastBytes;updateInterval;constructor(e){this.uiManager=e,this.lastUpdateTime=0,this.lastBytes=0,this.updateInterval=250}updateProgress(e,t,n,s=!1){const i=Date.now(),o=i-this.lastUpdateTime;if(!s&&o<this.updateInterval)return;const a=o/1e3,c=e-this.lastBytes;let u=0;a>0&&c>0&&(u=c/a*8/(1024*1024));const l=t>0?e/t*100:0,d=(e/(1024*1024)).toFixed(2),h=(t/(1024*1024)).toFixed(2);if(console.log("Receive progress: "+l.toFixed(2)+"% ("+d+" MB / "+h+" MB)"),this.uiManager.showSendingInProgress(),l>=100)this.uiManager.showTransferComplete(n);else{const f={percentage:l,current:d,total:h,rate:u.toFixed(2)};this.uiManager.showFileProgress(f,n)}this.lastUpdateTime=i,this.lastBytes=e}}class Lk{uiManager;constructor(e){this.uiManager=e}handleConnectionError(e,t){const n=`Connection error: ${e.message}`;this.logError(e,t),this.uiManager.showErrorPopup(n)}tryAgainError(){this.uiManager.showErrorPopup("The FileFerry got lost at sea, make sure your maps are in order and try again.")}handleTransferError(e,t){const n=`Transfer error: ${e.message}`;this.logError(e,t),this.uiManager.showErrorPopup(n)}handleApiError(e,t){const n=`API error: ${e.message}`;this.logError(e,t),this.uiManager.showErrorPopup(n)}reconnecting(){this.uiManager.showReconnecting()}reconnected(){this.uiManager.hideReconnecting()}logError(e,t){console.error("Error:",e.message,"Context:",t)}}class Nk{config;constructor(){this.config={relay:{address:"/dns4/195-114-14-137.k51qzi5uqu5dlg6rzzu1wamxpip5om9vddzw5dvmw38wp1f4b30yi0q4itxkym.libp2p.direct/tcp/41338/wss/p2p/12D3KooWQ3E3PsbrVnnh34dSggrcTqBKqrA2bbMwTH9EHmea7CfP"},api:{url:"https://exchange.fileferry.xyz"},transfer:{protocol:"/fileferry/filetransfer/1.0.0"},stun:{fallback:["stun:l.google.com:19302","stun:stun.nextcloud.com:443"]}}}getRelayAddress(){return this.config.relay.address}getApiUrl(){return this.config.api.url}getStunServers(){return this.config.stun.fallback}getFileTransferProtocol(){return this.config.transfer.protocol}validateConfig(){const e=["relay.address","api.url","transfer.protocol"];for(const t of e)if(!this.getConfigValue(t))throw new Error(`Missing required configuration: ${t}`);return!0}getConfigValue(e,t=null){const n=e.split(".");let s=this.config;for(const i of n){if(s[i]===void 0)return t;s=s[i]}return s}}class Bk{config;appState;node;services;managers;constructor(){this.config=new Nk,this.appState=new BC,this.node=null,this.services={},this.managers={}}async initialize(){try{this.config.validateConfig(),await this.setupServices(),await this.setupLibp2pNode(),await this.setupManagers(),await this.setupUI(),console.log("FileFerry app initialized successfully")}catch(e){throw console.error("Failed to initialize app:",e),e}}async setupServices(){this.services.stun=new pk,this.services.phrase=new wk(this.config.getApiUrl())}async setupLibp2pNode(){const e=await this.getStunConfiguration(),t=this.config.getRelayAddress();console.log(e);const n={rtcConfiguration:{iceServers:[{urls:e},{urls:"turn:turn.fileferry.xyz:5349",username:"ferryCaptain",credential:"i^YV13eTPOHdVzWm#2t5"}]}},s={addresses:{listen:["/webrtc","/p2p-circuit"]},transports:[cb(),Nv(n),Zv({filter:H4})],connectionEncrypters:[Sm()],streamMuxers:[Hm()],services:{dht:SC(),peerDiscovery:NC({list:[t],timeout:2e3}),dcutr:Hx(),identify:Db(),identifyPush:Lb(),keychain:Vx(),ping:qb()}};this.node=await _x(s),await this.node.start(),console.log(`Node started with Peer ID: ${this.node.peerId.toString()}`)}async setupManagers(){if(!this.node)throw new Error("Libp2p node is not initialized.");this.managers.ui=new Rk(this.appState),this.managers.error=new Lk(this.managers.ui),this.managers.progress=new Dk(this.managers.ui),this.managers.fileTransfer=new fk(this.node,this.appState,this.managers.progress,this.managers.ui),this.managers.connection=new MC(this.node,this.appState,this.managers.error,this.config,this.managers.fileTransfer),this.setupEventListeners(),this.managers.fileTransfer.setupFileTransferProtocol();const e=window.location.pathname;e&&this.actionPathname(e)}async setupUI(){if(!this.managers.ui)throw new Error("UIManager not initialized");this.managers.ui.setupEventListeners(),this.managers.ui.onFileSelected=this.handleFileSelected.bind(this),this.managers.ui.onPhraseEntered=this.handlePhraseEntered.bind(this),this.managers.ui.onReceiveModeRequested=this.handleReceiveModeRequested.bind(this)}setupEventListeners(){!this.node||!this.managers.connection||(this.node.addEventListener("connection:open",this.managers.connection.onConnectionEstablished.bind(this.managers.connection)),this.node.addEventListener("connection:close",this.managers.connection.onConnectionClosed.bind(this.managers.connection)))}async getStunConfiguration(){if(!this.services.stun)return this.config.getStunServers();try{const e=await this.services.stun.getClosestStunServers();return e||this.config.getStunServers()}catch(e){return console.warn("Could not fetch closest STUN server:",e),this.config.getStunServers()}}async handleFileSelected(e){if(!(!this.managers.ui||!this.managers.error))try{this.managers.ui.showSenderMode(),await this.startSenderMode(e)}catch(t){this.managers.error.handleTransferError(t,{operation:"fileSelected",direction:"send"})}}async handlePhraseEntered(e){if(this.managers.error)try{await this.startReceiverMode(e)}catch(t){this.managers.error.handleApiError(t,{operation:"phraseEntered"})}}async handleReceiveModeRequested(){this.managers.ui&&this.managers.ui.showReceiverMode()}async startSenderMode(e){if(!(!this.services.phrase||!this.managers.error))try{this.appState.setSelectedFile(e),this.appState.setMode("sender"),console.log("Starting sender mode...");const t=await this.services.phrase.generatePhrase();console.log(`Generated phrase: ${t}`),this.managers.ui?.showPhrase(t);let n;for(;!n;)n=this.node?.getMultiaddrs().find(s=>La.matches(s)),await new Promise(s=>setTimeout(s,1e3));console.log("WebRTC Circuit Address:",n?.toString()),console.log("Registering phrase..."),await this.services.phrase.registerPhrase(t,n),console.log("Sender mode setup complete. Waiting for receiver...")}catch(t){throw console.error("Failed to start sender mode:",t),this.managers.error.handleTransferError(t,{operation:"startSenderMode",direction:"send"}),this.appState.setMode("idle"),t}}async startReceiverMode(e){if(!this.appState||!this.services.phrase||!this.managers.connection||!this.node)return;this.appState.setMode("receiver");let t;try{t=await this.services.phrase.lookupPhrase(e)}catch{this.managers.ui?.showErrorPopup("No address found for the provided phrase.")}if(t==null||!t.maddr){this.managers.ui?.showErrorPopup("No address found for the provided phrase.");return}const n=W(t.maddr);console.log(`Connecting to peer: ${t.maddr}`);const s=await this.managers.connection.dialPeer(n,{signal:AbortSignal.timeout(6e4)});console.log(`Connected to sender via phrase: ${e}`),this.appState.setActivePeer(s.remotePeer.toString())}actionPathname(e){if(e.startsWith("/send"))this.managers.ui?.showSendWindow();else if(e.startsWith("/receive")){this.managers.ui?.showReceiveWindow();const t=new URLSearchParams(window.location.search),n=this.services.phrase?.sanitizePhrase(t.get("phrase")||"");n&&this.services.phrase?.validatePhrase(n)?(this.startReceiverMode(n),this.managers.ui?.showReceiverMode(),this.managers.ui?.onPhraseEntered(n)):this.managers.ui?.showErrorPopup("Invalid phrase provided.")}else e!=="/"&&e!==""&&!e.startsWith("/staging")&&this.managers.ui?.showErrorPopup("404 Page Not Found")}async start(){await this.initialize()}async stop(){this.node&&await this.node.stop(),this.appState.reset(),console.log("FileFerry app stopped")}}const j5=new Bk;document.addEventListener("DOMContentLoaded",async()=>{try{await j5.start()}catch(r){console.error("Failed to start FileFerry app:",r)}});window.addEventListener("unhandledrejection",r=>{console.error("Unhandled promise rejection:",r.reason)});window.addEventListener("error",r=>{console.error("Global error:",r.error)});window.fileFerryApp=j5;
